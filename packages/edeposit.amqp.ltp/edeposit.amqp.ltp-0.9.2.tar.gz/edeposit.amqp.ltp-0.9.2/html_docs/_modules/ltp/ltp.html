<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ltp.ltp &mdash; edeposit.amqp.ltp 0.9.2 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="edeposit.amqp.ltp 0.9.2 documentation" href="../../index.html" />
    <link rel="up" title="ltp" href="../ltp.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">edeposit.amqp.ltp 0.9.2 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ltp.html" accesskey="U">ltp</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ltp.ltp</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># Interpreter version: python 2.7</span>
<span class="c">#</span>
<span class="c"># Imports =====================================================================</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">xmltodict</span>
<span class="kn">from</span> <span class="nn">edeposit.amqp.aleph</span> <span class="kn">import</span> <span class="n">marcxml</span>

<span class="kn">import</span> <span class="nn">settings</span>

<span class="kn">import</span> <span class="nn">fn_composers</span>
<span class="kn">import</span> <span class="nn">checksum_generator</span>
<span class="kn">from</span> <span class="nn">xslt_transformer</span> <span class="kn">import</span> <span class="n">transform_to_mods</span>
<span class="kn">from</span> <span class="nn">mods_postprocessor</span> <span class="kn">import</span> <span class="n">_remove_hairs</span>


<span class="c"># Functions &amp; objects =========================================================</span>
<div class="viewcode-block" id="_get_package_name"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp._get_package_name">[docs]</a><span class="k">def</span> <span class="nf">_get_package_name</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">TEMP_DIR</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return package path. Use uuid to generate package&#39;s directory name.</span>

<span class="sd">    Args:</span>
<span class="sd">        prefix (str): Where the package will be stored. Default</span>
<span class="sd">                      :attr:`settings.TEMP_DIR`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Path to the root directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">prefix</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="p">)</span>

</div>
<div class="viewcode-block" id="_create_package_hierarchy"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp._create_package_hierarchy">[docs]</a><span class="k">def</span> <span class="nf">_create_package_hierarchy</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">TEMP_DIR</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create hierarchy of directories, at it is required in specification.</span>

<span class="sd">    `root_dir` is root of the package generated using :attr:`settings.TEMP_DIR`</span>
<span class="sd">    and :func:`_get_package_name`.</span>

<span class="sd">    `orig_dir` is path to the directory, where the data files are stored.</span>

<span class="sd">    `metadata_dir` is path to the directory with MODS metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        prefix (str): Path to the directory where the `root_dir` will be</span>
<span class="sd">                      stored.</span>

<span class="sd">    Warning:</span>
<span class="sd">        If the `root_dir` exists, it is REMOVED!</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of str: root_dir, orig_dir, metadata_dir</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_dir</span> <span class="o">=</span> <span class="n">_get_package_name</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="n">original_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">&quot;original&quot;</span><span class="p">)</span>
    <span class="n">metadata_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">&quot;metadata&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">original_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">metadata_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">original_dir</span><span class="p">,</span> <span class="n">metadata_dir</span>

</div>
<div class="viewcode-block" id="_get_localized_fn"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp._get_localized_fn">[docs]</a><span class="k">def</span> <span class="nf">_get_localized_fn</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return absolute `path` relative to `root_dir`.</span>

<span class="sd">    When `path` == ``/home/xex/somefile.txt`` and `root_dir` == ``/home``,</span>
<span class="sd">    returned path will be ``/xex/somefile.txt``.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Absolute path beginning in `root_dir`.</span>
<span class="sd">        root_dir (str): Absolute path containing `path` argument.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Local `path` when `root_dir` is considered as root of FS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">local_fn</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
        <span class="n">local_fn</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_fn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">local_fn</span>

    <span class="k">return</span> <span class="n">local_fn</span>

</div>
<div class="viewcode-block" id="_path_to_id"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp._path_to_id">[docs]</a><span class="k">def</span> <span class="nf">_path_to_id</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Name of the root directory is used as ``&lt;packageid&gt;`` in ``info.xml``.</span>

<span class="sd">    This function makes sure, that :func:`os.path.basename` doesn&#39;t return</span>
<span class="sd">    blank string in case that there is `/` at the end of the `path`.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to the root directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Basename of the `path`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_calc_dir_size"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp._calc_dir_size">[docs]</a><span class="k">def</span> <span class="nf">_calc_dir_size</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate size of all files in `path`.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to the directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Size of the directory in bytes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dir_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">full_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="n">dir_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">full_fn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dir_size</span>

</div>
<div class="viewcode-block" id="_add_order"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp._add_order">[docs]</a><span class="k">def</span> <span class="nf">_add_order</span><span class="p">(</span><span class="n">inp_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add order to unordered dict.</span>

<span class="sd">    Order is taken from *priority table*, which is just something I did to</span>
<span class="sd">    make outputs from `xmltodict` look like examples in specification.</span>

<span class="sd">    Args:</span>
<span class="sd">        inp_dict (dict): Unordered dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        OrderedDict: Dictionary ordered by *priority table*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="n">priority_table</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;created&quot;</span><span class="p">,</span>
        <span class="s">&quot;metadataversion&quot;</span><span class="p">,</span>
        <span class="s">&quot;packageid&quot;</span><span class="p">,</span>
        <span class="s">&quot;mainmets&quot;</span><span class="p">,</span>
        <span class="s">&quot;titleid&quot;</span><span class="p">,</span>
        <span class="s">&quot;collection&quot;</span><span class="p">,</span>
        <span class="s">&quot;institution&quot;</span><span class="p">,</span>
        <span class="s">&quot;creator&quot;</span><span class="p">,</span>
        <span class="s">&quot;size&quot;</span><span class="p">,</span>
        <span class="s">&quot;itemlist&quot;</span><span class="p">,</span>
        <span class="s">&quot;checksum&quot;</span>
    <span class="p">]</span>
    <span class="n">priority_table</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>  <span class="c"># construct dict keys -&gt; {key: order}</span>
        <span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cnt</span><span class="p">),</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="n">priority_table</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">sorted_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">inp_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">priority_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sorted_keys</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">inp_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">out</span>

</div>
<div class="viewcode-block" id="_compose_info"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp._compose_info">[docs]</a><span class="k">def</span> <span class="nf">_compose_info</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">hash_fn</span><span class="p">,</span> <span class="n">aleph_record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compose `info` XML file.</span>

<span class="sd">    Info example::</span>

<span class="sd">        &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
<span class="sd">        &lt;info&gt;</span>
<span class="sd">            &lt;created&gt;2014-07-31T10:58:53&lt;/created&gt;</span>
<span class="sd">            &lt;metadataversion&gt;1.0&lt;/metadataversion&gt;</span>
<span class="sd">            &lt;packageid&gt;c88f5a50-7b34-11e2-b930-005056827e51&lt;/packageid&gt;</span>
<span class="sd">            &lt;mainmets&gt;mets.xml&lt;/mainmets&gt;</span>
<span class="sd">            &lt;titleid type=&quot;ccnb&quot;&gt;cnb001852189&lt;/titleid&gt;</span>
<span class="sd">            &lt;titleid type=&quot;isbn&quot;&gt;978-80-85979-89-6&lt;/titleid&gt;</span>
<span class="sd">            &lt;collection&gt;edeposit&lt;/collection&gt;</span>
<span class="sd">            &lt;institution&gt;nakladatelství Altar&lt;/institution&gt;</span>
<span class="sd">            &lt;creator&gt;ABA001&lt;/creator&gt;</span>
<span class="sd">            &lt;size&gt;1530226&lt;/size&gt;</span>
<span class="sd">            &lt;itemlist itemtotal=&quot;1&quot;&gt;</span>
<span class="sd">                &lt;item&gt;\data\Denik_zajatce_Sramek_CZ_v30f-font.epub&lt;/item&gt;</span>
<span class="sd">            &lt;/itemlist&gt;</span>
<span class="sd">            &lt;checksum type=&quot;MD5&quot; checksum=&quot;ce076548eaade33888005de5d4634a0d&quot;&gt;</span>
<span class="sd">                \MD5.md5</span>
<span class="sd">            &lt;/checksum&gt;</span>
<span class="sd">        &lt;/info&gt;</span>

<span class="sd">    Args:</span>
<span class="sd">        root_dir (str): Absolute path to the root directory.</span>
<span class="sd">        original_fn (str): Absolute path to the ebook file.</span>
<span class="sd">        metadata_fn (str): Absolute path to the metadata file.</span>
<span class="sd">        hash_fn (str): Absolute path to the MD5 file.</span>
<span class="sd">        aleph_record (str): String with Aleph record with metadata.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: XML string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># compute hash for hashfile</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hash_fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">hash_file_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">document</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&quot;created&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">()),</span>
            <span class="s">&quot;metadataversion&quot;</span><span class="p">:</span> <span class="s">&quot;1.0&quot;</span><span class="p">,</span>
            <span class="s">&quot;packageid&quot;</span><span class="p">:</span> <span class="n">_path_to_id</span><span class="p">(</span><span class="n">root_dir</span><span class="p">),</span>

            <span class="c"># not used in SIP</span>
            <span class="c"># &quot;mainmets&quot;: _get_localized_fn(metadata_fn, root_dir),</span>

            <span class="s">&quot;itemlist&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;@itemtotal&quot;</span><span class="p">:</span> <span class="s">&quot;2&quot;</span><span class="p">,</span>
                <span class="s">&quot;item&quot;</span><span class="p">:</span> <span class="nb">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_get_localized_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">),</span>
                    <span class="n">files</span>
                <span class="p">)</span>
            <span class="p">},</span>
            <span class="s">&quot;checksum&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;@type&quot;</span><span class="p">:</span> <span class="s">&quot;MD5&quot;</span><span class="p">,</span>
                <span class="s">&quot;@checksum&quot;</span><span class="p">:</span> <span class="n">hash_file_md5</span><span class="p">,</span>
                <span class="s">&quot;#text&quot;</span><span class="p">:</span> <span class="n">_get_localized_fn</span><span class="p">(</span><span class="n">hash_fn</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s">&quot;collection&quot;</span><span class="p">:</span> <span class="s">&quot;edeposit&quot;</span><span class="p">,</span>
            <span class="s">&quot;size&quot;</span><span class="p">:</span> <span class="n">_calc_dir_size</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c"># size in kiB</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c"># get informations from MARC record</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">marcxml</span><span class="o">.</span><span class="n">MARCXMLRecord</span><span class="p">(</span><span class="n">aleph_record</span><span class="p">)</span>

    <span class="c"># get publisher info</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">getPublisher</span><span class="p">(</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;info&quot;</span><span class="p">][</span><span class="s">&quot;institution&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_remove_hairs</span><span class="p">(</span>
            <span class="n">record</span><span class="o">.</span><span class="n">getPublisher</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c"># get &lt;creator&gt; info</span>
    <span class="n">creator</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">getDataRecords</span><span class="p">(</span><span class="s">&quot;910&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">alt_creator</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">getDataRecords</span><span class="p">(</span><span class="s">&quot;040&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">document</span><span class="p">[</span><span class="s">&quot;info&quot;</span><span class="p">][</span><span class="s">&quot;creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">creator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">creator</span> <span class="k">else</span> <span class="n">alt_creator</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># collect informations for &lt;titleid&gt; tags</span>
    <span class="n">isbns</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">getISBNs</span><span class="p">()</span>

    <span class="n">ccnb</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">getDataRecords</span><span class="p">(</span><span class="s">&quot;015&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">ccnb</span> <span class="o">=</span> <span class="n">ccnb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">ccnb</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">isbns</span><span class="p">,</span> <span class="n">ccnb</span><span class="p">]):</span>  <span class="c"># TODO: issn</span>
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;info&quot;</span><span class="p">][</span><span class="s">&quot;titleid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">isbn</span> <span class="ow">in</span> <span class="n">isbns</span><span class="p">:</span>
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;info&quot;</span><span class="p">][</span><span class="s">&quot;titleid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">&quot;@type&quot;</span><span class="p">:</span> <span class="s">&quot;isbn&quot;</span><span class="p">,</span>
            <span class="s">&quot;#text&quot;</span><span class="p">:</span> <span class="n">isbn</span>
        <span class="p">})</span>

    <span class="k">if</span> <span class="n">ccnb</span><span class="p">:</span>
        <span class="n">document</span><span class="p">[</span><span class="s">&quot;info&quot;</span><span class="p">][</span><span class="s">&quot;titleid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">&quot;@type&quot;</span><span class="p">:</span> <span class="s">&quot;ccnb&quot;</span><span class="p">,</span>
            <span class="s">&quot;#text&quot;</span><span class="p">:</span> <span class="n">ccnb</span>
        <span class="p">})</span>

    <span class="c"># TODO: later</span>
    <span class="c"># if issn:</span>
    <span class="c">#     document[&quot;info&quot;][&quot;titleid&quot;].append({</span>
    <span class="c">#         &quot;@type&quot;: &quot;issn&quot;,</span>
    <span class="c">#         &quot;#text&quot;: issn</span>
    <span class="c">#     })</span>

    <span class="n">document</span><span class="p">[</span><span class="s">&quot;info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_add_order</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s">&quot;info&quot;</span><span class="p">])</span>
    <span class="n">xml_document</span> <span class="o">=</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># return xml_document.replace(&quot;&lt;?xml &quot;, &#39;&lt;?xml standalone=&quot;yes&quot; &#39;)</span>
    <span class="k">return</span> <span class="n">xml_document</span>

</div>
<div class="viewcode-block" id="create_ltp_package"><a class="viewcode-back" href="../../api/ltp.ltp.html#ltp.ltp.create_ltp_package">[docs]</a><span class="k">def</span> <span class="nf">create_ltp_package</span><span class="p">(</span><span class="n">aleph_record</span><span class="p">,</span> <span class="n">book_id</span><span class="p">,</span> <span class="n">ebook_fn</span><span class="p">,</span> <span class="n">b64_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create LTP package as it is specified in specification v1.0 as I understand</span>
<span class="sd">    it.</span>

<span class="sd">    Args:</span>
<span class="sd">        aleph_record (str): XML containing full aleph record.</span>
<span class="sd">        book_id (int): More or less unique ID of the book.</span>
<span class="sd">        ebook_fn (str): Original filename of the ebook.</span>
<span class="sd">        b64_data (str): Ebook file encoded in base64 string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Name of the package&#39;s directory in ``/tmp``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_dir</span><span class="p">,</span> <span class="n">orig_dir</span><span class="p">,</span> <span class="n">meta_dir</span> <span class="o">=</span> <span class="n">_create_package_hierarchy</span><span class="p">()</span>

    <span class="n">book_id</span> <span class="o">=</span> <span class="n">_path_to_id</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="c"># create original file</span>
    <span class="n">original_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">orig_dir</span><span class="p">,</span>
        <span class="n">fn_composers</span><span class="o">.</span><span class="n">original_fn</span><span class="p">(</span><span class="n">book_id</span><span class="p">,</span> <span class="n">ebook_fn</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_fn</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64_data</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c"># create metadata files</span>
    <span class="n">metadata_filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">transform_to_mods</span><span class="p">(</span><span class="n">aleph_record</span><span class="p">,</span> <span class="n">book_id</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">mods_record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">meta_dir</span><span class="p">,</span>
            <span class="n">fn_composers</span><span class="o">.</span><span class="n">volume_fn</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mods_record</span><span class="p">)</span>

        <span class="n">metadata_filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="c"># collect md5 sums</span>
    <span class="n">md5_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">fn_composers</span><span class="o">.</span><span class="n">checksum_fn</span><span class="p">(</span><span class="n">book_id</span><span class="p">))</span>
    <span class="n">checksums</span> <span class="o">=</span> <span class="n">checksum_generator</span><span class="o">.</span><span class="n">generate_hashfile</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">md5_fn</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">checksums</span><span class="p">)</span>

    <span class="c"># create info file</span>
    <span class="n">info_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">fn_composers</span><span class="o">.</span><span class="n">info_fn</span><span class="p">(</span><span class="n">book_id</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">info_fn</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="n">_compose_info</span><span class="p">(</span>
                <span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span>
                <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="n">original_fn</span><span class="p">]</span> <span class="o">+</span> <span class="n">metadata_filenames</span><span class="p">,</span>
                <span class="n">hash_fn</span><span class="o">=</span><span class="n">md5_fn</span><span class="p">,</span>
                <span class="n">aleph_record</span><span class="o">=</span><span class="n">aleph_record</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">root_dir</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">edeposit.amqp.ltp 0.9.2 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ltp.html" >ltp</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014 E-deposit team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>