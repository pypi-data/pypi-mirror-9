<!DOCTYPE html>
<html>

<head>
    <title>Agora Job Scheduler</title>

    <link rel="shortcut icon" href="/images/clock-128.png"/>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>

    <style>
        body {
            padding: 40px!important;
        }
    </style>
</head>

<body>
    <div ng-app="jobs_scheduler" ng-controller="jobsController">
        <table class="table table-striped table-hover table-condensed">
            <thead>
                <tr>
                    <th data-sortable="true">Name</th>
                    <th>Executor</th>
                    <th data-sortable="true">Next Run Time</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="job in jobs | orderBy: 'next_run_time'">
                    <td>{{job.name}}</td>
                    <td>{{job.executor}}</td>
                    <td>{{job.next_run_time.toString()}}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn" ng-click="modify(job.index,'edit')">
                                <span class="glyphicon glyphicon-pencil"></span>
                            </button>
                            <button class="btn" ng-show="job.running"
                                                ng-click="modify(job.index,'pause')">
                                <span class="glyphicon glyphicon-pause"></span>
                            </button>
                            <button class="btn" ng-show="!job.running"
                                                ng-click="modify(job.index,'resume')">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
                            <button class="btn" ng-click="modify(job.index,'remove')">
                                <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <div>
            <button class="btn" ng-click="new()">
                <span class="glyphicon glyphicon-plus"></span>
            </button>
            <button class="btn" ng-click="refresh()">
                <span class="glyphicon glyphicon-refresh"></span>
            </button>
        </div>

        <div id="job_edit" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title">Edit Job Parameters</h4>
                    </div>
                    <div class="modal-body">
                        <form novalidate class="form-horizontal" role="form">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">Module</label>
                                <div class="col-sm-8">
                                    <input type="text" ng-model="current.name" class="form-control input-sm"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">Executor</label>
                                <div class="col-sm-8">
                                    <input type="text" ng-model="current.executor" class="form-control input-sm"/>
                                </div>
                            </div>
                            <div ng-repeat="(key,value) in current.trigger">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">{{key}}</label>
                                    <div class="col-sm-8">
                                        <input type="text" ng-model="current.trigger[key]" class="form-control input-sm"/>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-defaultt btn-sm" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primaryt btn-sm" ng-click="upload()">Upload changes</button>
                    </div>
                </div>
            </div>
        </div><!-- job_edit -->

    </div><!-- /.ng-app -->

    <script>

        var my_app = angular.module("jobs_scheduler", []);

        function jobsController($scope,$http) {
            $scope.refresh = function(){
                $http.get("http://localhost:9100/jobs")
                    .success(function(response){
                        var idx = 0;
                        response.forEach(function(row){
                            row.index = idx;
                            if (row.next_run_time == "paused"){
                                row.running = false;
                            } else {
                                row.next_run_time = new Date(row.next_run_time);
                                row.running = true;
                            };
                            idx += 1;
                        });
                        $scope.jobs = response;
                    })
                    .error(function(data, status, headers, config){
                        alert(data);
                    });
            };
            $scope.modify = function(idx,action){
                switch (action){
                    case "edit":
                        $scope.newjob = false;
                        $scope.current = angular.copy($scope.jobs[idx]);
                        $("#job_edit").modal("show");
                        break;
                    case "remove":
                        alert("deleting " + $scope.jobs[idx]["id"]);
                        $scope.delete($scope.jobs[idx]["id"]);
                        break;
                    case "pause":
                        alert("pausing " + $scope.jobs[idx]["id"]);
                        $scope.pause($scope.jobs[idx]["id"]);
                        break;
                    case "resume":
                        alert("restarting " + $scope.jobs[idx]["id"]);
                        $scope.resume($scope.jobs[idx]["id"]);
                        break;
                };
            };
            $scope.new = function(){
                $scope.newjob = true;
                $scope.current = {
                    id: null,
                    name: "",
                    executor: "default",
                    trigger: {
                        year: "*",
                        month: "*",
                        week: "*",
                        day: "*",
                        hour: "*",
                        minute: "*",
                        second: "0",
                        day_of_week: "*",
                    },
                };
                $("#job_edit").modal("show");
            };
            $scope.upload = function(){
                if ($scope.newjob){
                    $http.post("http://localhost:9100/jobs",
                               $scope.current,
                               {headers: {"Content-Type":
                                          "application/x-www-form-urlencoded"}})
                        .success(function(response){
                            $scope.refresh();
                        })
                        .error(function(data, status, headers, config){
                            alert(data);
                        });
                } else {
                    job_id = $scope.current["id"];
                    changes = {
                        "executor": $scope.current["executor"],
                        "trigger": $scope.current["trigger"],
                    };
                    $http.put("http://localhost:9100/jobs/" + job_id,
                              changes,
                              {headers: {"Content-Type":
                                         "application/x-www-form-urlencoded"}})
                        .success(function(response){
                            $scope.refresh();
                        })
                        .error(function(data, status, headers, config){
                            alert(data);
                        });
                };
                $("#job_edit").modal("hide");
            };
            $scope.delete = function(job_id){
                $http.delete("http://localhost:9100/jobs/" + job_id)
                    .success(function(response){
                        $scope.refresh();
                    })
                    .error(function(data, status, headers, config){
                        alert(data);
                    });
            };
            $scope.pause = function(job_id){
                changes = {"next_run_time": "pause"};
                $http.put("http://localhost:9100/jobs/" + job_id,
                          changes,
                          {headers: {"Content-Type":
                                     "application/x-www-form-urlencoded"}})
                    .success(function(response){
                        $scope.refresh();
                    })
                    .error(function(data, status, headers, config){
                        alert(data);
                    });
            };
            $scope.resume = function(job_id){
                changes = {"next_run_time": "resume"};
                $http.put("http://localhost:9100/jobs/" + job_id,
                          changes,
                          {headers: {"Content-Type":
                                     "application/x-www-form-urlencoded"}})
                    .success(function(response){
                        $scope.refresh();
                    })
                    .error(function(data, status, headers, config){
                        alert(data);
                    });
            };
            // load jobs
            $scope.refresh();
        };
    </script>
</body>
</html>