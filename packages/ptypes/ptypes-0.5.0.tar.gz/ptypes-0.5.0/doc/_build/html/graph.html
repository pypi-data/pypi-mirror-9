<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Property Graphs &mdash; ptypes 0.4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ptypes 0.4 documentation" href="index.html" />
    <link rel="up" title="Ptypes through examples" href="examples.html" />
    <link rel="next" title="Persistent Buffers" href="buffer.html" />
    <link rel="prev" title="Persistent Collections" href="pcollections.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="buffer.html" title="Persistent Buffers"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pcollections.html" title="Persistent Collections"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">ptypes 0.4 documentation</a> &raquo;</li>
          <li><a href="examples.html" accesskey="U">Ptypes through examples</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="property-graphs">
<h1>Property Graphs<a class="headerlink" href="#property-graphs" title="Permalink to this headline">Â¶</a></h1>
<p>The <a class="reference internal" href="reference.html#module-ptypes.graph" title="ptypes.graph"><tt class="xref py py-mod docutils literal"><span class="pre">graph</span></tt></a> module provides extension classes for manipulating and
persistently storing property graphs.</p>
<p>We will play with a file called <tt class="file docutils literal"><span class="pre">testfile.mmap</span></tt>.
First we make sure there is no such file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mmapFileName</span> <span class="o">=</span> <span class="s">&#39;/tmp/testfile.mmap&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
<span class="gp">... </span><span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</pre></div>
</div>
<p>Now we can start the actual work and create a new storage for a simple graph.
First we import the necessary classes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.storage</span> <span class="kn">import</span> <span class="n">Storage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.graph</span> <span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Edge</span>
</pre></div>
</div>
<p><tt class="xref py py-class docutils literal"><span class="pre">Node</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">Edge</span></tt> are <em>type
descriptor classes</em>: in order to be able to associate data to the nodes and
edges of a graph, they can be parametrized with other persistent types.
<tt class="xref py py-class docutils literal"><span class="pre">Node</span></tt> accepts a single type parameter and the defined
type will be able to store an instance of the specified type (or a reference to
such an instance, depending on wether that type is stored by value or
reference).</p>
<p><tt class="xref py py-class docutils literal"><span class="pre">Edge</span></tt> represents directed edges in the graph.
It expects three type parameters:</p>
<ul class="simple">
<li>the type of the source (<em>from</em>) node</li>
<li>the type of the target (<em>to</em>)node</li>
<li>the type of the data associated with the edge itself</li>
</ul>
<p>In the below snippet we create a persistent type called <tt class="docutils literal"><span class="pre">NodeOfString</span></tt> and
based on <tt class="xref py py-class docutils literal"><span class="pre">Node</span></tt> and one called <tt class="docutils literal"><span class="pre">EdgeOfString</span></tt> based on
<tt class="xref py py-class docutils literal"><span class="pre">Edge</span></tt>.
Instances of both can refer to an arbitrary <tt class="docutils literal"><span class="pre">String</span></tt>.
Furthermore <tt class="docutils literal"><span class="pre">EdgeOfString</span></tt> can connect <tt class="docutils literal"><span class="pre">NodeOfString</span></tt> instances:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">NodeOfString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">Node</span><span class="p">(</span><span class="s">&#39;NodeOfString&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">Edge</span><span class="p">(</span><span class="s">&#39;EdgeOfString&#39;</span><span class="p">)[</span><span class="n">NodeOfString</span><span class="p">,</span> <span class="n">NodeOfString</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="p">]</span> <span class="p">)</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">node1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NodeOfString</span>
<span class="gp">... </span>            <span class="n">node2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NodeOfString</span>
<span class="gp">... </span>            <span class="n">node3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NodeOfString</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">Root</span></tt> object has three attributes capable of storing references to <tt class="docutils literal"><span class="pre">NodeOfString</span></tt>
instances. Let&#8217;s initialize them and connect them with edges like this:</p>
<div class="highlight-python"><div class="highlight"><pre>(node1) --&gt; (node2) --&gt; (node3)

&gt;&gt;&gt; p.root.node1 = p.schema.NodeOfString()
&gt;&gt;&gt; p.root.node2 = p.schema.NodeOfString()
&gt;&gt;&gt; p.root.node3 = p.schema.NodeOfString()
&gt;&gt;&gt; p.schema.EdgeOfString(p.root.node1, p.root.node2)          #doctest: +ELLIPSIS
&lt;persistent graph edge &#39;EdgeOfString&#39; @offset 0x...L referring to None &gt;
&gt;&gt;&gt; p.schema.EdgeOfString(p.root.node2, p.root.node3)            #doctest: +ELLIPSIS
&lt;persistent graph edge &#39;EdgeOfString&#39; @offset 0x...L referring to None &gt;
</pre></div>
</div>
<p>Tricky here: <tt class="docutils literal"><span class="pre">_</span></tt> refers to the result of the last statement, which prevents
closing the storage:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">_</span>                                        
<span class="go">&lt;persistent graph edge &#39;EdgeOfString&#39; @offset 0x...L referring to None &gt;</span>
</pre></div>
</div>
<p>Unfortunately <tt class="docutils literal"><span class="pre">del</span> <span class="pre">_</span></tt> does not work:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">_</span>                                          
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">NameError</span>: <span class="n">name &#39;_&#39; is not defined</span>
</pre></div>
</div>
<p>We need to type an expression that evaluates to other than <tt class="docutils literal"><span class="pre">None</span></tt>,
so that it is assigned to <tt class="docutils literal"><span class="pre">_</span></tt> and we can close the storage:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="s">&quot;replace the edge in _&quot;</span>
<span class="go">&#39;replace the edge in _&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>Let&#8217;s create a bit more elaborate graph from the example available at
<a class="reference external" href="https://github.com/tinkerpop/gremlin/blob/master/data/graph-example-1.json">https://github.com/tinkerpop/gremlin/blob/master/data/graph-example-1.json</a>
The graph will have two types of nodes:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">NDeveloper</span></tt> (associated with <tt class="docutils literal"><span class="pre">Developer</span></tt> instances, having <tt class="docutils literal"><span class="pre">id</span></tt>, <tt class="docutils literal"><span class="pre">name</span></tt> and <tt class="docutils literal"><span class="pre">age</span></tt> attributes)</li>
<li><tt class="docutils literal"><span class="pre">NSoftware</span></tt> (associated with <tt class="docutils literal"><span class="pre">Software</span></tt> instances, having <tt class="docutils literal"><span class="pre">id</span></tt>, <tt class="docutils literal"><span class="pre">name</span></tt> and <tt class="docutils literal"><span class="pre">lang</span></tt> attributes)</li>
</ul>
</div></blockquote>
<p>The edges of the graph are going to be of the below types:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">created</span></tt>: points from <tt class="docutils literal"><span class="pre">NDeveloper</span></tt> to <tt class="docutils literal"><span class="pre">NSoftware</span></tt></li>
<li><tt class="docutils literal"><span class="pre">knows</span></tt>: points from <tt class="docutils literal"><span class="pre">NDeveloper</span></tt> to <tt class="docutils literal"><span class="pre">NDeveloper</span></tt></li>
</ul>
</div></blockquote>
<p>Both types of edges will be able to refer to a structure called <tt class="docutils literal"><span class="pre">WeightedRelation</span></tt>,
which can express the extent to which a developer contributed to a software or
how well developers know each other.</p>
<p>To complicate things, we want to have an index of developers and pieces of
software sorted by name. We will use skip lists to implement these:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.storage</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.pcollections</span> <span class="kn">import</span> <span class="n">SkipList</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">sortOrder</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">from operator import attrgetter</span>
<span class="gp">... </span><span class="s">getKeyFromValue=attrgetter(&#39;contents.name&#39;)&quot;&quot;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Developer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="nb">id</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span>
<span class="gp">... </span>            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span>
<span class="gp">... </span>            <span class="n">age</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Software</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="nb">id</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span>
<span class="gp">... </span>            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span>
<span class="gp">... </span>            <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="n">NDeveloper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">Node</span><span class="p">(</span><span class="s">&#39;NDeveloper&#39;</span><span class="p">)[</span><span class="n">Developer</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">... </span>        <span class="n">NSoftware</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">Node</span><span class="p">(</span><span class="s">&#39;NSoftware&#39;</span><span class="p">)[</span><span class="n">Software</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">Dict</span><span class="p">(</span><span class="s">&#39;NDevelopersByName&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NDeveloper</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">SkipList</span><span class="p">(</span><span class="s">&#39;Developers&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NDeveloper</span><span class="p">,</span> <span class="n">sortOrder</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">SkipList</span><span class="p">(</span><span class="s">&#39;Programs&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NSoftware</span><span class="p">,</span> <span class="n">sortOrder</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">WeightedRelation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="nb">id</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span>
<span class="gp">... </span>            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Float</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">Edge</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">)[</span><span class="n">NDeveloper</span><span class="p">,</span> <span class="n">NSoftware</span> <span class="p">,</span> <span class="n">WeightedRelation</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="n">Edge</span><span class="p">(</span><span class="s">&#39;knows&#39;</span>  <span class="p">)[</span><span class="n">NDeveloper</span><span class="p">,</span> <span class="n">NDeveloper</span><span class="p">,</span> <span class="n">WeightedRelation</span><span class="p">]</span> <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">devByName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NDevelopersByName</span>
<span class="gp">... </span>            <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Developers</span>
<span class="gp">... </span>            <span class="n">sw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Programs</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">16000</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<p>We can populate this data structure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">loads</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">graphson</span> <span class="o">=</span> <span class="n">loads</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">{</span>
<span class="gp">... </span><span class="s">  &quot;vertices&quot;:[</span>
<span class="gp">... </span><span class="s">    {&quot;name&quot;:&quot;marko&quot;,&quot;age&quot;:29,&quot;id&quot;:1},</span>
<span class="gp">... </span><span class="s">    {&quot;name&quot;:&quot;vadas&quot;,&quot;age&quot;:27,&quot;id&quot;:2},</span>
<span class="gp">... </span><span class="s">    {&quot;name&quot;:&quot;lop&quot;,&quot;lang&quot;:&quot;java&quot;,&quot;id&quot;:3},</span>
<span class="gp">... </span><span class="s">    {&quot;name&quot;:&quot;josh&quot;,&quot;age&quot;:32,&quot;id&quot;:4},</span>
<span class="gp">... </span><span class="s">    {&quot;name&quot;:&quot;ripple&quot;,&quot;lang&quot;:&quot;java&quot;,&quot;id&quot;:5},</span>
<span class="gp">... </span><span class="s">    {&quot;name&quot;:&quot;peter&quot;,&quot;age&quot;:35,&quot;id&quot;:6}</span>
<span class="gp">... </span><span class="s">  ],</span>
<span class="gp">... </span><span class="s">  &quot;edges&quot;:[</span>
<span class="gp">... </span><span class="s">    {&quot;weight&quot;:0.5,&quot;id&quot;:7,&quot;_outV&quot;:1,&quot;_inV&quot;:2,&quot;_label&quot;:&quot;knows&quot;},</span>
<span class="gp">... </span><span class="s">    {&quot;weight&quot;:1.0,&quot;id&quot;:8,&quot;_outV&quot;:1,&quot;_inV&quot;:4,&quot;_label&quot;:&quot;knows&quot;},</span>
<span class="gp">... </span><span class="s">    {&quot;weight&quot;:0.4,&quot;id&quot;:9,&quot;_outV&quot;:1,&quot;_inV&quot;:3,&quot;_label&quot;:&quot;created&quot;},</span>
<span class="gp">... </span><span class="s">    {&quot;weight&quot;:1.0,&quot;id&quot;:10,&quot;_outV&quot;:4,&quot;_inV&quot;:5,&quot;_label&quot;:&quot;created&quot;},</span>
<span class="gp">... </span><span class="s">    {&quot;weight&quot;:0.4,&quot;id&quot;:11,&quot;_outV&quot;:4,&quot;_inV&quot;:3,&quot;_label&quot;:&quot;created&quot;},</span>
<span class="gp">... </span><span class="s">    {&quot;weight&quot;:0.2,&quot;id&quot;:12,&quot;_outV&quot;:6,&quot;_inV&quot;:3,&quot;_label&quot;:&quot;created&quot;}</span>
<span class="gp">... </span><span class="s">  ]</span>
<span class="gp">... </span><span class="s">}&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Developers</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">sw</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Programs</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">devByName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NDevelopersByName</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">allNodes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">properties</span> <span class="ow">in</span> <span class="n">graphson</span><span class="p">[</span><span class="s">&quot;vertices&quot;</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="n">nodes</span><span class="p">,</span> <span class="n">NClass</span><span class="p">,</span> <span class="n">Class</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">sw</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NSoftware</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Software</span><span class="p">)</span> <span class="k">if</span> <span class="s">&quot;lang&quot;</span> <span class="ow">in</span> <span class="n">properties</span> <span class="k">else</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">NDeveloper</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Developer</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">node</span> <span class="o">=</span> <span class="n">allNodes</span><span class="p">[</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">NClass</span><span class="p">(</span><span class="n">Class</span><span class="p">(</span><span class="o">**</span><span class="n">properties</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">nodes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="s">&quot;lang&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">devByName</span><span class="p">[</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()]</span> <span class="o">=</span> <span class="n">node</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">properties</span> <span class="ow">in</span> <span class="n">graphson</span><span class="p">[</span><span class="s">&quot;edges&quot;</span><span class="p">]:</span>                              
<span class="gp">... </span>    <span class="n">EdgeClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">properties</span><span class="p">[</span><span class="s">&quot;_label&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">e</span> <span class="o">=</span> <span class="n">EdgeClass</span><span class="p">(</span><span class="n">allNodes</span><span class="p">[</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;_outV&quot;</span><span class="p">]],</span> <span class="n">allNodes</span><span class="p">[</span><span class="n">properties</span><span class="p">[</span><span class="s">&quot;_inV&quot;</span><span class="p">]],</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">WeightedRelation</span><span class="p">(</span><span class="o">**</span><span class="n">properties</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>... and run a simple query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">ndeveloper</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">devByName</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">developer</span> <span class="o">=</span> <span class="n">ndeveloper</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">name</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">_edge</span> <span class="ow">in</span> <span class="n">ndeveloper</span><span class="o">.</span><span class="n">outEdges</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">created</span><span class="p">):</span>
<span class="gp">... </span>         <span class="n">developersProgram</span> <span class="o">=</span> <span class="n">_edge</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">name</span>
<span class="gp">... </span>         <span class="k">print</span> <span class="s">&#39;developer = {}, developersProgram = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">developer</span><span class="p">,</span> <span class="n">developersProgram</span><span class="p">)</span>
<span class="gp">...</span>
<span class="go">developer = peter, developersProgram = lop</span>
<span class="go">developer = marko, developersProgram = lop</span>
<span class="go">developer = josh, developersProgram = lop</span>
<span class="go">developer = josh, developersProgram = ripple</span>
</pre></div>
</div>
<div class="section" id="declarative-queries">
<span id="id1"></span><h2>Declarative Queries<a class="headerlink" href="#declarative-queries" title="Permalink to this headline">Â¶</a></h2>
<dl class="docutils">
<dt>In general, a query has a two-fold functionality:</dt>
<dd><ul class="first last simple">
<li>select certain combinations of the objects in the storage</li>
<li>do something useful with the selected combinations</li>
</ul>
</dd>
</dl>
<p>Note that in the above example the only &#8220;useful&#8221; part is the print statement.
The rest is a set of for cycles and object navigation code, which is slow and
looks a bit boilerplate. The developer writing this code is forced to focus on <em>how</em>
(by what procedure) to enumerate the tuples of interest instead of concentrating
on <em>what</em> needs to be enumerated.</p>
<p>So here is a more efficient (no Python loops) and declarative way of achieving
the same goal:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.query</span> <span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Each</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.graph</span> <span class="kn">import</span> <span class="n">FindEdge</span><span class="p">,</span> <span class="n">NodeAttribute</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyQuery</span><span class="p">(</span><span class="n">Query</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">_ndeveloper</span> <span class="o">=</span> <span class="n">Each</span><span class="p">(</span><span class="s">&#39;devByName&#39;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">developer</span> <span class="o">=</span> <span class="n">NodeAttribute</span><span class="p">(</span><span class="n">_ndeveloper</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">developersProgram</span> <span class="o">=</span> <span class="n">FindEdge</span><span class="p">(</span><span class="s">&#39;created&#39;</span>  <span class="p">,</span> <span class="n">fromNode</span><span class="o">=</span><span class="n">_ndeveloper</span><span class="p">)</span><span class="o">.</span><span class="n">toNode</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">MyQuery</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="p">()</span>
<span class="go">==== Results ====</span>
<span class="go">developer = peter, developersProgram = lop</span>
<span class="go">developer = marko, developersProgram = lop</span>
<span class="go">developer = josh, developersProgram = lop</span>
<span class="go">developer = josh, developersProgram = ripple</span>
<span class="go">---- End of results ----</span>
</pre></div>
</div>
<p>As you see, here the query is represented by a subclass of
<a class="reference internal" href="reference.html#ptypes.query.Query" title="ptypes.query.Query"><tt class="xref py py-class docutils literal"><span class="pre">Query</span></tt></a> (called <tt class="docutils literal"><span class="pre">MyQuery</span></tt>).
In the body of the subclass the query is defined by a set of <em>binding rules</em>. These rules
select the combinations of the persistent objects have to be processed by the query.
The actual processing of the combinations happens in the
<a class="reference internal" href="reference.html#ptypes.query.Query.processOne" title="ptypes.query.Query.processOne"><tt class="xref py py-meth docutils literal"><span class="pre">processOne()</span></tt></a> generator method of the
<a class="reference internal" href="reference.html#ptypes.query.Query" title="ptypes.query.Query"><tt class="xref py py-class docutils literal"><span class="pre">Query</span></tt></a> class, which is invoked for each of the selected
combinations.
The default implementation of <a class="reference internal" href="reference.html#ptypes.query.Query.processOne" title="ptypes.query.Query.processOne"><tt class="xref py py-meth docutils literal"><span class="pre">processOne()</span></tt></a> prints
the header seen in the example, prints every tuple sent into it and finally
prints the footer.
The method can be overriden in subclasses, but has to remain a generator.</p>
<p>Let&#8217;s have a closer look at the process of selecting the combinations. The first thing to
note is that some rules refer to other rules. For example, the <tt class="docutils literal"><span class="pre">developer</span></tt> rule and the
one created by the <tt class="xref py py-class docutils literal"><span class="pre">FindEdge</span></tt> incovation refer to the
<tt class="docutils literal"><span class="pre">ndeveloper</span></tt> rule.
The <tt class="xref py py-attr docutils literal"><span class="pre">toNode</span></tt> attribute of the rule created by
<tt class="xref py py-class docutils literal"><span class="pre">FindEdge(...)</span></tt> is a rule referring to the rule
created by <tt class="xref py py-class docutils literal"><span class="pre">FindEdge(...)</span></tt>, etc.
The bottom line is that these references represent depenency relationships
among the rules and thus determine a partial ordering that has to be respected
at the time the rules are evaluated. It is an error if such an order does not
exist because of reference cycles.</p>
<p>When the query is executed, a <tt class="xref py py-class docutils literal"><span class="pre">QueryContext</span></tt> is created.
Each binding rule can select multiple values to be bound to a name in the query
context.
The evaluation of the query starts by requesting a value from the first rule
according to the order and binding it to the name of the rule. Then a value
from the next rule is acquired and bound to its name, then the third, etc.
Each rule may rely on the values in the context bound by previous rules to
compute the values it supplies.
If there are no more rules, then the context is &#8220;complete&#8221;, so it is passed to
the callback method (by default <a class="reference internal" href="reference.html#ptypes.query.Query.processOne" title="ptypes.query.Query.processOne"><tt class="xref py py-meth docutils literal"><span class="pre">processOne()</span></tt></a>).
After the callback returns or when a rule cannot provide a value, we
&#8220;backtrack&#8221;, i.e. bind a new value from the previous rule to the name of that
rule and try again.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Property Graphs</a><ul>
<li><a class="reference internal" href="#declarative-queries">Declarative Queries</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="pcollections.html"
                        title="previous chapter">Persistent Collections</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="buffer.html"
                        title="next chapter">Persistent Buffers</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/graph.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="buffer.html" title="Persistent Buffers"
             >next</a> |</li>
        <li class="right" >
          <a href="pcollections.html" title="Persistent Collections"
             >previous</a> |</li>
        <li><a href="index.html">ptypes 0.4 documentation</a> &raquo;</li>
          <li><a href="examples.html" >Ptypes through examples</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Amadeus IT Group.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>