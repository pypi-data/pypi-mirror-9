<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting Started with ptypes &mdash; ptypes 0.4 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="ptypes 0.4 documentation" href="index.html" />
    <link rel="up" title="Ptypes through examples" href="examples.html" />
    <link rel="next" title="Persistent Collections" href="pcollections.html" />
    <link rel="prev" title="Ptypes through examples" href="examples.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pcollections.html" title="Persistent Collections"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Ptypes through examples"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">ptypes 0.4 documentation</a> &raquo;</li>
          <li><a href="examples.html" accesskey="U">Ptypes through examples</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="getting-started-with-ptypes">
<h1>Getting Started with <tt class="docutils literal"><span class="pre">ptypes</span></tt><a class="headerlink" href="#getting-started-with-ptypes" title="Permalink to this headline">Â¶</a></h1>
<p>This page will introduce the usage of the <tt class="xref py py-mod docutils literal"><span class="pre">ptypes</span></tt> module through a few basic examples.
We will play with a file called <tt class="file docutils literal"><span class="pre">testfile.mmap</span></tt>.
First we make sure there is no such file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mmapFileName</span> <span class="o">=</span> <span class="s">&#39;/tmp/testfile.mmap&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
<span class="gp">... </span><span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</pre></div>
</div>
<p>Now we can start the actual work and create a new storage with a very simple structure.
First we import the necessary classes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.storage</span> <span class="kn">import</span> <span class="n">Storage</span>
</pre></div>
</div>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">Storage</span></tt> class represents a persistent data store.
To make it actually usable, we have to subclass it and override its
<tt class="xref py py-meth docutils literal"><span class="pre">populateSchema()</span></tt> callback method with code
defining the structure of our persistent store.</p>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
The structure is defined in the
<tt class="xref py py-meth docutils literal"><span class="pre">populateSchema()</span></tt> method by creating a class</p>
<blockquote>
<div><ul class="simple">
<li>called <tt class="docutils literal"><span class="pre">Root</span></tt></li>
<li>subclassed from <tt class="docutils literal"><span class="pre">self.schema.Structure</span></tt> (where <tt class="docutils literal"><span class="pre">self</span></tt> is the sole</li>
</ul>
</div></blockquote>
<p>parameter of <tt class="xref py py-meth docutils literal"><span class="pre">populateSchema()</span></tt>)</p>
<p><tt class="docutils literal"><span class="pre">self.schema.Structure</span></tt> comes with a metaclass (<tt class="xref py py-class docutils literal"><span class="pre">StructureMeta</span></tt>),
which takes care of binding the persistent class to the
<tt class="xref py py-class docutils literal"><span class="pre">Storage`</span></tt> instance.
This way there is no need to pass the <tt class="xref py py-class docutils literal"><span class="pre">Storage</span></tt> instance
to the constructor when creating persistent instances:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">pass</span>
</pre></div>
</div>
<p>Now we are ready to create our first persistent storage object.
The <tt class="xref py py-meth docutils literal"><span class="pre">populateSchema()</span></tt> callback will be invoked
automatically if and when the schema of a new storage object needs to be
created. The reason for having to define the structure of the storage inside a
callback is that the persistent types describing the structure are bound to the
storage instance.
This way we avoid having to refer explicitely to the storage instance through
the code that manipulates persistent objects inside the storage:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<p>There we go! We created our first persistent storage. The <tt class="docutils literal"><span class="pre">fileSize</span></tt> keyword
argument specifies the size of the files in bytes and it is rounded up to the
nearest multiple of the page size.
The <tt class="docutils literal"><span class="pre">stringRegistrySize</span></tt> parameter is the number of interned strings the
storage can hold.  Upon the first access to the <tt class="docutils literal"><span class="pre">root</span></tt> attribute of the
storage an instance of the <tt class="docutils literal"><span class="pre">Root</span></tt> class is created and returned:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span>                                             
<span class="go">&lt;persistent Root object @offset 0x...L&gt;</span>
</pre></div>
</div>
<p>So far so good, but our storage is not very useful as it cannot hold any data:
the root object has no attributes.
Let&#8217;s add some fields to our <tt class="docutils literal"><span class="pre">Root</span></tt> class.
To do so, we need to specify a persistent type for each field.  The available
persistent types are accessible as attributes on the module object representing
the <em>schema</em> of the storage:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">schema</span>
<span class="go">&lt;module &#39;schema&#39; (built-in)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="p">))</span>
<span class="go">[&#39;Float&#39;, &#39;Int&#39;, &#39;Root&#39;, &#39;String&#39;, &#39;Structure&#39;, &#39;__doc__&#39;, &#39;__name__&#39;]</span>
</pre></div>
</div>
<p>It is essential that before we lose the reference to a storage object we
<tt class="xref py py-meth docutils literal"><span class="pre">close()</span></tt> it, otherwise the underlying file
remains open (occupying disk space even if deleted) and mapped into memory
(wasting the address space):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Now here is an improved version of our storage, this time with the structure
having some useful fields:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">print</span> <span class="s">&#39;Creating an improved schema...&#39;</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span>
<span class="gp">... </span>            <span class="n">age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span>
<span class="gp">... </span>            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Float</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<p>Oops, we expected a message <tt class="docutils literal"><span class="pre">Creating</span> <span class="pre">an</span> <span class="pre">improved</span> <span class="pre">schema...</span></tt>, why didn&#8217;t we get it?
Because the file under the storage has already been created and properly
initialized (with the useless version of <tt class="docutils literal"><span class="pre">Root</span></tt>.)
The <tt class="xref py py-meth docutils literal"><span class="pre">populateSchema()</span></tt> method is only called once
on a file.
On subsequent attachment attempts the schema is read back from the storage.</p>
<p>So let&#8217;s get rid of the old storage and create a new one:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">p</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="go">Creating an improved schema...</span>
</pre></div>
</div>
<p>Now we have our improved storage, with an instance of <tt class="docutils literal"><span class="pre">Root</span></tt> created but
still un-initialized:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">age</span>                                                 
<span class="go">&lt;persistent Int object &#39;0&#39; @offset 0x...&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">weight</span>                                               
<span class="go">&lt;persistent Float object &#39;0.0&#39; @offset 0x...&gt;</span>
</pre></div>
</div>
<p>Let&#8217;s try to initialize it!:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">27</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">73.1415926</span>
</pre></div>
</div>
<p>The Python integer and float assigned are stored by value. When accessing them, we get
proxy objects back, allowing for various operations on them.
To get the original Python integer back, you have to access the
<tt class="xref py py-attr docutils literal"><span class="pre">contents`</span></tt> attribute of the proxy:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">contents</span>                             
<span class="go">(&lt;persistent Int object &#39;27&#39; @offset 0x...&gt;, 27)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">contents</span>                       
<span class="go">(&lt;persistent Float object &#39;73.1415926&#39; @offset 0x...&gt;, 73.1415926)</span>
</pre></div>
</div>
<p><em>... and a year later James put on some weight ;-)</em></p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">31.45</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">contents</span>
<span class="go">(28, 104.5915926)</span>
</pre></div>
</div>
<p>The <tt class="xref py py-class docutils literal"><span class="pre">Int</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">Float</span></tt> persistent
types are assigned by value because it takes less memory to store them directly
than to create <tt class="xref py py-class docutils literal"><span class="pre">Int</span></tt> or <tt class="xref py py-class docutils literal"><span class="pre">Float</span></tt>
objects and store offsets to those.
The downside of this decision is that one cannot instanciate these objects
directly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>                                      
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">&lt;persistent class &#39;Int&#39;&gt; exhibits store-by-value semantics and therefore can only be instantiated inside a container (e.g. in Structure)</span>
</pre></div>
</div>
<p>Types assigned by value can only be created as part of an other object containing them.
When the container is created, the space allocated for it includes the space for the
assigned-by-value types. The proxy objects or their
<tt class="xref py py-attr docutils literal"><span class="pre">`contents</span></tt> descriptor can be used to read or
write their contents, but there is neither a need nor a way to create
assigned-by-value instances in a stand-alone fashion.</p>
<p>In contrast to <tt class="xref py py-class docutils literal"><span class="pre">Int</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">Float</span></tt>,
persistent strings are assigned by reference.
The assignment to a field will convert a Python string implicitly to a persistent string:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;James Bond&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span>                                                 
<span class="go">&lt;persistent String object &#39;James Bond&#39; @offset 0x...&gt;</span>
</pre></div>
</div>
<p>We got back the persistent string; if we want it as a Python string object, we
access its <tt class="xref py py-attr docutils literal"><span class="pre">`contents</span></tt> attribute:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contents</span>
<span class="go">&#39;James Bond&#39;</span>
</pre></div>
</div>
<p>Or alternatively:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="go">&#39;James Bond&#39;</span>
</pre></div>
</div>
<p>The assignment of the Python string  works because the constructor of
<tt class="docutils literal"><span class="pre">p.schema.String</span></tt> accepts a Python string as its single argument.
Note however, that this solution leaks persistent storage space, as each time
the Python string <tt class="docutils literal"><span class="pre">'James</span> <span class="pre">Bond'</span></tt> is  assigned,
a new persistent string is allocated, storing the same sequence of characters:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">isSameAs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">&#39;James Bond&#39;</span><span class="p">))</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">&#39;James Bond&#39;</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>To remedy this, the recommended way of interning strings is via the <em>string
registry</em> of the storage:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stringRegistry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;James Bond&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This always returns proxy objects to the same persistent string:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">stringRegistry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;James Bond&#39;</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Although the proxy objects are not the same:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="n">p</span><span class="o">.</span><span class="n">stringRegistry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;James Bond&#39;</span><span class="p">)</span>
<span class="go">False</span>
</pre></div>
</div>
<p>This is just like with the Python strings:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contents</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">&#39;James Bond&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">contents</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contents</span> <span class="ow">is</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">&#39;James Bond&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">contents</span>
<span class="go">False</span>
</pre></div>
</div>
<p>From an already existing file a storage can be created without specifying the
size parameters or a schema. Its contents is preserved:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span> 
<span class="go">&lt;persistent Root object @offset 0x...L&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contents</span>
<span class="go">&#39;James Bond&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>Our improved storage structure is still not very usefull as we can only define a single
secret agent in it. What if we have more?</p>
<p>When defining the structure, we can rely on the <tt class="docutils literal"><span class="pre">type</span> <span class="pre">descriptor</span> <span class="pre">classes</span></tt>. With the help of
these one can define persistent types parametrized with already existing persistent types.
The most notable type descriptors are Dict and List.
To define a parametrized persistent type, one instantiates a type descriptor supplying the
desired name of the new persistent type. The parameters of the type have to be specified
using the item access operator, which records the parameters and returns the type descriptor
instance. The instance is then passed in to the
<tt class="xref py py-meth docutils literal"><span class="pre">define()</span></tt> method of the <tt class="xref py py-class docutils literal"><span class="pre">Storage</span></tt>,
which will actually create the new persistent type. Let&#8217;s see this through an example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.storage</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Agent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span>
<span class="gp">... </span>            <span class="n">age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span>
<span class="gp">... </span>            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Float</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="s">&#39;ListOfAgents&#39;</span><span class="p">)[</span><span class="n">Agent</span><span class="p">])</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">Dict</span><span class="p">(</span><span class="s">&#39;AgentsByName&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">Agent</span><span class="p">])</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ListOfAgents</span>
<span class="gp">... </span>            <span class="n">agentsByName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">AgentsByName</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<p>Before we access the persistent list or dict, we need to create them:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ListOfAgents</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agentsByName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">AgentsByName</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can store at least 13 agents by their names and ages (the actual limits
may be higher).
Note that while the root object was created automatically on the first access to <tt class="docutils literal"><span class="pre">p.root</span></tt>,
all other <tt class="xref py py-class docutils literal"><span class="pre">Structure</span></tt> instances have to be created
explicitly. Specifying keyword arguments as constructor parameters allows for
the immediate initialization of the fields of the structure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">agentName</span><span class="p">,</span> <span class="n">age</span> <span class="ow">in</span> <span class="p">((</span><span class="s">&quot;Felix Leiter&quot;</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;Miss Moneypenny&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;Bill Tanner&quot;</span><span class="p">,</span><span class="mi">57</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="n">agent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Agent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">stringRegistry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agentName</span><span class="p">),</span> <span class="n">age</span><span class="o">=</span><span class="n">age</span> <span class="p">)</span>
<span class="gp">... </span>    <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agentsByName</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">agent</span><span class="o">.</span><span class="n">name</span>
<span class="go">Felix Leiter</span>
<span class="go">Miss Moneypenny</span>
<span class="go">Bill Tanner</span>
</pre></div>
</div>
<p>Note that in the <tt class="docutils literal"><span class="pre">print</span></tt> statements above the persistent string got implicitly converted
to a Python string via <tt class="docutils literal"><span class="pre">str()</span></tt>. When the persistent string is the return value of an
expression typed in at the interpreter prompt, <tt class="docutils literal"><span class="pre">repr()</span></tt> is invoked; that is why you
got different representations of persistent strings in the previous examples.</p>
<p>The persistent Dicts support <tt class="xref py py-meth docutils literal"><span class="pre">iteritems()</span></tt>,
<tt class="xref py py-meth docutils literal"><span class="pre">iterkeys()</span></tt> and <tt class="xref py py-meth docutils literal"><span class="pre">itervalues()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agentsByName</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>                                    
<span class="go">Felix Leiter &lt;persistent Agent object @offset 0x...&gt;</span>
<span class="go">Bill Tanner &lt;persistent Agent object @offset 0x...&gt;</span>
<span class="go">Miss Moneypenny &lt;persistent Agent object @offset 0x...&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">contents</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agentsByName</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()]</span>
<span class="go">[&#39;Felix Leiter&#39;, &#39;Bill Tanner&#39;, &#39;Miss Moneypenny&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">contents</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agentsByName</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()]</span>
<span class="go">[&#39;Felix Leiter&#39;, &#39;Bill Tanner&#39;, &#39;Miss Moneypenny&#39;]</span>
</pre></div>
</div>
<p>For persistent sets only <tt class="xref py py-meth docutils literal"><span class="pre">iterkeys()</span></tt> is supported:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stringRegistry</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span> <span class="k">pass</span>                    
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Cannot iterate over the values: no value class is defined. (Is this not a Set?)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stringRegistry</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> <span class="k">pass</span>                    
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Cannot iterate over the items: no value class is defined. (Is this not a Set?)</span>
</pre></div>
</div>
<p>The dictionary accepts non-persistent keys to look up values, as long as it was
defined with a key class that accpets the non-persistent key as its sole
constructor argument:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agentsByName</span><span class="p">[</span><span class="s">&quot;Miss Moneypenny&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="mf">57.3</span>                
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">agent</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span>
<span class="go">0.0 57.3 0.0</span>
</pre></div>
</div>
<p>Now let&#8217;s finish with this storage and create a new one to demonstrate how Dict
and List work with types assigned by value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                                             
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">Cannot close &lt;MyStorage &#39;...&#39;&gt; - some proxies are still around: &lt;persistent Agent object @offset 0x...L&gt; &lt;persistent String object &#39;Miss Moneypenny&#39; @offset 0x...L&gt; &lt;persistent Agent object @offset 0x...L&gt;</span>
</pre></div>
</div>
<p>Ooops... Indeed, the <tt class="docutils literal"><span class="pre">key</span></tt>, <tt class="docutils literal"><span class="pre">value</span></tt> and <tt class="docutils literal"><span class="pre">agent</span></tt> references from the
previous examples are still around, and if we closed the storage (which unmaps
the underlying file), the pointers into the mapped memory area in these proxy
objects would become invalid. Trying to use these objects with the dangling
pointers would cause segmentation faults.
Therefore, all the references to proxy objects belonging to the storage (except
the reference of the storage object to the root, in our example <tt class="docutils literal"><span class="pre">p.root</span></tt>)
must be deleted before closing the storage:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">agent</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Accessing the root property after closing the storage or trying to close it
again will raise a ValueError exception:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span>                                               
<span class="gt">Traceback (most recent call last):</span>
 <span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">Storage ... is closed.</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                                
<span class="gt">Traceback (most recent call last):</span>
 <span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">Storage ... is closed.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we really can continue and demonstrate that the
<tt class="xref py py-class docutils literal"><span class="pre">Dict</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">List</span></tt> type
descriptors work just as well with types assigned by value:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="s">&#39;ListOfInts&#39;</span> <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span> <span class="p">])</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="s">&#39;ListOfFloats&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Float</span><span class="p">])</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">uints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ListOfInts</span>
<span class="gp">... </span>            <span class="n">floats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ListOfFloats</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>      
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">uints</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ListOfInts</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">floats</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ListOfFloats</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">seed</span><span class="p">,</span> <span class="n">random</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seed</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<span class="gp">... </span>   <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">uints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="gp">... </span>   <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">floats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">uints</span><span class="p">:</span>
<span class="gp">... </span>     <span class="k">print</span> <span class="n">i</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span>
<span class="go">0 1 2 3 4 5 6 7 8 9</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">floats</span><span class="p">:</span>
<span class="gp">... </span>     <span class="k">print</span> <span class="n">f</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span>
<span class="go">0.259008491715 0.685257992965 0.684081918016 0.84933616139 0.185724173874 0.230558608965 0.147159918168 0.225162935562 0.734023602213 0.13021302276</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">Dict</span><span class="p">(</span><span class="s">&#39;MyType&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">])</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">myType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">MyType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stringRegistrySize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>      
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>If you pass in the wrong number of type arguments to a type descriptor, you
will get a <tt class="xref py py-exc docutils literal"><span class="pre">ValueError</span></tt> exception:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">Dict</span><span class="p">(</span><span class="s">&#39;BadType&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>                                  
<span class="gt">Traceback (most recent call last):</span>
   <span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Type BadType must have at most 2 parameter(s), found (1, 2, 3)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">Dict</span><span class="p">(</span><span class="s">&#39;BadType&#39;</span><span class="p">)[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">pass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> 
<span class="gt">Traceback (most recent call last):</span>
   <span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">The type parameter specifying the type of keys cannot be None</span>
</pre></div>
</div>
<p>If you pass in <tt class="docutils literal"><span class="pre">None</span></tt> as the value class to a <tt class="xref py py-class docutils literal"><span class="pre">Dict</span></tt>,
you get set-like behaviour.
For convenience, <tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt> is defined exactly that way.
The below example also demonstrates that <tt class="xref py py-meth docutils literal"><span class="pre">define()</span></tt>
returns the defined type instance, so you can use it in subsequent type
definitions:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">ptypes.storage</span> <span class="kn">import</span> <span class="n">Set</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">stringSet1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">Dict</span><span class="p">(</span><span class="s">&#39;ThisIsInFactASet&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="bp">None</span><span class="p">])</span>
<span class="gp">... </span>        <span class="n">stringSet2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="n">Set</span><span class="p">(</span><span class="s">&#39;ThisIsAnotherSet&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">String</span><span class="p">])</span>
<span class="gp">... </span>        <span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">strings1</span> <span class="o">=</span> <span class="n">stringSet1</span>
<span class="gp">... </span>            <span class="n">strings2</span> <span class="o">=</span> <span class="n">stringSet2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">strings1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ThisIsInFactASet</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">strings1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;abc</span><span class="se">\x00</span><span class="s">def&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span>                                                        
<span class="go">&lt;persistent String object &#39;abc\x00def&#39; @offset 0x...L&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="o">.</span><span class="n">contents</span>
<span class="go">&#39;abc\x00def&#39;</span>
</pre></div>
</div>
<p>Note that type definitions are not interchangable, even if they come from the same type
descriptor with the same parameters:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">strings2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">ThisIsInFactASet</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
   <span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Expected &lt;persistent class &#39;ThisIsAnotherSet&#39;&gt;, found &lt;persistent class &#39;ThisIsInFactASet&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">s1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="xref py py-meth docutils literal"><span class="pre">define()</span></tt> method will complain if you try to
pass in some garbage:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">MyStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">populateSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">define</span><span class="p">(</span> <span class="s">&#39;foo&#39;</span> <span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">MyStorage</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> 
<span class="gt">Traceback (most recent call last):</span>
   <span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">Don&#39;t know how to define &#39;foo&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mmapFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>That&#8217;s it for getting started!</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="examples.html"
                        title="previous chapter">Ptypes through examples</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="pcollections.html"
                        title="next chapter">Persistent Collections</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/storage.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="pcollections.html" title="Persistent Collections"
             >next</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Ptypes through examples"
             >previous</a> |</li>
        <li><a href="index.html">ptypes 0.4 documentation</a> &raquo;</li>
          <li><a href="examples.html" >Ptypes through examples</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Amadeus IT Group.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>