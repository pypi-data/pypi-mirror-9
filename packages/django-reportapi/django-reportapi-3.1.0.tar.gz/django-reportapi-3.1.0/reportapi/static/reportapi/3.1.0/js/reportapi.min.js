window.TEMPLATES={};delay=(function(){var a=0;return function(c,b){clearTimeout(a);a=setTimeout(c,b)}})();function handlerHideAlert(){$(".alert").alert("close");$("#alert-place").css("z-index","-1000")}function handlerShowAlert(c,a,d,b){b=b||5000;console.log(c);if(!a){a="alert-danger"}html=TEMPLATES.alert({msg:c,type:a});$("#alert-place").css("z-index","1000").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,b)}else{delay(handlerHideAlert,b)}return false}function jsonAPI(a,f,d,b,c){if(!a){a={method:"reportapi.get_scheme"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!b,timeout:c||AJAX_TIMEOUT,url:REPORTAPI_API_URL,data:{jsonData:$.toJSON(a),language:window.LANGUAGE_CODE},dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location);console.log("1:"+i.getResponseHeader("Location"))}else{console.log("ERROR:"+i.responseText);if(i.responseText){handlerShowAlert(_(i.responseText).truncate(255),"alert-danger")}}}).done(function(h,g,j){var i,k;if(d){console.log(d)}if((h.status>=300)&&(h.status<400)&&(h.data.Location!=undefined)){k=function(){var l=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(l)};if(h.message){handlerShowAlert(h.message,"alert-danger",k)}else{k()}}else{if(h.status>=400){handlerShowAlert(h.message,"alert-danger");clearInterval(window.REPORT.process);window.REPORT.process=undefined;$(".progress .progress-bar").removeClass("progress-bar-striped active");handlerSetProgress(0)}else{if(DEBUG){i=new Object;$.extend(true,i,h.data);console.log($.toJSON(h.message))}return f(h,g,j)}}});return e}function handlerCreateReport(c){$(".action-create-report, .action-recreate-report, .action-preview, .action-download, .action-remove").attr("disabled","disabled");$("#view-document-place").hide();window.REPORT.id=null;window.REPORT.process_filters={};$.each(window.REPORT.filters,function(e,f){if(f.value!=null&&f.value!=undefined){window.REPORT.process_filters[f.name]={condition:f.condition,value:(f.server_value!=undefined)?f.server_value:f.value,}}});var b={method:"reportapi.document_create",section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,force:c},a=function(f,e,g){};var d=jsonAPI(b,a,null,false,window.REPORT.timeout);handlerStartProgress();return d}function handlerCheckProcess(){var b={method:"reportapi.document_info",id:window.REPORT.id||null,section:window.REPORT.section,name:window.REPORT.name,filters:window.REPORT.process_filters,};var a=function(g,e,i){var h=$(".progress .progress-bar"),d=Number(h.attr("aria-valuemax")),f=Number(h.attr("aria-valuenow"));window.REPORT.id=g.data.id;window.REPORT.timeout=g.data.timeout;if(g.data.end){clearInterval(window.REPORT.process);window.REPORT.process=undefined;handlerSetProgress(d);if(g.data.error){$(".action-preview").attr("onclick","handlerShowDocument('"+g.data.urls.view.auto+"', 'document-"+g.data.id+"')").prop("disabled",false).removeAttr("disabled").removeClass("btn-default btn-success").addClass("btn-warning").find(".fa").removeClass("fa-search").addClass("fa-bug")}else{if(g.data.urls.view.auto){$(".action-preview").attr("onclick","handlerShowDocument('"+g.data.urls.view.auto+"', 'document-"+g.data.id+"')").prop("disabled",false).removeAttr("disabled").removeClass("btn-warning").addClass("btn-default").find(".fa").removeClass("fa-bug").addClass("fa-search")}if(g.data.urls.download.odf||g.data.urls.download.xml){$(".action-download.type-odf").attr("download",g.data.filenames.odf||g.data.filenames.xml).attr("href",g.data.urls.download.odf||g.data.urls.download.xml).prop("disabled",false).removeAttr("disabled")}if(g.data.urls.download.pdf){$(".action-download.type-pdf").attr("download",g.data.filenames.pdf).attr("href",g.data.urls.download.pdf).prop("disabled",false).removeAttr("disabled")}}if(g.data.has_remove){$(".action-remove").attr("onclick","handlerRemoveDocument("+g.data.id+")").prop("disabled",false).removeAttr("disabled")}else{$(".action-remove").removeAttr("onclick").prop("disabled",true).attr("disabled","disabled")}h.removeClass("progress-bar-striped active");$(".action-recreate-report").prop("disabled",false).removeAttr("disabled");if(window.REPORT.create_force){$(".action-create-report:visible").hide();$(".action-recreate-report:hidden").show()}else{$(".action-create-report").prop("disabled",true).attr("disabled","disabled")}}else{if(f>=d){h.addClass("progress-bar-striped active")}else{handlerSetProgress(TIMEOUT_PROGRESS+f)}}};var c=jsonAPI(b,a);return c}function handlerStartProgress(){$(".action-create-report").prop("disabled",true);$(".progress .progress-bar").attr("aria-valuemax",window.REPORT.timeout||TIMEOUT_PROGRESS).attr("aria-valuenow",0).css("width","0%");window.REPORT.process=setInterval(function(){handlerCheckProcess()},window.TIMEOUT_PROGRESS)}function handlerRemoveDocument(d,b){if(d){var a={method:"reportapi.document_delete",id:d,},c=function(){$("#div-document-"+d).remove();$("#view-document-place").hide();if(b){window.location.reload()}else{handlerAfterChanges()}};new jsonAPI(a,c)}}function eventCreateReport(a){handlerCreateReport();a.preventDefault()}function eventRecreateReport(a){handlerCreateReport(true);a.preventDefault()}function eventRemoveDocument(a){var b=null;handlerRemoveDocument(b);a.preventDefault()}function handlerSetSelectizers(b){var c=$("#valuebox-"+b.name);if(c.size()<1){return false}$.each(c.find('select[data-type="object"]'),function(e,d){if(d.name){var f=window.REPORT.filters[d.name],g=f.unicode_key||"__unicode__";$(d).selectize({valueField:"pk",labelField:g,searchField:f.fields_search||g,create:false,options:f.options,maxItems:(f.condition=="range")?2:undefined,render:{option:function(i,h){return'<div><span class="pull-right"> #'+h(i.pk)+"</span><span>"+h(i[g])+"</span></div>"}},load:function(i,k){if(!i.length){return k()}if(f.search_on_date){if(i.length<=3){return k()}}var h={method:"reportapi.object_search",section:window.REPORT.section||null,name:window.REPORT.name,filter_name:f.name,query:i,},j=function(l){k(l.data.object_list)};new jsonAPI(h,j)},onChange:function(h){if(f.condition=="range"&&(!h||h.length!=2)){f.value=null}else{f.value=(h=="")?null:h}handlerAfterChanges()},onClear:function(){f.value=null;handlerAfterChanges()}})}});var a=c.find('select[data-type="choice"],                      select[data-type="month"],                      select[data-type="weekday"],                      select[data-type="period"]');$.each(a,function(e,d){if(d.name){var f=window.REPORT.filters[d.name];$(d).selectize({options:f.options,valueField:"value",labelField:"label",searchField:"label",create:false,maxItems:(f.condition=="range")?2:undefined,onChange:function(g){if(f.condition=="range"&&(!g||g.length!=2)){f.value=null}else{f.value=(g=="")?null:g}handlerAfterChanges()},onClear:function(){f.value=null;handlerAfterChanges()}})}});return true}function handlerSetDatetimePickers(d){if(!d||!(d.type in {datetime:"",date:"",time:""})){return false}var b={lang:LANGUAGE_CODE,format:d.format,timepicker:true,datepicker:true,mask:d.use_mask,};if(d.type=="datetime"){b.formatDate=d.formatDate;b.formatTime=d.formatTime;b.onChangeDateTime=function(g,i){var h;if(d.use_tz){g.setMinutes(g.getMinutes()-(g.getTimezoneOffset()-SERVER_TZ_OFFSET));h=g.toISOString()}else{h=""+g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate()+"T"+g.getHours()+":"+g.getMinutes()+":"+g.getSeconds()+"."+g.getMilliseconds()}i.data("server_value",h)}}else{if(d.type=="time"){b.formatTime=d.format;b.datepicker=false;b.onChangeDateTime=function(g,h){h.data("server_value",""+g.getHours()+":"+g.getMinutes()+":"+g.getSeconds()+"."+g.getMilliseconds())}}else{b.formatDate=d.format;b.timepicker=false;b.onChangeDateTime=function(g,h){g.setMinutes(g.getMinutes()-(g.getTimezoneOffset()-SERVER_TZ_OFFSET));h.data("server_value",""+g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate())}}}if(d.condition=="range"){var f={},e={},c=$("#value-"+d.name+"-range1"),a=$("#value-"+d.name+"-range2");$.extend(true,f,b);$.extend(true,e,b);if(d.type=="date"){f.onShow=function(g){this.setOptions({maxDate:a.data().server_value?a.val():false})};e.onShow=function(g){this.setOptions({minDate:c.data().server_value?c.val():false})}}c.datetimepicker(f);a.datetimepicker(e)}else{$("#value-"+d.name).datetimepicker(b)}return true}function handlerCheckRequiredValue(){var a=true;$.each(REPORT.filters,function(b,c){if(c.required){if(c.value===null||c.value===undefined){a=false}else{if(c.condition=="range"&&(c.value.length<2||c.value[0]===null||c.value[1]===null)){a=false}}}});if(a){$(".action-create-report").prop("disabled",false).removeAttr("disabled")}else{$(".action-create-report").prop("disabled",true).attr("disabled","disabled")}return a}function handlerAfterChanges(){if(window.REPORT.process){clearInterval(window.REPORT.process);window.REPORT.id=null;window.REPORT.process=null}handlerSetProgress(0);$(".action-create-report, .action-preview, .action-download, .action-remove").attr("disabled","disabled");$(".action-recreate-report:visible").hide();$(".action-create-report:hidden").show();handlerCheckRequiredValue()}function eventChangeValue(d){var f=this.value,e=$(this).data(),h=e.server_value,c=REPORT.filters[this.name],b=function(i){var j=true;$.each(i,function(l,k){if(!k||k.indexOf("_")>=0){j=false}});return j};if(c.type=="boolean"){$("#valuebox-"+c.name).html("")}if(this.type=="radio"){c.value=(f=="true")?true:(f=="false")?false:null;if(h!=undefined){c.server_value=c.value}}else{if(c.condition=="range"&&c.type in {datetime:"",date:"",time:""}){var a,g;if(this.id.match(/.*-range1/g)){a=$("#value-"+c.name+"-range2");g=a.val();c.value=b([g,f])?[f,g]:null;c.server_value=b([g,f])?[h,a.data().server_value]:null}else{a=$("#value-"+c.name+"-range1");g=a.val();c.value=b([g,f])?[g,f]:null;c.server_value=b([g,f])?[a.data().server_value,h]:null}}else{c.value=f||null;if(h!=undefined){c.server_value=h}}}handlerAfterChanges()}function eventConditionChange(e){var d=REPORT.filters[$(this).data()["name"]],c=d.condition,a=d.value,f=d.server_value;d.condition=this.value||null;if(!d.condition){d.value=null;if(d.server_value!=undefined){d.server_value=null}}else{if(d.condition in {isnull:0,empty:0}){d.value=true}else{if(a===true||a===false||a===null||a===undefined){d.value=null;if(d.server_value!=undefined){d.server_value=null}}else{if(d.type in {object:0,choice:0,month:0,weekday:0,period:0}){d.value=null}else{if(d.condition in {range:0,"in":0}){if(!(c in {range:0,"in":0})){d.value=(d.condition=="range")?[a,a]:[a];if(d.server_value!=undefined){d.server_value=(d.condition=="range")?[f,f]:[f]}}else{if(c=="in"&&d.condition=="range"){d.value=a.slice(0,2);if(d.value.length<2){d.value[1]=d.value[0]}if(d.server_value!=undefined){d.server_value=f.slice(0,2);if(d.server_value.length<2){d.server_value[1]=d.server_value[0]}}}}}else{if(c in {range:0,"in":0}){d.value=a?a[0]:null;if(d.server_value!=undefined){d.server_value=f?f[0]:null}}}}}}}var b=TEMPLATES.filter({data:d});$("#valuebox-"+d.name).html(b);handlerSetSelectizers(d);handlerSetDatetimePickers(d);handlerAfterChanges();return true}function keyDownIsControl(a){if((a.which==8)||(a.which==9)||(a.which==13)||(a.which==27)||(a.which>=33&&a.which<=46)||(a.which>=112&&a.which<=145)){return true}return false}function eventKeyDownOnNumber(a){var b=function(c){value=c.target.value||"";if(value.length<1){c.target.value="0."}else{if(value.indexOf(".")<0){c.target.value=c.target.value+"."}}};if((a.which>=48&&a.which<=57)||keyDownIsControl(a)){return true}else{if(a.which==188||a.which==190){b(a);return false}}return false}function handlerSetProgress(b){b=b||0;var d=$(".progress .progress-bar"),a=Number(d.attr("aria-valuemax"))||100,c=(b/a)*100;c=c>100?100:c;d.attr("aria-valuenow",b).css("width",c+"%")}function handlerShowDocument(a,c,b){if(b){var e=window.open(a,c,"height=500,width=800,resizable=yes,scrollbars=yes");e.focus()}else{var f=$("#view-document-place"),d='<iframe class="embed-responsive-item" src="'+a+'" allowfullscreen webkitallowfullscreen></iframe>';if(f.size()==0){$("#view-"+c).toggle();$("#view-"+c+":visible .embed-responsive").html(d)}else{f.show().find(".embed-responsive").html(d)}}}function handlerTemplates(){TEMPLATES.alert=_.template($("#underscore-alert").html());TEMPLATES.filter=_.template($("#underscore-filter").html());return true}function handlerBindinds(){$("body").on("click",'button.close[data-dismiss="alert"]',function(){$("#alert-place").css("z-index","-1000")});$("body").on("change",'select[id^="condition-"]',eventConditionChange);$("body").on("keydown",'input[data-validate="number"]',eventKeyDownOnNumber);$("body").on("change",'input[id^="value-"]',eventChangeValue);$("body").on("click",".action-create-report",eventCreateReport);$("body").on("click",".action-recreate-report",eventRecreateReport);return true}$(document).ready(function(a){handlerTemplates();a("alert").alert();a(".dropdown-toggle").dropdown();handlerBindinds()});