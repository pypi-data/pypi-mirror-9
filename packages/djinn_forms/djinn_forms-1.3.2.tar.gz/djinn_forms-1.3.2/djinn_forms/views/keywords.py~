import json
from django.http import HttpResponse
from django.views.generic import View
from haystack.query import SearchQuerySet


class Keywords(View):

    """ Perform a keyword search on the indexed keywords, and return a list of
    the found keywords, with their frequency """

    def get(self, request):

        kw = self.request.GET.get("kw")

        sqs = SearchQuerySet().filter(keywords__startswith=kw).facet("keywords")

        result = []

        for term, count in sqs.facet_counts()['fields']['keywords']:
            if term.startswith(kw):
                result.append((term, count))

        sorted(result, lambda x, y: cmp(x[1], y[1]))

        return HttpResponse(
            json.dumps(result),
            mimetype='application/json')
