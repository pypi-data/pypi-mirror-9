'\" t
.\"     Title: rdopkg-adv-new-version
.\"    Author: [FIXME: author] [see http://docbook.sf.net/el/author]
.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
.\"      Date: 01/22/2015
.\"    Manual: \ \&
.\"    Source: \ \&
.\"  Language: English
.\"
.TH "RDOPKG\-ADV\-NEW\-VE" "7" "01/22/2015" "\ \&" "\ \&"
.\" -----------------------------------------------------------------
.\" * Define some portability stuff
.\" -----------------------------------------------------------------
.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.\" http://bugs.debian.org/507673
.\" http://lists.gnu.org/archive/html/groff/2009-02/msg00013.html
.\" ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\" -----------------------------------------------------------------
.\" * set default formatting
.\" -----------------------------------------------------------------
.\" disable hyphenation
.nh
.\" disable justification (adjust text to left margin only)
.ad l
.\" -----------------------------------------------------------------
.\" * MAIN CONTENT STARTS HERE *
.\" -----------------------------------------------------------------
.SH "NAME"
rdopkg-new-version \- rdopkg adventures: new\-version
.SH "SYNOPSIS"
.sp
This is a short story about updating RDO python\-swiftclient package to new upstream version using rdopkg new\-version\&.
.sp
Let\(cqs assume update of \fBHavana\fR \fBepel\-6\fR python\-swiftclient\-1\&.8\&.0\-1 package to latest upstream version 2\&.0\&.2\&.
.SH "PROLOGUE"
.sp
\fBdist\-git & remotes\fR
.sp
.if n \{\
.RS 4
.\}
.nf
$ cd python\-swiftclient
$ git fetch \-\-all
$ git remote \-v
openstack   git://github\&.com/openstack/python\-swiftclient\&.git (fetch)
openstack   git://github\&.com/openstack/python\-swiftclient\&.git (push)
origin      ssh://jruzicka@pkgs\&.fedoraproject\&.org/python\-swiftclient (fetch)
origin      ssh://jruzicka@pkgs\&.fedoraproject\&.org/python\-swiftclient (push)
patches     git@github\&.com:redhat\-openstack/python\-swiftclient\&.git (fetch)
patches     git@github\&.com:redhat\-openstack/python\-swiftclient\&.git (push)
.fi
.if n \{\
.RE
.\}
.sp
To summarise, above remotes are:
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
\fBorigin\fR: Fedora dist\-git containing \&.spec & patches

(obtained by
fedpkg clone python\-swiftclient)
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
\fBpatches\fR: github remote with RDO patches branches
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
\fBopenstack\fR: upstream code repo to cherry\-pick backported patch from
.RE
.sp
This is a Havana epel\-6 fix, so I\(cqm gonna work with:
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
\fBorigin/el6\-havana\fR
dist\-git
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
\fBpatches/stable/havana\fR
patches branch
.RE
.sp
See rdopkg info output for current branch names\&.
.sp
Before we proceed, let\(cqs inspect the patches branch:
.sp
.if n \{\
.RS 4
.\}
.nf
o [patches/stable/havana] Add SSL certificate verification by default
o Remove builtin requirements handling
M─┐ [1\&.8\&.0] Merge "Make pbr only a build\-time dependency\&."
│ o Make pbr only a build\-time dependency\&.
o │ assertEquals is deprecated, use assertEqual (H602
\&.\&.\&.
.fi
.if n \{\
.RE
.\}
.sp
You can see that there are two commits on top of 1\&.8\&.0\&. These two patches are present in dist\-git and applied in \&.spec file:
.sp
.if n \{\
.RS 4
.\}
.nf
\&.\&.\&.
Patch0001: 0001\-Remove\-builtin\-requirements\-handling\&.patch
Patch0002: 0002\-Add\-SSL\-certificate\-verification\-by\-default\&.patch
\&.\&.\&.
%patch0001 \-p1
%patch0002 \-p1
\&.\&.\&.
.fi
.if n \{\
.RE
.\}
.SH "CHAPTER 1"
.sp
\fBrdopkg new\-version\fR
.sp
With remotes set up and up to date, it\(cqs time to run rdopkg new\-version\&.
.sp
The only required positional argument specifies a version to update to\&. This is 2\&.0\&.2 in this case and it\(cqs both new rpm Version and git tag to rebase patches branch on\&. For other packages and versions, version tag and rpm Version might differ\&.
.sp
.if n \{\
.RS 4
.\}
.nf
$ git fetch \-\-all
$ git checkout el6\-havana
$ rdopkg new\-version 2\&.0\&.2
.fi
.if n \{\
.RE
.\}
.SH "CHAPTER 2"
.sp
\fBdiff\fR
.sp
First, rdopkg displays summary of changed files and changes to requirements\&.txt files:
.sp
.if n \{\
.RS 4
.\}
.nf
\-\-\- a/requirements\&.txt
+++ b/requirements\&.txt
@@ \-1 +1,2 @@
+requests>=1\&.1
simplejson>=2\&.0\&.9
.fi
.if n \{\
.RE
.\}
.sp
I make a mental note I need to add Requires: python\-requests later and press enter to advance\&.
.SH "CHAPTER 3"
.sp
\fBrebase of patches branch\fR
.sp
Next, rdopkg resets the local stable/havana branch to patches/stable/havana, switches to it, and tries to \fBrebase\fR it on 2\&.0\&.2 git tag\&.
.sp
The rebase failed due to a conflict of downstream patches nuking pbr and rdopkg exited to shell so I can finish the rebase manually\&.
.sp
I modified the conflicting patch and continued the rebase with
.sp
.if n \{\
.RS 4
.\}
.nf
git rebase \-\-continue
.fi
.if n \{\
.RE
.\}
.sp
Then the second patch failed to apply as well\&. This was a downstream only fix and upstream has chosen a different solution which is already included in 2\&.0\&.2 and thus I skipped this patch entirely with
.sp
.if n \{\
.RS 4
.\}
.nf
git rebase \-\-skip
.fi
.if n \{\
.RE
.\}
.sp
Now, the patches branch look like this:
.sp
.if n \{\
.RS 4
.\}
.nf
o [stable/havana] Remove builtin requirements handling
o [2\&.0\&.2] Remove multipart/form\-data file upload
o Fix \-\-insecure option on auth
M─┐ Merge "Port to python\-requests"
.fi
.if n \{\
.RE
.\}
.sp
First patch is on top of 2\&.0\&.2, second obsolete patch is gone\&.
.SH "CHAPTER 4"
.sp
\fBthe rest is magic\fR
.sp
Once I\(cqm happy with the rebased patches branch, I resume rdopkg action with
.sp
.if n \{\
.RS 4
.\}
.nf
rdopkg \-c
.fi
.if n \{\
.RE
.\}
.sp
Now, rdopkg asks if I want to push the shiny rebased patches branch\&. I indeed do\&. Note that you need to have force push permission in the patches remote\&.
.sp
.if n \{\
.RS 4
.\}
.nf
Push stable/havana to patches / stable/havana (with \-\-force)? [Yn]
.fi
.if n \{\
.RE
.\}
.sp
After this, rdopkg:
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
downloads the source tarball
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
calls
fedpkg new\-sources
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
updates
\&.spec
file (Version, Release, patches_base, new changelog entry)
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
creates new commit with updated
\&.spec
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
updates patches from local patches branch
stable/havana
.RE
.sp
.RS 4
.ie n \{\
\h'-04'\(bu\h'+03'\c
.\}
.el \{\
.sp -1
.IP \(bu 2.3
.\}
shows final diff
.RE
.sp
pseudo\-diff of \&.spec file:
.sp
.if n \{\
.RS 4
.\}
.nf
\-Version:    1\&.8\&.0
+Version:    2\&.0\&.2
 \&.\&.\&.
\-# patches_base=1\&.8\&.0
+# patches_base=2\&.0\&.2
 \&.\&.\&.
 Patch0001: 0001\-Remove\-builtin\-requirements\-handling\&.patch
\-Patch0002: 0002\-Add\-SSL\-certificate\-verification\-by\-default\&.patch
 \&.\&.\&.
 %patch0001 \-p1
\-%patch0002 \-p1
 \&.\&.\&.
+* Thu Feb 20 2014 Jakub Ruzicka <jruzicka@redhat\&.com> 2\&.0\&.2\-1
+\- Update to upstream 2\&.0\&.2
+
 \&.\&.\&.
.fi
.if n \{\
.RE
.\}
.sp
As you can see, obsolete patch I deleted during rebase is gone\&.
.sp
Commit message and changed files:
.sp
.if n \{\
.RS 4
.\}
.nf
Update to upstream 2\&.0\&.2
.fi
.if n \{\
.RE
.\}
.sp
.if n \{\
.RS 4
.\}
.nf
M   \&.gitignore
M   0001\-Remove\-builtin\-requirements\-handling\&.patch
D   0002\-Add\-SSL\-certificate\-verification\-by\-default\&.patch
M   python\-swiftclient\&.spec
M   sources
.fi
.if n \{\
.RE
.\}
.SH "CHAPTER 5"
.sp
\fBfinishing touches & rdopkg amend\fR
.sp
Finally, I need to tune \&.spec file due to new deps and amend with rdopkg amend to regenerate commit message from %changelog:
.sp
.if n \{\
.RS 4
.\}
.nf
vim python\-swiftclient\&.spec
rdopkg amend
.fi
.if n \{\
.RE
.\}
.sp
Final commit message:
.sp
.if n \{\
.RS 4
.\}
.nf
Update to upstream 2\&.0\&.2
.fi
.if n \{\
.RE
.\}
.sp
.if n \{\
.RS 4
.\}
.nf
Changelog:
\- Update to upstream 2\&.0\&.2
\- Switch from pyOpenSSL to python\-requests \- update dependencies
\- Remove unneeded dependency: python\-simplejson
.fi
.if n \{\
.RE
.\}
.SH "EPILOGUE"
.sp
See available options
.sp
.if n \{\
.RS 4
.\}
.nf
rdopkg new\-version \-h
.fi
.if n \{\
.RE
.\}
.sp
and rdopkg(1) manual for more information\&.
