<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Movie Renege &mdash; SimPy 3.0.6 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.0.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="SimPy 3.0.6 documentation" href="../index.html" />
    <link rel="up" title="Examples" href="index.html" />
    <link rel="next" title="Gas Station Refueling" href="gas_station_refuel.html" />
    <link rel="prev" title="Machine Shop" href="machine_shop.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="gas_station_refuel.html" title="Gas Station Refueling"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="machine_shop.html" title="Machine Shop"
             accesskey="P">previous</a> |</li>
        <li><a href="../contents.html">SimPy 3.0.6 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Examples</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="movie-renege">
<h1>Movie Renege<a class="headerlink" href="#movie-renege" title="Permalink to this headline">¶</a></h1>
<p>Covers:</p>
<ul class="simple">
<li>Resources: Resource</li>
<li>Condition events</li>
<li>Shared events</li>
</ul>
<p>This examples models a movie theater with one ticket counter selling tickets
for three movies (next show only). People arrive at random times and triy to
buy a random number (1&#8211;6) tickets for a random movie. When a movie is sold
out, all people waiting to buy a ticket for that movie renege (leave the
queue).</p>
<p>The movie theater is just a container for all the related data (movies, the
counter, tickets left, collected data, ...). The counter is
a <a class="reference internal" href="../api_reference/simpy.resources.html#simpy.resources.resource.Resource" title="simpy.resources.resource.Resource"><tt class="xref py py-class docutils literal"><span class="pre">Resource</span></tt></a> with a capacity of one.</p>
<p>The <em>moviegoer</em> process starts waiting until either it&#8217;s his turn (it acquires
the counter resource) or until the <em>sold out</em> signal is triggered. If the
latter is the case it reneges (leaves the queue). If it gets to the counter,
it tries to buy some tickets. This might not be successful, e.g. if the process
tries to buy 5 tickets but only 3 are left. If less then two tickets are left
after the ticket purchase, the <em>sold out</em> signal is triggered.</p>
<p>Moviegoers are generated by the <em>customer arrivals</em> process. It also chooses a
movie and the number of tickets for the moviegoer.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Movie renege example</span>

<span class="sd">Covers:</span>

<span class="sd">- Resources: Resource</span>
<span class="sd">- Condition events</span>
<span class="sd">- Shared events</span>

<span class="sd">Scenario:</span>
<span class="sd">  A movie theatre has one ticket counter selling tickets for three</span>
<span class="sd">  movies (next show only). When a movie is sold out, all people waiting</span>
<span class="sd">  to buy tickets for that movie renege (leave queue).</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">simpy</span>


<span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">TICKETS</span> <span class="o">=</span> <span class="mi">50</span>  <span class="c"># Number of tickets per movie</span>
<span class="n">SIM_TIME</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c"># Simulate until</span>


<span class="k">def</span> <span class="nf">moviegoer</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">num_tickets</span><span class="p">,</span> <span class="n">theater</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A moviegoer tries to by a number of tickets (*num_tickets*) for</span>
<span class="sd">    a certain *movie* in a *theater*.</span>

<span class="sd">    If the movie becomes sold out, she leaves the theater. If she gets</span>
<span class="sd">    to the counter, she tries to buy a number of tickets. If not enough</span>
<span class="sd">    tickets are left, she argues with the teller and leaves.</span>

<span class="sd">    If at most one ticket is left after the moviegoer bought her</span>
<span class="sd">    tickets, the *sold out* event for this movie is triggered causing</span>
<span class="sd">    all remaining moviegoers to leave.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">theater</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">my_turn</span><span class="p">:</span>
        <span class="c"># Wait until its our turn or until the movie is sold out</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">my_turn</span> <span class="o">|</span> <span class="n">theater</span><span class="o">.</span><span class="n">sold_out</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span>

        <span class="c"># Check if it&#39;s our turn of if movie is sold out</span>
        <span class="k">if</span> <span class="n">my_turn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">theater</span><span class="o">.</span><span class="n">num_renegers</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">env</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c"># Check if enough tickets left.</span>
        <span class="k">if</span> <span class="n">theater</span><span class="o">.</span><span class="n">available</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">num_tickets</span><span class="p">:</span>
            <span class="c"># Moviegoer leaves after some discussion</span>
            <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">env</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="c"># Buy tickets</span>
        <span class="n">theater</span><span class="o">.</span><span class="n">available</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span> <span class="o">-=</span> <span class="n">num_tickets</span>
        <span class="k">if</span> <span class="n">theater</span><span class="o">.</span><span class="n">available</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># Trigger the &quot;sold out&quot; event for the movie</span>
            <span class="n">theater</span><span class="o">.</span><span class="n">sold_out</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
            <span class="n">theater</span><span class="o">.</span><span class="n">when_sold_out</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">now</span>
            <span class="n">theater</span><span class="o">.</span><span class="n">available</span><span class="p">[</span><span class="n">movie</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">customer_arrivals</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">theater</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create new *moviegoers* until the sim time reaches 120.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">expovariate</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.5</span><span class="p">))</span>

        <span class="n">movie</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">theater</span><span class="o">.</span><span class="n">movies</span><span class="p">)</span>
        <span class="n">num_tickets</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theater</span><span class="o">.</span><span class="n">available</span><span class="p">[</span><span class="n">movie</span><span class="p">]:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">moviegoer</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">movie</span><span class="p">,</span> <span class="n">num_tickets</span><span class="p">,</span> <span class="n">theater</span><span class="p">))</span>


<span class="n">Theater</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;Theater&#39;</span><span class="p">,</span> <span class="s">&#39;counter, movies, available, &#39;</span>
                                            <span class="s">&#39;sold_out, when_sold_out, &#39;</span>
                                            <span class="s">&#39;num_renegers&#39;</span><span class="p">)</span>


<span class="c"># Setup and start the simulation</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;Movie renege&#39;</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>

<span class="c"># Create movie theater</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">movies</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Python Unchained&#39;</span><span class="p">,</span> <span class="s">&#39;Kill Process&#39;</span><span class="p">,</span> <span class="s">&#39;Pulp Implementation&#39;</span><span class="p">]</span>
<span class="n">available</span> <span class="o">=</span> <span class="p">{</span><span class="n">movie</span><span class="p">:</span> <span class="n">TICKETS</span> <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">}</span>
<span class="n">sold_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">movie</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">event</span><span class="p">()</span> <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">}</span>
<span class="n">when_sold_out</span> <span class="o">=</span> <span class="p">{</span><span class="n">movie</span><span class="p">:</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">}</span>
<span class="n">num_renegers</span> <span class="o">=</span> <span class="p">{</span><span class="n">movie</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">}</span>
<span class="n">theater</span> <span class="o">=</span> <span class="n">Theater</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">movies</span><span class="p">,</span> <span class="n">available</span><span class="p">,</span> <span class="n">sold_out</span><span class="p">,</span> <span class="n">when_sold_out</span><span class="p">,</span>
                  <span class="n">num_renegers</span><span class="p">)</span>

<span class="c"># Start process and run</span>
<span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">customer_arrivals</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">theater</span><span class="p">))</span>
<span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">SIM_TIME</span><span class="p">)</span>

<span class="c"># Analysis/results</span>
<span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">theater</span><span class="o">.</span><span class="n">sold_out</span><span class="p">[</span><span class="n">movie</span><span class="p">]:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Movie &quot;</span><span class="si">%s</span><span class="s">&quot; sold out </span><span class="si">%.1f</span><span class="s"> minutes after ticket counter &#39;</span>
              <span class="s">&#39;opening.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">movie</span><span class="p">,</span> <span class="n">theater</span><span class="o">.</span><span class="n">when_sold_out</span><span class="p">[</span><span class="n">movie</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;  Number of people leaving queue when film sold out: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
              <span class="n">theater</span><span class="o">.</span><span class="n">num_renegers</span><span class="p">[</span><span class="n">movie</span><span class="p">])</span>
</pre></div>
</div>
<p>The simulation&#8217;s output:</p>
<div class="highlight-python"><div class="highlight"><pre>Movie renege
Movie &quot;Python Unchained&quot; sold out 38.0 minutes after ticket counter opening.
  Number of people leaving queue when film sold out: 16
Movie &quot;Kill Process&quot; sold out 43.0 minutes after ticket counter opening.
  Number of people leaving queue when film sold out: 5
Movie &quot;Pulp Implementation&quot; sold out 28.0 minutes after ticket counter opening.
  Number of people leaving queue when film sold out: 5
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/simpy-logo-small.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="machine_shop.html"
                        title="previous chapter">Machine Shop</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="gas_station_refuel.html"
                        title="next chapter">Gas Station Refueling</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/examples/movie_renege.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="gas_station_refuel.html" title="Gas Station Refueling"
             >next</a> |</li>
        <li class="right" >
          <a href="machine_shop.html" title="Machine Shop"
             >previous</a> |</li>
        <li><a href="../contents.html">SimPy 3.0.6 documentation</a> &raquo;</li>
          <li><a href="index.html" >Examples</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2002–2015, Team SimPy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>