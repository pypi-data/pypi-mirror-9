"use strict";function FocusOn(a){var b=function(a){if(!a.focusOn&&""!=a.focusOn)throw"FocusOnCondition missing attribute to evaluate"};return{restrict:"A",link:function(c,d,e){b(e),c.$watch(e.focusOn,function(b){1==b&&a(function(){d.focus()})})}}}angular.module("anarchoApp",["ngCookies","ngRoute","ui.bootstrap","angularFileUpload","ja.qr","ngClipboard","monospaced.elastic","ngToast"]);var app=angular.module("anarchoApp");app.config(["ngClipProvider",function(a){a.setPath("bower_components/zeroclipboard/dist/ZeroClipboard.swf"),a.setConfig({forceHandCursor:!1})}]),app.config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|itms-services):/)}]),app.filter("addEllipsis",function(){return function(a,b){var c=b;if(isNaN(parseFloat(c))&&!isFinite(c))throw"addEllipsis wrong attribute to evaluate. Usage: {{ data | addEllipsis : 50}} ";return a?a.length>c?a.substring(0,c).trim()+"...":a:void 0}}),app.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),app.config(["$routeProvider",function(a){a.when("/apps",{templateUrl:"views/apps_list.html"}).when("/apps/:app_key",{templateUrl:"views/app_detail.html"}).when("/apps/:app_key/:build_id",{templateUrl:"views/build_details.html"}).when("/settings/:app_key/",{templateUrl:"views/app_settings.html"}).otherwise({redirectTo:"/apps"})}]),app.constant("app_config",{API_URL:"api/"});var MainCtrl=function(a,b,c,d,e,f,g){a.isLoading=!1,a.showLoader=function(){a.progressTimeout=c(function(){a.showProgress=!0},2e3)},a.hideLoader=function(){a.showProgress=!1,c.cancel(a.progressTimeout)},a.isMobile={Android:function(){return/Android/i.test(navigator.userAgent)},BlackBerry:function(){return/BlackBerry/i.test(navigator.userAgent)},iOS:function(){return/iPhone|iPad|iPod/i.test(navigator.userAgent)},Windows:function(){return/IEMobile/i.test(navigator.userAgent)},any:function(){return isMobile.Android()||isMobile.BlackBerry()||isMobile.iOS()||isMobile.Windows()}},a.loadUser=function(){e.isAuthorized()&&f.getUser().success(function(b){a.currentUser=b,g.reload()}).finally(function(){a.hideLoader()})},a.$on(d.loginSuccess,function(){a.loadUser()}),a.$on(d.logoutSuccess,function(){a.currentUser=null}),a.loadUser()};app.controller("MainCtrl",["$scope","$cookieStore","$timeout","AUTH_EVENTS","Session","AuthService","$route",MainCtrl]);var AuthCtrl=function(a,b,c,d,e){a.login=function(f){d.login(f).success(function(a){e.create(a.authToken),b.$broadcast(c.loginSuccess)}).error(function(d){a.error=d.error,b.$broadcast(c.loginFailed)})},a.register=function(f){d.register(f).success(function(a){e.create(a.authToken),b.$broadcast(c.loginSuccess)}).error(function(d){a.error=d.error,b.$broadcast(c.loginFailed)})},a.logout=function(){e.destroy(),b.$broadcast(c.logoutSuccess)}};app.controller("AuthCtrl",["$scope","$rootScope","AUTH_EVENTS","AuthService","Session",AuthCtrl]);var AppBaseCtrl=function(a,b,c){a.app={},a.appKey=b.app_key,a.hasPermission=function(a,b){return a.permission?-1!=a.permission.indexOf(b):!1},a.canWrite=function(){return a.hasPermission(a.app,"w")},a.loadApp=function(){c.get(a.appKey).success(function(b){a.app=b})}};app.controller("AppBaseCtrl",["$scope","$routeParams","AppsService",AppBaseCtrl]);var AppsListCtrl=function(a,b,c){a.apps=[];var d=function(a,b){a.modalAddApp=function(a){b.close(a)},a.cancel=function(){b.dismiss()}};d.$inject=["$scope","$modalInstance"],a.showNewApp=function(){b.open({templateUrl:"views/new_app_modal.html",size:"sm",controller:d}).result.then(function(b){a.addApp(b)})},a.getList=function(){c.list().success(function(b){a.apps=b.list}).finally(function(){a.hideLoader()})},a.addApp=function(b){c.add(b).success(function(b){a.apps.push(b)})},a.showLoader(),a.getList()};app.controller("AppsCtrl",["$scope","$modal","AppsService",AppsListCtrl]);var AppDetailsCtrl=function(a,b,c,d,e,f,g){f("AppBaseCtrl",{$scope:a}),a.builds=[],a.progress=-1,a.buildsList=function(b){d.getBuilds(b).success(function(b){a.builds=b.list}).finally(function(){$rootScope.hideLoader()})},a.onFileSelect=function(b){var e=b[0];d.uploadBuild(a.appKey,e,function(b){a.progress=b}).success(function(b){a.builds.push(b),a.getApp(a.appKey)}).error(function(a){g.create({content:a.error,className:"danger"})}).finally(function(){c(function(){a.progress=-1},1e3)})},a.showBuildInfo=function(b){e.path("/apps/"+a.app.app_key+"/"+b.id)},a.ids=[],a.remove=function(){d.removeBuilds(a.appKey,a.ids).success(function(){a.ids=[],a.buildsList(a.appKey)})},a.toggleBuild=function(b){var c=a.ids.indexOf(b);c>-1?a.ids.splice(c,1):a.ids.push(b)},a.showLoader(),a.loadApp(),a.buildsList(a.appKey)};app.controller("AppDetailsCtrl",["$scope","$modal","$timeout","AppsService","$location","$controller","ngToast",AppDetailsCtrl]);var BuildDetailsCtrl=function(a,b,c,d,e,f){e("AppBaseCtrl",{$scope:a}),a.certLink=f.API_URL+"cert",a.buildId=c.build_id,a.editNotesDisabled=!0,a.$watch("app",function(){a.iosApp="ios"===a.app.app_type?!0:!1}),a.getBuild=function(){b.getBuild(a.appKey,a.buildId).success(function(b){a.build=b}).finally(function(){$rootScope.hideLoader()})},a.editNotes=function(){a.editNotesDisabled=!1},a.saveNotes=function(){b.postNotes(a.appKey,a.buildId,a.build.release_notes).success(function(){a.editNotesDisabled=!0}).error(function(){d.create({content:"Can't update release notes",className:"danger"})})},a.linkCopied=function(){d.create("Link "+a.build.build_url+" copied")},a.showLoader(),a.loadApp(),a.getBuild()};app.controller("BuildDetailsCtrl",["$scope","AppsService","$routeParams","ngToast","$controller","app_config",BuildDetailsCtrl]);var AppSettingsCtrl=function(a,b,c,d){d("AppBaseCtrl",{$scope:a}),a.getInclude=function(){var b="";switch(a.action){case"team":b="views/settings_team.html";break;case"remove":b="views/settings_remove_app.html";break;case"plugin":b="andr"===a.app.app_type?"views/settings_plugin_config_android.html":"views/settings_plugin_config_bash.html"}return b},a.loadApp(),a.action="team"};app.controller("AppSettingsCtrl",["$scope","$routeParams","AppsService","$controller",AppSettingsCtrl]);var AppRemoveCtrl=function(a,b,c,d){a.removeApp=function(){b.removeApp(a.appKey).success(function(){c.path("#/apps")}).error(function(b){var c=b.error,e="You can't remove <b>"+a.app.name+"</b>.  <br> ";"not_enough_permission"===c&&(e+="Not enough permission!"),"app_not_found"===c&&(e+="Application not found!"),d.create({content:e,className:"danger"})})}};app.controller("AppRemoveCtrl",["$scope","AppsService","$location","ngToast",AppRemoveCtrl]);var AppTeamCtrl=function(a,b){a.all_permissions=[{id:"w",name:"Write"},{id:"r",name:"Read"}],a.permissions=[],a.usersList=function(c){b.list(c).success(function(b){a.permissions=b.list})},a.addUser=function(c){c.app_key=a.appKey,b.add(c).success(function(b){a.permissions.push(b),a.error=null}).error(function(b){a.error=b.error})},a.updateUser=function(c){c.app_key=a.appKey,b.update(c).success(function(){})},a.revokeUser=function(c){c.app_key=a.appKey,b.revoke(c).success(function(b){for(var c=0;c<a.permissions.length;c++)if(a.permissions[c].email===b.email){a.permissions.splice(c,1);break}})},a.usersList(a.appKey)};app.controller("AppTeamCtrl",["$scope","TeamService",AppTeamCtrl]);var AppPluginCtrl=function(a,b){b.getPluginConfig(a.appKey).success(function(b){a.appKey=b.app_key,a.host=b.host,a.apiToken=b.api_token})};app.controller("AppPluginCtrl",["$scope","AppsService",AppPluginCtrl]),app.controller("TracksCtrl",["$scope","TracksService",function(a,b){a.tracks=[],b.fetch().success(function(b){a.tracks=b.data})}]);var api=function(a,b,c,d){var e={};return e.getBaseConfig=function(a){var b={url:c.API_URL+a,headers:{}},e=d.authToken;return null!=e&&(b.headers["x-auth-token"]=e),b},e.delete=function(b,c){var d=e.getBaseConfig(b);return d.headers["Content-Type"]="application/json;charset=utf-8",d.method="DELETE",d.data=c,a(d)},e.post=function(b,c){var d=e.getBaseConfig(b);return d.headers["Content-Type"]="application/json;charset=utf-8",d.method="POST",d.data=c,a(d)},e.patch=function(b,c){var d=e.getBaseConfig(b);return d.method="PATCH",d.data=c,a(d)},e.get=function(b){var c=e.getBaseConfig(b);return c.method="GET",a(c)},e.uploadBuild=function(a,c,d,f){var g=e.getBaseConfig(a);return b.upload({url:g.url,method:"POST",headers:g.headers,file:c}).progress(function(a){d(parseInt(100*a.loaded/a.total))}).success(function(a){f(a)})},e};app.factory("Api",["$http","$upload","app_config","Session",api]);var AuthService=function(a){var b={};return b.login=function(b){return a.post("login",b)},b.register=function(b){return a.post("register",b)},b.getUser=function(){return a.get("user")},b};app.factory("AuthService",["Api",AuthService]);var SessionService=function(a){return this.authToken=a.get("auth_token"),this.isAuthorized=function(){return null==this.authToken?!1:!0},this.create=function(b){this.authToken=b,a.put("auth_token",this.authToken)},this.destroy=function(){a.remove("auth_token"),this.authToken=null},this};app.service("Session",["$cookieStore",SessionService]);var AppsService=function(a){var b={};return b.list=function(){return a.get("apps")},b.add=function(b){return a.post("apps",b)},b.removeApp=function(b){return a.delete("apps/"+b)},b.get=function(b){return a.get("apps/"+b)},b.getBuilds=function(b){return a.get("apps/"+b+"/builds")},b.uploadBuild=function(b,c,d,e){return a.uploadBuild("apps/"+b,c,d,e)},b.removeBuilds=function(b,c){return a.delete("apps/"+b+"/builds",{ids:c})},b.getPluginConfig=function(b){return a.get("apps/"+b+"/plugin")},b.getBuild=function(b,c){return a.get("apps/"+b+"/"+c)},b.postNotes=function(b,c,d){return a.post("apps/"+b+"/"+c+"/notes",{release_notes:d})},b};app.factory("AppsService",["Api",AppsService]);var TrackService=function(a,b,c){return{fetch:function(){var d={headers:{"x-auth-token":c.authToken}};return a.get(b.API_URL+"track/list",d)}}};app.factory("TracksService",["$http","configuration","Session",TrackService]);var TeamService=function(a){var b={};return b.add=function(b){return a.post("permission",b)},b.update=function(b){return a.patch("permission",b)},b.revoke=function(b){return a.delete("permission",b)},b.list=function(b){return a.get("permission/"+b)},b};app.factory("TeamService",["Api",TeamService]);var IconSrc=function(){var a={};return a.link=function(a,b,c){a.$watch(function(){return c.iconSrc?b.attr("src",c.iconSrc):b.attr("src","images/logo.6db6798c.png"),c.iconSrc},function(a){a||b.attr("src","images/logo.6db6798c.png")}),b.bind("error",function(){b.attr("src","images/logo.6db6798c.png")})},a},AppTypeIcon=function(){var a={};return a.link=function(a,b,c){a.$watch(function(){var a=c.appTypeIcon;b.css("display","initial"),"andr"===a?b.attr("src","images/icon_droid.f2902d36.png"):"ios"===a?b.attr("src","images/icon_apple.3270d7c9.png"):b.css("display","none")})},a},OrderBtn=function(){var a={};return a.restrict="E",a.scope=!1,a.link=function(a,b,c){var d=function(){var d="&nbsp;";a.order.field===c.field&&(d=a.order.reverse?"&#9660;":"&#9650;"),b.html("<span>"+c.text+d+"</span>")};b.bind("click",function(){var b=!a.order.reverse;c.field!=a.order.field&&(b=!0),a.$apply(function(){a.order={field:c.field,reverse:b}})}),b.hover(function(){b.css("cursor","hand"),b.css("cursor","pointer")}),a.$watch(function(){return a.order},function(){d()}),void 0!=c.reverse&&null!=c.reverse&&(a.order={field:c.field,reverse:"true"===c.reverse},d())},a};app.directive("iconSrc",IconSrc),app.directive("appTypeIcon",AppTypeIcon),app.directive("orderBtn",OrderBtn),app.directive("focusOn",["$timeout",FocusOn]);