<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="base">
<head><title></title></head>
<body>
<div id="mainPanel" metal:fill-slot="main">
  ${form.begin()}
  <!-- ............................... Buttons ............................ -->
  <div id="buttons">
    <div class="first">
      ${request.breadcrumbs.back_button()}
    </div>
    <div class="last" tal:switch="task is None">
      <div tal:case="True" tal:omit-tag="">
        ${form.submit('sav!.x', _('Create'), class_='buttonMain')}
        ${form.button(route('project_edit', project_id=project['project_id']), _('Cancel'))}
      </div>
      <div tal:case="False" tal:omit-tag="">
        ${form.submit('sav!.x', _('Save'), class_='buttonMain')}
        ${form.button(route('task_view', project_id=task.project_id, task_id=task.task_id), _('Cancel'))}
        ${form.button(route('project_%s' % ('edit' in request.breadcrumbs.back_path() and 'edit' or 'view'),
          project_id=task.project_id), _('View project settings'))}
      </div>
    </div>
    <hr class="hidden"/>
  </div>
  <div id="main">
    <h2 id="subtitle" class="task" title="${_('Task')}">
      ${project['label']} <em>${task and task.label}</em>
    </h2>
    <!-- ............................. Flash .............................. -->
    <div tal:define="flash load: flash.macro.pt" metal:use-macro="flash"/>
    <!-- ........................ Processings to add ...................... -->
    <div id="dialogBox" tal:condition="action == 'apr?'">
      <div id="dialogBoxTitle">
        <div class="first">${_('Processings to add')}</div>
        <div class="last">
          ${form.submit_image('ccl!', _('Close'), '/Static/Images/close_light.png')}
        </div>
      </div>
      <div id="dialogBoxContent">
        <div class="listActions">
          <div class="first"> </div>
          <div class="last">
            ${form.submit('apr!#.x', _('Add processings'))}
          </div>
        </div>
        <table class="list smallList">
          <caption>${_('Processings')}</caption>
          <tr>
            <th class="checkbox" id="check_all"></th>
            <th>${_('Label')}</th>
            <th class="last">${_('Actions')}</th>
          </tr>
          <tr tal:repeat="processing project['processing_labels']">
            <td class="checkbox">${form.checkbox('#%d' % processing[0], id=None, class_='listCheck')}</td>
            <td>
              <a href="${route('processing_view', project_id=project['project_id'],
                       processing_id=processing[0])}">${processing[1]}</a>
            </td>
            <td class="last actions">
              ${form.submit_image('apr!%d' % processing[0], _('Add processing'),
              '/Static/Images/action_add_one.png')}
            </td>
          </tr>
        </table>
      </div>
    </div>
    <!-- ........................ Connections to add ...................... -->
    <div id="dialogBox" tal:condition="action == 'alk?'">
      <div id="dialogBoxTitle">
        <div class="first">${_('Connections to add')}</div>
        <div class="last">
          ${form.submit_image('ccl!', _('Close'), '/Static/Images/close_light.png')}
        </div>
      </div>
      <div id="dialogBoxContent">
        <div class="listActions">
          <div class="first"> </div>
          <div class="last">
            ${form.submit('alk!#.x', _('Add connections'))}
          </div>
        </div>
        <table class="list smallList">
          <caption>${_('Connections')}</caption>
          <tr>
            <th class="checkbox" id="check_all"></th>
            <th>${_('Label')}</th>
            <th class="last">${_('Actions')}</th>
          </tr>
          <tr tal:repeat="target sorted(project['task_labels'], key=lambda k:project['task_labels'][k])">
            <td class="checkbox">${form.checkbox('#%d' % target, id=None, class_='listCheck')}</td>
            <td>${project['task_labels'][target]}</td>
            <td class="last actions">
              ${form.submit_image('alk!%d' % target, _('Add connection'),
              '/Static/Images/action_add_one.png')}
            </td>
          </tr>
        </table>
      </div>
    </div>
    <!-- ............................. Tabs ............................... -->
    <div id="tabSet">
      ${tab_set.toc('tabTask')}
      <!-- ..... Description ...... -->
      ${tab_set.tab_begin(0, 'd')}
      ${form.grid_text('label', _('Label:'), required=True)}
      ${form.grid_text('description', _('Description:'))}
      ${form.grid_select('operator', _('Operator:'), operators)}
      ${form.grid_text('deadline', _('Deadline:'),
        hint=_('Format: YYYY-MM-DD'), class_='formItem date')}
      ${tab_set.tab_end()}
      <!-- ..... Processings ...... -->
      ${tab_set.tab_begin(1, 'p')}
      <div class="listActions" tal:condition="task">
        <div class="first">
          <img src="/Static/Images/processing22.png" alt="${_('Processings')}"/>
        </div>
        <div class="last">
          ${form.submit_image('apr?', _('Add processing'), '/Static/Images/action_add.png')}
        </div>
      </div>
      <table class="list smallList" tal:condition="task">
        <caption>${_('Processings')}</caption>
        <tr>
          <th>${_('Available processings')}</th>
          <th class="last">${_('Action')}</th>
        </tr>
        <tr tal:repeat="processing task.processings">
          <td>
            <a href="${route('processing_view', project_id=task.project_id, processing_id=processing.processing_id)}">
              ${dict(project['processing_labels'])[processing.processing_id]}
            </a>
          </td>
          <td class="last" tal:switch="action == 'rpr?%d' % processing.processing_id">
            <span tal:case="True" tal:omit-tag="">
              ${form.submit('rpr!%d.x' % processing.processing_id, _('Confirm removal'), class_='button')}
              ${form.submit_cancel(_('Cancel'))}
            </span>
            <span tal:case="False" tal:omit-tag="">
              ${form.submit_image('rpr?%d' % processing.processing_id, _('Remove processing'),
              '/Static/Images/action_remove_one.png')}
            </span>
          </td>
        </tr>
      </table>
      <div tal:condition="not task">${_('Create task before adding processings.')}</div>
      ${tab_set.tab_end()}
      <!-- ..... Connections ...... -->
      ${tab_set.tab_begin(2, 'c')}
      <div class="listActions" tal:condition="task">
        <div class="first">
          <img src="/Static/Images/link22.png" alt="${_('Connections')}"/>
        </div>
        <div class="last">
          ${form.submit_image('alk?', _('Add connection'), '/Static/Images/action_add.png')}
        </div>
      </div>
      <table class="list smallList" tal:condition="task">
        <caption>${_('Connections')}</caption>
        <tr>
          <th>${_('To task')}</th>
          <th>${_('Mode')}</th>
          <th class="last">${_('Action')}</th>
        </tr>
        <tr tal:repeat="link task.links">
          <td>${dict(project['task_labels'])[link.target_id]}</td>
          <td>
            ${form.select('lnk_%d' % link.target_id, link.link_type, LINK_TYPES.items())}
          </td>
          <td class="last actions" tal:switch="action == 'rlk?%d' % link.target_id">
            <span tal:case="True" tal:omit-tag="">
              ${form.submit('rlk!%d.x' % link.target_id, _('Confirm removal'), class_='button')}
              ${form.submit_cancel(_('Cancel'))}
            </span>
            <span tal:case="False" tal:omit-tag="">
              ${form.submit_image('rlk?%d' % link.target_id, _('Remove connection'),
              '/Static/Images/action_remove_one.png')}
            </span>
          </td>
        </tr>
      </table>
      <div tal:condition="not task">${_('Create task before adding connections.')}</div>
      ${tab_set.tab_end()}
    </div>
  </div>
  ${form.end()}
</div>
</body>
</html>
