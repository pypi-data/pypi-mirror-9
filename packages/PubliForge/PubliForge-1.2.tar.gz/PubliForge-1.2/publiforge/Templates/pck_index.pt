<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="base">
<head><title></title></head>
<body>
<div id="mainPanel" metal:fill-slot="main">
  ${form.begin(request.current_route_path(_anchor='current'), multipart=True)}
  <!-- ............................... Buttons ............................ -->
  <div id="buttons">
    <div class="first">
      ${request.breadcrumbs.back_button()}
    </div>
    <div class="last">
      ${form.button(route('project_dashboard', project_id=project['project_id']), _('View dashboard'))}
    </div>
    <hr class="hidden"/>
  </div>
  <div id="main">
    <h2 id="subtitle" class="pack" title="${_('Packs')}">${project['label']}</h2>
    <!-- ............................... Filter ........................... -->
    <div  class="filter">
      <h3><span>${_('Pack filter')}</span></h3>
      <div class="col11">
        <div class="colFirst">
          ${form.grid_text('f_label', _('Label:'))}
        </div>
        <div class="colLast" tal:condition="project['task_labels']">
          ${form.grid_select('f_task', _('Task:'), [('*', '')] + project['task_labels'].items(),
            autosubmit=True)}
        </div>
        <div class="submit">${form.submit('filter', _('Apply filter'), class_='button')}</div>
      </div>
    </div>
    <!-- ............................. Flash .............................. -->
    <div tal:define="flash load: flash.macro.pt" metal:use-macro="flash"></div>
    <!-- ............................ Action list ......................... -->
    <div class="listActions">
      <div id="actionParams" tal:condition="action[0:4] in ('imp?', 'ipk?')">
        ${form.grid_upload('pack_file', _('Pack file:'))}
        <div tal:condition="action[0:4] == 'ipk?'">${form.grid_text('message', _('Message:'))}</div>
        <div class="submit">
          ${form.submit('%s!.x' % action[0:3], _('Import file'), class_='button')}
          ${form.submit_cancel(_('Cancel'))}
        </div>
      </div>
      <div class="first">${paging.pager_top('pack22', _('Packs'))}</div>
      <div class="last" tal:switch="action == 'del?#'">Â 
        <span tal:case="True" tal:omit-tag="">
          ${form.submit('del!#.x', _('Confirm deletion'), class_='button')}
          ${form.submit_cancel(_('Cancel'))}
        </span>
        <span tal:case="False" tal:condition="action in ('', 'ccl!')" tal:omit-tag="">
          <span tal:condition="project['processing_labels']" class="processing">
            ${_('Processing:')}
            ${form.select('processing_id', None, project['processing_labels'])}
            ${form.submit_image('bld!#', _('Execute processing on selected packs'),
              '/Static/Images/action_build.png', class_="slow")}
            ${paging.pipe()}
          </span>
          <span tal:condition="i_packmaker">
            ${form.submit_image('ipk?', _('Import pack content'),
              '/Static/Images/action_upload.png')}
            ${form.button(route('pack_create', project_id=project['project_id'], _anchor='tab0'),
              src='/Static/Images/action_create.png', title=_('Create a pack'))}
            ${form.submit_image('imp?', _('Import pack settings'),
              '/Static/Images/action_import.png')}
            ${paging.pipe()}
          </span>
          ${form.submit_image('exp!#', _('Export selected pack settings'),
            '/Static/Images/action_export.png')}
          <span tal:condition="i_packmaker">
            ${paging.pipe()}
            ${form.submit_image('del?#', _('Delete packs'), '/Static/Images/action_delete.png')}
          </span>
        </span>
        <span tal:condition="action == 'del?#' or action not in ('', 'ccl!')" tal:omit-tag="">
          ${form.hidden('processing_id')}
        </span>
      </div>
    </div>
    <!-- ............................... Packs ............................ -->
    <div id="content">
      <table tal:condition="paging" class="list">
        <caption>${_('Packs')}</caption>
        <thead>
          <tr>
            <th class="checkbox" id="check_all"></th>
            <th>${paging.sortable_column(_('Pack'), 'label')}</th>
            <th>${_('Description')}</th>
            <th tal:condition="project['task_labels']">${_('Current task')}</th>
            <th class="last">${_('Actions')}</th>
          </tr>
        </thead>
        <tbody tal:repeat="pack paging">
          <tr>
            <td class="checkbox">
              ${form.checkbox('#%s' % pack.pack_id, id=None, class_='listCheck')}
            </td>
            <td>
              <span tal:switch="pack.pack_id == pack_id">
                <a tal:case="True" id="p${pack.pack_id}" class="collapse" title="${_('Close')}"
                   href="${route('pack_index', project_id=project['project_id'],
                         _anchor='p%d' % pack.pack_id)}">
                  <span tal:switch="'container' in request.session
                                    and request.session['container'].get('pack_id') == pack.pack_id" tal:omit-tag="">
                    <img tal:case="True" src="/Static/Images/collapse_current_open.png" alt="open"/>
                    <img tal:case="False" src="/Static/Images/collapse_open.png" alt="open"/>
                  </span>
                </a>
                <a tal:case="False" id="p${pack.pack_id}" class="collapse" title="${_('Open')}"
                   href="${route('pack_index_pack', project_id=project['project_id'],
                         pack_id=pack.pack_id, _anchor='p%d' % pack.pack_id, _query={'open': 1})}">
                  <span tal:switch="'container' in request.session
                                    and request.session['container'].get('pack_id') == pack.pack_id" tal:omit-tag="">
                    <img tal:case="True" src="/Static/Images/collapse_current_closed.png" alt="closed"/>
                    <img tal:case="False" src="/Static/Images/collapse_closed.png" alt="closed"/>
                  </span>
                </a>
              </span>
              <a href="${route('pack_view', project_id=project['project_id'], pack_id=pack.pack_id)}"
                 >${pack.label}</a>
            </td>
            <td class="info">${pack.description}</td>
            <td tal:condition="project['task_labels']">
              <span tal:condition="pack.task_id is not None" tal:omit-tag="">
                ${project['task_labels'][pack.task_id]}
              </span>
            </td>
            <td class="last actions" tal:switch="action == 'del?%d' % pack.pack_id">
              <span tal:case="True" id="current">
                ${form.submit('del!%d.x' % pack.pack_id, _('Confirm deletion'), class_='button')}
                ${form.submit_cancel(_('Cancel'))}
              </span>
              <span tal:case="False" tal:omit-tag="">
                <span tal:condition="project['processing_labels']" tal:omit-tag="">
                  ${form.submit_image('bld!%d' % pack.pack_id, _('Execute processing'),
                    '/Static/Images/action_build_one.png', class_='slow')}
                </span>
                <span tal:condition="i_packmaker">
                  ${form.button(route('pack_edit', project_id=project['project_id'], pack_id=pack.pack_id),
                    src='/Static/Images/action_edit_one.png', title=_('Edit pack'))}
                </span>
                ${form.submit_image('dnl!%d' % pack.pack_id, _('Download pack content'),
                  '/Static/Images/action_download_one.png')}
                ${form.submit_image('exp!%d' % pack.pack_id, _('Export pack settings'),
                  '/Static/Images/action_export_one.png')}
                <span tal:condition="i_packmaker">
                  ${form.submit_image('del?%d' % pack.pack_id, _('Delete pack'),
                    '/Static/Images/action_delete_one.png')}
                </span>
              </span>
            </td>
          </tr>
          <tr tal:condition="pack.pack_id == pack_id" class="files"
              tal:repeat="item [i + (j,) for j, k in sorted(files.items()) for i in k]"
              tal:attributes="id action[4:] == '%s/%s' % (item[1], item[2]) and 'current'">
            <!-- ...................... One pack ...................... -->
            <td> </td>
            <td colspan="${project['task_labels'] and 3 or 2}">
              <img src="/Static/Images/MimeTypes/${item[0] if item[0] in MIME_TYPES else 'unknown'}.png"
                   alt="${item[0]}" title="${item[0]}"/>
              ${FILE_TYPE_MARKS[item[5]]}
              <a href="${route('file_render', storage_id=item[1], path=item[2])}">${'%s/%s' % (item[1], item[2])}</a>
            </td>
            <td class="last">
              ${form.button(route('file_info', storage_id=item[1], path=item[2]),
                src='/Static/Images/action_info_one.png', title=_('Display file information'), class_="slow")}
              ${form.button(route('file_download', storage_id=item[1], path=item[2]),
                src='/Static/Images/action_download_one.png', title=_('Download file'))}
              ${form.button(route('storage_browse', storage_id=item[1], path=item[2]),
                src='/Static/Images/action_browse.png', title=_('View in storage'), class_="slow")}
            </td>
          </tr>
        </tbody>
      </table>
      <div id="flash" tal:condition="not paging">${_('No pack.')}</div>
    </div>
    <div class="listPager">
      <div class="first">${paging.pager_bottom('pack', _('Packs'))}</div>
      <div class="last">
        ${_('Lines per page:')} ${form.select('page_size', '', paging.page_sizes, True)}
      </div>
    </div>
  </div>
  ${form.end()}
</div>
</body>
</html>
