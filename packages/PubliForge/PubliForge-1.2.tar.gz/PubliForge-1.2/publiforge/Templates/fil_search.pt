<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="base">
<head><title></title></head>
<body>
<div id="mainPanel" metal:fill-slot="main">
  ${form.begin()}
  <div id="main">
    <h2 id="subtitle" class="search" title="${_('Search')}">${_('Advanced search')}</h2>
    <!-- ............................... Query ............................ -->
    <div id="search">
      <div class="searchQuery">
        <div class="searchOp"> </div>
        <div class="searchIndex">
          ${form.select('q0index', None,
            [('', '')] + fields + [('filename', _('+ File name')), ('*', _('+ Query'))], True)}
          <strong class="error" tal:condition="form.has_error('q0index')">${form.error('q0index')}</strong>
        </div>
        <div class="searchEqual"><img src="/Static/Images/equal.png" alt="="/></div>
        <div class="searchValue" tal:switch="values[0] is None">
          <div tal:case="True" tal:omit-tag="">${form.text('q0value')}</div>
          <div tal:case="False" tal:omit-tag="">${form.select('q0value', None, [('', '')] + values[0])}</div>
          <strong class="error" tal:condition="form.has_error('q0value')">${form.error('q0value')}</strong>
        </div>
        <div class="clear"> </div>
      </div>
      <div class="searchQuery" tal:condition="qindex[0] != '*'">
        <div class="searchOp">${form.select('q1op', None, (('AND', _('AND')), ('OR', _('OR')), ('NOT', _('EXCEPT'))))}</div>
        <div class="searchIndex">${form.select('q1index', None, [('', '')] + fields, True)}</div>
        <div class="searchEqual"><img src="/Static/Images/equal.png" alt="="/></div>
        <div class="searchValue" tal:switch="values[1] is None">
          <div tal:case="True" tal:omit-tag="">${form.text('q1value')}</div>
          <div tal:case="False" tal:omit-tag="">${form.select('q1value', None, [('', '')] + values[1])}</div>
          <strong class="error" tal:condition="form.has_error('q1value')">${form.error('q1value')}</strong>
        </div>
        <div class="clear"> </div>
      </div>
      <div class="searchQuery" tal:condition="qindex[0] != '*' and qindex[1]">
        <div class="searchOp">${form.select('q2op', None, (('AND', _('AND')), ('OR', _('OR')), ('NOT', _('EXCEPT'))))}</div>
        <div class="searchIndex">${form.select('q2index', None, [('', '')] + fields, True)}</div>
        <div class="searchEqual"><img src="/Static/Images/equal.png" alt="="/></div>
        <div class="searchValue" tal:switch="values[2] is None">
          <div tal:case="True" tal:omit-tag="">${form.text('q2value')}</div>
          <div tal:case="False" tal:omit-tag="">${form.select('q2value', None, [('', '')] + values[2])}</div>
          <strong class="error" tal:condition="form.has_error('q2value')">${form.error('q2value')}</strong>
        </div>
        <div class="clear"> </div>
      </div>
      <div class="searchScope">
        <label><em>${_('Scope:')}</em></label>
        <div id="scope">
          <div tal:repeat="item scope">
            ${form.checkbox('~%s' % item[0])} ${item[1]}
          </div>
          <div>
            ${form.checkbox('~ALL~')} ${_('All storages')}
          </div>
        </div>
        <div class="clear"> </div>
      </div>
      <div class="col11">
        <div class="colFirst">
          <div>
            <label><em>${_('Limit:')}</em></label>
            <div>${form.select('limit', None, SEARCH_LIMIT)}</div>
            <div class="clear"> </div>
          </div>
        </div>
        <div class="colLast submit">
          ${form.submit('go', _('Launch search'), class_='buttonMain slow')}
        </div>
      </div>
    </div>
    <hr/>
    <!-- ........................... Containers ........................... -->
    <div tal:condition="results" tal:define="container load: container.macro.pt" metal:use-macro="container"/>
    <!-- ............................. Flash .............................. -->
    <div tal:define="flash load: flash.macro.pt" metal:use-macro="flash"/>
    <!-- ............................... Result ........................... -->
    <div tal:condition="results is not None" tal:define="join import: os.path.join">
      <div class="listActions">
        <div class="first" tal:switch="len(results) > request.session['search']['l']">
          <span tal:case="True" tal:omit-tag="">${_('Number of results: more than ${n}', {'n': len(results) - 1})}</span>
          <span tal:case="False" tal:omit-tag="">${_('Number of results: ${n}', {'n': len(results)})}</span>
        </div>
        <div class="last">
        ${form.submit_image('dnl!#', _('Download files'), '/Static/Images/action_download.png')}
        <span tal:condition="'project' in request.session" tal:omit-tag="">
          ${form.submit_image('npk!#', _('Create a pack with selected files for "${p}"',
            dict(p=request.session['project']['label'])), '/Static/Images/action_pack.png')}
        </span>
        </div>
      </div>
      <div id="content">
        <table class="list">
          <tr>
            <th class="checkbox" id="check_all"></th>
            <th>${_('Score')}</th>
            <th>${_('File')}</th>
            <th>${_('Title/Extract')}</th>
            <th class="last">${_('Actions')}</th>
          </tr>
          <tr tal:repeat="item results">
            <td class="checkbox">
              ${form.checkbox('#%s' % join(item[2], item[3]), id=None, class_='listCheck')}
            </td>
            <td>${item[0]}</td>
            <td>
              <img src="/Static/Images/MimeTypes/${item[1] if item[1] in MIME_TYPES else 'unknown'}.png"
                   alt="${item[1] or 'unknown'}" title="${item[1] or 'unknown'}"/>
              <a href="${route('file_render', storage_id=item[2], path=item[3])}">${item[2]}/${item[3]}</a>
            </td>
            <td class="extract">
              <div tal:condition="item[4]"><strong>${item[4]}</strong></div>
              ${item[5] and u'%s…' % item[5] or ''}
            </td>
            <td class="last actions">
              ${form.button(route('file_info', storage_id=item[2], path=item[3]),
                src='/Static/Images/action_info_one.png', title=_('Display file information'), class_="slow")}
              ${form.button(route('file_download', storage_id=item[2], path=item[3]),
                src='/Static/Images/action_download_one.png', title=_('Download file'))}
              ${form.button(route('storage_browse', storage_id=item[2], path=item[3]),
                src='/Static/Images/action_browse.png', title=_('View in storage'), class_="slow")}
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
  ${form.end()}
</div>  
</body>
</html>
