<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="base">
<head>
  <title></title>
  <script metal:fill-slot="js"
          src="/Static/Js/stg_index.js" type="text/javascript"></script>
</head>
<body>
<div id="mainPanel" metal:fill-slot="main">
  <div id="main">
    ${form.begin()}
    <!-- ............................... Filter ........................... -->
    <div class="filter">
    <h3><span>${_('Storage filter')}</span></h3>
      <div class="col11">
        <div class="colFirst">
          ${form.grid_text('f_label', _('Label:'))}
          ${form.grid_select('f_engine', _('Versions:'),
            [('', '')] + vcs_engines.items(), autosubmit=True)}
        </div>
        <div class="colLast">
          ${form.grid_text('f_id', _('Identifier:'))}
        </div>
        <div class="submit">${form.submit('filter', _('Apply filter'), class_='button')}</div>
      </div>
    </div>
    <!-- ........................... Containers ........................... -->
    <div id="container"
         tal:condition="'container' in request.session and 'project' in request.session
                        and request.session['project']['perm'] in ('leader', 'packmaker')">
      <h3>${_('Containers')}</h3>
      <div class="legend">
        <div tal:condition="'pack_id' in request.session['container']" class="first">
          <img src="/Static/Images/pack.png" alt="pack" title="${_('Pack')}"/> 
          ${_('Pack "${x}" of project "${y}"',
            dict(x=request.session['container']['pack_label'], y=request.session['project']['label']))}
        </div>
        <div tal:condition="'processing_id' in request.session['container']" class="first">
          <img src="/Static/Images/processing.png" alt="processing" title="${_('Processing')}"/> 
          ${_('Processing "${x}" of project "${y}"',
            dict(x=request.session['container']['processing_label'], y=request.session['project']['label']))}
        </div>
        <div class="last">${form.submit_image('cls!', _('Close'), '/Static/Images/close_light.png')}</div>
      </div>
      <div class="content nav" tal:condition="'pack_id' in request.session['container']"
           tal:define="pack_id request.session['container'].get('pack_id')">
        <div class="first">${_('Select a storage to associate files with this pack.')}</div>
        <div class="last">
          ${form.button(route('pack_edit', project_id=request.session['project']['project_id'],
            pack_id=pack_id), _('View pack'))}
        </div>
      </div>
      <div class="content nav" tal:condition="'processing_id' in request.session['container']"
           tal:define="processing_id request.session['container'].get('processing_id')">
        <div class="first">${_('Select a storage to associate files with this processing.')}</div>
        <div class="last">
          ${form.button(route('processing_edit', project_id=request.session['project']['project_id'],
            processing_id=processing_id), _('View processing'))}
        </div>
      </div>
    </div>
    <!-- ............................. Flash .............................. -->
    <div tal:define="flash load: flash.macro.pt" metal:use-macro="flash"></div>
    <!-- ............................ Action list ......................... -->
    <h3 class="list">${_('Storage List')}</h3>
    <div class="listActions">
      <div class="first">${paging.pager_top('storage22', _('All storages'))}</div>
      <div class="last" tal:switch="working">
        <span tal:case="True" tal:omit-tag="">
          <img src="/Static/Images/wait_synchro.gif" alt="In progress"
               title="${_('In progress...')}" id="refresh" tal:attributes="class refresh"/>
        </span>
        <span tal:case="False" tal:omit-tag="">
          ${form.submit_image('exp!#', _('Export selected storages'),
            '/Static/Images/action_export.png')}
          ${paging.pipe()}
          ${form.submit_image('syn!#', _('Synchronize storages'),
            '/Static/Images/action_synchronize.png')}
        </span>
      </div>
    </div>
    <!-- ............................ Storages .......................... -->
    <div id="content">
      <table class="list">
        <caption>${_('Storages')}</caption>
        <tr>
          <th class="checkbox" id="check_all"></th>
          <th>${paging.sortable_column(_('Label'), 'label')}</th>
          <th>${paging.sortable_column(_('Identifier'), 'storage_id')}</th>
          <th>${_('Versions')}</th>
          <th class="last">${_('Age/Date')}</th>
          <th class="last">${_('Revision')}</th>
          <th>${_('User')}</th>
          <th class="last">${_('Actions')}</th>
        </tr>
        <tr tal:repeat="stg paging">
          <td class="checkbox">
            ${form.checkbox('#%s' % stg.storage_id, id=None, class_='listCheck')}
          </td>
          <td>
            <a href="${route('storage_root', storage_id=stg.storage_id)}"
               title="${stg.description}" class="slow">${stg.label}</a>
          </td>
          <td>
            <a href="${route('storage_root', storage_id=stg.storage_id)}"
               title="${stg.description}" class="slow">${stg.storage_id}</a>
          </td>
          <td class="info">${_(vcs_engines.get(stg.vcs_engine, stg.vcs_engine)).partition(u'–')[2]}</td>
          <td class="info last" title="${changes[stg.storage_id][0][1]}">
            ${changes[stg.storage_id][0][0]}
          </td>
          <td class="info center">${changes[stg.storage_id][1]}</td>
          <td class="info">${changes[stg.storage_id][2]}</td>
          <td class="last actions">
            <span tal:switch="stg.storage_id in in_menus" tal:omit-tag="">
              <span tal:case="True" tal:omit-tag="">
                ${form.submit_image('men-%s' % stg.storage_id, _('Remove from menu'),
                  '/Static/Images/in_menu_on.png')}
              </span>
              <span tal:case="False" tal:omit-tag="">
                ${form.submit_image('men+%s' % stg.storage_id, _('Display in menu'),
                  '/Static/Images/in_menu_off.png')}
              </span>
            </span>
            ${form.button(route('storage_view', storage_id=stg.storage_id),
              src='/Static/Images/action_info_one.png', title=_('View settings'))}
            ${form.submit_image('exp!%s' % stg.storage_id, _('Export storage settings'),
              '/Static/Images/action_export_one.png')}
            <span tal:switch="stg.storage_id in progress and progress[stg.storage_id][0] == 'run'"
                  tal:omit-tag="">
              <span tal:case="True" tal:omit-tag="">
                <img src="/Static/Images/wait_synchro.gif" alt="In progress"
                     title="${_('In progress...')}" class="wait" id="${stg.storage_id}"/>
              </span>
              <span tal:case="False" tal:omit-tag="">
                ${form.submit_image('syn!%s' % stg.storage_id, _('Synchronize storage'),
                  '/Static/Images/action_synchronize_one.png')}
              </span>
            </span>
            <div tal:condition="stg.storage_id in progress and progress[stg.storage_id][0] == 'error'"
                 class="error">
              ${progress[stg.storage_id][1]}
            </div>
         </td>
        </tr>
      </table>
    </div>
    <div class="listPager">
      <div class="first">${paging.pager_bottom('storage', _('All storages'))}</div>
      <div class="last">
        ${_('Lines per page:')} ${form.select('page_size', '', paging.page_sizes, True)}
      </div>
    </div>
    ${form.end()}
  </div>
</div>
</body>
</html>
