<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="base">
<head>
  <title></title>
  <script metal:fill-slot="js"
          src="/Static/Js/bld_view.js" type="text/javascript"></script>
</head>
<body>
<div id="mainPanel" metal:fill-slot="main">
  ${form.begin(request.current_route_path(_anchor='current'), multipart=True)}
  <!-- ............................... Buttons ............................ -->
  <div id="buttons">
    <div class="first">
      ${request.breadcrumbs.back_button()}
    </div>
   <div class="last">
     ${form.submit('bld!.x', _('Launch build'), class_='buttonMain slow')}
     ${form.submit('exp!.x', _('Export'))}
     ${form.button(route('project_dashboard', project_id=project['project_id']), _('View dashboard'))}
    </div>
    <hr class="hidden"/>
  </div>
  <div id="main">
    <h2 id="subtitle" class="build" title="${_('Build')}">${project['label']}</h2>
    <!-- ............................. Flash .............................. -->
    <div tal:define="flash load: flash.macro.pt" metal:use-macro="flash"/>
    <!-- ............................ Processing .......................... -->
    <div tal:define="build_processing load: bld_processing.macro.pt" metal:use-macro="build_processing"/>
    <!-- ............................... Pack ............................. -->
    <div class="formItem">
      <label><em>${_('Pack:')}</em></label>
      <div id="pack" class="files" tal:define="files [k for k in pack.files if k.visible]">
        <h3><a href="${route('pack_view', project_id=pack.project_id, pack_id=pack.pack_id)}">${pack.label}</a></h3>
        <ul tal:condition="len(files)">
          <li tal:repeat="item files">
            <div tal:define="build_pack load: bld_pack.macro.pt" metal:use-macro="build_pack"/>
          </li>
        </ul>
      </div>
      <div class="clear"></div>
    </div>
    <!-- .............................. Output ............................ -->
    <div tal:define="build_output load: bld_output.macro.pt" metal:use-macro="build_output"></div>
    <!-- .............................. Result ............................ -->
    <div tal:condition="result" tal:omit-tag="" tal:define="datetime import: datetime">
      <div class="formItem"><label></label><div><hr/></div></div>
      <div class="formItem">
        <label><em>${_('Build:')}</em></label>
        <div id="build"><h3>${datetime.datetime.fromtimestamp(result['log'][0][0]).isoformat(' ').split('.')[0]}</h3></div>
        <div class="clear"></div>
      </div>
      <div class="formItem">
        <label><em>${_('Playing time:')}</em></label>
        <div id="playing">${str(datetime.timedelta(seconds=result['log'][-1][0] - result['log'][0][0])).split('.')[0]}</div>
        <div class="clear"></div>
      </div>
      <div class="formItem">
        <label><em>${_('Message:')}</em></label>
        <div id="status"><b>${message or u'Â '}</b></div>
      </div>
      <div class="formItem" tal:condition="'values' in result">
        <label><em>${_('Values:')}</em></label>
        <div id="values">
          <pre tal:repeat="value result['values']">${value}</pre>
        </div>
        <div class="clear"></div>
      </div>
      <div class="formItem" tal:condition="'files' in result">
        <label><em>${_('Files:')}</em></label>
        <div class="files">
          <ul id="files" tal:define="join import: os.path.join">
            <li tal:repeat="filename result['files']"
                tal:define="sid output['storage_id'] ; path output['path']">
              ${form.button(route('file_download', storage_id=sid, path=join(path, filename)),
                src='/Static/Images/action_download.png', title=_('Download file'))}
              ${form.button(route('storage_browse', storage_id=sid, path=join(path, filename)),
                src='/Static/Images/action_browse.png', title=_('View in storage'), class_="slow")}
              <a href="${route('file_render', storage_id=sid, path=join(path, filename))}">${join(sid, path, filename)}</a>
            </li>
          </ul>
        </div>
        <div class="clear"></div>
      </div>
      <!-- ............................... Log ............................ -->
      <div class="formItem">
        <label><em>${_('Log:')}</em></label>
        <div id="log" class="${result['status']}">
          ${form.button(route('build_log', build_id=build['build_id']), title=_('Download log'),
            src='/Static/Images/log_download.png')}
        </div>
        <div class="clear"></div>
      </div>
      <pre id="logLines">${log}</pre>
    </div>
    <div id="content" tal:condition="not result"></div>
  </div>
  ${form.end()}
</div>
</body>
</html>
