<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="jalon.content">

<body>

<metal:content-core fill-slot="content">

<metal:macro define-macro="mescours_liste">

<tal:define define="folderContents python:context.getContents(subjects,
                   typeR='JalonCours',
                   authMember=user.getId(),
                   repertoire='Cours',
                   categorie=categorie);">

            <div class="panel callout radius"
                 tal:condition="not:folderContents"
                 i18n:translate="">
                Aucun élément
            </div>

    <tal:listing condition="folderContents">

            <table summary="Liste des cours de la catégorie">
                <thead>
                    <tr>
                        <th class="sort show-for-medium-up has-tip" data-tooltip data-sort="new" 
                            title="Trier selon la nouveauté" i18n:attributes="title">
                            <span>
                                <i class="fa fa-sort"></i>
                                <i class="fa fa-sort-asc"></i>
                                <i class="fa fa-sort-desc"></i>
                                <span class="fa fa-bell-o fa-fw no-pad"></span>
                            </span>
                        </th>
                        <th class="sort has-tip" data-tooltip data-sort="favori" 
                            title="Trier selon les favoris" i18n:attributes="title">
                            <span>
                                <i class="fa fa-sort"></i>
                                <i class="fa fa-sort-asc"></i>
                                <i class="fa fa-sort-desc"></i>
                                <tal:block i18n:translate="">Favori</tal:block>
                            </span>
                        </th>
                        <th class="sort text-left has-tip" data-tooltip data-sort="title" title="Trier selon le titre" i18n:attributes="title">
                            <span>
                                <i class="fa fa-sort"></i>
                                <i class="fa fa-sort-asc"></i>
                                <i class="fa fa-sort-desc"></i>
                                <tal:block i18n:translate="">Titre</tal:block>
                            </span>
                        </th>
                        <th class="sort has-tip" data-tooltip data-sort="role" title="Trier selon le rôle" i18n:attributes="title">
                            <span>
                                <i class="fa fa-sort"></i>
                                <i class="fa fa-sort-asc"></i>
                                <i class="fa fa-sort-desc"></i>
                                <tal:block i18n:translate="">Rôle</tal:block>
                            </span>
                        </th>
                        <th class="sort show-for-medium-up has-tip" data-tooltip data-sort="acc_etu" title="Trier selon l'accès étudiant" i18n:attributes="title">
                            <span>
                                <i class="fa fa-sort"></i>
                                <i class="fa fa-sort-asc"></i>
                                <i class="fa fa-sort-desc"></i>
                                <tal:block i18n:translate="">Ac. étu.</tal:block>
                            </span>
                        </th>
                        <th class="sort show-for-medium-up has-tip" data-tooltip data-sort="acc_pass" title="Trier selon l'accès par mot de passe" i18n:attributes="title">
                            <span>
                                <i class="fa fa-sort"></i>
                                <i class="fa fa-sort-asc"></i>
                                <i class="fa fa-sort-desc"></i>
                                <tal:block i18n:translate="">Ac. pass.</tal:block>
                            </span>
                        </th>
                        <th class="sort show-for-medium-up has-tip" data-tooltip data-sort="acc_anon" title="Trier selon l'accès public" i18n:attributes="title">
                            <span>
                                <i class="fa fa-sort"></i>
                                <i class="fa fa-sort-asc"></i>
                                <i class="fa fa-sort-desc"></i>
                                <tal:block i18n:translate="">Ac. pub.</tal:block>
                            </span>
                        </th>
                        <th class="action show-for-medium-up has-tip" data-tooltip title="Actions (auteur uniquement)" i18n:attributes="title">
                            <i class="fa fa-cog fa-lg no-pad" title="Actions" i18n:attributes="title"></i>
                        </th>
                    </tr>
                </thead>
                <tfoot></tfoot>
                <tbody class="list">

        <tal:entry repeat="item folderContents">

                    <tr tal:define="role item/getRoleCat;
                                    isAuteur python:context.test(user.getId() in role['auteur'], 1, 0);
                                    isCoAuteur python:context.test(user.getId() in role['coauteur'], 1, 0);
                                    isCoLecteur python:context.test(user.getId() in role['colecteur'], 1, 0)"
                        tal:condition="python:context.test(isAuteur or isCoAuteur or isCoLecteur, 1, 0)">
                        <td class="new show-for-medium-up"
                            tal:define="isNouveau python:cmp(item.getDateDerniereActu, user.getProperty('login_time', None)) > 0">
                    <tal:isNouveau condition="isNouveau">
                                <span class="hide"
                                      tal:content="item/modified" />
                                <i class="fa fa-bell-o fa-fw no-pad"></i>
                    </tal:isNouveau>
                    <tal:isNotNouveau condition="not:isNouveau">
                                <span class="hide">Z<tal:replace replace="item/modified"/></span>
                    </tal:isNotNouveau>
                        </td>
                        <td class="favori"
                            tal:define="isFavori python:context.test(user.getId() in item.Subject, 'Oui', 'Non')">
                            <a class="favorite-selector" title="Permuter l'attribut « favori » de ce cours"
                               tal:attributes="data-href string:${item/getURL}/setFavori?fav=${isFavori};
                                               data-href_root string:${item/getURL};
                                               data-href_attr string:${isFavori};
                                               data-item_name item/Title;
                                               data-success_msg_pre string:Le cours;
                                               data-success_msg_post_fav string:est un cours favori.;
                                               data-success_msg_post_nofav string:n'est plus un cours favori."
                               i18n:attributes="title; data-success_msg_pre; data-success_msg_post_fav; data-success_msg_post_nofav">
                                <i tal:attributes="class python:context.test(isFavori == 'Oui', 'js-fav fa fa-star fa-lg no-pad', 'js-fav fa fa-star-o fa-lg no-pad')"></i>
                            </a>
                        </td>
                        <td class="title">
                            <span class="hide" tal:content="item/Title" />
                            <a title="Ouvrir le cours"
                               tal:attributes="href string:${item/getURL}/view"
                               tal:content="python:here.getShortText(item['Title'])"
                               i18n:attributes="title" />
                            <span class="show-for-medium-up"
                                  tal:condition="item/Description">
                                <tal:block content="python:here.getShortText(item['Description'], 210)" />
                                <tal:block define="auteurs role/auteur"
                                           condition="not:isAuteur">
                                    <tal:block i18n:translate="">par</tal:block>
                                    <strong tal:content="python:context.test(auteurs[-1]!='',context.getDisplayName(auteurs[-1]),context.getDisplayName(auteurs[0]))" />
                                </tal:block>
                            </span>
                            <span class="show-for-small-only"
                                  tal:define="auteurs role/auteur"
                                  tal:condition="not:isAuteur">
                                <tal:block i18n:translate="">par</tal:block>
                                <tal:replace replace="python:context.test(auteurs[-1]!='',context.getDisplayName(auteurs[-1]),context.getDisplayName(auteurs[0]))" />
                            </span>
                        </td>
                        <td class="role">
                            <span tal:condition="isAuteur"
                                  class="label bkgrnd"
                                  i18n:translate="">Auteur</span>
                            <span tal:condition="isCoAuteur"
                                  class="label bkgrnd"
                                  i18n:translate="">Co-auteur</span>
                            <span tal:condition="isCoLecteur"
                                  class="label bkgrnd"
                                  i18n:translate="">Lecteur</span>
                        </td>
                        <td class="acc_etu show-for-medium-up"
                            tal:define="etudiants item/getRechercheAcces;
                                        acces python:context.test(len(etudiants) > 0, 'Oui', 'Non')">
                            <i tal:attributes="class python:context.test(acces == 'Oui', 'fa fa-check fa-lg no-pad success', 'fa fa-times fa-lg no-pad warning')"></i>
                        </td>
                        <td class="acc_pass show-for-medium-up"
                            tal:define="password item/getLibre;">
                            <i tal:attributes="class python:context.test(password, 'fa fa-check fa-lg no-pad success', 'fa fa-times fa-lg no-pad warning')"></i>
                        </td>
                        <td class="acc_anon show-for-medium-up"
                            tal:define="typeCours item/getAcces;
                                        acces python:context.test(typeCours == 'Public', 'Oui', 'Non')">
                            <i tal:attributes="class python:context.test(acces == 'Oui', 'fa fa-check fa-lg no-pad success', 'fa fa-times fa-lg no-pad warning')"></i>
                        </td>
                        <td class="show-for-medium-up">

            <tal:block condition="python:context.test(user.getId() in role['auteur'], 1, 0)">

                            <a class="dropdown" data-options="align:left"
                               tal:attributes="data-dropdown string:drop-${repeat/item/index}">
                                <i class="fa fa-cog fa-fw fa-lg no-pad"></i>
                            </a>
                            <ul class="f-dropdown" data-dropdown-content="data-dropdown-content"
                                tal:attributes="id string:drop-${repeat/item/index}">
                                <li>
                                    <a data-reveal-id="reveal-cours" data-reveal-ajax="true"
                                       tal:attributes="href string:${item/getURL}/folder_form?macro=macro_mescours&amp;formulaire=dupliquer">
                                        <i class="fa fa-code-fork fa-fw"></i>
                                        <tal:block i18n:translate="">Dupliquer</tal:block>
                                    </a>
                                </li>
                                <li>
                                    <a data-reveal-id="reveal-cours" data-reveal-ajax="true"
                                       tal:attributes="href string:${item/getURL}/folder_form?macro=macro_mescours&amp;formulaire=purger">
                                        <i class="fa fa-filter fa-fw"></i>
                                        <tal:block i18n:translate="">Purger</tal:block>
                                    </a>
                                </li>
                                <li>
                                    <a data-reveal-id="reveal-cours" data-reveal-ajax="true"
                                       tal:attributes="href string:${item/getURL}/folder_form?macro=macro_form&amp;formulaire=supprimer">
                                        <i class="fa fa-trash-o fa-fw"></i>
                                        <tal:block i18n:translate="">Supprimer</tal:block>
                                    </a>
                                </li>
                            </ul>
            </tal:block>

                        </td>
                    </tr>
        </tal:entry>

                </tbody>
            </table>

            <!-- L'attribut data-options permet d'éviter un bug à la fermeture du popup dans certaines conditions non vraiment définies… -->
            <div id="reveal-cours" class="reveal-modal medium" data-reveal="data-reveal" data-options="close_on_background_click: true;"></div>

    <tal:condition condition="not:is_ajax">

        <tal:block define="script1 string:setSortableList('js-list-cours',['new','favori','title','role','acc_etu','acc_pass','acc_anon'],'new','desc');
                           script2 string:setFavoriteState()">
            <tal:jsBuffer define="addJsContent python:jsBuffer.addJS(script1)" />
            <tal:jsBuffer define="addJsContent python:jsBuffer.addJS(script2)" />
        </tal:block>

    </tal:condition>

    <tal:condition condition="is_ajax">

            <!--script charset="UTF-8"
                    tal:content="structure string:$$(document).foundation('dropdown', 'reflow')">
            </script-->
            <!-- Le reflow échoue parfois… -->
            <script charset="UTF-8"
                    tal:content="structure string:$$(document).foundation({dropdown:{align:'left'}})">
            </script>

        <tal:block define="script1 string:setSortableList('js-list-cours',['new','favori','title','role','acc_etu','acc_anon'],'new','desc');
                           script2 string:setFavoriteState()">
            <tal:jsBuffer define="addDirectJsContent python:jsBuffer.addJSDirect(script1)" />
            <tal:jsBuffer define="addDirectJsContent python:jsBuffer.addJSDirect(script2)" />
        </tal:block>

            <script charset="UTF-8"
                    tal:define="buffer python:jsBuffer.getDirectBuffer()"
                    tal:content="structure buffer">
            </script>

    </tal:condition>

    </tal:listing>
</tal:define>

</metal:macro>

</metal:content-core>

</body>

</html>
