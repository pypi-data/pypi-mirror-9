<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: payslip.views</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="payslip.templatetags.payslip_tags.html">payslip.templatetags.payslip_tags</a> &lt;&lt;
  <a href="../index.html">index</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">payslip.views</span>:
    150 total statements,
    <span class="normal">100.0% covered</span>
  </h1>
  <p>Generated: Sat 2015-02-07 20:31 CET</p>
  <p>Source file: /home/tobi/Projects/django-payslip/src/payslip/views.py</p>
  <p>
    Stats:
    <span class="executed">136 executed</span>,
    <span class="missed">0 missed</span>,
    <span class="excluded">14 excluded</span>,
    <span class="ignored">236 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="ignored"><code>"""Views for the ``online_docs`` app."""</code></li>
<li class="excluded"><code>import cStringIO as StringIO</code></li>
<li class="excluded"><code>from datetime import datetime</code></li>
<li class="excluded"><code>import os</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from django.contrib.auth.decorators import login_required</code></li>
<li class="excluded"><code>from django.core.urlresolvers import reverse</code></li>
<li class="excluded"><code>from django.db.models import Q, Sum</code></li>
<li class="excluded"><code>from django.http import Http404, HttpResponse</code></li>
<li class="excluded"><code>from django.utils.decorators import method_decorator</code></li>
<li class="excluded"><code>from django.views.generic import (</code></li>
<li class="ignored"><code>    CreateView,</code></li>
<li class="ignored"><code>    DeleteView,</code></li>
<li class="ignored"><code>    FormView,</code></li>
<li class="ignored"><code>    TemplateView,</code></li>
<li class="ignored"><code>    UpdateView,</code></li>
<li class="ignored"><code>)</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from dateutil import relativedelta, rrule</code></li>
<li class="excluded"><code>from xhtml2pdf import pisa</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from .app_settings import CURRENCY</code></li>
<li class="excluded"><code>from .forms import (</code></li>
<li class="ignored"><code>    EmployeeForm,</code></li>
<li class="ignored"><code>    ExtraFieldForm,</code></li>
<li class="ignored"><code>    PaymentForm,</code></li>
<li class="ignored"><code>    PayslipForm,</code></li>
<li class="ignored"><code>)</code></li>
<li class="excluded"><code>from .models import (</code></li>
<li class="ignored"><code>    Company,</code></li>
<li class="ignored"><code>    Employee,</code></li>
<li class="ignored"><code>    ExtraField,</code></li>
<li class="ignored"><code>    ExtraFieldType,</code></li>
<li class="ignored"><code>    Payment,</code></li>
<li class="ignored"><code>    PaymentType,</code></li>
<li class="ignored"><code>)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># -------------#</code></li>
<li class="ignored"><code># Mixins       #</code></li>
<li class="ignored"><code># -------------#</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PermissionMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle security functions."""</code></li>
<li class="executed"><code>    @method_decorator(login_required)</code></li>
<li class="ignored"><code>    def dispatch(self, request, *args, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Makes sure that the user is logged in and has the right to display this</code></li>
<li class="ignored"><code>        view.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        """</code></li>
<li class="executed"><code>        if not request.user.is_staff:</code></li>
<li class="executed"><code>            raise Http404</code></li>
<li class="executed"><code>        return super(PermissionMixin, self).dispatch(request, *args, **kwargs)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_success_url(self):</code></li>
<li class="executed"><code>        return reverse('payslip_dashboard')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class CompanyMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle company related functions."""</code></li>
<li class="executed"><code>    @method_decorator(login_required)</code></li>
<li class="ignored"><code>    def dispatch(self, request, *args, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Makes sure that the user is logged in and has the right to display this</code></li>
<li class="ignored"><code>        view.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        """</code></li>
<li class="executed"><code>        self.kwargs = kwargs</code></li>
<li class="executed"><code>        self.object = self.get_object()</code></li>
<li class="executed"><code>        try:</code></li>
<li class="executed"><code>            Employee.objects.get(company=self.object, user=request.user,</code></li>
<li class="ignored"><code>                                 is_manager=True)</code></li>
<li class="executed"><code>        except Employee.DoesNotExist:</code></li>
<li class="executed"><code>            if not request.user.is_staff:</code></li>
<li class="executed"><code>                raise Http404</code></li>
<li class="executed"><code>        return super(CompanyMixin, self).dispatch(request, *args, **kwargs)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_success_url(self):</code></li>
<li class="executed"><code>        return reverse('payslip_dashboard')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class CompanyPermissionMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle company-wide permissions functions."""</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @method_decorator(login_required)</code></li>
<li class="ignored"><code>    def dispatch(self, request, *args, **kwargs):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Makes sure that the user is logged in and has the right to display this</code></li>
<li class="ignored"><code>        view.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        """</code></li>
<li class="executed"><code>        try:</code></li>
<li class="executed"><code>            self.company = Employee.objects.get(</code></li>
<li class="ignored"><code>                user=request.user, is_manager=True).company</code></li>
<li class="executed"><code>        except Employee.DoesNotExist:</code></li>
<li class="executed"><code>            if not request.user.is_staff:</code></li>
<li class="executed"><code>                raise Http404</code></li>
<li class="executed"><code>            self.company = None</code></li>
<li class="executed"><code>        return super(CompanyPermissionMixin, self).dispatch(request, *args,</code></li>
<li class="ignored"><code>                                                            **kwargs)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_success_url(self):</code></li>
<li class="executed"><code>        return reverse('payslip_dashboard')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class EmployeeMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle employee related functions."""</code></li>
<li class="executed"><code>    form_class = EmployeeForm</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_form_kwargs(self):</code></li>
<li class="executed"><code>        kwargs = super(EmployeeMixin, self).get_form_kwargs()</code></li>
<li class="executed"><code>        kwargs.update({'company': self.company})</code></li>
<li class="executed"><code>        return kwargs</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle extra field related functions."""</code></li>
<li class="executed"><code>    model = ExtraField</code></li>
<li class="executed"><code>    form_class = ExtraFieldForm</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldTypeMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle extra field type related functions."""</code></li>
<li class="executed"><code>    model = ExtraFieldType</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle payment related functions."""</code></li>
<li class="executed"><code>    model = Payment</code></li>
<li class="executed"><code>    form_class = PaymentForm</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentTypeMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle payment type related functions."""</code></li>
<li class="executed"><code>    model = PaymentType</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># -------------#</code></li>
<li class="ignored"><code># Views        #</code></li>
<li class="ignored"><code># -------------#</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class DashboardView(PermissionMixin, TemplateView):</code></li>
<li class="ignored"><code>    """Dashboard to navigate through the payslip app."""</code></li>
<li class="executed"><code>    template_name = 'payslip/dashboard.html'</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_context_data(self, **kwargs):</code></li>
<li class="executed"><code>        return {</code></li>
<li class="ignored"><code>            'companies': Company.objects.all(),</code></li>
<li class="ignored"><code>            'employees': Employee.objects.all(),</code></li>
<li class="ignored"><code>            'extra_field_types': ExtraFieldType.objects.all(),</code></li>
<li class="ignored"><code>            'fixed_value_extra_fields': ExtraField.objects.filter(</code></li>
<li class="ignored"><code>                field_type__fixed_values=True),</code></li>
<li class="ignored"><code>            'payments': Payment.objects.all(),</code></li>
<li class="ignored"><code>            'payment_types': PaymentType.objects.all(),</code></li>
<li class="ignored"><code>        }</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class CompanyCreateView(PermissionMixin, CreateView):</code></li>
<li class="ignored"><code>    """Classic view to create a company."""</code></li>
<li class="executed"><code>    model = Company</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_success_url(self):</code></li>
<li class="executed"><code>        return reverse('payslip_dashboard')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class CompanyUpdateView(CompanyMixin, UpdateView):</code></li>
<li class="ignored"><code>    """Classic view to update a company."""</code></li>
<li class="executed"><code>    model = Company</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class CompanyDeleteView(CompanyMixin, DeleteView):</code></li>
<li class="ignored"><code>    """Classic view to delete a company."""</code></li>
<li class="executed"><code>    model = Company</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class EmployeeCreateView(CompanyPermissionMixin, EmployeeMixin, CreateView):</code></li>
<li class="ignored"><code>    """Classic view to create an employee."""</code></li>
<li class="executed"><code>    model = Employee</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class EmployeeUpdateView(CompanyPermissionMixin, EmployeeMixin, UpdateView):</code></li>
<li class="ignored"><code>    """Classic view to update an employee."""</code></li>
<li class="executed"><code>    model = Employee</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class EmployeeDeleteView(CompanyPermissionMixin, EmployeeMixin, DeleteView):</code></li>
<li class="ignored"><code>    """Classic view to delete an employee."""</code></li>
<li class="executed"><code>    model = Employee</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldTypeCreateView(PermissionMixin, ExtraFieldTypeMixin,</code></li>
<li class="ignored"><code>                               CreateView):</code></li>
<li class="ignored"><code>    """Classic view to create an extra field type."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldTypeUpdateView(PermissionMixin, ExtraFieldTypeMixin,</code></li>
<li class="ignored"><code>                               UpdateView):</code></li>
<li class="ignored"><code>    """Classic view to update an extra field type."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldTypeDeleteView(PermissionMixin, ExtraFieldTypeMixin,</code></li>
<li class="ignored"><code>                               DeleteView):</code></li>
<li class="ignored"><code>    """Classic view to delete an extra field type."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldCreateView(PermissionMixin, ExtraFieldMixin, CreateView):</code></li>
<li class="ignored"><code>    """Classic view to create an extra field."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldUpdateView(PermissionMixin, ExtraFieldMixin, UpdateView):</code></li>
<li class="ignored"><code>    """Classic view to update an extra field."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldDeleteView(PermissionMixin, ExtraFieldMixin, DeleteView):</code></li>
<li class="ignored"><code>    """Classic view to delete an extra field."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentTypeCreateView(CompanyPermissionMixin, PaymentTypeMixin,</code></li>
<li class="ignored"><code>                            CreateView):</code></li>
<li class="ignored"><code>    """Classic view to create a payment type."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentTypeUpdateView(CompanyPermissionMixin, PaymentTypeMixin,</code></li>
<li class="ignored"><code>                            UpdateView):</code></li>
<li class="ignored"><code>    """Classic view to update a payment type."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentTypeDeleteView(CompanyPermissionMixin, PaymentTypeMixin,</code></li>
<li class="ignored"><code>                            DeleteView):</code></li>
<li class="ignored"><code>    """Classic view to delete a payment type."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentCreateView(CompanyPermissionMixin, PaymentMixin, CreateView):</code></li>
<li class="ignored"><code>    """Classic view to create a payment."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentUpdateView(CompanyPermissionMixin, PaymentMixin, UpdateView):</code></li>
<li class="ignored"><code>    """Classic view to update a payment."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentDeleteView(CompanyPermissionMixin, PaymentMixin, DeleteView):</code></li>
<li class="ignored"><code>    """Classic view to delete a payment."""</code></li>
<li class="executed"><code>    pass</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PayslipGeneratorView(CompanyPermissionMixin, FormView):</code></li>
<li class="ignored"><code>    """View to present a small form to generate a custom payslip."""</code></li>
<li class="executed"><code>    template_name = 'payslip/payslip_form.html'</code></li>
<li class="executed"><code>    form_class = PayslipForm</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_form_kwargs(self):</code></li>
<li class="executed"><code>        kwargs = super(PayslipGeneratorView, self).get_form_kwargs()</code></li>
<li class="executed"><code>        kwargs.update({'company': self.company})</code></li>
<li class="executed"><code>        return kwargs</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_template_names(self):</code></li>
<li class="executed"><code>        if hasattr(self, 'post_data'):</code></li>
<li class="executed"><code>            return ['payslip/payslip.html']</code></li>
<li class="executed"><code>        return super(PayslipGeneratorView, self).get_template_names()</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_context_data(self, **kwargs):</code></li>
<li class="executed"><code>        kwargs = super(PayslipGeneratorView, self).get_context_data(**kwargs)</code></li>
<li class="executed"><code>        if hasattr(self, 'post_data'):</code></li>
<li class="ignored"><code>            # Get form data</code></li>
<li class="executed"><code>            employee = Employee.objects.get(pk=self.post_data.get('employee'))</code></li>
<li class="executed"><code>            date_start = datetime.strptime(</code></li>
<li class="ignored"><code>                '{}-{}-01'.format(</code></li>
<li class="ignored"><code>                    self.post_data.get('year'), self.post_data.get('month')),</code></li>
<li class="ignored"><code>                '%Y-%m-%d',</code></li>
<li class="ignored"><code>            )</code></li>
<li class="executed"><code>            january_1st = datetime.strptime(</code></li>
<li class="ignored"><code>                '{}-01-01'.format(self.post_data.get('year')),</code></li>
<li class="ignored"><code>                '%Y-%m-%d',</code></li>
<li class="ignored"><code>            )</code></li>
<li class="executed"><code>            date_end = (date_start + relativedelta.relativedelta(months=1)</code></li>
<li class="ignored"><code>                        - relativedelta.relativedelta(days=1))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # Get payments for the selected year</code></li>
<li class="executed"><code>            payments_year = employee.payments.filter(</code></li>
<li class="ignored"><code>                # Recurring payments with past date and end_date in the</code></li>
<li class="ignored"><code>                # selected year or later</code></li>
<li class="ignored"><code>                Q(date__lte=date_end, end_date__gte=january_1st) |</code></li>
<li class="ignored"><code>                # Recurring payments with past date in period and open end</code></li>
<li class="ignored"><code>                Q(date__lte=date_end, end_date__isnull=True,</code></li>
<li class="ignored"><code>                  payment_type__rrule__isnull=False)</code></li>
<li class="ignored"><code>            ).exclude(payment_type__rrule__exact='') | employee.payments.filter(</code></li>
<li class="ignored"><code>                # Single payments in this year</code></li>
<li class="ignored"><code>                date__year=date_start.year, payment_type__rrule__exact='',</code></li>
<li class="ignored"><code>            )</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # Get payments for the selected period</code></li>
<li class="executed"><code>            payments = payments_year.exclude(</code></li>
<li class="ignored"><code>                # Exclude single payments not transferred in the period</code></li>
<li class="ignored"><code>                Q(date__lt=date_start) |</code></li>
<li class="ignored"><code>                Q(date__gt=date_end),</code></li>
<li class="ignored"><code>                Q(payment_type__rrule__exact=''),</code></li>
<li class="ignored"><code>            ).filter(</code></li>
<li class="ignored"><code>                # Recurring payments with past date and end_date in the period</code></li>
<li class="ignored"><code>                Q(end_date__gte=date_end, date__lte=date_end) |</code></li>
<li class="ignored"><code>                # Recurring payments with past date in period and open end</code></li>
<li class="ignored"><code>                Q(date__lte=date_end, end_date__isnull=True)</code></li>
<li class="ignored"><code>            )</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # Yearly positive summary</code></li>
<li class="executed"><code>            sum_year = payments_year.filter(</code></li>
<li class="ignored"><code>                amount__gt=0, payment_type__rrule__exact='').aggregate(</code></li>
<li class="ignored"><code>                    Sum('amount')).get('amount__sum') or 0</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # Yearly negative summary</code></li>
<li class="executed"><code>            sum_year_neg = payments_year.filter(</code></li>
<li class="ignored"><code>                amount__lt=0, payment_type__rrule__exact='').aggregate(</code></li>
<li class="ignored"><code>                    Sum('amount')).get('amount__sum') or 0</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # Yearly summary of recurring payments</code></li>
<li class="executed"><code>            for payment in payments_year.exclude(</code></li>
<li class="ignored"><code>                    payment_type__rrule__exact=''):</code></li>
<li class="ignored"><code>                # If the recurring payment started in a year before, let's take</code></li>
<li class="ignored"><code>                # January 1st as a start, otherwise take the original date</code></li>
<li class="executed"><code>                if payment.get_date_without_tz().year &lt; date_start.year:</code></li>
<li class="executed"><code>                    start = january_1st</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="executed"><code>                    start = payment.get_date_without_tz()</code></li>
<li class="ignored"><code>                # If the payments ends before the period's end date, let's take</code></li>
<li class="ignored"><code>                # this date, otherwise we can take the period's end</code></li>
<li class="executed"><code>                if (payment.end_date</code></li>
<li class="ignored"><code>                        and payment.get_end_date_without_tz() &lt; date_end):</code></li>
<li class="executed"><code>                    end = payment.get_end_date_without_tz()</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="executed"><code>                    end = date_end</code></li>
<li class="executed"><code>                recurrings = rrule.rrule(</code></li>
<li class="ignored"><code>                    rrule._rrulestr._freq_map.get(payment.payment_type.rrule),</code></li>
<li class="ignored"><code>                    dtstart=start, until=end,</code></li>
<li class="ignored"><code>                )</code></li>
<li class="ignored"><code>                # Multiply amount with recurrings</code></li>
<li class="executed"><code>                if payment.amount &gt; 0:</code></li>
<li class="executed"><code>                    sum_year += payment.amount * recurrings.count()</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="executed"><code>                    sum_year_neg += payment.amount * recurrings.count()</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>            # Period summaries</code></li>
<li class="executed"><code>            sum = payments.filter(amount__gt=0).aggregate(</code></li>
<li class="ignored"><code>                Sum('amount')).get('amount__sum') or 0</code></li>
<li class="executed"><code>            sum_neg = payments.filter(amount__lt=0).aggregate(</code></li>
<li class="ignored"><code>                Sum('amount')).get('amount__sum') or 0</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>            kwargs.update({</code></li>
<li class="ignored"><code>                'employee': employee,</code></li>
<li class="ignored"><code>                'date_start': date_start,</code></li>
<li class="ignored"><code>                'date_end': date_end,</code></li>
<li class="ignored"><code>                'payments': payments,</code></li>
<li class="ignored"><code>                'payment_extra_fields': ExtraFieldType.objects.filter(</code></li>
<li class="ignored"><code>                    model='Payment'),</code></li>
<li class="ignored"><code>                'sum_year': sum_year,</code></li>
<li class="ignored"><code>                'sum_year_neg': sum_year + sum_year_neg,</code></li>
<li class="ignored"><code>                'sum': sum,</code></li>
<li class="ignored"><code>                'sum_neg': sum_neg,</code></li>
<li class="ignored"><code>                'currency': CURRENCY,</code></li>
<li class="ignored"><code>            })</code></li>
<li class="executed"><code>        return kwargs</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def form_valid(self, form):</code></li>
<li class="executed"><code>        self.post_data = self.request.POST</code></li>
<li class="executed"><code>        if 'download' in self.post_data:</code></li>
<li class="executed"><code>            result = StringIO.StringIO()</code></li>
<li class="executed"><code>            html = self.render_to_response(self.get_context_data(form=form))</code></li>
<li class="executed"><code>            f = open(os.path.join(</code></li>
<li class="ignored"><code>                os.path.dirname(__file__), './static/payslip/css/payslip.css'))</code></li>
<li class="executed"><code>            pdf = pisa.CreatePDF(html.render().content, result,</code></li>
<li class="ignored"><code>                                 default_css=f.read())</code></li>
<li class="executed"><code>            f.close()</code></li>
<li class="executed"><code>            if not pdf.err:</code></li>
<li class="executed"><code>                return HttpResponse(result.getvalue(),</code></li>
<li class="ignored"><code>                                    mimetype='application/pdf')</code></li>
<li class="executed"><code>        return self.render_to_response(self.get_context_data(form=form))</code></li>
  </ol>
</div>

<div class="nav">
  <a href="payslip.templatetags.payslip_tags.html">payslip.templatetags.payslip_tags</a> &lt;&lt;
  <a href="../index.html">index</a>
</div>

  </body>
</html>

