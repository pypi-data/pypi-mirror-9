<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: payslip.forms</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="payslip.__init__.html">payslip.__init__</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="payslip.models.html">payslip.models</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">payslip.forms</span>:
    135 total statements,
    <span class="normal">100.0% covered</span>
  </h1>
  <p>Generated: Sat 2015-02-07 20:31 CET</p>
  <p>Source file: /home/tobi/Projects/django-payslip/src/payslip/forms.py</p>
  <p>
    Stats:
    <span class="executed">127 executed</span>,
    <span class="missed">0 missed</span>,
    <span class="excluded">8 excluded</span>,
    <span class="ignored">120 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="ignored"><code>"""Forms for the ``payslip`` app."""</code></li>
<li class="excluded"><code>import md5</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from django.contrib.auth.models import make_password, User</code></li>
<li class="excluded"><code>from django.db.models import Q</code></li>
<li class="excluded"><code>from django import forms</code></li>
<li class="excluded"><code>from django.utils import timezone</code></li>
<li class="excluded"><code>from django.utils.translation import ugettext_lazy as _</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from dateutil.relativedelta import relativedelta</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from payslip.models import (</code></li>
<li class="ignored"><code>    Company,</code></li>
<li class="ignored"><code>    Employee,</code></li>
<li class="ignored"><code>    ExtraField,</code></li>
<li class="ignored"><code>    ExtraFieldType,</code></li>
<li class="ignored"><code>    Payment,</code></li>
<li class="ignored"><code>)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_md5_hexdigest(email):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Returns an md5 hash for a given email.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    The length is 30 so that it fits into Django's ``User.username`` field.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    """</code></li>
<li class="executed"><code>    return md5.new(email).hexdigest()[0:30]</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def generate_username(email):</code></li>
<li class="ignored"><code>    """</code></li>
<li class="ignored"><code>    Generates a unique username for the given email.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    The username will be an md5 hash of the given email. If the username exists</code></li>
<li class="ignored"><code>    we just append `a` to the email until we get a unique md5 hash.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    """</code></li>
<li class="executed"><code>    username = get_md5_hexdigest(email)</code></li>
<li class="executed"><code>    found_unique_username = False</code></li>
<li class="executed"><code>    while not found_unique_username:</code></li>
<li class="executed"><code>        try:</code></li>
<li class="executed"><code>            User.objects.get(username=username)</code></li>
<li class="executed"><code>            email = '{0}a'.format(email)</code></li>
<li class="executed"><code>            username = get_md5_hexdigest(email)</code></li>
<li class="executed"><code>        except User.DoesNotExist:</code></li>
<li class="executed"><code>            found_unique_username = True</code></li>
<li class="executed"><code>            return username</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldFormMixin(object):</code></li>
<li class="ignored"><code>    """Mixin to handle extra field related functions."""</code></li>
<li class="executed"><code>    def __init__(self, *args, **kwargs):</code></li>
<li class="executed"><code>        self.extra_field_types = ExtraFieldType.objects.filter(</code></li>
<li class="ignored"><code>            Q(model=self.Meta.model.__name__) | Q(model__isnull=True))</code></li>
<li class="executed"><code>        if kwargs.get('instance'):</code></li>
<li class="executed"><code>            for extra_field_type in self.extra_field_types:</code></li>
<li class="executed"><code>                try:</code></li>
<li class="executed"><code>                    field = kwargs.get('instance').extra_fields.get(</code></li>
<li class="ignored"><code>                        field_type__name=extra_field_type.name)</code></li>
<li class="executed"><code>                except ExtraField.DoesNotExist:</code></li>
<li class="executed"><code>                    pass</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="executed"><code>                    kwargs['initial'].update({'{0}'.format(</code></li>
<li class="ignored"><code>                        extra_field_type.name): field.value})</code></li>
<li class="executed"><code>        super(ExtraFieldFormMixin, self).__init__(*args, **kwargs)</code></li>
<li class="executed"><code>        for extra_field_type in self.extra_field_types:</code></li>
<li class="executed"><code>            if extra_field_type.fixed_values:</code></li>
<li class="executed"><code>                choices = [(x.value, x.value)</code></li>
<li class="ignored"><code>                           for x in extra_field_type.extra_fields.all()]</code></li>
<li class="executed"><code>                choices.append(('', '-----'))</code></li>
<li class="executed"><code>                self.fields[extra_field_type.name] = forms.ChoiceField(</code></li>
<li class="ignored"><code>                    required=False,</code></li>
<li class="ignored"><code>                    choices=list(set(choices)),</code></li>
<li class="ignored"><code>                )</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="executed"><code>                self.fields[extra_field_type.name] = forms.CharField(</code></li>
<li class="ignored"><code>                    required=False, max_length=200)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def save(self, *args, **kwargs):</code></li>
<li class="executed"><code>        resp = super(ExtraFieldFormMixin, self).save(*args, **kwargs)</code></li>
<li class="executed"><code>        for extra_field_type in self.extra_field_types:</code></li>
<li class="executed"><code>            try:</code></li>
<li class="executed"><code>                field_to_save = self.instance.extra_fields.get(</code></li>
<li class="ignored"><code>                    field_type__name=extra_field_type.name)</code></li>
<li class="executed"><code>            except ExtraField.DoesNotExist:</code></li>
<li class="executed"><code>                field_to_save = None</code></li>
<li class="executed"><code>            if extra_field_type.fixed_values:</code></li>
<li class="executed"><code>                if field_to_save:</code></li>
<li class="executed"><code>                    self.instance.extra_fields.remove(</code></li>
<li class="ignored"><code>                        self.instance.extra_fields.get(</code></li>
<li class="ignored"><code>                            field_type__name=extra_field_type.name))</code></li>
<li class="executed"><code>                try:</code></li>
<li class="executed"><code>                    field_to_save = ExtraField.objects.get(</code></li>
<li class="ignored"><code>                        field_type__name=extra_field_type.name,</code></li>
<li class="ignored"><code>                        value=self.data.get(extra_field_type.name))</code></li>
<li class="executed"><code>                except ExtraField.DoesNotExist:</code></li>
<li class="executed"><code>                    pass</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="executed"><code>                    self.instance.extra_fields.add(field_to_save)</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="executed"><code>                if field_to_save:</code></li>
<li class="executed"><code>                    field_to_save.value = self.data.get(extra_field_type.name)</code></li>
<li class="executed"><code>                    field_to_save.save()</code></li>
<li class="executed"><code>                elif self.data.get(extra_field_type.name):</code></li>
<li class="executed"><code>                    new_field = ExtraField(</code></li>
<li class="ignored"><code>                        field_type=extra_field_type,</code></li>
<li class="ignored"><code>                        value=self.data.get(extra_field_type.name),</code></li>
<li class="ignored"><code>                    )</code></li>
<li class="executed"><code>                    new_field.save()</code></li>
<li class="executed"><code>                    self.instance.extra_fields.add(new_field)</code></li>
<li class="executed"><code>        return resp</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class EmployeeForm(ExtraFieldFormMixin, forms.ModelForm):</code></li>
<li class="ignored"><code>    """Form to create a new Employee instance."""</code></li>
<li class="executed"><code>    first_name = forms.CharField(max_length=30)</code></li>
<li class="executed"><code>    last_name = forms.CharField(max_length=30)</code></li>
<li class="executed"><code>    email = forms.EmailField()</code></li>
<li class="executed"><code>    password = forms.CharField(widget=forms.PasswordInput(), max_length=128)</code></li>
<li class="executed"><code>    retype_password = forms.CharField(widget=forms.PasswordInput(),</code></li>
<li class="ignored"><code>                                      max_length=128)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def __init__(self, company, *args, **kwargs):</code></li>
<li class="executed"><code>        self.company = company</code></li>
<li class="executed"><code>        if kwargs.get('instance'):</code></li>
<li class="executed"><code>            instance = kwargs.get('instance')</code></li>
<li class="executed"><code>            user = instance.user</code></li>
<li class="executed"><code>            kwargs['initial'] = {</code></li>
<li class="ignored"><code>                'first_name': user.first_name,</code></li>
<li class="ignored"><code>                'last_name': user.last_name,</code></li>
<li class="ignored"><code>                'email': user.email,</code></li>
<li class="ignored"><code>            }</code></li>
<li class="executed"><code>        super(EmployeeForm, self).__init__(*args, **kwargs)</code></li>
<li class="executed"><code>        if self.instance.id:</code></li>
<li class="executed"><code>            del self.fields['password']</code></li>
<li class="executed"><code>            del self.fields['retype_password']</code></li>
<li class="executed"><code>        if self.company and self.company.pk:</code></li>
<li class="executed"><code>            del self.fields['company']</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def clean_email(self):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Validate that the username is alphanumeric and is not already</code></li>
<li class="ignored"><code>        in use.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        """</code></li>
<li class="executed"><code>        email = self.cleaned_data['email']</code></li>
<li class="executed"><code>        try:</code></li>
<li class="executed"><code>            user = User.objects.get(email__iexact=email)</code></li>
<li class="executed"><code>        except User.DoesNotExist:</code></li>
<li class="executed"><code>            return email</code></li>
<li class="executed"><code>        if self.instance.id and user == self.instance.user:</code></li>
<li class="executed"><code>            return email</code></li>
<li class="executed"><code>        raise forms.ValidationError(</code></li>
<li class="ignored"><code>            _('A user with that email already exists.'))</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def clean(self):</code></li>
<li class="ignored"><code>        """</code></li>
<li class="ignored"><code>        Verifiy that the values entered into the two password fields match.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        Note that an error here will end up in ``non_field_errors()`` because</code></li>
<li class="ignored"><code>        it doesn't apply to a single field.</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>        """</code></li>
<li class="executed"><code>        data = self.cleaned_data</code></li>
<li class="executed"><code>        if 'email' not in data:</code></li>
<li class="executed"><code>            return data</code></li>
<li class="executed"><code>        if ('password' in data and 'retype_password' in data):</code></li>
<li class="executed"><code>            if data['password'] != data['retype_password']:</code></li>
<li class="executed"><code>                raise forms.ValidationError(</code></li>
<li class="ignored"><code>                    _("The two password fields didn't match."))</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>        self.cleaned_data['username'] = generate_username(data['email'])</code></li>
<li class="executed"><code>        return self.cleaned_data</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def save(self, *args, **kwargs):</code></li>
<li class="executed"><code>        if self.instance.id:</code></li>
<li class="executed"><code>            User.objects.filter(pk=self.instance.user.pk).update(</code></li>
<li class="ignored"><code>                first_name=self.cleaned_data.get('first_name'),</code></li>
<li class="ignored"><code>                last_name=self.cleaned_data.get('last_name'),</code></li>
<li class="ignored"><code>                email=self.cleaned_data.get('email'),</code></li>
<li class="ignored"><code>            )</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="executed"><code>            user = User(</code></li>
<li class="ignored"><code>                username=self.cleaned_data.get('email'),</code></li>
<li class="ignored"><code>                first_name=self.cleaned_data.get('first_name'),</code></li>
<li class="ignored"><code>                last_name=self.cleaned_data.get('last_name'),</code></li>
<li class="ignored"><code>                email=self.cleaned_data.get('email'),</code></li>
<li class="ignored"><code>                password=make_password(self.cleaned_data.get('password')),</code></li>
<li class="ignored"><code>            )</code></li>
<li class="executed"><code>            user.save()</code></li>
<li class="executed"><code>            self.instance.user = user</code></li>
<li class="executed"><code>        if self.company and self.company.pk:</code></li>
<li class="executed"><code>            self.instance.company = Company.objects.get(pk=self.company.pk)</code></li>
<li class="executed"><code>        return super(EmployeeForm, self).save(*args, **kwargs)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    class Meta:</code></li>
<li class="executed"><code>        model = Employee</code></li>
<li class="executed"><code>        fields = ('company', 'hr_number', 'address', 'title', 'is_manager')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PaymentForm(ExtraFieldFormMixin, forms.ModelForm):</code></li>
<li class="ignored"><code>    """Form to create a new Payment instance."""</code></li>
<li class="executed"><code>    class Meta:</code></li>
<li class="executed"><code>        model = Payment</code></li>
<li class="executed"><code>        fields = ('payment_type', 'employee', 'amount', 'date', 'end_date',</code></li>
<li class="ignored"><code>                  'description')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class ExtraFieldForm(forms.ModelForm):</code></li>
<li class="ignored"><code>    """Form to create a new ExtraField instance."""</code></li>
<li class="executed"><code>    def __init__(self, *args, **kwargs):</code></li>
<li class="executed"><code>        super(ExtraFieldForm, self).__init__(*args, **kwargs)</code></li>
<li class="executed"><code>        self.fields['field_type'].queryset = ExtraFieldType.objects.filter(</code></li>
<li class="ignored"><code>            fixed_values=True)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    class Meta:</code></li>
<li class="executed"><code>        model = ExtraField</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class PayslipForm(forms.Form):</code></li>
<li class="ignored"><code>    """Form to create a custom payslip."""</code></li>
<li class="executed"><code>    year = forms.ChoiceField()</code></li>
<li class="executed"><code>    month = forms.ChoiceField()</code></li>
<li class="executed"><code>    employee = forms.ChoiceField()</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def __init__(self, company, *args, **kwargs):</code></li>
<li class="executed"><code>        super(PayslipForm, self).__init__(*args, **kwargs)</code></li>
<li class="executed"><code>        last_month = timezone.now().replace(day=1) - relativedelta(months=1)</code></li>
<li class="executed"><code>        self.fields['month'].choices = (</code></li>
<li class="ignored"><code>            (1, _('January')),</code></li>
<li class="ignored"><code>            (2, _('February')),</code></li>
<li class="ignored"><code>            (3, _('March')),</code></li>
<li class="ignored"><code>            (4, _('April')),</code></li>
<li class="ignored"><code>            (5, _('May')),</code></li>
<li class="ignored"><code>            (6, _('June')),</code></li>
<li class="ignored"><code>            (7, _('July')),</code></li>
<li class="ignored"><code>            (8, _('August')),</code></li>
<li class="ignored"><code>            (9, _('September')),</code></li>
<li class="ignored"><code>            (10, _('October')),</code></li>
<li class="ignored"><code>            (11, _('November')),</code></li>
<li class="ignored"><code>            (12, _('December')),</code></li>
<li class="ignored"><code>        )</code></li>
<li class="executed"><code>        self.fields['month'].initial = last_month.month</code></li>
<li class="executed"><code>        current_year = timezone.now().year</code></li>
<li class="executed"><code>        self.fields['year'].choices = [</code></li>
<li class="ignored"><code>            (current_year - x, current_year - x) for x in range(0, 20)]</code></li>
<li class="executed"><code>        self.fields['year'].initial = last_month.year</code></li>
<li class="executed"><code>        self.company = company</code></li>
<li class="executed"><code>        if self.company:</code></li>
<li class="executed"><code>            self.fields['employee'].choices = [(</code></li>
<li class="ignored"><code>                x.id, x) for x in self.company.employees.all()]</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="executed"><code>            self.fields['employee'].choices = [(</code></li>
<li class="ignored"><code>                x.id, x) for x in Employee.objects.all()]</code></li>
  </ol>
</div>

<div class="nav">
  <a href="payslip.__init__.html">payslip.__init__</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="payslip.models.html">payslip.models</a>
</div>

  </body>
</html>

