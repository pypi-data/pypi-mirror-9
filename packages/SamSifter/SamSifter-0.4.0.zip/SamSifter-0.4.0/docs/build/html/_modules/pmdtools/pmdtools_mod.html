<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pmdtools.pmdtools_mod &mdash; SamSifter 0.4.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="SamSifter 0.4.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SamSifter 0.4.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pmdtools.pmdtools_mod</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python3</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Calculate and filter post-mortem degeneration score for NGS reads in SAM files.</span>

<span class="sd">Modified version of PMDtools based on v0.55 by Pontus Skoglund:</span>

<span class="sd">cite: P Skoglund, BH Northoff, MV Shunkov, AP Derevianko, S Paabo, J Krause, M</span>
<span class="sd">Jakobsson (2014) Separating endogenous ancient DNA from modern day</span>
<span class="sd">contamination in a Siberian Neandertal, PNAS, advance online 27 January</span>

<span class="sd">Included changes:</span>

<span class="sd">* count and show excluded reads due to unsupported CIGAR operations</span>
<span class="sd">* count and show excluded reads due to % identity filtering</span>
<span class="sd">* port from Python2 to Python3</span>
<span class="sd">* bugfix: ambiguous combinations of CIGAR and MD with deletions lead to shifts</span>
<span class="sd">  in reconstructed reference sequence</span>
<span class="sd">* support for all CIGAR operations except padded references (untested)</span>
<span class="sd">* support of IUPAC ambiguity codes</span>
<span class="sd">* optional parameters to adapt % identity calculation to MALT defaults</span>
<span class="sd">* refactoring into main method</span>
<span class="sd">* use of ArgumentParser over deprecated OptionParser</span>
<span class="sd">* improved PEP8 and pylint compliance</span>
<span class="sd">* ReST documentation</span>

<span class="sd">.. moduleauthor:: Florian Aldehoff &lt;faldehoff@student.uni-tuebingen.de&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>

<span class="sd">&quot;&quot;&quot; custom libraries &quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">samsifter.util.sam</span> <span class="kn">import</span> <span class="n">reconstruct</span>
<span class="kn">from</span> <span class="nn">samsifter.util.genetics</span> <span class="kn">import</span> <span class="n">reverse_complement</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">aln_identity</span>


<div class="viewcode-block" id="phred2prob"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.phred2prob">[docs]</a><span class="k">def</span> <span class="nf">phred2prob</span><span class="p">(</span><span class="n">Q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert PHRED score to probability of sequencing error.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Q : int</span>
<span class="sd">        PHRED score.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The probability of a sequencing error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">10.0</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">Q</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="prob2phred"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.prob2phred">[docs]</a><span class="k">def</span> <span class="nf">prob2phred</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert probability of sequencing error to PHRED score.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        The probability of a sequencing error.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        PHRED score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">10.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="prob2ascii"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.prob2ascii">[docs]</a><span class="k">def</span> <span class="nf">prob2ascii</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">33</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert probability of sequencing error to ASCII-encoded PHRED score.</span>

<span class="sd">    By default uses ASCII offset 33 (Illumina standard).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : float</span>
<span class="sd">        The probability of a sequencing error.</span>
<span class="sd">    offset : int, optional</span>
<span class="sd">        ASCII encoding offset, defaults to 33.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">prob2phred</span><span class="p">(</span><span class="n">P</span><span class="p">))</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="prob"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.prob">[docs]</a><span class="k">def</span> <span class="nf">prob</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate probability of either match or mismatch under given model.</span>

<span class="sd">    Expects distance of base from end of read, a pre-computed distribution of</span>
<span class="sd">    damage probabilities, PHRED score of base (probability of sequencing</span>
<span class="sd">    error) and probability of true polymorphism.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : int</span>
<span class="sd">        Position of base from end of read.</span>
<span class="sd">    model : list</span>
<span class="sd">        Distribution of damage probabilities.</span>
<span class="sd">    qual : int</span>
<span class="sd">        PHRED score of base.</span>
<span class="sd">    poly : float</span>
<span class="sd">        Probability of a true polymorphism at this base.</span>
<span class="sd">    match : bool, optional</span>
<span class="sd">        Switch between calculation for a match (default) or mismatch.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Probability of either match or mismatch under given model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_damage</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
    <span class="n">p_error</span> <span class="o">=</span> <span class="n">phred2prob</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">qual</span><span class="p">)</span> <span class="o">-</span> <span class="mi">33</span><span class="p">))</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">p_poly</span> <span class="o">=</span> <span class="n">poly</span>
    <span class="n">p_match</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_damage</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_error</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_poly</span><span class="p">)</span>
               <span class="o">+</span> <span class="p">(</span><span class="n">p_damage</span> <span class="o">*</span> <span class="n">p_error</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_poly</span><span class="p">))</span>
               <span class="o">+</span> <span class="p">(</span><span class="n">p_error</span> <span class="o">*</span> <span class="n">p_poly</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_damage</span><span class="p">)))</span>
    <span class="n">p_mismatch</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_match</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p_match</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">p_mismatch</span>

</div>
<div class="viewcode-block" id="L_match"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.L_match">[docs]</a><span class="k">def</span> <span class="nf">L_match</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate likelihood of a match under given model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : int</span>
<span class="sd">        Position of base from end of read.</span>
<span class="sd">    model : list</span>
<span class="sd">        Distribution of damage probabilities.</span>
<span class="sd">    qual : int</span>
<span class="sd">        PHRED score of base.</span>
<span class="sd">    poly : float</span>
<span class="sd">        Probability of a true polymorphism at this base.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Probability of match under given model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">prob</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="L_mismatch"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.L_mismatch">[docs]</a><span class="k">def</span> <span class="nf">L_mismatch</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate likelihood of a mismatch under given model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos : int</span>
<span class="sd">        Position of base from end of read.</span>
<span class="sd">    model : list</span>
<span class="sd">        Distribution of damage probabilities.</span>
<span class="sd">    qual : int</span>
<span class="sd">        PHRED score of base.</span>
<span class="sd">    poly : float</span>
<span class="sd">        Probability of a true polymorphism at this base.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Probability of mismatch under given model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">prob</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="adjust_quality"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.adjust_quality">[docs]</a><span class="k">def</span> <span class="nf">adjust_quality</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">qual</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adjust base quality value (sequencing error probability).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    position : int</span>
<span class="sd">        Position of base from end of read.</span>
<span class="sd">    model : list</span>
<span class="sd">        Distribution of damage probabilities.</span>
<span class="sd">    qual : int</span>
<span class="sd">        PHRED score of base.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Adjusted base quality value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_damage</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">position</span><span class="p">])</span>
    <span class="n">p_error</span> <span class="o">=</span> <span class="n">phred2prob</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">qual</span><span class="p">)</span> <span class="o">-</span> <span class="mi">33</span><span class="p">))</span> <span class="o">/</span> <span class="mf">3.0</span>
    <span class="n">adjusted</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_damage</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_error</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">adjusted</span>

</div>
<div class="viewcode-block" id="geometric"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.geometric">[docs]</a><span class="k">def</span> <span class="nf">geometric</span><span class="p">(</span><span class="n">pval</span><span class="p">,</span> <span class="n">kval</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate geometrically distributed probability.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pval : float</span>
<span class="sd">        Parameter p of geometric distribution.</span>
<span class="sd">    kval : float</span>
<span class="sd">        Parameter k of geometric distribution.</span>
<span class="sd">    constant : float</span>
<span class="sd">        Constant value of geometric distribution.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Probability of deamination based on geometric distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">pval</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">kval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">pval</span> <span class="o">+</span> <span class="n">constant</span>

</div>
<div class="viewcode-block" id="fa_get"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.fa_get">[docs]</a><span class="k">def</span> <span class="nf">fa_get</span><span class="p">(</span><span class="n">ffile</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">fstart</span><span class="p">,</span> <span class="n">fend</span><span class="p">,</span> <span class="n">samtoolspath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unused method stub to get reference sequence from supplied FASTA?</span>

<span class="sd">    Calls SAMtools in subprocess to create index of FASTA file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ffile : str</span>
<span class="sd">        Path to FASTA file.</span>
<span class="sd">    chrom : int</span>
<span class="sd">        Chromosome number.</span>
<span class="sd">    fstart : int</span>
<span class="sd">        Start position.</span>
<span class="sd">    fend : int</span>
<span class="sd">        End position.</span>
<span class="sd">    samtoolspath : str</span>
<span class="sd">        Path to samtools.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Enable output of executed commandline, defaults to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        reference sequence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FNULL</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">chrom</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chrom</span><span class="p">)</span>    <span class="c"># &#39;chr&#39;+str(chrom)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chrom</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fstart</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fend</span><span class="p">)</span>
    <span class="n">cmd_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">samtoolspath</span><span class="p">,</span> <span class="s">&#39;faidx&#39;</span><span class="p">,</span> <span class="n">ffile</span><span class="p">,</span> <span class="n">location</span><span class="p">]</span>
    <span class="n">outp_file</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd_line</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                 <span class="n">stderr</span><span class="o">=</span><span class="n">FNULL</span><span class="p">)</span>
    <span class="n">pileupline</span> <span class="o">=</span> <span class="n">outp_file</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">pileupline</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pileupline</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pileupline</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;no such reference sequence&#39;</span><span class="p">,</span> <span class="n">cmd_line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_line</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pileupline</span>

</div>
<div class="viewcode-block" id="score_pmd"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.score_pmd">[docs]</a><span class="k">def</span> <span class="nf">score_pmd</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">quals</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">modern_model_deam</span><span class="p">,</span>
              <span class="n">adjustment_model_deam</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">polymorphism_contamination</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">polymorphism_ancient</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
              <span class="n">adjustbaseq_all</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">adjustbaseq</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">baseq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">deamination</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">cpg</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">nocpg</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">UDGhalf</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
              <span class="n">PMDSprim</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate post-mortem degradation score (PMDS).</span>

<span class="sd">    Requires full read and reference sequence including clips, skips and gaps</span>
<span class="sd">    as recovered from CIGAR and MD to use the correct distance from 5&#39; or 3&#39;</span>
<span class="sd">    end in the PMDS calculation. However only the aligned read bases with</span>
<span class="sd">    PHRED scores are considered for PMD scoring.</span>

<span class="sd">    Optional adjustment of base qualities requires additional adjustment model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    read : str</span>
<span class="sd">        Full read sequence.</span>
<span class="sd">    ref : str</span>
<span class="sd">        Aligned reference sequence including clips, skips and gaps.</span>
<span class="sd">    quals : list</span>
<span class="sd">        Quality scores for aligned bases.</span>
<span class="sd">    ancient_model_deam : list</span>
<span class="sd">        Probability distribution for ancient deamination.</span>
<span class="sd">    modern_model_deam : list</span>
<span class="sd">        Probability distribution for modern deamination.</span>
<span class="sd">    adjustment_model_deam : list, optional</span>
<span class="sd">        Adjustments to the deamination probabilities, defaults to None.</span>
<span class="sd">    polymorphism_contamination : float, optional</span>
<span class="sd">        Probability of polymorphism due to contamination, defaults to 0.001.</span>
<span class="sd">    polymorphism_ancient : float, optional</span>
<span class="sd">        Probability of polymorphism due to age, defaults to 0.001.</span>
<span class="sd">    adjustbaseq_all : bool, optional</span>
<span class="sd">        Switch to adjust all base quality values, defaults to False.</span>
<span class="sd">    adjustbaseq : bool, optional</span>
<span class="sd">        Switch to adjust affected base quality values, defaults to False.</span>
<span class="sd">    baseq : int, optional</span>
<span class="sd">        Minimum quality value for processed bases, defaults to 0</span>
<span class="sd">    deamination : bool, optional</span>
<span class="sd">        Enable output of base frequencies in deaminated context, defaults to</span>
<span class="sd">        False.</span>
<span class="sd">    cpg : bool, optional</span>
<span class="sd">        Only use Cs and Gs in CpG context, defaults to False.</span>
<span class="sd">    nocpg : bool, optional</span>
<span class="sd">        Do NOT use Cs and Gs in CpG context, defaults to False.</span>
<span class="sd">    UDGhalf : bool, optional</span>
<span class="sd">        Only use Cs and Gs in CpG context, the first and last base are used</span>
<span class="sd">        regardless of dinucleotide context. Defaults to False.</span>
<span class="sd">    PMDSprim : bool, optional</span>
<span class="sd">        Defaults to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Likelihood of deamination under ancient DNA model.</span>
<span class="sd">    float</span>
<span class="sd">        Likelihood of deamination under ancient DNA model.</span>
<span class="sd">    float</span>
<span class="sd">        Post-mortem degradation score</span>
<span class="sd">    list</span>
<span class="sd">        Adjusted base qualities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># this should never happen if reference was correctly reconstructed</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Undefined for sequences of unequal length&quot;</span><span class="p">)</span>

    <span class="n">L_D</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c"># likelihood of degradation</span>
    <span class="n">L_M</span> <span class="o">=</span> <span class="mf">1.0</span>    <span class="c"># likelihood of mutation</span>

<span class="c">#    L_D_max = 1.0</span>
<span class="c">#    L_M_max = 1.0</span>
<span class="c">#</span>
<span class="c">#    L_D_min = 1.0</span>
<span class="c">#    L_M_min = 1.0</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check for informative sites (does nothing at the moment)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    #print ref[-1]</span>
<span class="sd">    if cpg:</span>
<span class="sd">        if &#39;CG&#39; not in ref:</span>
<span class="sd">            #print &#39;no informative&#39;</span>
<span class="sd">            L_D = 1.0</span>
<span class="sd">            L_M = 1.0</span>
<span class="sd">    elif UDGhalf:</span>
<span class="sd">        if &#39;CG&#39; not in ref and ref[0] != &#39;C&#39; and ref[-1] != &#39;G&#39;:</span>
<span class="sd">            #print &#39;no informative&#39;</span>
<span class="sd">            L_D = 1.0</span>
<span class="sd">            L_M = 1.0</span>
<span class="sd">    else:</span>
<span class="sd">        if &#39;C&#39; not in ref and &#39;G&#39; not in ref:</span>
<span class="sd">            #print &#39;no informative&#39;</span>
<span class="sd">            L_D = 1.0</span>
<span class="sd">            L_M = 1.0</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">newquals</span> <span class="o">=</span> <span class="n">quals</span>

    <span class="n">qual_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">aln_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">readbase</span><span class="p">,</span> <span class="n">refbase</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">ref</span><span class="p">)):</span>
        <span class="c"># skipped intron</span>
        <span class="k">if</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># hard clipping</span>
        <span class="k">if</span> <span class="n">readbase</span> <span class="o">==</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># soft clipping</span>
        <span class="k">if</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span><span class="p">:</span>
            <span class="n">qual_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c"># gaps in read</span>
        <span class="k">if</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># gaps in reference</span>
        <span class="k">if</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">qual_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c"># ambiguous bases TODO some of these may actually be informative!</span>
        <span class="n">ambiguous</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="s">&#39;X&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;D&#39;</span><span class="p">,</span> <span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="s">&#39;V&#39;</span><span class="p">,</span> <span class="s">&#39;Y&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">readbase</span> <span class="ow">in</span> <span class="n">ambiguous</span> <span class="ow">or</span> <span class="n">refbase</span> <span class="ow">in</span> <span class="n">ambiguous</span><span class="p">):</span>
            <span class="n">qual_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">quality</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[</span><span class="n">qual_idx</span><span class="p">]</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        At this point we&#39;re dealing with a qualified alignment where each</span>
<span class="sd">        position has exactly</span>
<span class="sd">        - one informative read base:        readbase       read[aln_idx]</span>
<span class="sd">        - one informative reference base:   refbase        ref[aln_idx]</span>
<span class="sd">        - one quality score:                quality        quals[qual_idx]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">qual_idx</span>                    <span class="c"># distance from 5&#39; end of read</span>
        <span class="n">z</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">quals</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">qual_idx</span>    <span class="c"># distance from 3&#39; end of read</span>

        <span class="k">if</span> <span class="n">adjustbaseq_all</span> <span class="ow">and</span> <span class="n">adjustment_model_deam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">newprob</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjustment_model_deam</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                       <span class="o">+</span> <span class="n">adjustment_model_deam</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>
                       <span class="o">+</span> <span class="n">phred2prob</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">quality</span><span class="p">)</span> <span class="o">-</span> <span class="mi">33</span><span class="p">))</span>
<span class="c">#            newprob = min(newprob, 1.0)</span>
            <span class="n">newqual</span> <span class="o">=</span> <span class="n">prob2ascii</span><span class="p">(</span><span class="n">newprob</span><span class="p">)</span>
            <span class="n">newquals</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">newqual</span> <span class="o">+</span> <span class="n">quals</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">quality</span><span class="p">)</span> <span class="o">-</span> <span class="mi">33</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">baseq</span><span class="p">:</span>
            <span class="c"># make sure that quality is adjusted even if baseq is below</span>
            <span class="c"># threshold</span>
            <span class="k">if</span> <span class="n">adjustbaseq</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span><span class="p">:</span>
<span class="c">#                    if cpg:</span>
<span class="c">#                        if i + 1 &gt;= readlen:</span>
<span class="c">#                            break</span>
<span class="c">#                        if ref[i + 1] != &#39;G&#39;:</span>
<span class="c">#                            continue</span>
<span class="c">#                    elif nocpg:</span>
<span class="c">#                        if i + 1 &gt;= readlen:</span>
<span class="c">#                            break</span>
<span class="c">#                        if ref[i + 1] == &#39;G&#39;:</span>
<span class="c">#                            continue</span>
<span class="c">#                    elif UDGhalf:</span>
<span class="c">#                        if i + 1 &gt;= readlen:</span>
<span class="c">#                            break</span>
<span class="c">#                        if ref[i + 1] != &#39;G&#39; and i != 0:</span>
<span class="c">#                            continue</span>
                    <span class="n">newprob</span> <span class="o">=</span> <span class="n">adjust_quality</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">)</span>
                    <span class="n">newqual</span> <span class="o">=</span> <span class="n">prob2ascii</span><span class="p">(</span><span class="n">newprob</span><span class="p">)</span>
                    <span class="n">newquals</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">newqual</span> <span class="o">+</span> <span class="n">quals</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>

                <span class="k">if</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;G&#39;</span> <span class="ow">and</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
<span class="c">#                    if cpg:</span>
<span class="c">#                        if i - 1 &gt;= readlen:</span>
<span class="c">#                            break</span>
<span class="c">#                        if ref[i - 1] != &#39;C&#39;:</span>
<span class="c">#                            continue</span>
<span class="c">#                    elif nocpg:</span>
<span class="c">#                        if i - 1 &gt;= readlen:</span>
<span class="c">#                            break</span>
<span class="c">#                        if ref[i - 1] == &#39;C&#39;:</span>
<span class="c">#                            continue</span>
<span class="c">#                    elif UDGhalf:</span>
<span class="c">#                        if ref[i - 1] != &#39;C&#39; and z != 0:</span>
<span class="c">#                            continue</span>
                    <span class="n">newprob</span> <span class="o">=</span> <span class="n">adjust_quality</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">)</span>
                    <span class="n">newqual</span> <span class="o">=</span> <span class="n">prob2ascii</span><span class="p">(</span><span class="n">newprob</span><span class="p">)</span>
                    <span class="n">newquals</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">newqual</span> <span class="o">+</span> <span class="n">quals</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>
            <span class="k">continue</span>

<span class="c">#        if deamination:</span>
<span class="c">#            if refbase == &#39;C&#39;:</span>
<span class="c">#                if cpg:</span>
<span class="c">#                    if i + 1 &gt;= readlen:</span>
<span class="c">#                        break</span>
<span class="c">#                    if read[i + 1] != &#39;G&#39;:</span>
<span class="c">#                        continue</span>
<span class="c">#                elif nocpg:</span>
<span class="c">#                    if i + 1 &gt;= readlen:</span>
<span class="c">#                        break</span>
<span class="c">#                    if read[i + 1] == &#39;G&#39;:</span>
<span class="c">#                        continue</span>
<span class="c">#                elif UDGhalf:</span>
<span class="c">#                    if i + 1 &gt;= readlen:</span>
<span class="c">#                        break</span>
<span class="c">#                    if ref[i + 1] != &#39;G&#39; and i != 0:</span>
<span class="c">#                        continue</span>
<span class="c">#</span>
<span class="c">#                thekey = refbase + readbase + str(i)</span>
<span class="c">#                if thekey in mismatch_dict.keys():</span>
<span class="c">#                    addition = mismatch_dict[thekey]</span>
<span class="c">#                    addition += 1</span>
<span class="c">#                    mismatch_dict[thekey] = addition</span>
<span class="c">#                else:</span>
<span class="c">#                    mismatch_dict[thekey] = 1</span>
<span class="c">#</span>
<span class="c">#            if refbase == &#39;G&#39;:</span>
<span class="c">#                if cpg:</span>
<span class="c">#                    if i - 1 &gt;= readlen:</span>
<span class="c">#                        break</span>
<span class="c">#                    if ref[i - 1] != &#39;C&#39;:</span>
<span class="c">#                        continue</span>
<span class="c">#                elif nocpg:</span>
<span class="c">#                    if i - 1 &gt;= readlen:</span>
<span class="c">#                        break</span>
<span class="c">#                    if ref[i - 1] == &#39;C&#39;:</span>
<span class="c">#                        continue</span>
<span class="c">#                elif UDGhalf:</span>
<span class="c">#                    if i - 1 &gt;= readlen:</span>
<span class="c">#                        break</span>
<span class="c">#                    if ref[i - 1] != &#39;C&#39; and z != 0:</span>
<span class="c">#                        continue</span>
<span class="c">#                thekey = refbase + readbase + str(z)</span>
<span class="c">#                if thekey in mismatch_dict_rev.keys():</span>
<span class="c">#                    addition = mismatch_dict_rev[thekey]</span>
<span class="c">#                    addition += 1</span>
<span class="c">#                    mismatch_dict_rev[thekey] = addition</span>
<span class="c">#                else:</span>
<span class="c">#                    mismatch_dict_rev[thekey] = 1</span>
<span class="c">#            continue</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compute degradation score</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c">#        if i &gt;= readlen:continue</span>
        <span class="k">if</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span><span class="p">:</span>
<span class="c">#            if cpg:</span>
<span class="c">#                if i + 1 &gt;= readlen:</span>
<span class="c">#                    break</span>
<span class="c">#                if ref[i + 1] != &#39;G&#39;:</span>
<span class="c">#                    continue</span>
<span class="c">#            elif cpg:</span>
<span class="c">#                if i + 1 &gt;= readlen:</span>
<span class="c">#                    break</span>
<span class="c">#                if ref[i + 1] == &#39;G&#39;:</span>
<span class="c">#                    continue</span>
<span class="c">#            elif UDGhalf:</span>
<span class="c">#                if i + 1 &gt;= readlen:</span>
<span class="c">#                    break</span>
<span class="c">#                if ref[i + 1] != &#39;G&#39; and i != 0:</span>
<span class="c">#                    continue</span>

            <span class="k">if</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span><span class="p">:</span>
                <span class="n">L_D</span> <span class="o">=</span> <span class="n">L_D</span> <span class="o">*</span> <span class="n">L_mismatch</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                       <span class="n">polymorphism_ancient</span><span class="p">)</span>
                <span class="n">L_M</span> <span class="o">=</span> <span class="n">L_M</span> <span class="o">*</span> <span class="n">L_mismatch</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">modern_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                       <span class="n">polymorphism_contamination</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">adjustbaseq</span><span class="p">:</span>
                    <span class="n">newprob</span> <span class="o">=</span> <span class="n">adjust_quality</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">)</span>
                    <span class="n">newqual</span> <span class="o">=</span> <span class="n">prob2ascii</span><span class="p">(</span><span class="n">newprob</span><span class="p">)</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    print phred2prob(ord(quality)),newprob</span>
<span class="sd">                    print ord(quality),newphred</span>
<span class="sd">                    print quality,newqual</span>
<span class="sd">                    print quals[0:i],quality,quals[(i+1):]</span>
<span class="sd">                    print quals</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="n">quals</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">newqual</span> <span class="o">+</span> <span class="n">quals</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>

            <span class="k">elif</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span><span class="p">:</span>
                <span class="n">L_D</span> <span class="o">=</span> <span class="n">L_D</span> <span class="o">*</span> <span class="n">L_match</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                    <span class="n">polymorphism_ancient</span><span class="p">)</span>
                <span class="n">L_M</span> <span class="o">=</span> <span class="n">L_M</span> <span class="o">*</span> <span class="n">L_match</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">modern_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                    <span class="n">polymorphism_contamination</span><span class="p">)</span>

<span class="c">#            if PMDSprim and readbase in [&#39;C&#39;, &#39;T&#39;, &#39;c&#39;, &#39;t&#39;]:</span>
<span class="c">#                L_D_max = L_D_max * L_mismatch(i, ancient_model_deam, quality,</span>
<span class="c">#                                               polymorphism_ancient)</span>
<span class="c">#                L_M_max = L_M_max * L_mismatch(i, modern_model_deam, quality,</span>
<span class="c">#                                               polymorphism_ancient)</span>
<span class="c">#                L_D_min = L_D_min * L_match(i, ancient_model_deam, quality,</span>
<span class="c">#                                            polymorphism_ancient)</span>
<span class="c">#                L_M_min = L_M_min * L_match(i, modern_model_deam, quality,</span>
<span class="c">#                                            polymorphism_ancient)</span>

        <span class="k">if</span> <span class="n">refbase</span> <span class="o">==</span> <span class="s">&#39;G&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cpg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;C&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">nocpg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">UDGhalf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                <span class="n">L_D</span> <span class="o">=</span> <span class="n">L_D</span> <span class="o">*</span> <span class="n">L_mismatch</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                       <span class="n">polymorphism_ancient</span><span class="p">)</span>
                <span class="n">L_M</span> <span class="o">=</span> <span class="n">L_M</span> <span class="o">*</span> <span class="n">L_mismatch</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">modern_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                       <span class="n">polymorphism_contamination</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">adjustbaseq</span><span class="p">:</span>
                    <span class="n">newprob</span> <span class="o">=</span> <span class="n">adjust_quality</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">)</span>
                    <span class="n">newqual</span> <span class="o">=</span> <span class="n">prob2ascii</span><span class="p">(</span><span class="n">newprob</span><span class="p">)</span>
                    <span class="n">newquals</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">newqual</span> <span class="o">+</span> <span class="n">quals</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>

            <span class="k">elif</span> <span class="n">readbase</span> <span class="o">==</span> <span class="s">&#39;G&#39;</span><span class="p">:</span>
                <span class="n">L_D</span> <span class="o">=</span> <span class="n">L_D</span> <span class="o">*</span> <span class="n">L_match</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">ancient_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                    <span class="n">polymorphism_ancient</span><span class="p">)</span>
                <span class="n">L_M</span> <span class="o">=</span> <span class="n">L_M</span> <span class="o">*</span> <span class="n">L_match</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">modern_model_deam</span><span class="p">,</span> <span class="n">quality</span><span class="p">,</span>
                                    <span class="n">polymorphism_contamination</span><span class="p">)</span>

<span class="c">#            if PMDSprim and readbase in [&#39;G&#39;, &#39;A&#39;, &#39;g&#39;, &#39;a&#39;]:</span>
<span class="c">#                L_D_max = L_D_max * L_mismatch(z, ancient_model_deam, quality,</span>
<span class="c">#                                               polymorphism_ancient)</span>
<span class="c">#                L_M_max = L_M_max * L_mismatch(z, modern_model_deam, quality,</span>
<span class="c">#                                               polymorphism_ancient)</span>
<span class="c">#                L_D_min = L_D_min * L_match(z, ancient_model_deam, quality,</span>
<span class="c">#                                            polymorphism_ancient)</span>
<span class="c">#                L_M_min = L_M_min * L_match(z, modern_model_deam, quality,</span>
<span class="c">#                                            polymorphism_ancient)</span>

    <span class="c"># calculate log-likelihood ratio as final PMD score</span>
    <span class="n">pmds</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L_D</span> <span class="o">/</span> <span class="n">L_M</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">L_D</span><span class="p">,</span> <span class="n">L_M</span><span class="p">,</span> <span class="n">pmds</span><span class="p">,</span> <span class="n">newquals</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../pmdtools.html#pmdtools.pmdtools_mod.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Executable to calculate post-mortem degradation scores for SAM files.</span>

<span class="sd">    See ``--help`` for details on expected arguments. Takes input only on</span>
<span class="sd">    STDIN. Logs messages to STDERR and writes processed SAM file to</span>
<span class="sd">    STDOUT.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">usage</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;python </span><span class="si">%(prog)s</span><span class="s"> &lt;SAM formatted data with MD field present &quot;</span>
               <span class="s">&quot;from stdin&gt; [options]&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c"># options to control PMD score calculation</span>
    <span class="n">pmd_options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">&quot;PMD parameters&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;influence the geometric distribution used for PMD score &quot;</span>
                     <span class="s">&quot;calculation by changing these parameters&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">pmd_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--PMDpparam&quot;</span><span class="p">,</span>
                             <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                             <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                             <span class="n">dest</span><span class="o">=</span><span class="s">&quot;PMDpparam&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s">&quot;parameter p in geometric probability </span><span class="se">\</span>
<span class="s">                             distribution of PMD&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">pmd_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--PMDconstant&quot;</span><span class="p">,</span>
                             <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                             <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                             <span class="n">dest</span><span class="o">=</span><span class="s">&quot;PMDconstant&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s">&quot;constant C in geometric probability </span><span class="se">\</span>
<span class="s">                             distribution of PMD&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">pmd_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--polymorphism_ancient&quot;</span><span class="p">,</span>
                             <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                             <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                             <span class="n">dest</span><span class="o">=</span><span class="s">&quot;polymorphism_ancient&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s">&quot;True biological polymorphism between the </span><span class="se">\</span>
<span class="s">                             ancient individual and the reference sequence&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="n">pmd_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--polymorphism_contamination&quot;</span><span class="p">,</span>
                             <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                             <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                             <span class="n">dest</span><span class="o">=</span><span class="s">&quot;polymorphism_contamination&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s">&quot;True biological polymorphism between the </span><span class="se">\</span>
<span class="s">                             contaminants and the reference sequence&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c"># options to filter SAM file</span>
    <span class="n">filter_options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">&quot;filters&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;restrict analysis to a subset of reads by setting these &quot;</span>
                     <span class="s">&quot;thresholds&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--dry&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;dry&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;print SAM input without any filters&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;--number&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;maxreads&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;stop after these many reads have been </span><span class="se">\</span>
<span class="s">                                processed&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;--chromosome&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;chromosome&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process data from this chromosome&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--perc_identity&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;perc_identity&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only output sequences with percent </span><span class="se">\</span>
<span class="s">                                identity above this threshold&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-m&quot;</span><span class="p">,</span> <span class="s">&quot;--requiremapq&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;mapq&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process sequences with mapping </span><span class="se">\</span>
<span class="s">                                quality at least this great&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--readlength&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;readlength&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process sequences with this read </span><span class="se">\</span>
<span class="s">                                length&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--maxlength&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;maxlength&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process sequences with max this </span><span class="se">\</span>
<span class="s">                                read length&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--minlength&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;minlength&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process sequences with min this </span><span class="se">\</span>
<span class="s">                                read length&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--maxGC&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;maxGC&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process sequences with max this </span><span class="se">\</span>
<span class="s">                                GC content of the aligning reference sequence&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--minGC&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;minGC&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process sequences with min this GC </span><span class="se">\</span>
<span class="s">                                content of the aligning reference sequence&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="s">&quot;--requirebaseq&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;baseq&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only process bases with base quality at </span><span class="se">\</span>
<span class="s">                                least this great&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-t&quot;</span><span class="p">,</span> <span class="s">&quot;--threshold&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;threshold&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only output sequences with PMD score </span><span class="se">\</span>
<span class="s">                                above this threshold&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">20000.0</span><span class="p">))</span>
    <span class="n">filter_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--upperthreshold&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;upperthreshold&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;only output sequences with PMD score </span><span class="se">\</span>
<span class="s">                                below this threshold&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">1000000.0</span><span class="p">))</span>

    <span class="c"># options controlling handling of CpG contexts</span>
    <span class="n">cpg_options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">&quot;CpG context&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;options controlling the handling of deamination in CpG &quot;</span>
                     <span class="s">&quot;contexts&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c"># --CpG, --noCpG and --UDGhalf exclude each other</span>
    <span class="n">cpg_excl</span> <span class="o">=</span> <span class="n">cpg_options</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cpg_excl</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--CpG&quot;</span><span class="p">,</span> <span class="s">&quot;--UDGplus&quot;</span><span class="p">,</span>
                          <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s">&quot;cpg&quot;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s">&quot;only use Cs and Gs in CpG context&quot;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cpg_excl</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--noCpG&quot;</span><span class="p">,</span>
                          <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s">&quot;nocpg&quot;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s">&quot;dont use Cs and Gs in CpG context&quot;</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">cpg_excl</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--UDGhalf&quot;</span><span class="p">,</span>
                          <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                          <span class="n">dest</span><span class="o">=</span><span class="s">&quot;UDGhalf&quot;</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;only use Cs and Gs in CpG context, the first &quot;</span>
                                <span class="s">&quot;and last base are used regardless of &quot;</span>
                                <span class="s">&quot;dinucleotide context&quot;</span><span class="p">),</span>
                          <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c">#    cpg_options.add_argument(&quot;--UDGplus&quot;,</span>
<span class="c">#                             action=&quot;store_true&quot;,</span>
<span class="c">#                             dest=&quot;UDGplus&quot;,</span>
<span class="c">#                             help=&quot;only use Cs and Gs in CpG context \</span>
<span class="c">#                             (synonymous with option --CpG)&quot;,</span>
<span class="c">#                             default=False)</span>
    <span class="n">cpg_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--UDGminus&quot;</span><span class="p">,</span>
                             <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                             <span class="n">dest</span><span class="o">=</span><span class="s">&quot;UDGminus&quot;</span><span class="p">,</span>
                             <span class="n">help</span><span class="o">=</span><span class="s">&quot;use all bases (placeholder)&quot;</span><span class="p">,</span>
                             <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># options controlling output</span>
    <span class="n">output_options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">&quot;output&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s">&quot;control type and detail of output&quot;</span>
    <span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--verbose&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--header&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;header&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;output the SAM header&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--writesamfield&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;writesamfield&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;add &#39;DS:Z:&lt;PMDS&gt;&#39; field to SAM output, </span><span class="se">\</span>
<span class="s">                                will overwrite if already present&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--stats&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;stats&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;output summarizing statistics to stderr&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--debug&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;debug&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;show additional information for </span><span class="se">\</span>
<span class="s">                                debugging&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="s">&quot;--printDS&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;printDS&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;print PMD scores&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--printalignments&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;printalignments&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;print human readable alignments&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--platypus&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;platypus&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;output big list of base frequencies for </span><span class="se">\</span>
<span class="s">                                platypus&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="s">&quot;--deamination&quot;</span><span class="p">,</span>
                                <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s">&quot;deamination&quot;</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s">&quot;output base frequencies in the read at </span><span class="se">\</span>
<span class="s">                                positions where there are C or G in the </span><span class="se">\</span>
<span class="s">                                reference&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># options to modify calculation of percent identity</span>
    <span class="n">perc_id_options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">&quot;percent identity&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s">&quot;options to modify calculation of percent identity&quot;</span>
    <span class="p">)</span>
    <span class="n">perc_id_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--include_deamination&quot;</span><span class="p">,</span>
                                 <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                 <span class="n">dest</span><span class="o">=</span><span class="s">&quot;include_deamination&quot;</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s">&quot;treat possibly deaminated T&gt;C and A&gt;G </span><span class="se">\</span>
<span class="s">                                 pairs as mismatches in calculation of </span><span class="se">\</span>
<span class="s">                                 percent identity&quot;</span><span class="p">,</span>
                                 <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">perc_id_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--include_indels&quot;</span><span class="p">,</span>
                                 <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                 <span class="n">dest</span><span class="o">=</span><span class="s">&quot;include_indels&quot;</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s">&quot;treat insertions and deletions as </span><span class="se">\</span>
<span class="s">                                 mismatches in calculation of percent </span><span class="se">\</span>
<span class="s">                                 identity&quot;</span><span class="p">,</span>
                                 <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">perc_id_options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--include_unknown&quot;</span><span class="p">,</span>
                                 <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                                 <span class="n">dest</span><span class="o">=</span><span class="s">&quot;include_unknown&quot;</span><span class="p">,</span>
                                 <span class="n">help</span><span class="o">=</span><span class="s">&quot;treat Ns in either read or reference </span><span class="se">\</span>
<span class="s">                                 as mismatch in calculation of percent </span><span class="se">\</span>
<span class="s">                                 identity&quot;</span><span class="p">,</span>
                                 <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># remaining options</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--version&#39;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&#39;version&#39;</span><span class="p">,</span>
                        <span class="n">version</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%(prog)s</span><span class="s"> v0.55 (modified)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--PMDSprim&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;PMDSprim&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;PMDSprim&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--PMDSprimthreshold&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;PMDSprimthreshold&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;PMDSprimthreshold&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--first&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;first&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;outputs the deamination rate at the first </span><span class="se">\</span>
<span class="s">                        position only, but with a standard error&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--range&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;range&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;output deamination patterns for this many </span><span class="se">\</span>
<span class="s">                        positions from the sequence terminus (default=30)&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--noclips&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;noclips&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;no clips&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--noindels&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;noindels&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;no indels&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--onlyclips&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;onlyclips&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;only clips&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--onlydeletions&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;onlydeletions&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;only deletions&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--onlyinsertions&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;onlyinsertions&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;only insertions&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--nodeletions&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;nodeletions&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;no deletions&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--noinsertions&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;noinsertions&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;no insertions&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--notreverse&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;notreverse&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;no reverse complement alignments&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-a&quot;</span><span class="p">,</span> <span class="s">&quot;--adjustbaseq&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;adjustbaseq&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;apply PMD-aware adjustment of base quality </span><span class="se">\</span>
<span class="s">                        scores specific to C&gt;T and G&gt;A mismatches to the </span><span class="se">\</span>
<span class="s">                        reference&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--adjustbaseq_all&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;adjustbaseq_all&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;apply PMD-aware adjustment of base quality </span><span class="se">\</span>
<span class="s">                        scores regardless of observed bases&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--samtoolspath&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;samtoolspath&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;full path to samtools&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s">&#39;samtools&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--basecomposition&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;basecomposition&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;basecomposition&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-r&quot;</span><span class="p">,</span> <span class="s">&quot;--refseq&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;refseq&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;refseq&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--estimate&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;estimate&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;two-terminus estimate of contamination&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;--estimatebase&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;estimatebase&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;position of base used fortwo-terminus estimate </span><span class="se">\</span>
<span class="s">                        of contamination&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-b&quot;</span><span class="p">,</span> <span class="s">&quot;--basic&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s">&quot;store&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s">&quot;basic&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&quot;only output reads with a C&gt;T mismatch this </span><span class="se">\</span>
<span class="s">                        many basepairs from the 5&#39; end&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

<span class="c">#    if options.UDGplus:</span>
<span class="c">#        options.CpG = True</span>

<span class="c">#    maxlen = options.maxlength</span>

    <span class="c"># pre-compute probabilities of deamination for 1000 bases under modern and</span>
    <span class="c"># ancient models</span>
    <span class="n">modern_model_deam</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">repeat</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)]</span>
    <span class="n">ancient_model_deam</span> <span class="o">=</span> <span class="p">[</span><span class="n">geometric</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">PMDpparam</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">PMDconstant</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)]</span>
    <span class="n">adjustment_model_deam</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq_all</span><span class="p">:</span>
        <span class="c"># constant is 0.0 here in contrast to model used to compute PMD scores</span>
        <span class="n">adjustment_model_deam</span> <span class="o">=</span> <span class="p">[</span><span class="n">geometric</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">PMDpparam</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)]</span>

    <span class="c"># base composition</span>
<span class="c">#    start_count = 0</span>
<span class="c">#    rev_start_count = 0</span>
<span class="c">#    not_counted = 0</span>
<span class="c">#    imperfect = 0</span>

<span class="c">#    start_dict= {}</span>
<span class="c">#    start_dict_rev = {}</span>
    <span class="n">mismatch_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mismatch_dict_rev</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c">#    mismatch_dict_CpG = {}</span>
<span class="c">#    mismatch_dict_CpG_rev = {}</span>

    <span class="n">firstC</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">firstT</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">clipexcluded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">indelexcluded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cigarextexcluded</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># reads excluded for extended CIGAR (N, H, P, not S)</span>
    <span class="n">identityexcluded</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># reads excluded due to percent identity filter</span>
    <span class="n">noMD</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">noGCexcluded</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">excluded_threshold</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">noquals</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c">#    maskings = 0</span>
<span class="c">#</span>
<span class="c">#    CCandCC = 0</span>
<span class="c">#    CTandCC = 0</span>
<span class="c">#    CCandCT = 0</span>
<span class="c">#    CTandCT = 0</span>
<span class="c">#</span>
<span class="c">#    estimator_list = []</span>

    <span class="n">composition_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">composition_dict_rev</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">line_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">line_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

<span class="c">#        readname = col[0]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">chromosome</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">chromosome</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chromosome</span> <span class="o">!=</span> <span class="n">options</span><span class="o">.</span><span class="n">chromosome</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="n">MAPQ</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">read</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">readlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
        <span class="n">quals</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">cigar</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">quals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">noquals</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">noinsertions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;I&#39;</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">nodeletions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;D&#39;</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">onlyinsertions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;I&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">onlydeletions</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;D&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">noindels</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;I&#39;</span> <span class="ow">in</span> <span class="n">cigar</span> <span class="ow">or</span> <span class="s">&#39;D&#39;</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
                <span class="n">indelexcluded</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">noclips</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">cigar</span> <span class="ow">or</span> <span class="s">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">cigar</span> <span class="ow">or</span> <span class="s">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">cigar</span> <span class="ow">or</span> <span class="s">&#39;P&#39;</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
                <span class="n">clipexcluded</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">onlyclips</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="s">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">cigar</span> <span class="ow">or</span> <span class="s">&#39;P&#39;</span> <span class="ow">in</span> <span class="n">cigar</span> <span class="ow">or</span> <span class="s">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">cigar</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;cigar found: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cigar</span><span class="p">,),</span>
                  <span class="s">&quot;PMDtools only supports cigar operations M, I, S and D,&quot;</span><span class="p">,</span>
                  <span class="s">&quot;the alignment has been excluded&quot;</span><span class="p">,</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">cigarextexcluded</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">MAPQ</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">mapq</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># read length filter</span>
        <span class="c"># TODO check for default values unnecessary, just remove defaults and</span>
        <span class="c"># check for args directly</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">readlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">readlength</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">minlength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">minlength</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">maxlength</span> <span class="o">!=</span> <span class="mi">300</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">maxlength</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">read</span><span class="p">):</span>
                <span class="k">continue</span>

        <span class="c"># chromosome filter</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">chromosome</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chromosome</span> <span class="o">!=</span> <span class="n">options</span><span class="o">.</span><span class="n">chromosome</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c"># check orientation of read</span>
        <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">:</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">:</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reverse</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># filter reverse reads</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">notreverse</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c"># check for previously calculated PMD score</span>
        <span class="n">DSfield</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s">&#39;DS:Z:&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">DSfield</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">PMDS</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;DS:Z:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">LR</span> <span class="o">=</span> <span class="n">PMDS</span>
<span class="c">#            print PMDS</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recreate reference sequence from MD field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DSfield</span> <span class="ow">is</span> <span class="bp">False</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">writesamfield</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">basic</span> <span class="o">&gt;</span> <span class="mi">0</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">perc_identity</span> <span class="o">&gt;</span> <span class="mf">0.01</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">printalignments</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq_all</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">deamination</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">dry</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">estimate</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">first</span><span class="p">):</span>
            <span class="n">read</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">MD</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;MD:Z:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">noMD</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c"># using external library to reconstruct reference from CIGAR and MD</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">reconstruct</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">cigar</span><span class="p">,</span> <span class="n">MD</span><span class="p">)</span>
            <span class="p">(</span><span class="n">rec_ref_full</span><span class="p">,</span> <span class="n">rec_read_full</span><span class="p">,</span> <span class="n">rec_ref_aln</span><span class="p">,</span> <span class="n">rec_read_aln</span><span class="p">)</span> <span class="o">=</span> <span class="n">rec</span>

            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">read</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
                <span class="c"># don&#39;t use raw read beyond here...</span>
                <span class="n">rec_ref_full</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">rec_ref_full</span><span class="p">)</span>
                <span class="n">rec_read_full</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">rec_read_full</span><span class="p">)</span>
                <span class="n">rec_ref_aln</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">rec_ref_aln</span><span class="p">)</span>
                <span class="n">rec_read_aln</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">rec_read_aln</span><span class="p">)</span>
                <span class="n">quals</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c"># this assumption previously lead to trouble because of missing</span>
            <span class="c"># gaps in aligned read!</span>
            <span class="n">real_read</span> <span class="o">=</span> <span class="n">read</span>
            <span class="n">real_ref_seq</span> <span class="o">=</span> <span class="n">rec_ref_aln</span>

        <span class="c"># debugging the reference sequence reconstruction</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="s">read</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t</span><span class="s">ref&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_read</span><span class="p">,</span> <span class="n">real_ref_seq</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;CIGAR:</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cigar</span><span class="p">,))</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;MD:</span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MD</span><span class="p">,))</span>

        <span class="c"># GC content filter</span>
        <span class="c"># FA: Read and aligned reference can have different lengths!</span>
        <span class="c"># See genetics.gc() for a faster, case-unaware alternative considering</span>
        <span class="c"># all ambiguity codes.</span>
<span class="c">#        GCcontent = (1.0 * (real_ref_seq.count(&#39;G&#39;) + real_ref_seq.count(&#39;C&#39;))</span>
<span class="c">#                     / readlen)</span>
        <span class="n">GCcontent</span> <span class="o">=</span> <span class="n">gc</span><span class="p">(</span><span class="n">real_ref_seq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">GCcontent</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">maxGC</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">GCcontent</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">minGC</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c"># test for empty reference sequence TODO include in reconstruction</span>
        <span class="c"># method and throw exception?</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;G&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_ref_seq</span>
           <span class="ow">and</span> <span class="s">&#39;C&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_ref_seq</span>
           <span class="ow">and</span> <span class="s">&#39;T&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_ref_seq</span>
           <span class="ow">and</span> <span class="s">&#39;A&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_ref_seq</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;bad reference sequence reconstruction: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">real_ref_seq</span><span class="p">,</span>
                  <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;SAM line: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,))</span>
            <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">basecomposition</span><span class="p">:</span>
            <span class="n">backoffset</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">endpos</span> <span class="o">=</span> <span class="n">position</span>
                <span class="n">startpos</span> <span class="o">=</span> <span class="n">position</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">real_read</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">startpos</span> <span class="o">=</span> <span class="n">position</span>
                <span class="n">endpos</span> <span class="o">=</span> <span class="n">position</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">real_read</span><span class="p">)</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            5&#39; end</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">largerefseq</span> <span class="o">=</span> <span class="n">fa_get</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">refseq</span><span class="p">,</span>
                                 <span class="n">chromosome</span><span class="p">,</span>
                                 <span class="n">startpos</span> <span class="o">-</span> <span class="n">backoffset</span><span class="p">,</span>
                                 <span class="n">startpos</span> <span class="o">+</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">largerefseq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
<span class="c">#            print largerefseq</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">largerefseq</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">largerefseq</span><span class="p">)</span>
<span class="c">#            print(largerefseq, real_read)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">backoffset</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">):</span>
<span class="c">#                print(i+backoffset, len(largerefseq))</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">largerefseq</span><span class="p">[</span><span class="nb">min</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="n">backoffset</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">largerefseq</span><span class="p">)])]</span>
                <span class="n">thekey</span> <span class="o">=</span> <span class="s">&#39;5&#39;</span> <span class="o">+</span> <span class="n">base</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">thekey</span> <span class="ow">in</span> <span class="n">composition_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">addition</span> <span class="o">=</span> <span class="n">composition_dict</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                    <span class="n">addition</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">composition_dict</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">addition</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">composition_dict</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            3&#39; end</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">largerefseq</span> <span class="o">=</span> <span class="n">fa_get</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">refseq</span><span class="p">,</span>
                                 <span class="n">chromosome</span><span class="p">,</span>
                                 <span class="n">endpos</span> <span class="o">-</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">,</span>
                                 <span class="n">endpos</span> <span class="o">+</span> <span class="n">backoffset</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">largerefseq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">largerefseq</span> <span class="o">=</span> <span class="n">reverse_complement</span><span class="p">(</span><span class="n">largerefseq</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">backoffset</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">):</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">largerefseq</span><span class="p">[</span><span class="nb">min</span><span class="p">([</span><span class="n">i</span> <span class="o">+</span> <span class="n">backoffset</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">largerefseq</span><span class="p">)])]</span>
                <span class="n">thekey</span> <span class="o">=</span> <span class="s">&#39;3&#39;</span> <span class="o">+</span> <span class="n">base</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">thekey</span> <span class="ow">in</span> <span class="n">composition_dict_rev</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">addition</span> <span class="o">=</span> <span class="n">composition_dict_rev</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                    <span class="n">addition</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">composition_dict_rev</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span> <span class="o">=</span> <span class="n">addition</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">composition_dict_rev</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">continue</span>    <span class="c"># useless?</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        basic filter</span>
<span class="sd">        prints the SAM line if a C&gt;T mismatch with sufficient base quality is</span>
<span class="sd">        observed in the first n bases, where n is specified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">basic</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="c">#            start_position = len(real_read) - len(real_read.lstrip(&#39;-&#39;))</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">real_read</span><span class="p">,</span> <span class="n">real_ref_seq</span><span class="p">,</span>
                               <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">real_ref_seq</span><span class="p">))):</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;N&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&#39;N&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">x</span>                       <span class="c"># - start_position</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">readlen</span><span class="p">:</span>            <span class="c"># 20</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">options</span><span class="o">.</span><span class="n">basic</span><span class="p">:</span>
                    <span class="k">break</span>
<span class="c">#                print(a, b, i)</span>
                <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cpg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span>
                       <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">quals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">33</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">baseq</span>
                       <span class="ow">and</span> <span class="n">real_ref_seq</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;G&#39;</span><span class="p">):</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
                        <span class="k">break</span>

                <span class="k">elif</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span>
                      <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">quals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mi">33</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">baseq</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
                    <span class="k">break</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        first base</span>
<span class="sd">        prints the deamination rate at the first base and a standard error</span>
<span class="sd">        computed by jackknife over reads</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">first</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">real_ref_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">real_read</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">cpg</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span>
                   <span class="ow">and</span> <span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">33</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">baseq</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">real_ref_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;G&#39;</span><span class="p">)):</span>
                    <span class="n">firstT</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span>
                   <span class="ow">and</span> <span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">33</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">baseq</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">real_ref_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;G&#39;</span><span class="p">)):</span>
                    <span class="n">firstC</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span>
                   <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">33</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">baseq</span><span class="p">):</span>
                    <span class="n">firstT</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span>
                   <span class="ow">and</span> <span class="nb">ord</span><span class="p">(</span><span class="n">quals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">33</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">baseq</span><span class="p">):</span>
                    <span class="n">firstC</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">perc_identity</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">printalignments</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            divergence filter</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="p">(</span><span class="n">perc_identity</span><span class="p">,</span> <span class="n">mismatch_string</span><span class="p">)</span> <span class="o">=</span> <span class="n">aln_identity</span><span class="p">(</span>
                <span class="n">rec_read_aln</span><span class="p">,</span>
                <span class="n">rec_ref_aln</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">include_indels</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">include_deamination</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">include_unknown</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">perc_identity</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">perc_identity</span><span class="p">:</span>
                <span class="n">identityexcluded</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        start PMD score computations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DSfield</span> <span class="ow">is</span> <span class="bp">False</span>
           <span class="ow">or</span> <span class="p">(</span><span class="n">DSfield</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">writesamfield</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">)</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">basic</span> <span class="o">&gt;</span> <span class="mi">0</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq_all</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">deamination</span>
           <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">dry</span><span class="p">):</span>

            <span class="p">(</span><span class="n">L_D</span><span class="p">,</span> <span class="n">L_M</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">newquals</span><span class="p">)</span> <span class="o">=</span> <span class="n">score_pmd</span><span class="p">(</span>
                <span class="n">rec_read_full</span><span class="p">,</span>  <span class="c"># was: real_read</span>
                <span class="n">rec_ref_full</span><span class="p">,</span>   <span class="c"># was: real_ref_seq</span>
                <span class="n">quals</span><span class="p">,</span>
                <span class="n">ancient_model_deam</span><span class="p">,</span>
                <span class="n">modern_model_deam</span><span class="p">,</span>
                <span class="n">adjustment_model_deam</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">polymorphism_contamination</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">polymorphism_ancient</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq_all</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq</span><span class="p">,</span>
                <span class="n">options</span><span class="o">.</span><span class="n">baseq</span>
            <span class="p">)</span>
            <span class="c"># TODO re-enable these options step by step...</span>
<span class="c">#                options.deamination,</span>
<span class="c">#                options.cpg,</span>
<span class="c">#                options.nocpg,</span>
<span class="c">#                options.UDGhalf,</span>
<span class="c">#                options.PMDSprim)</span>

<span class="c">#            if options.PMDSprim:</span>
<span class="c">#                maxPMDSval = math.log(L_D_max / L_M_max)</span>
<span class="c">#                maxPMDSval = maxPMDSval / readlen</span>
<span class="c">#                if LR &gt; 0.0:</span>
<span class="c">#                    LRnumerator = math.log(L_D_max / L_M_max)</span>
<span class="c">#                elif LR &lt; 0.0:</span>
<span class="c">#                    LRnumerator = math.log(L_D_max / L_M_max)</span>
<span class="c">#                if options.PMDSprimthreshold:</span>
<span class="c">#                    if maxPMDSval &lt; options.PMDSprimthreshold:</span>
<span class="c">#                        continue</span>
<span class="c">#</span>
<span class="c">#                if options.printDS:</span>
<span class="c">#                    print(LR, maxPMDSval, maxPMDSval, maxPMDSval * readlen,</span>
<span class="c">#                          readlen)</span>
<span class="c">##                LR = LR / LRnumerator</span>
<span class="c">#            quals = newquals</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">adjustbaseq</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">qualsp</span> <span class="o">=</span> <span class="n">quals</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qualsp</span> <span class="o">=</span> <span class="n">quals</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span>
                    <span class="o">+</span> <span class="n">qualsp</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span>
                    <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">11</span><span class="p">:]))</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add PMDS tag</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">writesamfield</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c"># remove DS field if present</span>
            <span class="k">if</span> <span class="n">DSfield</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">newline</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&#39;DS:Z:&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newline</span> <span class="o">+=</span> <span class="n">col</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">newline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;DS:Z:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">printDS</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">L_D</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">L_M</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">L_D</span> <span class="o">/</span> <span class="n">L_M</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">LR</span><span class="p">)</span>
<span class="c">#            print(L_D, &#39;\t&#39;, L_M, &#39;\t&#39;, L_D / L_M, &#39;\t&#39;, LR, &#39;\t&#39;,</span>
<span class="c">#                  readlen, &#39;\t&#39;,</span>
<span class="c">#                  perc_identity, &#39;\t&#39;,</span>
<span class="c">#                  perc_identity * math.log(L_D / L_M))</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">dry</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">-</span><span class="mi">10000</span><span class="p">)</span> <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">upperthreshold</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">LR</span> <span class="o">&gt;=</span> <span class="n">options</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">and</span> <span class="n">LR</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">upperthreshold</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">excluded_threshold</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">printalignments</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">10000</span>
               <span class="ow">or</span> <span class="n">options</span><span class="o">.</span><span class="n">upperthreshold</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">LR</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">L_D</span> <span class="o">/</span> <span class="n">L_M</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">LR</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">threshold</span>
                   <span class="ow">or</span> <span class="n">LR</span> <span class="o">&gt;</span> <span class="n">options</span><span class="o">.</span><span class="n">upperthreshold</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">):</span>
                    <span class="k">continue</span>

            <span class="n">quals1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">quals2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">quals</span><span class="p">:</span>
                <span class="n">qnum</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">-</span> <span class="mi">33</span>
                <span class="k">if</span> <span class="n">qnum</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">quals1</span> <span class="o">+=</span> <span class="s">&#39;0&#39;</span>
                    <span class="n">quals2</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">quals1</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">qnum</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">quals2</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">qnum</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="c">#            print(MD, cigar, reverse)</span>
<span class="c">#            print(col[9])</span>
            <span class="k">print</span><span class="p">(</span><span class="n">real_read</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">mismatch_string</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">real_ref_seq</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">quals</span><span class="p">)</span>
<span class="c">#            print(quals1)</span>
<span class="c">#            print(quals2)</span>
<span class="c">#            print(col[10])</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">passed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">passed</span> <span class="o">&gt;=</span> <span class="n">options</span><span class="o">.</span><span class="n">maxreads</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">first</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">firstC</span> <span class="o">+</span> <span class="n">firstT</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">firstT</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">SE</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">freq</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">freq</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">SE</span> <span class="o">=</span> <span class="s">&#39;NA&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;C&gt;T at first position and SE:&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">SE</span><span class="p">)</span>
<span class="c">#        print(&#39;C&gt;T at first position and SE:&#39;, freq, &#39;\t&#39;, SE, &#39;\t&#39;,</span>
<span class="c">#              n, firstC, firstT)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">stats</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="c"># added stats</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;excluded due to extended CIGAR (H, N, P):</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">cigarextexcluded</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;excluded due percent identity filter:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">identityexcluded</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;excluded due to clipping:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">clipexcluded</span><span class="p">,),</span>
              <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;excluded due to indels:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indelexcluded</span><span class="p">,),</span>
              <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;no MD field:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">noMD</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;no G or C in ref:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">noGCexcluded</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;total seqs:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">passed</span><span class="p">,),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;excluded due to PMD score &lt; </span><span class="si">%i</span><span class="s">:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span>
              <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">threshold</span><span class="p">),</span> <span class="n">excluded_threshold</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;passed seqs:</span><span class="se">\t</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">passed</span> <span class="o">-</span> <span class="n">excluded_threshold</span><span class="p">,),</span>
              <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">deamination</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;CT&#39;</span><span class="p">,</span> <span class="s">&#39;CA&#39;</span><span class="p">,</span> <span class="s">&#39;CG&#39;</span><span class="p">,</span> <span class="s">&#39;CC&#39;</span><span class="p">,</span> <span class="s">&#39;GA&#39;</span><span class="p">,</span> <span class="s">&#39;GT&#39;</span><span class="p">,</span> <span class="s">&#39;GC&#39;</span><span class="p">,</span> <span class="s">&#39;GG&#39;</span><span class="p">]</span>
            <span class="n">itotaldict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ztotaldict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">):</span>
                <span class="n">itotal</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ztotal</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                    <span class="n">thekey</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">itotal</span> <span class="o">+=</span> <span class="n">mismatch_dict</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ztotal</span> <span class="o">+=</span> <span class="n">mismatch_dict_rev</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">itotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">itotal</span>
                <span class="n">ztotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ztotal</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;z</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pairs</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                    <span class="n">thekey</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">thecount</span> <span class="o">=</span> <span class="n">mismatch_dict</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;0.00000</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">thetotal</span> <span class="o">=</span> <span class="n">itotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">frac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">thecount</span> <span class="o">/</span> <span class="n">thetotal</span>
                    <span class="k">if</span> <span class="s">&#39;G&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">thecount</span> <span class="o">=</span> <span class="n">mismatch_dict_rev</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;0.00000</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">thetotal</span> <span class="o">=</span> <span class="n">ztotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">frac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">thecount</span> <span class="o">/</span> <span class="n">thetotal</span>
                    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">basecomposition</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">composition_dict</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">composition_dict_rev</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;5T&#39;</span><span class="p">,</span> <span class="s">&#39;5A&#39;</span><span class="p">,</span> <span class="s">&#39;5G&#39;</span><span class="p">,</span> <span class="s">&#39;5C&#39;</span><span class="p">,</span> <span class="s">&#39;3T&#39;</span><span class="p">,</span> <span class="s">&#39;3A&#39;</span><span class="p">,</span> <span class="s">&#39;3G&#39;</span><span class="p">,</span> <span class="s">&#39;3C&#39;</span><span class="p">]</span>
            <span class="n">itotaldict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ztotaldict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">backoffset</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">):</span>
                <span class="n">itotal</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ztotal</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                    <span class="n">thekey</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">itotal</span> <span class="o">+=</span> <span class="n">composition_dict</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ztotal</span> <span class="o">+=</span> <span class="n">composition_dict_rev</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">itotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">itotal</span>
                <span class="n">ztotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ztotal</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;z</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pairs</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">backoffset</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">range</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                    <span class="n">thekey</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;5&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">thecount</span> <span class="o">=</span> <span class="n">composition_dict</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;0.00000</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">thetotal</span> <span class="o">=</span> <span class="n">itotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">frac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">thecount</span> <span class="o">/</span> <span class="n">thetotal</span>
                    <span class="k">if</span> <span class="s">&#39;3&#39;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">thecount</span> <span class="o">=</span> <span class="n">composition_dict_rev</span><span class="p">[</span><span class="n">thekey</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&#39;0.00000</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">thetotal</span> <span class="o">=</span> <span class="n">ztotaldict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">frac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">thecount</span> <span class="o">/</span> <span class="n">thetotal</span>
                    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="nb">exit</span><span class="p">()</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">SamSifter 0.4.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Florian Aldehoff.
      Last updated on Feb 20, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>