<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>
            
    
    What&#8217;s New in SQLAlchemy 1.0?
 &mdash;
    SQLAlchemy 0.9 Documentation

        </title>

        
            <!-- begin iterate through SQLA + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
            <!-- end iterate through SQLA + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 0.9 Documentation" href="../index.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">0.9.9</span> | Release Date: March 10, 2015
    </div>

    <h1>SQLAlchemy 0.9 Documentation</h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 0.9 Documentation</a></h3>

            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <input type="text" name="q" size="12" /> <input type="submit" value="Search" />
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        
        <h3>
            <a href="../index.html" title="SQLAlchemy 0.9 Documentation">SQLAlchemy 0.9 Documentation</a>
        </h3>

        <ul>
<li><span class="link-container first"><a class="reference external" href="../intro.html">Overview</a></span></li>
<li><span class="link-container first"><a class="reference external" href="../orm/index.html">SQLAlchemy ORM</a></span></li>
<li><span class="link-container first"><a class="reference external" href="../core/index.html">SQLAlchemy Core</a></span></li>
<li><span class="link-container first"><a class="reference external" href="../dialects/index.html">Dialects</a></span></li>
<li><span class="link-container first"><a class="reference external" href="../faq/index.html">Frequently Asked Questions</a></span></li>
<li><span class="link-container first"><a class="reference external" href="index.html">Changes and Migration</a></span></li>
</ul>



        </div>

    </div>

    

    <div id="docs-body" class="withsidebar" >
        
<div class="section" id="what-s-new-in-sqlalchemy-1-0">
<h1>What&#8217;s New in SQLAlchemy 1.0?<a class="headerlink" href="#what-s-new-in-sqlalchemy-1-0" title="Permalink to this headline">¶</a></h1>
<div class="admonition-about-this-document admonition">
<p class="first admonition-title">About this Document</p>
<p>This document describes changes between SQLAlchemy version 0.9,
undergoing maintenance releases as of May, 2014,
and SQLAlchemy version 1.0, as of yet unreleased.</p>
<p class="last">Document last updated: December 14, 2014</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This guide introduces what&#8217;s new in SQLAlchemy version 1.0,
and also documents changes which affect users migrating
their applications from the 0.9 series of SQLAlchemy to 1.0.</p>
<p>Please carefully review the sections on behavioral changes for
potentially backwards-incompatible changes in behavior.</p>
</div>
<div class="section" id="new-features-and-improvements-orm">
<h2>New Features and Improvements - ORM<a class="headerlink" href="#new-features-and-improvements-orm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="new-session-bulk-insert-update-api">
<h3>New Session Bulk INSERT/UPDATE API<a class="headerlink" href="#new-session-bulk-insert-update-api" title="Permalink to this headline">¶</a></h3>
<p>A new series of <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><tt class="xref py py-class docutils literal"><span class="pre">Session</span></tt></a> methods which provide hooks directly
into the unit of work&#8217;s facility for emitting INSERT and UPDATE
statements has been created.  When used correctly, this expert-oriented system
can allow ORM-mappings to be used to generate bulk insert and update
statements batched into executemany groups, allowing the statements
to proceed at speeds that rival direct use of the Core.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><em class="xref std std-ref">bulk_operations</em> - introduction and full documentation</p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3100">#3100</a></p>
</div>
<div class="section" id="new-performance-example-suite">
<h3>New Performance Example Suite<a class="headerlink" href="#new-performance-example-suite" title="Permalink to this headline">¶</a></h3>
<p>Inspired by the benchmarking done for the <em class="xref std std-ref">bulk_operations</em> feature
as well as for the <a class="reference internal" href="../faq/performance.html#faq-how-to-profile"><em>How can I profile a SQLAlchemy powered application?</em></a> section of the FAQ, a new
example section has been added which features several scripts designed
to illustrate the relative performance profile of various Core and ORM
techniques.  The scripts are organized into use cases, and are packaged
under a single console interface such that any combination of demonstrations
can be run, dumping out timings, Python profile results and/or RunSnake profile
displays.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><em class="xref std std-ref">examples_performance</em></p>
</div>
</div>
<div class="section" id="improvements-to-declarative-mixins-declared-attr-and-related-features">
<span id="feature-3150"></span><h3>Improvements to declarative mixins, <tt class="docutils literal"><span class="pre">&#64;declared_attr</span></tt> and related features<a class="headerlink" href="#improvements-to-declarative-mixins-declared-attr-and-related-features" title="Permalink to this headline">¶</a></h3>
<p>The declarative system in conjunction with <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><tt class="xref py py-class docutils literal"><span class="pre">declared_attr</span></tt></a> has been
overhauled to support new capabilities.</p>
<p>A function decorated with <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><tt class="xref py py-class docutils literal"><span class="pre">declared_attr</span></tt></a> is now called only <strong>after</strong>
any mixin-based column copies are generated.  This means the function can
call upon mixin-established columns and will receive a reference to the correct
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><tt class="xref py py-class docutils literal"><span class="pre">Column</span></tt></a> object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HasFooBar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">foobar</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">foobar_prop</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">column_property</span><span class="p">(</span><span class="s">&#39;foobar: &#39;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">foobar</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="n">HasFooBar</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;some_table&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
</div>
<p>Above, <tt class="docutils literal"><span class="pre">SomeClass.foobar_prop</span></tt> will be invoked against <tt class="docutils literal"><span class="pre">SomeClass</span></tt>,
and <tt class="docutils literal"><span class="pre">SomeClass.foobar</span></tt> will be the final <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><tt class="xref py py-class docutils literal"><span class="pre">Column</span></tt></a> object that is
to be mapped to <tt class="docutils literal"><span class="pre">SomeClass</span></tt>, as opposed to the non-copied object present
directly on <tt class="docutils literal"><span class="pre">HasFooBar</span></tt>, even though the columns aren&#8217;t mapped yet.</p>
<p>The <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><tt class="xref py py-class docutils literal"><span class="pre">declared_attr</span></tt></a> function now <strong>memoizes</strong> the value
that&#8217;s returned on a per-class basis, so that repeated calls to the same
attribute will return the same value.  We can alter the example to illustrate
this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HasFooBar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">foobar</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">foobar_prop</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">column_property</span><span class="p">(</span><span class="s">&#39;foobar: &#39;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">foobar</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="n">HasFooBar</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;some_table&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
</div>
<p>Previously, <tt class="docutils literal"><span class="pre">SomeClass</span></tt> would be mapped with one particular copy of
the <tt class="docutils literal"><span class="pre">foobar</span></tt> column, but the <tt class="docutils literal"><span class="pre">foobar_prop</span></tt> by calling upon <tt class="docutils literal"><span class="pre">foobar</span></tt>
a second time would produce a different column.   The value of
<tt class="docutils literal"><span class="pre">SomeClass.foobar</span></tt> is now memoized during declarative setup time, so that
even before the attribute is mapped by the mapper, the interim column
value will remain consistent no matter how many times the
<a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><tt class="xref py py-class docutils literal"><span class="pre">declared_attr</span></tt></a> is called upon.</p>
<p>The two behaviors above should help considerably with declarative definition
of many types of mapper properties that derive from other attributes, where
the <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><tt class="xref py py-class docutils literal"><span class="pre">declared_attr</span></tt></a> function is called upon from other
<a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.declared_attr" title="sqlalchemy.ext.declarative.declared_attr"><tt class="xref py py-class docutils literal"><span class="pre">declared_attr</span></tt></a> functions locally present before the class is
actually mapped.</p>
<p>For a pretty slim edge case where one wishes to build a declarative mixin
that establishes distinct columns per subclass, a new modifier
<tt class="xref py py-attr docutils literal"><span class="pre">declared_attr.cascading</span></tt> is added.  With this modifier, the
decorated function will be invoked individually for each class in the
mapped inheritance hierarchy.  While this is already the behavior for
special attributes such as <tt class="docutils literal"><span class="pre">__table_args__</span></tt> and <tt class="docutils literal"><span class="pre">__mapper_args__</span></tt>,
for columns and other properties the behavior by default assumes that attribute
is affixed to the base class only, and just inherited from subclasses.
With <tt class="xref py py-attr docutils literal"><span class="pre">declared_attr.cascading</span></tt>, individual behaviors can be
applied:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HasSomeAttribute</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@declared_attr.cascading</span>
    <span class="k">def</span> <span class="nf">some_id</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_inherited_table</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;myclass.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">HasSomeAttribute</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="s">&quot;&quot;</span>
    <span class="c"># ...</span>

<span class="k">class</span> <span class="nc">MySubClass</span><span class="p">(</span><span class="n">MyClass</span><span class="p">):</span>
    <span class="s">&quot;&quot;</span>
    <span class="c"># ...</span></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><em class="xref std std-ref">mixin_inheritance_columns</em></p>
</div>
<p>Finally, the <a class="reference internal" href="../orm/extensions/declarative/api.html#sqlalchemy.ext.declarative.AbstractConcreteBase" title="sqlalchemy.ext.declarative.AbstractConcreteBase"><tt class="xref py py-class docutils literal"><span class="pre">AbstractConcreteBase</span></tt></a> class has been reworked
so that a relationship or other mapper property can be set up inline
on the abstract base:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="p">(</span><span class="n">declarative_base</span><span class="p">,</span> <span class="n">declared_attr</span><span class="p">,</span>
    <span class="n">AbstractConcreteBase</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Something</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">u&#39;something&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Abstract</span><span class="p">(</span><span class="n">AbstractConcreteBase</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">something_id</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Something</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="nd">@declared_attr</span>
    <span class="k">def</span> <span class="nf">something</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Something</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Concrete</span><span class="p">(</span><span class="n">Abstract</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">u&#39;cca&#39;</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;cca&#39;</span><span class="p">,</span> <span class="s">&#39;concrete&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span></pre></div>
</div>
<p>The above mapping will set up a table <tt class="docutils literal"><span class="pre">cca</span></tt> with both an <tt class="docutils literal"><span class="pre">id</span></tt> and
a <tt class="docutils literal"><span class="pre">something_id</span></tt> column, and <tt class="docutils literal"><span class="pre">Concrete</span></tt> will also have a relationship
<tt class="docutils literal"><span class="pre">something</span></tt>.  The new feature is that <tt class="docutils literal"><span class="pre">Abstract</span></tt> will also have an
independently configured relationship <tt class="docutils literal"><span class="pre">something</span></tt> that builds against
the polymorphic union of the base.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3150">#3150</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2670">#2670</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3149">#3149</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2952">#2952</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3050">#3050</a></p>
</div>
<div class="section" id="orm-full-object-fetches-25-faster">
<h3>ORM full object fetches 25% faster<a class="headerlink" href="#orm-full-object-fetches-25-faster" title="Permalink to this headline">¶</a></h3>
<p>The mechanics of the <tt class="docutils literal"><span class="pre">loading.py</span></tt> module as well as the identity map
have undergone several passes of inlining, refactoring, and pruning, so
that a raw load of rows now populates ORM-based objects around 25% faster.
Assuming a 1M row table, a script like the following illustrates the type
of load that&#8217;s improved the most:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="p">)</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="s">&#39;mysql+mysqldb://scott:tiger@localhost/test&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c"># avoid using all() so that we don&#39;t have the overhead of building</span>
<span class="c"># a large list of full objects in memory</span>
<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">print</span><span class="p">(</span><span class="s">&quot;Total time: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span></pre></div>
</div>
<p>Local MacBookPro results bench from 19 seconds for 0.9 down to 14 seconds for
1.0.  The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.yield_per" title="sqlalchemy.orm.query.Query.yield_per"><tt class="xref py py-meth docutils literal"><span class="pre">Query.yield_per()</span></tt></a> call is always a good idea when batching
huge numbers of rows, as it prevents the Python interpreter from having
to allocate a huge amount of memory for all objects and their instrumentation
at once.  Without the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.yield_per" title="sqlalchemy.orm.query.Query.yield_per"><tt class="xref py py-meth docutils literal"><span class="pre">Query.yield_per()</span></tt></a>, the above script on the
MacBookPro is 31 seconds on 0.9 and 26 seconds on 1.0, the extra time spent
setting up very large memory buffers.</p>
</div>
<div class="section" id="new-keyedtuple-implementation-dramatically-faster">
<span id="feature-3176"></span><h3>New KeyedTuple implementation dramatically faster<a class="headerlink" href="#new-keyedtuple-implementation-dramatically-faster" title="Permalink to this headline">¶</a></h3>
<p>We took a look into the <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><tt class="xref py py-class docutils literal"><span class="pre">KeyedTuple</span></tt></a> implementation in the hopes
of improving queries like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">rows</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Foo</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">Foo</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">Foo</span><span class="o">.</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><tt class="xref py py-class docutils literal"><span class="pre">KeyedTuple</span></tt></a> class is used rather than Python&#8217;s
<tt class="docutils literal"><span class="pre">collections.namedtuple()</span></tt>, because the latter has a very complex
type-creation routine that benchmarks much slower than <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><tt class="xref py py-class docutils literal"><span class="pre">KeyedTuple</span></tt></a>.
However, when fetching hundreds of thousands of rows,
<tt class="docutils literal"><span class="pre">collections.namedtuple()</span></tt> quickly overtakes <a class="reference internal" href="../orm/query.html#sqlalchemy.util.KeyedTuple" title="sqlalchemy.util.KeyedTuple"><tt class="xref py py-class docutils literal"><span class="pre">KeyedTuple</span></tt></a> which
becomes dramatically slower as instance invocation goes up.   What to do?
A new type that hedges between the approaches of both.   Benching
all three types for &#8220;size&#8221; (number of rows returned) and &#8220;num&#8221;
(number of distinct queries), the new &#8220;lightweight keyed tuple&#8221; either
outperforms both, or lags very slightly behind the faster object, based on
which scenario.  In the &#8220;sweet spot&#8221;, where we are both creating a good number
of new types as well as fetching a good number of rows, the lightweight
object totally smokes both namedtuple and KeyedTuple:</p>
<div class="highlight-python"><div class="highlight"><pre>-----------------
size=10 num=10000                 # few rows, lots of queries
namedtuple: 3.60302400589         # namedtuple falls over
keyedtuple: 0.255059957504        # KeyedTuple very fast
lw keyed tuple: 0.582715034485    # lw keyed trails right on KeyedTuple
-----------------
size=100 num=1000                 # &lt;--- sweet spot
namedtuple: 0.365247011185
keyedtuple: 0.24896979332
lw keyed tuple: 0.0889317989349   # lw keyed blows both away!
-----------------
size=10000 num=100
namedtuple: 0.572599887848
keyedtuple: 2.54251694679
lw keyed tuple: 0.613876104355
-----------------
size=1000000 num=10               # few queries, lots of rows
namedtuple: 5.79669594765         # namedtuple very fast
keyedtuple: 28.856498003          # KeyedTuple falls over
lw keyed tuple: 6.74346804619     # lw keyed trails right on namedtuple</pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3176">#3176</a></p>
</div>
<div class="section" id="update-statements-are-now-batched-with-executemany-in-a-flush">
<span id="feature-updatemany"></span><h3>UPDATE statements are now batched with executemany() in a flush<a class="headerlink" href="#update-statements-are-now-batched-with-executemany-in-a-flush" title="Permalink to this headline">¶</a></h3>
<p>UPDATE statements can now be batched within an ORM flush
into more performant executemany() call, similarly to how INSERT
statements can be batched; this will be invoked within flush
based on the following criteria:</p>
<ul class="simple">
<li>two or more UPDATE statements in sequence involve the identical set of
columns to be modified.</li>
<li>The statement has no embedded SQL expressions in the SET clause.</li>
<li>The mapping does not use a <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapper.params.version_id_col" title="sqlalchemy.orm.mapper"><tt class="xref py py-paramref docutils literal"><span class="pre">version_id_col</span></tt></a>, or
the backend dialect supports a &#8220;sane&#8221; rowcount for an executemany()
operation; most DBAPIs support this correctly now.</li>
</ul>
</div>
<div class="section" id="session-get-bind-handles-a-wider-variety-of-inheritance-scenarios">
<span id="bug-3035"></span><span id="feature-3178"></span><h3>Session.get_bind() handles a wider variety of inheritance scenarios<a class="headerlink" href="#session-get-bind-handles-a-wider-variety-of-inheritance-scenarios" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.get_bind" title="sqlalchemy.orm.session.Session.get_bind"><tt class="xref py py-meth docutils literal"><span class="pre">Session.get_bind()</span></tt></a> method is invoked whenever a query or unit
of work flush process seeks to locate the database engine that corresponds
to a particular class.   The method has been improved to handle a variety
of inheritance-oriented scenarios, including:</p>
<ul>
<li><p class="first">Binding to a Mixin or Abstract Class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">SomeMixin</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;my_table&#39;</span>
    <span class="c"># ...</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">binds</span><span class="o">=</span><span class="p">{</span><span class="n">SomeMixin</span><span class="p">:</span> <span class="n">some_engine</span><span class="p">})</span></pre></div>
</div>
</li>
<li><p class="first">Binding to inherited concrete subclasses individually based on table:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BaseClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;base&#39;</span>

    <span class="c"># ...</span>

<span class="k">class</span> <span class="nc">ConcreteSubClass</span><span class="p">(</span><span class="n">BaseClass</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;concrete&#39;</span>

    <span class="c"># ...</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;concrete&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>


<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">binds</span><span class="o">=</span><span class="p">{</span>
    <span class="n">base_table</span><span class="p">:</span> <span class="n">some_engine</span><span class="p">,</span>
    <span class="n">concrete_table</span><span class="p">:</span> <span class="n">some_other_engine</span>
<span class="p">})</span></pre></div>
</div>
</li>
</ul>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3035">#3035</a></p>
</div>
<div class="section" id="info-dictionary-improvements">
<span id="feature-2963"></span><h3>.info dictionary improvements<a class="headerlink" href="#info-dictionary-improvements" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="xref py py-attr docutils literal"><span class="pre">InspectionAttr.info</span></tt> collection is now available on every kind
of object that one would retrieve from the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapper.Mapper.all_orm_descriptors" title="sqlalchemy.orm.mapper.Mapper.all_orm_descriptors"><tt class="xref py py-attr docutils literal"><span class="pre">Mapper.all_orm_descriptors</span></tt></a>
collection.  This includes <a class="reference internal" href="../orm/extensions/hybrid.html#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><tt class="xref py py-class docutils literal"><span class="pre">hybrid_property</span></tt></a> and <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.association_proxy" title="sqlalchemy.ext.associationproxy.association_proxy"><tt class="xref py py-func docutils literal"><span class="pre">association_proxy()</span></tt></a>.
However, as these objects are class-bound descriptors, they must be accessed
<strong>separately</strong> from the class to which they are attached in order to get
at the attribute.  Below this is illustared using the
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapper.Mapper.all_orm_descriptors" title="sqlalchemy.orm.mapper.Mapper.all_orm_descriptors"><tt class="xref py py-attr docutils literal"><span class="pre">Mapper.all_orm_descriptors</span></tt></a> namespace:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SomeObject</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">some_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="mi">5</span>


<span class="n">inspect</span><span class="p">(</span><span class="n">SomeObject</span><span class="p">)</span><span class="o">.</span><span class="n">all_orm_descriptors</span><span class="o">.</span><span class="n">some_prop</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;bar&#39;</span></pre></div>
</div>
<p>It is also available as a constructor argument for all <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.SchemaItem" title="sqlalchemy.schema.SchemaItem"><tt class="xref py py-class docutils literal"><span class="pre">SchemaItem</span></tt></a>
objects (e.g. <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKey</span></tt></a>, <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><tt class="xref py py-class docutils literal"><span class="pre">UniqueConstraint</span></tt></a> etc.) as well
as remaining ORM constructs such as <a class="reference internal" href="../orm/mapped_attributes.html#sqlalchemy.orm.synonym" title="sqlalchemy.orm.synonym"><tt class="xref py py-func docutils literal"><span class="pre">orm.synonym()</span></tt></a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2971">#2971</a></p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2963">#2963</a></p>
</div>
<div class="section" id="columnproperty-constructs-work-a-lot-better-with-aliases-order-by">
<span id="bug-3188"></span><h3>ColumnProperty constructs work a lot better with aliases, order_by<a class="headerlink" href="#columnproperty-constructs-work-a-lot-better-with-aliases-order-by" title="Permalink to this headline">¶</a></h3>
<p>A variety of issues regarding <a class="reference internal" href="../orm/mapping_columns.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><tt class="xref py py-func docutils literal"><span class="pre">column_property()</span></tt></a> have been fixed,
most specifically with regards to the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><tt class="xref py py-func docutils literal"><span class="pre">aliased()</span></tt></a> construct as well
as the &#8220;order by label&#8221; logic introduced in 0.9 (see <a class="reference internal" href="migration_09.html#migration-1068"><em>Label constructs can now render as their name alone in an ORDER BY</em></a>).</p>
<p>Given a mapping like the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;b&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;a.id&#39;</span><span class="p">))</span>


<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">a_id</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="p">)</span></pre></div>
</div>
<p>A simple scenario that included &#8220;A.b&#8221; twice would fail to render
correctly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">print</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">b</span><span class="p">)</span></pre></div>
</div>
<p>This would order by the wrong column:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT a.id AS a_id, (SELECT max(b.id) AS max_1 FROM b
WHERE b.a_id = a.id) AS anon_1, a_1.id AS a_1_id,
(SELECT max(b.id) AS max_2
FROM b WHERE b.a_id = a_1.id) AS anon_2
FROM a, a AS a_1 ORDER BY anon_1</pre></div>
</div>
<p>New output:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT a.id AS a_id, (SELECT max(b.id) AS max_1
FROM b WHERE b.a_id = a.id) AS anon_1, a_1.id AS a_1_id,
(SELECT max(b.id) AS max_2
FROM b WHERE b.a_id = a_1.id) AS anon_2
FROM a, a AS a_1 ORDER BY anon_2</pre></div>
</div>
<p>There were also many scenarios where the &#8220;order by&#8221; logic would fail
to order by label, for example if the mapping were &#8220;polymorphic&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;a&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&#39;with_polymorphic&#39;</span><span class="p">:</span> <span class="s">&#39;*&#39;</span><span class="p">}</span></pre></div>
</div>
<p>The order_by would fail to use the label, as it would be anonymized due
to the polymorphic loading:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT a.id AS a_id, a.type AS a_type, (SELECT max(b.id) AS max_1
FROM b WHERE b.a_id = a.id) AS anon_1
FROM a ORDER BY (SELECT max(b.id) AS max_2
FROM b WHERE b.a_id = a.id)</pre></div>
</div>
<p>Now that the order by label tracks the anonymized label, this now works:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT a.id AS a_id, a.type AS a_type, (SELECT max(b.id) AS max_1
FROM b WHERE b.a_id = a.id) AS anon_1
FROM a ORDER BY anon_1</pre></div>
</div>
<p>Included in these fixes are a variety of heisenbugs that could corrupt
the state of an <tt class="docutils literal"><span class="pre">aliased()</span></tt> construct such that the labeling logic
would again fail; these have also been fixed.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3148">#3148</a> <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3188">#3188</a></p>
</div>
</div>
<div class="section" id="new-features-and-improvements-core">
<h2>New Features and Improvements - Core<a class="headerlink" href="#new-features-and-improvements-core" title="Permalink to this headline">¶</a></h2>
<div class="section" id="select-query-limit-offset-may-be-specified-as-an-arbitrary-sql-expression">
<span id="feature-3034"></span><h3>Select/Query LIMIT / OFFSET may be specified as an arbitrary SQL expression<a class="headerlink" href="#select-query-limit-offset-may-be-specified-as-an-arbitrary-sql-expression" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.limit" title="sqlalchemy.sql.expression.Select.limit"><tt class="xref py py-meth docutils literal"><span class="pre">Select.limit()</span></tt></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.offset" title="sqlalchemy.sql.expression.Select.offset"><tt class="xref py py-meth docutils literal"><span class="pre">Select.offset()</span></tt></a> methods now accept
any SQL expression, in addition to integer values, as arguments.  The ORM
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><tt class="xref py py-class docutils literal"><span class="pre">Query</span></tt></a> object also passes through any expression to the underlying
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><tt class="xref py py-class docutils literal"><span class="pre">Select</span></tt></a> object.   Typically
this is used to allow a bound parameter to be passed, which can be substituted
with a value later:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sel</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="p">])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">bindparam</span><span class="p">(</span><span class="s">&#39;mylimit&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">bindparam</span><span class="p">(</span><span class="s">&#39;myoffset&#39;</span><span class="p">))</span></pre></div>
</div>
<p>Dialects which don&#8217;t support non-integer LIMIT or OFFSET expressions may continue
to not support this behavior; third party dialects may also need modification
in order to take advantage of the new behavior.  A dialect which currently
uses the <tt class="docutils literal"><span class="pre">._limit</span></tt> or <tt class="docutils literal"><span class="pre">._offset</span></tt> attributes will continue to function
for those cases where the limit/offset was specified as a simple integer value.
However, when a SQL expression is specified, these two attributes will
instead raise a <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.CompileError" title="sqlalchemy.exc.CompileError"><tt class="xref py py-class docutils literal"><span class="pre">CompileError</span></tt></a> on access.  A third-party dialect which
wishes to support the new feature should now call upon the <tt class="docutils literal"><span class="pre">._limit_clause</span></tt>
and <tt class="docutils literal"><span class="pre">._offset_clause</span></tt> attributes to receive the full SQL expression, rather
than the integer value.</p>
</div>
<div class="section" id="insert-from-select-now-includes-python-and-sql-expression-defaults">
<span id="feature-insert-from-select-defaults"></span><span id="change-2051"></span><h3>INSERT FROM SELECT now includes Python and SQL-expression defaults<a class="headerlink" href="#insert-from-select-now-includes-python-and-sql-expression-defaults" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.from_select" title="sqlalchemy.sql.expression.Insert.from_select"><tt class="xref py py-meth docutils literal"><span class="pre">Insert.from_select()</span></tt></a> now includes Python and SQL-expression defaults if
otherwise unspecified; the limitation where non-server column defaults
aren&#8217;t included in an INSERT FROM SELECT is now lifted and these
expressions are rendered as constants into the SELECT statement:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">somefunction</span><span class="p">()))</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>
<span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">from_select</span><span class="p">([</span><span class="s">&#39;x&#39;</span><span class="p">],</span> <span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p>Will render:</p>
<div class="highlight-python"><div class="highlight"><pre>INSERT INTO t (x, y) SELECT t.x, somefunction() AS somefunction_1
FROM t</pre></div>
</div>
<p>The feature can be disabled using
<a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.from_select.params.include_defaults" title="sqlalchemy.sql.expression.Insert.from_select"><tt class="xref py py-paramref docutils literal"><span class="pre">Insert.from_select.include_defaults</span></tt></a>.</p>
</div>
<div class="section" id="uniqueconstraint-is-now-part-of-the-table-reflection-process">
<span id="feature-3184"></span><h3>UniqueConstraint is now part of the Table reflection process<a class="headerlink" href="#uniqueconstraint-is-now-part-of-the-table-reflection-process" title="Permalink to this headline">¶</a></h3>
<p>A <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt></a> object populated using <tt class="docutils literal"><span class="pre">autoload=True</span></tt> will now
include <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><tt class="xref py py-class docutils literal"><span class="pre">UniqueConstraint</span></tt></a> constructs as well as
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><tt class="xref py py-class docutils literal"><span class="pre">Index</span></tt></a> constructs.  This logic has a few caveats for
Postgresql and Mysql:</p>
<div class="section" id="postgresql">
<h4>Postgresql<a class="headerlink" href="#postgresql" title="Permalink to this headline">¶</a></h4>
<p>Postgresql has the behavior such that when a UNIQUE constraint is
created, it implicitly creates a UNIQUE INDEX corresponding to that
constraint as well. The <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_indexes" title="sqlalchemy.engine.reflection.Inspector.get_indexes"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_indexes()</span></tt></a> and the
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_unique_constraints" title="sqlalchemy.engine.reflection.Inspector.get_unique_constraints"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_unique_constraints()</span></tt></a> methods will continue to
<strong>both</strong> return these entries distinctly, where
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_indexes" title="sqlalchemy.engine.reflection.Inspector.get_indexes"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_indexes()</span></tt></a> now features a token
<tt class="docutils literal"><span class="pre">duplicates_constraint</span></tt> within the index entry  indicating the
corresponding constraint when detected.   However, when performing
full table reflection using  <tt class="docutils literal"><span class="pre">Table(...,</span> <span class="pre">autoload=True)</span></tt>, the
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><tt class="xref py py-class docutils literal"><span class="pre">Index</span></tt></a> construct is detected as being linked to the
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><tt class="xref py py-class docutils literal"><span class="pre">UniqueConstraint</span></tt></a>, and is <strong>not</strong> present within the
<tt class="xref py py-attr docutils literal"><span class="pre">Table.indexes</span></tt> collection; only the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><tt class="xref py py-class docutils literal"><span class="pre">UniqueConstraint</span></tt></a>
will be present in the <tt class="xref py py-attr docutils literal"><span class="pre">Table.constraints</span></tt> collection.   This
deduplication logic works by joining to the <tt class="docutils literal"><span class="pre">pg_constraint</span></tt> table
when querying <tt class="docutils literal"><span class="pre">pg_index</span></tt> to see if the two constructs are linked.</p>
</div>
<div class="section" id="mysql">
<h4>MySQL<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h4>
<p>MySQL does not have separate concepts for a UNIQUE INDEX and a UNIQUE
constraint.  While it supports both syntaxes when creating tables and indexes,
it does not store them any differently. The
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_indexes" title="sqlalchemy.engine.reflection.Inspector.get_indexes"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_indexes()</span></tt></a>
and the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_unique_constraints" title="sqlalchemy.engine.reflection.Inspector.get_unique_constraints"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_unique_constraints()</span></tt></a> methods will continue to
<strong>both</strong> return an entry for a UNIQUE index in MySQL,
where <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_unique_constraints" title="sqlalchemy.engine.reflection.Inspector.get_unique_constraints"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_unique_constraints()</span></tt></a> features a new token
<tt class="docutils literal"><span class="pre">duplicates_index</span></tt> within the constraint entry indicating that this is a
dupe entry corresponding to that index.  However, when performing
full table reflection using <tt class="docutils literal"><span class="pre">Table(...,</span> <span class="pre">autoload=True)</span></tt>,
the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><tt class="xref py py-class docutils literal"><span class="pre">UniqueConstraint</span></tt></a> construct is
<strong>not</strong> part of the fully reflected <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt></a> construct under any
circumstances; this construct is always represented by a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><tt class="xref py py-class docutils literal"><span class="pre">Index</span></tt></a>
with the <tt class="docutils literal"><span class="pre">unique=True</span></tt> setting present in the <tt class="xref py py-attr docutils literal"><span class="pre">Table.indexes</span></tt>
collection.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p><em class="xref std std-ref">postgresql_index_reflection</em></p>
<p class="last"><em class="xref std std-ref">mysql_unique_constraints</em></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3184">#3184</a></p>
</div>
</div>
<div class="section" id="new-systems-to-safely-emit-parameterized-warnings">
<h3>New systems to safely emit parameterized warnings<a class="headerlink" href="#new-systems-to-safely-emit-parameterized-warnings" title="Permalink to this headline">¶</a></h3>
<p>For a long time, there has been a restriction that warning messages could not
refer to data elements, such that a particular function might emit an
infinite number of unique warnings.  The key place this occurs is in the
<tt class="docutils literal"><span class="pre">Unicode</span> <span class="pre">type</span> <span class="pre">received</span> <span class="pre">non-unicode</span> <span class="pre">bind</span> <span class="pre">param</span> <span class="pre">value</span></tt> warning.  Placing
the data value in this message would mean that the Python <tt class="docutils literal"><span class="pre">__warningregistry__</span></tt>
for that module, or in some cases the Python-global <tt class="docutils literal"><span class="pre">warnings.onceregistry</span></tt>,
would grow unbounded, as in most warning scenarios, one of these two collections
is populated with every distinct warning message.</p>
<p>The change here is that by using a special <tt class="docutils literal"><span class="pre">string</span></tt> type that purposely
changes how the string is hashed, we can control that a large number of
parameterized messages are hashed only on a small set of possible hash
values, such that a warning such as <tt class="docutils literal"><span class="pre">Unicode</span> <span class="pre">type</span> <span class="pre">received</span> <span class="pre">non-unicode</span>
<span class="pre">bind</span> <span class="pre">param</span> <span class="pre">value</span></tt> can be tailored to be emitted only a specific number
of times; beyond that, the Python warnings registry will begin recording
them as duplicates.</p>
<p>To illustrate, the following test script will show only ten warnings being
emitted for ten of the parameter sets, out of a total of 1000:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&quot;sqlite://&quot;</span><span class="p">)</span>

<span class="c"># Use the &quot;once&quot; filter (which is also the default for Python</span>
<span class="c"># warnings).  Exactly ten of these warnings will</span>
<span class="c"># be emitted; beyond that, the Python warnings registry will accumulate</span>
<span class="c"># new values as dupes of one of the ten existing.</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">&quot;once&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">e</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">([</span><span class="n">cast</span><span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;foo_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">Unicode</span><span class="p">)]))</span></pre></div>
</div>
<p>The format of the warning here is:</p>
<div class="highlight-python"><div class="highlight"><pre>/path/lib/sqlalchemy/sql/sqltypes.py:186: SAWarning: Unicode type received
  non-unicode bind param value &#39;foo_4852&#39;. (this warning may be
  suppressed after 10 occurrences)</pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3178">#3178</a></p>
</div>
</div>
<div class="section" id="key-behavioral-changes-orm">
<h2>Key Behavioral Changes - ORM<a class="headerlink" href="#key-behavioral-changes-orm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="query-update-now-resolves-string-names-into-mapped-attribute-names">
<span id="bug-3228"></span><h3>query.update() now resolves string names into mapped attribute names<a class="headerlink" href="#query-update-now-resolves-string-names-into-mapped-attribute-names" title="Permalink to this headline">¶</a></h3>
<p>The documentation for <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><tt class="xref py py-meth docutils literal"><span class="pre">Query.update()</span></tt></a> states that the given
<tt class="docutils literal"><span class="pre">values</span></tt> dictionary is &#8220;a dictionary with attributes names as keys&#8221;,
implying that these are mapped attribute names.  Unfortunately, the function
was designed more in mind to receive attributes and SQL expressions and
not as much strings; when strings
were passed, these strings would be passed through straight to the core
update statement without any resolution as far as how these names are
represented on the mapped class, meaning the name would have to match that
of a table column exactly, not how an attribute of that name was mapped
onto the class.</p>
<p>The string names are now resolved as attribute names in earnest:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;user&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s">&#39;user_name&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span></pre></div>
</div>
<p>Above, the column <tt class="docutils literal"><span class="pre">user_name</span></tt> is mapped as <tt class="docutils literal"><span class="pre">name</span></tt>.  Previously,
a call to <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><tt class="xref py py-meth docutils literal"><span class="pre">Query.update()</span></tt></a> that was passed strings would have to
have been called as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;user_name&#39;</span><span class="p">:</span> <span class="s">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p>The given string is now resolved against the entity:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p>It is typically preferable to use the attribute directly, to avoid any
ambiguity:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="s">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p>The change also indicates that synonyms and hybrid attributes can be referred
to by string name as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;user&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="s">&#39;user_name&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;fullname&#39;</span><span class="p">:</span> <span class="s">&#39;moonbeam&#39;</span><span class="p">})</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3228">#3228</a></p>
</div>
<div class="section" id="changes-to-attribute-events-and-other-operations-regarding-attributes-that-have-no-pre-existing-value">
<span id="migration-3061"></span><h3>Changes to attribute events and other operations regarding attributes that have no pre-existing value<a class="headerlink" href="#changes-to-attribute-events-and-other-operations-regarding-attributes-that-have-no-pre-existing-value" title="Permalink to this headline">¶</a></h3>
<p>In this change, the default return value of <tt class="docutils literal"><span class="pre">None</span></tt> when accessing an object
is now returned dynamically on each access, rather than implicitly setting the
attribute&#8217;s state with a special &#8220;set&#8221; operation when it is first accessed.
The visible result of this change is that <tt class="docutils literal"><span class="pre">obj.__dict__</span></tt> is not implicitly
modified on get, and there are also some minor behavioral changes
for <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.attributes.get_history" title="sqlalchemy.orm.attributes.get_history"><tt class="xref py py-func docutils literal"><span class="pre">attributes.get_history()</span></tt></a> and related functions.</p>
<p>Given an object with no state:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span></pre></div>
</div>
<p>It has always been SQLAlchemy&#8217;s behavior such that if we access a scalar
or many-to-one attribute that was never set, it is returned as <tt class="docutils literal"><span class="pre">None</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span>
<span class="go">None</span></pre></div>
</div>
<p>This value of <tt class="docutils literal"><span class="pre">None</span></tt> is in fact now part of the state of <tt class="docutils literal"><span class="pre">obj</span></tt>, and is
not unlike as though we had set the attribute explicitly, e.g.
<tt class="docutils literal"><span class="pre">obj.someattr</span> <span class="pre">=</span> <span class="pre">None</span></tt>.  However, the &#8220;set on get&#8221; here would behave
differently as far as history and events.   It would not emit any attribute
event, and additionally if we view history, we see this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=(), unchanged=[None], deleted=())   # 0.9 and below</span></pre></div>
</div>
<p>That is, it&#8217;s as though the attribute were always <tt class="docutils literal"><span class="pre">None</span></tt> and were
never changed.  This is explicitly different from if we had set the
attribute first instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span> <span class="o">=</span> <span class="bp">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=[None], unchanged=(), deleted=())  # all versions</span></pre></div>
</div>
<p>The above means that the behavior of our &#8220;set&#8221; operation can be corrupted
by the fact that the value was accessed via &#8220;get&#8221; earlier.  In 1.0, this
inconsistency has been resolved, by no longer actually setting anything
when the default &#8220;getter&#8221; is used.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=(), unchanged=(), deleted=())  # 1.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">someattr</span> <span class="o">=</span> <span class="bp">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">someattr</span><span class="o">.</span><span class="n">history</span>
<span class="go">History(added=[None], unchanged=(), deleted=())</span></pre></div>
</div>
<p>The reason the above behavior hasn&#8217;t had much impact is because the
INSERT statement in relational databases considers a missing value to be
the same as NULL in most cases.   Whether SQLAlchemy received a history
event for a particular attribute set to None or not would usually not matter;
as the difference between sending None/NULL or not wouldn&#8217;t have an impact.
However, as <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3060">#3060</a> illustrates, there are some seldom edge cases
where we do in fact want to positively have <tt class="docutils literal"><span class="pre">None</span></tt> set.  Also, allowing
the attribute event here means it&#8217;s now possible to create &#8220;default value&#8221;
functions for ORM mapped attributes.</p>
<p>As part of this change, the generation of the implicit &#8220;None&#8221; is now disabled
for other situations where this used to occur; this includes when an
attribute set operation on a many-to-one is received; previously, the &#8220;old&#8221; value
would be &#8220;None&#8221; if it had been not set otherwise; it now will send the
value <tt class="xref py py-data docutils literal"><span class="pre">orm.attributes.NEVER_SET</span></tt>, which is a value that may be sent
to an attribute listener now.   This symbol may also be received when
calling on mapper utility functions such as <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapper.Mapper.primary_key_from_instance" title="sqlalchemy.orm.mapper.Mapper.primary_key_from_instance"><tt class="xref py py-meth docutils literal"><span class="pre">Mapper.primary_key_from_instance()</span></tt></a>;
if the primary key attributes have no setting at all, whereas the value
would be <tt class="docutils literal"><span class="pre">None</span></tt> before, it will now be the <tt class="xref py py-data docutils literal"><span class="pre">orm.attributes.NEVER_SET</span></tt>
symbol, and no change to the object&#8217;s state occurs.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3061">#3061</a></p>
</div>
<div class="section" id="session-expunge-will-fully-detach-an-object-that-s-been-deleted">
<span id="bug-3139"></span><h3>session.expunge() will fully detach an object that&#8217;s been deleted<a class="headerlink" href="#session-expunge-will-fully-detach-an-object-that-s-been-deleted" title="Permalink to this headline">¶</a></h3>
<p>The behavior of <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.expunge" title="sqlalchemy.orm.session.Session.expunge"><tt class="xref py py-meth docutils literal"><span class="pre">Session.expunge()</span></tt></a> had a bug that caused an
inconsistency in behavior regarding deleted objects.  The
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.object_session" title="sqlalchemy.orm.session.object_session"><tt class="xref py py-func docutils literal"><span class="pre">object_session()</span></tt></a> function as well as the <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.state.InstanceState.session" title="sqlalchemy.orm.state.InstanceState.session"><tt class="xref py py-attr docutils literal"><span class="pre">InstanceState.session</span></tt></a>
attribute would still report object as belonging to the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session" title="sqlalchemy.orm.session.Session"><tt class="xref py py-class docutils literal"><span class="pre">Session</span></tt></a>
subsequent to the expunge:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">sess</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>

<span class="n">sess</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">assert</span> <span class="n">u1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="n">sess</span>  <span class="c"># this is normal before commit</span>

<span class="n">sess</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">u1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sess</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="bp">None</span>  <span class="c"># would fail</span></pre></div>
</div>
<p>Note that it is normal for <tt class="docutils literal"><span class="pre">u1</span> <span class="pre">not</span> <span class="pre">in</span> <span class="pre">sess</span></tt> to be True while
<tt class="docutils literal"><span class="pre">inspect(u1).session</span></tt> still refers to the session, while the transaction
is ongoing subsequent to the delete operation and <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.expunge" title="sqlalchemy.orm.session.Session.expunge"><tt class="xref py py-meth docutils literal"><span class="pre">Session.expunge()</span></tt></a>
has not been called; the full detachment normally completes once the
transaction is committed.  This issue would also impact functions
that rely on <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.Session.expunge" title="sqlalchemy.orm.session.Session.expunge"><tt class="xref py py-meth docutils literal"><span class="pre">Session.expunge()</span></tt></a> such as <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.session.make_transient" title="sqlalchemy.orm.session.make_transient"><tt class="xref py py-func docutils literal"><span class="pre">make_transient()</span></tt></a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3139">#3139</a></p>
</div>
<div class="section" id="joined-subquery-eager-loading-explicitly-disallowed-with-yield-per">
<span id="migration-yield-per-eager-loading"></span><h3>Joined/Subquery eager loading explicitly disallowed with yield_per<a class="headerlink" href="#joined-subquery-eager-loading-explicitly-disallowed-with-yield-per" title="Permalink to this headline">¶</a></h3>
<p>In order to make the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.yield_per" title="sqlalchemy.orm.query.Query.yield_per"><tt class="xref py py-meth docutils literal"><span class="pre">Query.yield_per()</span></tt></a> method easier to use,
an exception is raised if any subquery eager loaders, or joined
eager loaders that would use collections, are
to take effect when yield_per is used, as these are currently not compatible
with yield-per (subquery loading could be in theory, however).
When this error is raised, the <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.lazyload" title="sqlalchemy.orm.lazyload"><tt class="xref py py-func docutils literal"><span class="pre">lazyload()</span></tt></a> option can be sent with
an asterisk:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">q</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">lazyload</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></pre></div>
</div>
<p>or use <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.enable_eagerloads" title="sqlalchemy.orm.query.Query.enable_eagerloads"><tt class="xref py py-meth docutils literal"><span class="pre">Query.enable_eagerloads()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">q</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="o">.</span><span class="n">enable_eagerloads</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></pre></div>
</div>
<p>The <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.lazyload" title="sqlalchemy.orm.lazyload"><tt class="xref py py-func docutils literal"><span class="pre">lazyload()</span></tt></a> option has the advantage that additional many-to-one
joined loader options can still be used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">q</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">lazyload</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">),</span> <span class="n">joinedload</span><span class="p">(</span><span class="s">&quot;some_manytoone&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="single-inheritance-join-targets-will-no-longer-sometimes-implicitly-alias-themselves">
<span id="bug-3233"></span><h3>Single inheritance join targets will no longer sometimes implicitly alias themselves<a class="headerlink" href="#single-inheritance-join-targets-will-no-longer-sometimes-implicitly-alias-themselves" title="Permalink to this headline">¶</a></h3>
<p>This is a bug where an unexpected and inconsistent behavior would occur
in some scenarios when joining to a single-table-inheritance entity.  The
difficulty this might cause is that the query is supposed to raise an error,
as it is invalid SQL, however the bug would cause an alias to be added which
makes the query &#8220;work&#8221;.   The issue is confusing because this aliasing
is not applied consistently and could change based on the nature of the query
preceding the join.</p>
<p>A simple example is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;a&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">ASub1</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;asub1&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">ASub2</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;asub2&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;b&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="s">&quot;B.a_id == A.id&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ASub1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">ASub1</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ASub2</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>

<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ASub1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">ASub1</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ASub2</span><span class="p">,</span> <span class="n">ASub2</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">a_id</span><span class="p">)</span></pre></div>
</div>
<p>The two queries at the bottom are equivalent, and should both render
the identical SQL:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT a.id AS a_id, a.type AS a_type
FROM a JOIN b ON b.a_id = a.id JOIN a ON b.a_id = a.id AND a.type IN (:type_1)
WHERE a.type IN (:type_2)</pre></div>
</div>
<p>The above SQL is invalid, as it renders &#8220;a&#8221; within the FROM list twice.
The bug however would occur with the second query only and render this instead:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT a.id AS a_id, a.type AS a_type
FROM a JOIN b ON b.a_id = a.id JOIN a AS a_1
ON a_1.id = b.a_id AND a_1.type IN (:type_1)
WHERE a_1.type IN (:type_2)</pre></div>
</div>
<p>Where above, the second join to &#8220;a&#8221; is aliased.  While this seems convenient,
it&#8217;s not how single-inheritance queries work in general and is misleading
and inconsistent.</p>
<p>The net effect is that applications which were relying on this bug will now
have an error raised by the database.   The solution is to use the expected
form.  When referring to multiple subclasses of a single-inheritance
entity in a query, you must manually use aliases to disambiguate the table,
as all the subclasses normally refer to the same table:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">asub2_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">ASub2</span><span class="p">)</span>

<span class="k">print</span> <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ASub1</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">ASub1</span><span class="o">.</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asub2_alias</span><span class="p">,</span> <span class="n">B</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">asub2_alias</span><span class="p">))</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3233">#3233</a></p>
</div>
<div class="section" id="deprecated-orm-event-hooks-removed">
<span id="migration-deprecated-orm-events"></span><h3>Deprecated ORM Event Hooks Removed<a class="headerlink" href="#deprecated-orm-event-hooks-removed" title="Permalink to this headline">¶</a></h3>
<p>The following ORM event hooks, some of which have been deprecated since
0.5, have been removed:   <tt class="docutils literal"><span class="pre">translate_row</span></tt>, <tt class="docutils literal"><span class="pre">populate_instance</span></tt>,
<tt class="docutils literal"><span class="pre">append_result</span></tt>, <tt class="docutils literal"><span class="pre">create_instance</span></tt>.  The use cases for these hooks
originated in the very early 0.1 / 0.2 series of SQLAlchemy and have long
since been unnecessary.  In particular, the hooks were largely unusable
as the behavioral contracts within these events was strongly linked to
the surrounding internals, such as how an instance needs to be created
and initialized as well as how columns are located within an ORM-generated
row.   The removal of these hooks greatly simplifies the mechanics of ORM
object loading.</p>
</div>
<div class="section" id="api-change-for-new-bundle-feature-when-custom-row-loaders-are-used">
<span id="bundle-api-change"></span><h3>API Change for new Bundle feature when custom row loaders are used<a class="headerlink" href="#api-change-for-new-bundle-feature-when-custom-row-loaders-are-used" title="Permalink to this headline">¶</a></h3>
<p>The new <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Bundle" title="sqlalchemy.orm.query.Bundle"><tt class="xref py py-class docutils literal"><span class="pre">Bundle</span></tt></a> object of 0.9 has a small change in API,
when the <tt class="docutils literal"><span class="pre">create_row_processor()</span></tt> method is overridden on a custom class.
Previously, the sample code looked like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Bundle</span>

<span class="k">class</span> <span class="nc">DictBundle</span><span class="p">(</span><span class="n">Bundle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_row_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">procs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override create_row_processor to return values as dictionaries&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">proc</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">(</span><span class="n">proc</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">proc</span></pre></div>
</div>
<p>The unused <tt class="docutils literal"><span class="pre">result</span></tt> member is now removed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Bundle</span>

<span class="k">class</span> <span class="nc">DictBundle</span><span class="p">(</span><span class="n">Bundle</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_row_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">procs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override create_row_processor to return values as dictionaries&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">proc</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">(</span><span class="n">proc</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">proc</span></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="../orm/loading_columns.html#bundles"><em>Column Bundles</em></a></p>
</div>
</div>
<div class="section" id="right-inner-join-nesting-now-the-default-for-joinedload-with-innerjoin-true">
<span id="migration-3008"></span><h3>Right inner join nesting now the default for joinedload with innerjoin=True<a class="headerlink" href="#right-inner-join-nesting-now-the-default-for-joinedload-with-innerjoin-true" title="Permalink to this headline">¶</a></h3>
<p>The behavior of <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.joinedload.params.innerjoin" title="sqlalchemy.orm.joinedload"><tt class="xref py py-paramref docutils literal"><span class="pre">joinedload.innerjoin</span></tt></a> as well as
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.innerjoin" title="sqlalchemy.orm.relationship"><tt class="xref py py-paramref docutils literal"><span class="pre">relationship.innerjoin</span></tt></a> is now to use &#8220;nested&#8221;
inner joins, that is, right-nested, as the default behavior when an
inner join joined eager load is chained to an outer join eager load.  In
order to get the old behavior of chaining all joined eager loads as
outer join when an outer join is present, use <tt class="docutils literal"><span class="pre">innerjoin=&quot;unnested&quot;</span></tt>.</p>
<p>As introduced in <a class="reference internal" href="migration_09.html#feature-2976"><em>Right-nested inner joins available in joined eager loads</em></a> from version 0.9, the behavior of
<tt class="docutils literal"><span class="pre">innerjoin=&quot;nested&quot;</span></tt> is that an inner join eager load chained to an outer
join eager load will use a right-nested join.  <tt class="docutils literal"><span class="pre">&quot;nested&quot;</span></tt> is now implied
when using <tt class="docutils literal"><span class="pre">innerjoin=True</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">joinedload</span><span class="p">(</span><span class="s">&quot;orders&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span></pre></div>
</div>
<p>With the new default, this will render the FROM clause in the form:</p>
<div class="highlight-python"><div class="highlight"><pre>FROM users LEFT OUTER JOIN (orders JOIN items ON &lt;onclause&gt;) ON &lt;onclause&gt;</pre></div>
</div>
<p>That is, using a right-nested join for the INNER join so that the full
result of <tt class="docutils literal"><span class="pre">users</span></tt> can be returned.   The use of an INNER join is more efficient
than using an OUTER join, and allows the <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.joinedload.params.innerjoin" title="sqlalchemy.orm.joinedload"><tt class="xref py py-paramref docutils literal"><span class="pre">joinedload.innerjoin</span></tt></a>
optimization parameter to take effect in all cases.</p>
<p>To get the older behavior, use <tt class="docutils literal"><span class="pre">innerjoin=&quot;unnested&quot;</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">joinedload</span><span class="p">(</span><span class="s">&quot;orders&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span> <span class="n">innerjoin</span><span class="o">=</span><span class="s">&quot;unnested&quot;</span><span class="p">))</span></pre></div>
</div>
<p>This will avoid right-nested joins and chain the joins together using all
OUTER joins despite the innerjoin directive:</p>
<div class="highlight-python"><div class="highlight"><pre>FROM users LEFT OUTER JOIN orders ON &lt;onclause&gt; LEFT OUTER JOIN items ON &lt;onclause&gt;</pre></div>
</div>
<p>As noted in the 0.9 notes, the only database backend that has difficulty
with right-nested joins is SQLite; SQLAlchemy as of 0.9 converts a right-nested
join into a subquery as a join target on SQLite.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="migration_09.html#feature-2976"><em>Right-nested inner joins available in joined eager loads</em></a> - description of the feature as introduced in 0.9.4.</p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3008">#3008</a></p>
</div>
<div class="section" id="query-update-with-synchronize-session-evaluate-raises-on-multi-table-update">
<h3>query.update() with <tt class="docutils literal"><span class="pre">synchronize_session='evaluate'</span></tt> raises on multi-table update<a class="headerlink" href="#query-update-with-synchronize-session-evaluate-raises-on-multi-table-update" title="Permalink to this headline">¶</a></h3>
<p>The &#8220;evaluator&#8221; for <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.update" title="sqlalchemy.orm.query.Query.update"><tt class="xref py py-meth docutils literal"><span class="pre">Query.update()</span></tt></a> won&#8217;t work with multi-table
updates, and needs to be set to <tt class="docutils literal"><span class="pre">synchronize_session=False</span></tt> or
<tt class="docutils literal"><span class="pre">synchronize_session='fetch'</span></tt> when multiple tables are present.
The new behavior is that an explicit exception is now raised, with a message
to change the synchronize setting.
This is upgraded from a warning emitted as of 0.9.7.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3117">#3117</a></p>
</div>
<div class="section" id="resurrect-event-has-been-removed">
<h3>Resurrect Event has been Removed<a class="headerlink" href="#resurrect-event-has-been-removed" title="Permalink to this headline">¶</a></h3>
<p>The &#8220;resurrect&#8221; ORM event has been removed entirely.  This event ceased to
have any function since version 0.8 removed the older &#8220;mutable&#8221; system
from the unit of work.</p>
</div>
<div class="section" id="change-to-single-table-inheritance-criteria-when-using-from-self-count">
<span id="migration-3177"></span><h3>Change to single-table-inheritance criteria when using from_self(), count()<a class="headerlink" href="#change-to-single-table-inheritance-criteria-when-using-from-self-count" title="Permalink to this headline">¶</a></h3>
<p>Given a single-table inheritance mapping, such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Widget</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="s">&#39;widget_table&#39;</span>

<span class="k">class</span> <span class="nc">FooWidget</span><span class="p">(</span><span class="n">Widget</span><span class="p">):</span>
    <span class="k">pass</span></pre></div>
</div>
<p>Using <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.from_self" title="sqlalchemy.orm.query.Query.from_self"><tt class="xref py py-meth docutils literal"><span class="pre">Query.from_self()</span></tt></a> or <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.count" title="sqlalchemy.orm.query.Query.count"><tt class="xref py py-meth docutils literal"><span class="pre">Query.count()</span></tt></a> against a subclass
would produce a subquery, but then add the &#8220;WHERE&#8221; criteria for subtypes
to the outside:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">)</span><span class="o">.</span><span class="n">from_self</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>rendering:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT
    anon_1.widgets_id AS anon_1_widgets_id,
    anon_1.widgets_type AS anon_1_widgets_type
FROM (SELECT widgets.id AS widgets_id, widgets.type AS widgets_type,
FROM widgets) AS anon_1
WHERE anon_1.widgets_type IN (?)</pre></div>
</div>
<p>The issue with this is that if the inner query does not specify all
columns, then we can&#8217;t add the WHERE clause on the outside (it actually tries,
and produces a bad query).  This decision
apparently goes way back to 0.6.5 with the note &#8220;may need to make more
adjustments to this&#8221;.   Well, those adjustments have arrived!  So now the
above query will render:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT
    anon_1.widgets_id AS anon_1_widgets_id,
    anon_1.widgets_type AS anon_1_widgets_type
FROM (SELECT widgets.id AS widgets_id, widgets.type AS widgets_type,
FROM widgets
WHERE widgets.type IN (?)) AS anon_1</pre></div>
</div>
<p>So that queries that don&#8217;t include &#8220;type&#8221; will still work!:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FooWidget</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></pre></div>
</div>
<p>Renders:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT count(*) AS count_1
FROM (SELECT widgets.id AS widgets_id
FROM widgets
WHERE widgets.type IN (?)) AS anon_1</pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3177">#3177</a></p>
</div>
<div class="section" id="single-table-inheritance-criteria-added-to-all-on-clauses-unconditionally">
<span id="migration-3222"></span><h3>single-table-inheritance criteria added to all ON clauses unconditionally<a class="headerlink" href="#single-table-inheritance-criteria-added-to-all-on-clauses-unconditionally" title="Permalink to this headline">¶</a></h3>
<p>When joining to a single-table inheritance subclass target, the ORM always adds
the &#8220;single table criteria&#8221; when joining on a relationship.  Given a
mapping as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Widget</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;widget&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">related_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;related.id&#39;</span><span class="p">))</span>
    <span class="n">related</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Related&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s">&quot;widget&quot;</span><span class="p">)</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_on&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">FooWidget</span><span class="p">(</span><span class="n">Widget</span><span class="p">):</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;polymorphic_identity&#39;</span><span class="p">:</span> <span class="s">&#39;foo&#39;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">Related</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;related&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
</div>
<p>It&#8217;s been the behavior for quite some time that a JOIN on the relationship
will render a &#8220;single inheritance&#8221; clause for the type:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Related</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">,</span> <span class="n">Related</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>SQL output:</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT related.id AS related_id
FROM related JOIN widget ON related.id = widget.related_id AND widget.type IN (:type_1)</pre></div>
</div>
<p>Above, because we joined to a subclass <tt class="docutils literal"><span class="pre">FooWidget</span></tt>, <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.join" title="sqlalchemy.orm.query.Query.join"><tt class="xref py py-meth docutils literal"><span class="pre">Query.join()</span></tt></a>
knew to add the <tt class="docutils literal"><span class="pre">AND</span> <span class="pre">widget.type</span> <span class="pre">IN</span> <span class="pre">('foo')</span></tt> criteria to the ON clause.</p>
<p>The change here is that the <tt class="docutils literal"><span class="pre">AND</span> <span class="pre">widget.type</span> <span class="pre">IN()</span></tt> criteria is now appended
to <em>any</em> ON clause, not just those generated from a relationship,
including one that is explicitly stated:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># ON clause will now render as</span>
<span class="c"># related.id = widget.related_id AND widget.type IN (:type_1)</span>
<span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Related</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">,</span> <span class="n">FooWidget</span><span class="o">.</span><span class="n">related_id</span> <span class="o">==</span> <span class="n">Related</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>As well as the &#8220;implicit&#8221; join when no ON clause of any kind is stated:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># ON clause will now render as</span>
<span class="c"># related.id = widget.related_id AND widget.type IN (:type_1)</span>
<span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Related</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FooWidget</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>Previously, the ON clause for these would not include the single-inheritance
criteria.  Applications that are already adding this criteria to work around
this will want to remove its explicit use, though it should continue to work
fine if the criteria happens to be rendered twice in the meantime.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="#bug-3233"><em>Single inheritance join targets will no longer sometimes implicitly alias themselves</em></a></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3222">#3222</a></p>
</div>
</div>
<div class="section" id="key-behavioral-changes-core">
<h2>Key Behavioral Changes - Core<a class="headerlink" href="#key-behavioral-changes-core" title="Permalink to this headline">¶</a></h2>
<div class="section" id="warnings-emitted-when-coercing-full-sql-fragments-into-text">
<span id="migration-2992"></span><h3>Warnings emitted when coercing full SQL fragments into text()<a class="headerlink" href="#warnings-emitted-when-coercing-full-sql-fragments-into-text" title="Permalink to this headline">¶</a></h3>
<p>Since SQLAlchemy&#8217;s inception, there has always been an emphasis on not getting
in the way of the usage of plain text.   The Core and ORM expression systems
were intended to allow any number of points at which the user can just
use plain text SQL expressions, not just in the sense that you can send a
full SQL string to <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execute" title="sqlalchemy.engine.Connection.execute"><tt class="xref py py-meth docutils literal"><span class="pre">Connection.execute()</span></tt></a>, but that you can send strings
with SQL expressions into many functions, such as <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.where" title="sqlalchemy.sql.expression.Select.where"><tt class="xref py py-meth docutils literal"><span class="pre">Select.where()</span></tt></a>,
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.filter" title="sqlalchemy.orm.query.Query.filter"><tt class="xref py py-meth docutils literal"><span class="pre">Query.filter()</span></tt></a>, and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.order_by" title="sqlalchemy.sql.expression.Select.order_by"><tt class="xref py py-meth docutils literal"><span class="pre">Select.order_by()</span></tt></a>.</p>
<p>Note that by &#8220;SQL expressions&#8221; we mean a <strong>full fragment of a SQL string</strong>,
such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the argument sent to where() is a full SQL expression</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">sometable</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">&quot;somecolumn = &#39;value&#39;&quot;</span><span class="p">)</span></pre></div>
</div>
<p>and we are <strong>not talking about string arguments</strong>, that is, the normal
behavior of passing string values that become parameterized:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This is a normal Core expression with a string argument -</span>
<span class="c"># we aren&#39;t talking about this!!</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">sometable</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sometable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">somecolumn</span> <span class="o">==</span> <span class="s">&#39;value&#39;</span><span class="p">)</span></pre></div>
</div>
<p>The Core tutorial has long featured an example of the use of this technique,
using a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><tt class="xref py py-func docutils literal"><span class="pre">select()</span></tt></a> construct where virtually all components of it
are specified as straight strings.  However, despite this long-standing
behavior and example, users are apparently surprised that this behavior
exists, and when asking around the community, I was unable to find any user
that was in fact <em>not</em> surprised that you can send a full string into a method
like <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.filter" title="sqlalchemy.orm.query.Query.filter"><tt class="xref py py-meth docutils literal"><span class="pre">Query.filter()</span></tt></a>.</p>
<p>So the change here is to encourage the user to qualify textual strings when
composing SQL that is partially or fully composed from textual fragments.
When composing a select as below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s">&quot;a = b&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="s">&quot;sometable&quot;</span><span class="p">)</span></pre></div>
</div>
<p>The statement is built up normally, with all the same coercions as before.
However, one will see the following warnings emitted:</p>
<div class="highlight-python"><div class="highlight"><pre>SAWarning: Textual column expression &#39;a&#39; should be explicitly declared
with text(&#39;a&#39;), or use column(&#39;a&#39;) for more specificity
(this warning may be suppressed after 10 occurrences)

SAWarning: Textual column expression &#39;b&#39; should be explicitly declared
with text(&#39;b&#39;), or use column(&#39;b&#39;) for more specificity
(this warning may be suppressed after 10 occurrences)

SAWarning: Textual SQL expression &#39;a = b&#39; should be explicitly declared
as text(&#39;a = b&#39;) (this warning may be suppressed after 10 occurrences)

SAWarning: Textual SQL FROM expression &#39;sometable&#39; should be explicitly
declared as text(&#39;sometable&#39;), or use table(&#39;sometable&#39;) for more
specificity (this warning may be suppressed after 10 occurrences)</pre></div>
</div>
<p>These warnings attempt to show exactly where the issue is by displaying
the parameters as well as where the string was received.
The warnings make use of the <a class="reference internal" href="#feature-3178"><em>Session.get_bind() handles a wider variety of inheritance scenarios</em></a> so that parameterized warnings
can be emitted safely without running out of memory, and as always, if
one wishes the warnings to be exceptions, the
<a class="reference external" href="https://docs.python.org/2/library/warnings.html">Python Warnings Filter</a>
should be used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">)</span>   <span class="c"># all warnings raise an exception</span></pre></div>
</div>
<p>Given the above warnings, our statement works just fine, but
to get rid of the warnings we would rewrite our statement as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
        <span class="n">text</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">),</span>
        <span class="n">text</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">)</span>
    <span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s">&quot;a = b&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s">&quot;sometable&quot;</span><span class="p">))</span></pre></div>
</div>
<p>and as the warnings suggest, we can give our statement more specificity
about the text if we use <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.column" title="sqlalchemy.sql.expression.column"><tt class="xref py py-func docutils literal"><span class="pre">column()</span></tt></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.table" title="sqlalchemy.sql.expression.table"><tt class="xref py py-func docutils literal"><span class="pre">table()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">column</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">),</span> <span class="n">column</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">)])</span><span class="o">.</span>\
    <span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s">&quot;a = b&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="s">&quot;sometable&quot;</span><span class="p">))</span></pre></div>
</div>
<p>Where note also that <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.table" title="sqlalchemy.sql.expression.table"><tt class="xref py py-func docutils literal"><span class="pre">table()</span></tt></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.column" title="sqlalchemy.sql.expression.column"><tt class="xref py py-func docutils literal"><span class="pre">column()</span></tt></a> can now
be imported from &#8220;sqlalchemy&#8221; without the &#8220;sql&#8221; part.</p>
<p>The behavior here applies to <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><tt class="xref py py-func docutils literal"><span class="pre">select()</span></tt></a> as well as to key methods
on <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><tt class="xref py py-class docutils literal"><span class="pre">Query</span></tt></a>, including <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.filter" title="sqlalchemy.orm.query.Query.filter"><tt class="xref py py-meth docutils literal"><span class="pre">Query.filter()</span></tt></a>,
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.from_statement" title="sqlalchemy.orm.query.Query.from_statement"><tt class="xref py py-meth docutils literal"><span class="pre">Query.from_statement()</span></tt></a> and <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query.having" title="sqlalchemy.orm.query.Query.having"><tt class="xref py py-meth docutils literal"><span class="pre">Query.having()</span></tt></a>.</p>
<div class="section" id="order-by-and-group-by-are-special-cases">
<h4>ORDER BY and GROUP BY are special cases<a class="headerlink" href="#order-by-and-group-by-are-special-cases" title="Permalink to this headline">¶</a></h4>
<p>There is one case where usage of a string has special meaning, and as part
of this change we have enhanced its functionality.  When we have a
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><tt class="xref py py-func docutils literal"><span class="pre">select()</span></tt></a> or <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><tt class="xref py py-class docutils literal"><span class="pre">Query</span></tt></a> that refers to some column name or named
label, we might want to GROUP BY and/or ORDER BY known columns or labels:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
    <span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s">&quot;id_count&quot;</span><span class="p">)</span>
<span class="p">])</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;id_count&quot;</span><span class="p">)</span></pre></div>
</div>
<p>In the above statement we expect to see &#8220;ORDER BY id_count&#8221;, as opposed to a
re-statement of the function.   The string argument given is actively
matched to an entry in the columns clause during compilation, so the above
statement would produce as we expect, without warnings (though note that
the <tt class="docutils literal"><span class="pre">&quot;name&quot;</span></tt> expression has been resolved to <tt class="docutils literal"><span class="pre">users.name</span></tt>!):</p>
<div class="highlight-python"><div class="highlight"><pre>SELECT users.name, count(users.id) AS id_count
FROM users GROUP BY users.name ORDER BY id_count</pre></div>
</div>
<p>However, if we refer to a name that cannot be located, then we get
the warning again, as below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
        <span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s">&quot;id_count&quot;</span><span class="p">)</span>
    <span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;some_label&quot;</span><span class="p">)</span></pre></div>
</div>
<p>The output does what we say, but again it warns us:</p>
<div class="highlight-python"><div class="highlight"><pre>SAWarning: Can&#39;t resolve label reference &#39;some_label&#39;; converting to
text() (this warning may be suppressed after 10 occurrences)

SELECT users.name, count(users.id) AS id_count
FROM users ORDER BY some_label</pre></div>
</div>
<p>The above behavior applies to all those places where we might want to refer
to a so-called &#8220;label reference&#8221;; ORDER BY and GROUP BY, but also within an
OVER clause as well as a DISTINCT ON clause that refers to columns (e.g. the
Postgresql syntax).</p>
<p>We can still specify any arbitrary expression for ORDER BY or others using
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><tt class="xref py py-func docutils literal"><span class="pre">text()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">users</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s">&quot;some special expression&quot;</span><span class="p">))</span></pre></div>
</div>
<p>The upshot of the whole change is that SQLAlchemy now would like us
to tell it when a string is sent that this string is explicitly
a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><tt class="xref py py-func docutils literal"><span class="pre">text()</span></tt></a> construct, or a column, table, etc., and if we use it as a
label name in an order by, group by, or other expression, SQLAlchemy expects
that the string resolves to something known, else it should again
be qualified with <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><tt class="xref py py-func docutils literal"><span class="pre">text()</span></tt></a> or similar.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2992">#2992</a></p>
</div>
</div>
<div class="section" id="event-listeners-can-not-be-added-or-removed-from-within-that-event-s-runner">
<span id="change-3163"></span><h3>Event listeners can not be added or removed from within that event&#8217;s runner<a class="headerlink" href="#event-listeners-can-not-be-added-or-removed-from-within-that-event-s-runner" title="Permalink to this headline">¶</a></h3>
<p>Removal of an event listener from inside that same event itself would
modify  the elements of a list during iteration, which would cause
still-attached event listeners to silently fail to fire.    To prevent
this while still maintaining performance, the lists have been replaced
with <tt class="docutils literal"><span class="pre">collections.deque()</span></tt>, which does not allow any additions or
removals during iteration, and instead raises <tt class="docutils literal"><span class="pre">RuntimeError</span></tt>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3163">#3163</a></p>
</div>
<div class="section" id="the-insert-from-select-construct-now-implies-inline-true">
<span id="change-3169"></span><h3>The INSERT...FROM SELECT construct now implies <tt class="docutils literal"><span class="pre">inline=True</span></tt><a class="headerlink" href="#the-insert-from-select-construct-now-implies-inline-true" title="Permalink to this headline">¶</a></h3>
<p>Using <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.from_select" title="sqlalchemy.sql.expression.Insert.from_select"><tt class="xref py py-meth docutils literal"><span class="pre">Insert.from_select()</span></tt></a> now implies <tt class="docutils literal"><span class="pre">inline=True</span></tt>
on <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><tt class="xref py py-func docutils literal"><span class="pre">insert()</span></tt></a>.  This helps to fix a bug where an
INSERT...FROM SELECT construct would inadvertently be compiled
as &#8220;implicit returning&#8221; on supporting backends, which would
cause breakage in the case of an INSERT that inserts zero rows
(as implicit returning expects a row), as well as arbitrary
return data in the case of an INSERT that inserts multiple
rows (e.g. only the first row of many).
A similar change is also applied to an INSERT..VALUES
with multiple parameter sets; implicit RETURNING will no longer emit
for this statement either.  As both of these constructs deal
with varible numbers of rows, the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ResultProxy.inserted_primary_key" title="sqlalchemy.engine.ResultProxy.inserted_primary_key"><tt class="xref py py-attr docutils literal"><span class="pre">ResultProxy.inserted_primary_key</span></tt></a> accessor does not
apply.   Previously, there was a documentation note that one
may prefer <tt class="docutils literal"><span class="pre">inline=True</span></tt> with INSERT..FROM SELECT as some databases
don&#8217;t support returning and therefore can&#8217;t do &#8220;implicit&#8221; returning,
but there&#8217;s no reason an INSERT...FROM SELECT needs implicit returning
in any case.   Regular explicit <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><tt class="xref py py-meth docutils literal"><span class="pre">Insert.returning()</span></tt></a> should
be used to return variable numbers of result rows if inserted
data is needed.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3169">#3169</a></p>
</div>
<div class="section" id="autoload-with-now-implies-autoload-true">
<span id="change-3027"></span><h3><tt class="docutils literal"><span class="pre">autoload_with</span></tt> now implies <tt class="docutils literal"><span class="pre">autoload=True</span></tt><a class="headerlink" href="#autoload-with-now-implies-autoload-true" title="Permalink to this headline">¶</a></h3>
<p>A <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt></a> can be set up for reflection by passing
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.autoload_with" title="sqlalchemy.schema.Table"><tt class="xref py py-paramref docutils literal"><span class="pre">Table.autoload_with</span></tt></a> alone:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s">&#39;my_table&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">some_engine</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3027">#3027</a></p>
</div>
<div class="section" id="dbapi-exception-wrapping-and-handle-error-event-improvements">
<span id="change-3266"></span><h3>DBAPI exception wrapping and handle_error() event improvements<a class="headerlink" href="#dbapi-exception-wrapping-and-handle-error-event-improvements" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy&#8217;s wrapping of DBAPI exceptions was not taking place in the
case where a <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a> object was invalidated, and then tried
to reconnect and encountered an error; this has been resolved.</p>
<p>Additionally, the recently added <a class="reference internal" href="../core/events.html#sqlalchemy.events.ConnectionEvents.handle_error" title="sqlalchemy.events.ConnectionEvents.handle_error"><tt class="xref py py-meth docutils literal"><span class="pre">ConnectionEvents.handle_error()</span></tt></a>
event is now invoked for errors that occur upon initial connect, upon
reconnect, and when <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><tt class="xref py py-func docutils literal"><span class="pre">create_engine()</span></tt></a> is used given a custom connection
function via <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.creator" title="sqlalchemy.create_engine"><tt class="xref py py-paramref docutils literal"><span class="pre">create_engine.creator</span></tt></a>.</p>
<p>The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.ExceptionContext" title="sqlalchemy.engine.ExceptionContext"><tt class="xref py py-class docutils literal"><span class="pre">ExceptionContext</span></tt></a> object has a new datamember
<tt class="xref py py-attr docutils literal"><span class="pre">ExceptionContext.engine</span></tt> that will always refer to the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><tt class="xref py py-class docutils literal"><span class="pre">Engine</span></tt></a>
in use, in those cases when the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a> object is not available
(e.g. on initial connect).</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3266">#3266</a></p>
</div>
<div class="section" id="foreignkeyconstraint-columns-is-now-a-columncollection">
<span id="change-3243"></span><h3>ForeignKeyConstraint.columns is now a ColumnCollection<a class="headerlink" href="#foreignkeyconstraint-columns-is-now-a-columncollection" title="Permalink to this headline">¶</a></h3>
<p><tt class="xref py py-attr docutils literal"><span class="pre">ForeignKeyConstraint.columns</span></tt> was previously a plain list
containing either strings or <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><tt class="xref py py-class docutils literal"><span class="pre">Column</span></tt></a> objects, depending on
how the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKeyConstraint</span></tt></a> was constructed and whether it was
associated with a table.  The collection is now a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnCollection" title="sqlalchemy.sql.expression.ColumnCollection"><tt class="xref py py-class docutils literal"><span class="pre">ColumnCollection</span></tt></a>,
and is only initialized after the <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKeyConstraint</span></tt></a> is
associated with a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt></a>.  A new accessor
<tt class="xref py py-attr docutils literal"><span class="pre">ForeignKeyConstraint.column_keys</span></tt>
is added to unconditionally return string keys for the local set of
columns regardless of how the object was constructed or its current
state.</p>
</div>
<div class="section" id="null-false-and-true-constants-are-no-longer-singletons">
<span id="bug-3170"></span><h3>null(), false() and true() constants are no longer singletons<a class="headerlink" href="#null-false-and-true-constants-are-no-longer-singletons" title="Permalink to this headline">¶</a></h3>
<p>These three constants were changed to return a &#8220;singleton&#8221; value
in 0.9; unfortunately, that would lead to a query like the following
to not render as expected:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">([</span><span class="n">null</span><span class="p">(),</span> <span class="n">null</span><span class="p">()])</span></pre></div>
</div>
<p>rendering only <tt class="docutils literal"><span class="pre">SELECT</span> <span class="pre">NULL</span> <span class="pre">AS</span> <span class="pre">anon_1</span></tt>, because the two <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.null" title="sqlalchemy.sql.expression.null"><tt class="xref py py-func docutils literal"><span class="pre">null()</span></tt></a>
constructs would come out as the same  <tt class="docutils literal"><span class="pre">NULL</span></tt> object, and
SQLAlchemy&#8217;s Core model is based on object identity in order to
determine lexical significance.    The change in 0.9 had no
importance other than the desire to save on object overhead; in general,
an unnamed construct needs to stay lexically unique so that it gets
labeled uniquely.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3170">#3170</a></p>
</div>
<div class="section" id="sqlite-oracle-have-distinct-methods-for-temporary-table-view-name-reporting">
<span id="change-3204"></span><h3>SQLite/Oracle have distinct methods for temporary table/view name reporting<a class="headerlink" href="#sqlite-oracle-have-distinct-methods-for-temporary-table-view-name-reporting" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_names" title="sqlalchemy.engine.reflection.Inspector.get_table_names"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_table_names()</span></tt></a> and <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_view_names" title="sqlalchemy.engine.reflection.Inspector.get_view_names"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_view_names()</span></tt></a>
methods in the case of SQLite/Oracle would also return the names of temporary
tables and views, which is not provided by any other dialect (in the case
of MySQL at least it is not even possible).  This logic has been moved
out to two new methods <tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_temp_table_names()</span></tt> and
<tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_temp_view_names()</span></tt>.</p>
<p>Note that reflection of a specific named temporary table or temporary view,
either by <tt class="docutils literal"><span class="pre">Table('name',</span> <span class="pre">autoload=True)</span></tt> or via methods like
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_columns" title="sqlalchemy.engine.reflection.Inspector.get_columns"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_columns()</span></tt></a> continues to function for most if not all
dialects.   For SQLite specifically, there is a bug fix for UNIQUE constraint
reflection from temp tables as well, which is <a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3203">#3203</a>.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3204">#3204</a></p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-postgresql">
<h2>Dialect Improvements and Changes - Postgresql<a class="headerlink" href="#dialect-improvements-and-changes-postgresql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="new-postgresql-table-options">
<h3>New Postgresql Table options<a class="headerlink" href="#new-postgresql-table-options" title="Permalink to this headline">¶</a></h3>
<p>Added support for PG table options TABLESPACE, ON COMMIT,
WITH(OUT) OIDS, and INHERITS, when rendering DDL via
the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt></a> construct.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><em class="xref std std-ref">postgresql_table_options</em></p>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2051">#2051</a></p>
</div>
<div class="section" id="new-get-enums-method-with-postgresql-dialect">
<span id="feature-get-enums"></span><h3>New get_enums() method with Postgresql Dialect<a class="headerlink" href="#new-get-enums-method-with-postgresql-dialect" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/inspection.html#sqlalchemy.inspection.inspect" title="sqlalchemy.inspection.inspect"><tt class="xref py py-func docutils literal"><span class="pre">inspect()</span></tt></a> method returns a <tt class="xref py py-class docutils literal"><span class="pre">PGInspector</span></tt> object in the
case of Postgresql, which includes a new <tt class="xref py py-meth docutils literal"><span class="pre">PGInspector.get_enums()</span></tt>
method that returns information on all available <tt class="docutils literal"><span class="pre">ENUM</span></tt> types:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">create_engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&quot;postgresql+psycopg2://host/dbname&quot;</span><span class="p">)</span>
<span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">insp</span><span class="o">.</span><span class="n">get_enums</span><span class="p">())</span></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><tt class="xref py py-meth docutils literal"><span class="pre">PGInspector.get_enums()</span></tt></p>
</div>
</div>
<div class="section" id="postgresql-dialect-reflects-materialized-views-foreign-tables">
<span id="feature-2891"></span><h3>Postgresql Dialect reflects Materialized Views, Foreign Tables<a class="headerlink" href="#postgresql-dialect-reflects-materialized-views-foreign-tables" title="Permalink to this headline">¶</a></h3>
<p>Changes are as follows:</p>
<ul class="simple">
<li>the <tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt> construct with <tt class="docutils literal"><span class="pre">autoload=True</span></tt> will now match a name
that exists in the database as a materialized view or foriegn table.</li>
<li><a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_view_names" title="sqlalchemy.engine.reflection.Inspector.get_view_names"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_view_names()</span></tt></a> will return plain and materialized view
names.</li>
<li><a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_names" title="sqlalchemy.engine.reflection.Inspector.get_table_names"><tt class="xref py py-meth docutils literal"><span class="pre">Inspector.get_table_names()</span></tt></a> does <strong>not</strong> change for Postgresql, it
continues to return only the names of plain tables.</li>
<li>A new method <tt class="xref py py-meth docutils literal"><span class="pre">PGInspector.get_foreign_table_names()</span></tt> is added which
will return the names of tables that are specifically marked as &#8220;foreign&#8221;
in the Postgresql schema tables.</li>
</ul>
<p>The change to reflection involves adding <tt class="docutils literal"><span class="pre">'m'</span></tt> and <tt class="docutils literal"><span class="pre">'f'</span></tt> to the list
of qualifiers we use when querying <tt class="docutils literal"><span class="pre">pg_class.relkind</span></tt>, but this change
is new in 1.0.0 to avoid any backwards-incompatible surprises for those
running 0.9 in production.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2891">#2891</a></p>
</div>
<div class="section" id="postgresql-has-table-now-works-for-temporary-tables">
<span id="change-3264"></span><h3>Postgresql <tt class="docutils literal"><span class="pre">has_table()</span></tt> now works for temporary tables<a class="headerlink" href="#postgresql-has-table-now-works-for-temporary-tables" title="Permalink to this headline">¶</a></h3>
<p>This is a simple fix such that &#8220;has table&#8221; for temporary tables now works,
so that code like the following may proceed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">user_tmp</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s">&quot;user_tmp&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">INT</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">prefixes</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;TEMPORARY&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="s">&#39;debug&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">e</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">user_tmp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># checkfirst will succeed</span>
    <span class="n">user_tmp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
</div>
<p>The very unlikely case that this behavior will cause a non-failing application
to behave differently, is because Postgresql allows a non-temporary table
to silently overwrite a temporary table.  So code like the following will
now act completely differently, no longer creating the real table following
the temporary table:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">user_tmp</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s">&quot;user_tmp&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">INT</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">prefixes</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;TEMPORARY&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="s">&#39;debug&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">e</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">user_tmp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">m2</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s">&quot;user_tmp&quot;</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">INT</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="c"># in 0.9, *will create* the new table, overwriting the old one.</span>
    <span class="c"># in 1.0, *will not create* the new table</span>
    <span class="n">user</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3264">#3264</a></p>
</div>
<div class="section" id="postgresql-filter-keyword">
<span id="feature-gh134"></span><h3>Postgresql FILTER keyword<a class="headerlink" href="#postgresql-filter-keyword" title="Permalink to this headline">¶</a></h3>
<p>The SQL standard FILTER keyword for aggregate functions is now supported
by Postgresql as of 9.4.  SQLAlchemy allows this using
<tt class="xref py py-meth docutils literal"><span class="pre">FunctionElement.filter()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p><tt class="xref py py-meth docutils literal"><span class="pre">FunctionElement.filter()</span></tt></p>
<p class="last"><tt class="xref py py-class docutils literal"><span class="pre">FunctionFilter</span></tt></p>
</div>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-mysql">
<h2>Dialect Improvements and Changes - MySQL<a class="headerlink" href="#dialect-improvements-and-changes-mysql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mysql-internal-no-such-table-exceptions-not-passed-to-event-handlers">
<h3>MySQL internal &#8220;no such table&#8221; exceptions not passed to event handlers<a class="headerlink" href="#mysql-internal-no-such-table-exceptions-not-passed-to-event-handlers" title="Permalink to this headline">¶</a></h3>
<p>The MySQL dialect will now disable <a class="reference internal" href="../core/events.html#sqlalchemy.events.ConnectionEvents.handle_error" title="sqlalchemy.events.ConnectionEvents.handle_error"><tt class="xref py py-meth docutils literal"><span class="pre">ConnectionEvents.handle_error()</span></tt></a>
events from firing for those statements which it uses internally
to detect if a table exists or not.   This is achieved using an
execution option <tt class="docutils literal"><span class="pre">skip_user_error_events</span></tt> that disables the handle
error event for the scope of that execution.   In this way, user code
that rewrites exceptions doesn&#8217;t need to worry about the MySQL
dialect or other dialects that occasionally need to catch
SQLAlchemy specific exceptions.</p>
</div>
<div class="section" id="changed-the-default-value-of-raise-on-warnings-for-mysql-connector">
<h3>Changed the default value of <tt class="docutils literal"><span class="pre">raise_on_warnings</span></tt> for MySQL-Connector<a class="headerlink" href="#changed-the-default-value-of-raise-on-warnings-for-mysql-connector" title="Permalink to this headline">¶</a></h3>
<p>Changed the default value of &#8220;raise_on_warnings&#8221; to False for
MySQL-Connector.  This was set at True for some reason.  The &#8220;buffered&#8221;
flag unfortunately must stay at True as MySQLconnector does not allow
a cursor to be closed unless all results are fully fetched.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2515">#2515</a></p>
</div>
<div class="section" id="mysql-boolean-symbols-true-false-work-again">
<span id="bug-3186"></span><h3>MySQL boolean symbols &#8220;true&#8221;, &#8220;false&#8221; work again<a class="headerlink" href="#mysql-boolean-symbols-true-false-work-again" title="Permalink to this headline">¶</a></h3>
<p>0.9&#8217;s overhaul of the IS/IS NOT operators as well as boolean types in
<a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/2682">#2682</a> disallowed the MySQL dialect from making use of the
&#8220;true&#8221; and &#8220;false&#8221; symbols in the context of &#8220;IS&#8221; / &#8220;IS NOT&#8221;.  Apparently,
even though MySQL has no &#8220;boolean&#8221; type, it supports IS / IS NOT when the
special &#8220;true&#8221; and &#8220;false&#8221; symbols are used, even though these are otherwise
synonymous with &#8220;1&#8221; and &#8220;0&#8221; (and IS/IS NOT don&#8217;t work with the numerics).</p>
<p>So the change here is that the MySQL dialect remains &#8220;non native boolean&#8221;,
but the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.true" title="sqlalchemy.sql.expression.true"><tt class="xref py py-func docutils literal"><span class="pre">true()</span></tt></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.false" title="sqlalchemy.sql.expression.false"><tt class="xref py py-func docutils literal"><span class="pre">false()</span></tt></a> symbols again produce the
keywords &#8220;true&#8221; and &#8220;false&#8221;, so that an expression like <tt class="docutils literal"><span class="pre">column.is_(true())</span></tt>
again works on MySQL.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3186">#3186</a></p>
</div>
<div class="section" id="the-match-operator-now-returns-an-agnostic-matchtype-compatible-with-mysql-s-floating-point-return-value">
<span id="change-3263"></span><h3>The match() operator now returns an agnostic MatchType compatible with MySQL&#8217;s floating point return value<a class="headerlink" href="#the-match-operator-now-returns-an-agnostic-matchtype-compatible-with-mysql-s-floating-point-return-value" title="Permalink to this headline">¶</a></h3>
<p>The return type of a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.match" title="sqlalchemy.sql.operators.ColumnOperators.match"><tt class="xref py py-meth docutils literal"><span class="pre">ColumnOperators.match()</span></tt></a> expression is now a new type
called <tt class="xref py py-class docutils literal"><span class="pre">MatchType</span></tt>.  This is a subclass of <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><tt class="xref py py-class docutils literal"><span class="pre">Boolean</span></tt></a>,
that can be intercepted by the dialect in order to produce a different
result type at SQL execution time.</p>
<p>Code like the following will now function correctly and return floating points
on MySQL:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>   <span class="n">select</span><span class="p">([</span>
<span class="gp">... </span>       <span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;Agile Ruby Programming&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s">&#39;ruby&#39;</span><span class="p">),</span>
<span class="gp">... </span>       <span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;Dive Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s">&#39;python&#39;</span><span class="p">),</span>
<span class="gp">... </span>       <span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span>
<span class="gp">... </span>   <span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">matchtable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">[</span>
<span class="go">    (2.0, 0.0, &#39;Agile Web Development with Ruby On Rails&#39;),</span>
<span class="go">    (0.0, 2.0, &#39;Dive Into Python&#39;),</span>
<span class="go">    (2.0, 0.0, &quot;Programming Matz&#39;s Ruby&quot;),</span>
<span class="go">    (0.0, 0.0, &#39;The Definitive Guide to Django&#39;),</span>
<span class="go">    (0.0, 1.0, &#39;Python in a Nutshell&#39;)</span>
<span class="go">]</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3263">#3263</a></p>
</div>
<div class="section" id="drizzle-dialect-is-now-an-external-dialect">
<span id="change-2984"></span><h3>Drizzle Dialect is now an External Dialect<a class="headerlink" href="#drizzle-dialect-is-now-an-external-dialect" title="Permalink to this headline">¶</a></h3>
<p>The dialect for <a class="reference external" href="http://www.drizzle.org/">Drizzle</a> is now an external
dialect, available at <a class="reference external" href="https://bitbucket.org/zzzeek/sqlalchemy-drizzle">https://bitbucket.org/zzzeek/sqlalchemy-drizzle</a>.
This dialect was added to SQLAlchemy right before SQLAlchemy was able to
accommodate third party dialects well; going forward, all databases that aren&#8217;t
within the &#8220;ubiquitous use&#8221; category are third party dialects.
The dialect&#8217;s implementation hasn&#8217;t changed and is still based on the
MySQL + MySQLdb dialects within SQLAlchemy.  The dialect is as of yet
unreleased and in &#8220;attic&#8221; status; however it passes the majority of tests
and is generally in decent working order, if someone wants to pick up
on polishing it.</p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-sqlite">
<h2>Dialect Improvements and Changes - SQLite<a class="headerlink" href="#dialect-improvements-and-changes-sqlite" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sqlite-named-and-unnamed-unique-and-foreign-key-constraints-will-inspect-and-reflect">
<h3>SQLite named and unnamed UNIQUE and FOREIGN KEY constraints will inspect and reflect<a class="headerlink" href="#sqlite-named-and-unnamed-unique-and-foreign-key-constraints-will-inspect-and-reflect" title="Permalink to this headline">¶</a></h3>
<p>UNIQUE and FOREIGN KEY constraints are now fully reflected on
SQLite both with and without names.  Previously, foreign key
names were ignored and unnamed unique constraints were skipped.   In particular
this will help with Alembic&#8217;s new SQLite migration features.</p>
<p>To achieve this, for both foreign keys and unique constraints, the result
of PRAGMA foreign_keys, index_list, and index_info is combined with regular
expression parsing of the CREATE TABLE statement overall to form a complete
picture of the names of constraints, as well as differentiating UNIQUE
constraints that were created as UNIQUE vs. unnamed INDEXes.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3244">#3244</a></p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3261">#3261</a></p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-sql-server">
<h2>Dialect Improvements and Changes - SQL Server<a class="headerlink" href="#dialect-improvements-and-changes-sql-server" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pyodbc-driver-name-is-required-with-hostname-based-sql-server-connections">
<span id="change-3182"></span><h3>PyODBC driver name is required with hostname-based SQL Server connections<a class="headerlink" href="#pyodbc-driver-name-is-required-with-hostname-based-sql-server-connections" title="Permalink to this headline">¶</a></h3>
<p>Connecting to SQL Server with PyODBC using a DSN-less connection, e.g.
with an explicit hostname, now requires a driver name - SQLAlchemy will no
longer attempt to guess a default:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">&quot;mssql+pyodbc://scott:tiger@myhost:port/databasename?driver=SQL+Server+Native+Client+10.0&quot;</span><span class="p">)</span></pre></div>
</div>
<p>SQLAlchemy&#8217;s previously hardcoded default of &#8220;SQL Server&#8221; is obsolete on
Windows, and SQLAlchemy cannot be tasked with guessing the best driver
based on operation system/driver detection.   Using a DSN is always preferred
when using ODBC to avoid this issue entirely.</p>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3182">#3182</a></p>
</div>
<div class="section" id="sql-server-2012-large-text-binary-types-render-as-varchar-nvarchar-varbinary">
<h3>SQL Server 2012 large text / binary types render as VARCHAR, NVARCHAR, VARBINARY<a class="headerlink" href="#sql-server-2012-large-text-binary-types-render-as-varchar-nvarchar-varbinary" title="Permalink to this headline">¶</a></h3>
<p>The rendering of the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Text" title="sqlalchemy.types.Text"><tt class="xref py py-class docutils literal"><span class="pre">Text</span></tt></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.UnicodeText" title="sqlalchemy.types.UnicodeText"><tt class="xref py py-class docutils literal"><span class="pre">UnicodeText</span></tt></a>, and <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.LargeBinary" title="sqlalchemy.types.LargeBinary"><tt class="xref py py-class docutils literal"><span class="pre">LargeBinary</span></tt></a>
types has been changed for SQL Server 2012 and greater, with options
to control the behavior completely, based on deprecation guidelines from
Microsoft.  See <em class="xref std std-ref">mssql_large_type_deprecation</em> for details.</p>
</div>
</div>
<div class="section" id="dialect-improvements-and-changes-oracle">
<h2>Dialect Improvements and Changes - Oracle<a class="headerlink" href="#dialect-improvements-and-changes-oracle" title="Permalink to this headline">¶</a></h2>
<div class="section" id="improved-support-for-ctes-in-oracle">
<span id="change-3220"></span><h3>Improved support for CTEs in Oracle<a class="headerlink" href="#improved-support-for-ctes-in-oracle" title="Permalink to this headline">¶</a></h3>
<p>CTE support has been fixed up for Oracle, and there is also a new feature
<tt class="xref py py-meth docutils literal"><span class="pre">CTE.with_suffixes()</span></tt> that can assist with Oracle&#8217;s special directives:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">included_parts</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
    <span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">sub_part</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">quantity</span>
<span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">part</span> <span class="o">==</span> <span class="s">&quot;p1&quot;</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">cte</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;included_parts&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">suffix_with</span><span class="p">(</span>
        <span class="s">&quot;search depth first by part set ord1&quot;</span><span class="p">,</span>
        <span class="s">&quot;cycle part set y_cycle to 1 default 0&quot;</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s">&#39;oracle&#39;</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="http://www.sqlalchemy.org/trac/ticket/3220">#3220</a></p>
</div>
<div class="section" id="new-oracle-keywords-for-ddl">
<h3>New Oracle Keywords for DDL<a class="headerlink" href="#new-oracle-keywords-for-ddl" title="Permalink to this headline">¶</a></h3>
<p>Keywords such as COMPRESS, ON COMMIT, BITMAP:</p>
<p><em class="xref std std-ref">oracle_table_options</em></p>
<p><em class="xref std std-ref">oracle_index_options</em></p>
</div>
</div>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links">

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2015, the SQLAlchemy authors and contributors.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3.
    </div>
</div>

</div>


        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '0.9.9',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


