function TypeaheadTaggingPlugin(element){this.element=element,this.input=void 0,this.ul=void 0,this.cleaning_pattern=/[^\w\s-]+/g,this.typeahead_datasetname="tagging",this.max_tags=parseInt(this.element.getAttribute("data-max-tags"))||9001}Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement,fromIndex){var k;if(null===this)throw new TypeError('"this" is null or not defined');var O=Object(this),len=O.length>>>0;if(0===len)return-1;var n=+fromIndex||0;if(1/0===Math.abs(n)&&(n=0),n>=len)return-1;for(k=Math.max(n>=0?n:len-Math.abs(n),0);len>k;){if(k in O&&O[k]===searchElement)return k;k++}return-1}),TypeaheadTaggingPlugin.prototype.add_tag=function(value,mute){value=this.clean_value(value),value&&(this.add_to_value(value)&&this.append_li(value),jQuery(this.input).typeahead("val",""),mute!==!0&&this.fire_change_event())},TypeaheadTaggingPlugin.prototype.add_to_value=function(value){var taglist,added;return added=!1,taglist=this.get_taglist(),-1===taglist.indexOf(value)&&taglist.length<this.max_tags&&(taglist.push(value),added=!0),this.set_taglist(taglist),added},TypeaheadTaggingPlugin.prototype.append_li=function(value){var li,tagging_li_new,span;span=document.createElement("span"),span.classList.add("tagging_delete_tag"),span.setAttribute("data-class","tagging_delete_tag"),span.textContent="x",li=document.createElement("li"),li.textContent=value,li.classList.add("tagging_li"),li.setAttribute("data-value",value),li.setAttribute("title",value),li.setAttribute("data-class","tagging_tag"),void 0!==this.input?(tagging_li_new=this.element.parentElement.querySelector('[data-class="tagging_li_new"]'),tagging_li_new.parentNode.insertBefore(li,tagging_li_new)):this.ul.appendChild(li),li.appendChild(span),span.onclick=this.handle_click_delete()},TypeaheadTaggingPlugin.prototype.clean_value=function(value){return value.replace(this.cleaning_pattern,"")},TypeaheadTaggingPlugin.prototype.clear_tags=function(mute){for(var tag_li=this.ul.querySelector('[data-class="tagging_tag"]');tag_li;)tag_li.remove(),tag_li=this.ul.querySelector('[data-class="tagging_tag"]');this.element.value="",mute!==!0&&this.fire_change_event()},TypeaheadTaggingPlugin.prototype.create_li_with_input=function(){var li;li=document.createElement("li"),li.innerHTML='<input type="text" class="tagging_li_new_input" data-class="tagging_li_new_input" />',li.classList.add("tagging_li_new"),li.setAttribute("data-class","tagging_li_new"),this.element.parentElement.querySelector('[data-class="tagging_ul"]').appendChild(li),this.input=li.querySelector('[data-class="tagging_li_new_input"]'),this.input.onkeyup=this.handle_input_keyup(),this.input.onkeydown=this.handle_input_keydown()},TypeaheadTaggingPlugin.prototype.create_tags=function(){var taglist;taglist=this.get_taglist(),this.ul.innerHTML="";for(var i=0;i<taglist.length;i++)this.append_li(taglist[i])},TypeaheadTaggingPlugin.prototype.create_ul=function(){var ul;ul=document.createElement("ul"),ul.classList.add("tagging_ul"),ul.setAttribute("data-class","tagging_ul"),this.element.parentNode.insertBefore(ul,this.element),ul.onclick=this.handle_click_to_focus(),this.ul=ul},TypeaheadTaggingPlugin.prototype.delete_from_value=function(value){var taglist,index;return value?(taglist=this.get_taglist(),index=taglist.indexOf(value),-1!==index&&taglist.splice(index,1),this.set_taglist(taglist),!0):!1},TypeaheadTaggingPlugin.prototype.delete_tag=function(value,mute){this.delete_from_value(value)&&this.element.parentElement.querySelector('[data-value="'+value+'"]').remove(),mute!==!0&&this.fire_change_event()},TypeaheadTaggingPlugin.prototype.fire_change_event=function(){if("createEvent"in document){var evt=document.createEvent("HTMLEvents");evt.initEvent("change",!1,!0),this.element.dispatchEvent(evt)}else this.element.fireEvent("onchange")},TypeaheadTaggingPlugin.prototype.get_taglist=function(){return this.element.value?this.element.value.split(","):[]},TypeaheadTaggingPlugin.prototype.handle_click_to_focus=function(){var that=this;return function(){that.input.focus()}},TypeaheadTaggingPlugin.prototype.handle_click_delete=function(){var handler,that=this;return handler=function(){var value;value=this.parentNode.getAttribute("data-value"),that.delete_tag(value)}},TypeaheadTaggingPlugin.prototype.handle_input_keyup=function(){var handler,that=this;return handler=function(e){(13===e.keyCode||188===e.keyCode)&&that.add_tag(this.value)}},TypeaheadTaggingPlugin.prototype.handle_input_keydown=function(){var handler,taglist,that=this;return handler=function(e){(9===e.keyCode||13===e.keyCode)&&this.value&&!that.input.parentNode.querySelector("[class*=tt-hint]").value&&(e.preventDefault(),that.add_tag(this.value)),8===e.keyCode&&(this.value||(taglist=that.get_taglist(),that.delete_tag(taglist[taglist.length-1])))}},TypeaheadTaggingPlugin.prototype.init=function(tagsource){var wrapper=document.createElement("div"),parent_node=this.element.parentNode,next_sibling=this.element.nextSibling;wrapper.classList.add("tagging_wrapper"),wrapper.appendChild(this.element),next_sibling?parent_node.insertBefore(wrapper,next_sibling):parent_node.appendChild(wrapper),this.element.style.display="none",this.create_ul(),this.create_tags(),this.create_li_with_input(),this.init_typeahead(tagsource)},TypeaheadTaggingPlugin.prototype.init_typeahead=function(tagsource){tagsource&&jQuery(this.input).typeahead({hint:!0,highlight:!0,minLength:1},{name:this.typeahead_datasetname,displayKey:"value",source:this.substringMatcher(tagsource)})},TypeaheadTaggingPlugin.prototype.set_taglist=function(taglist){this.element.value=taglist.join()},TypeaheadTaggingPlugin.prototype.set_value=function(taglist){this.clear_tags(!0);for(var i=0;i<taglist.length;i++)this.add_tag(taglist[i],!0);this.fire_change_event()},TypeaheadTaggingPlugin.prototype.substringMatcher=function(tagsource){var that=this;return function(q,cb){var matches,substrRegex,values,taglist;matches=[],values=[],substrRegex=new RegExp(q,"i"),taglist=that.get_taglist();for(var i=0;i<tagsource.length;i++)-1===taglist.indexOf(tagsource[i])&&values.push(tagsource[i]);jQuery.each(values,function(i,str){substrRegex.test(str)&&matches.push({value:str})}),cb(matches)}},function($){$.fn.tagging=function(arg,arg2){var plugin,plugin_name="plugin_tagging";return arg?$.isArray(arg)?this.each(function(){return plugin=$.data(this,plugin_name),"undefined"==typeof plugin&&(plugin=new TypeaheadTaggingPlugin(this),$.data(this,plugin_name,plugin),plugin.init(arg)),plugin}):"clear"===arg?(plugin=$.data(this[0],plugin_name),plugin.clear_tags()):"value"===arg&&"undefined"==typeof arg2?(plugin=$.data(this[0],plugin_name),plugin.get_taglist()):"value"===arg?(plugin=$.data(this[0],plugin_name),plugin.set_value(arg2),plugin):void 0:$.data(this[0],plugin_name)}}(jQuery);