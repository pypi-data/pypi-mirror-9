<!DOCTYPE html>
<html>
    <head>
        <title>py-pg-querymaker</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- Bootstrap -->
        <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen" />
        <link rel="stylesheet" href="static/jqueryui/css/ui-lightness/jquery-ui-1.10.0.custom.min.css">
        <link href="static/treeview/treeview.css" rel="stylesheet" media="screen" />
    </head>
    <body style="padding-top:50px">
        <div id="credits-modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h3 id="myModalLabel">Credits</h3>
            </div>
            <div class="modal-body">
                <p>The complete credit for this small project goes to the creators of these wonderful tools and libraries. </p>
                <hr>
                <h4><a target="_blank"  href="http://twitter.github.io/bootstrap/index.html">Bootstrap</a><small> CSS Framework</small></h4>
                <h4><a target="_blank"  href="http://ace.ajax.org">Ace</a><small> Code editor</small></h4>
                <h4><a target="_blank"  href="https://github.com/andialbrecht/sqlparse">andialbrecht/sqlparse</a><small>python-sqlparse</small></h4>
                <hr>
                <img src="static/misc/images/bitbucket.jpg">Please report any issue at Bitbucket repo <a target="_blank" href="https://bitbucket.org/sras/py-pg-query-maker">here</a>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
            </div>
        </div>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner sqlcraft-mainnav">
                <ul class="nav">
                    <li class="active"><a class='nav-link' href="ctab-1">Connection</a></li>
                    <li><a class='nav-link' href="ctab-5">Schema</a></li>
                    <li><a class='nav-link' href="ctab-2">Queries</a></li>
                    <li><a class='nav-link' href="ctab-3">History</a></li>
                    <li>
                    <div class="dropdown" style='margin-left:10px' >
                        <div class="btn-group">
                            <button class='btn btn-success disabled db-select-button' id='db-select-button'>Select Database</button>
                            <ul id='database-list' class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                <li class="divider"></li>
                                <li><a href="#" id='refresh-schema'>  <i class="icon-refresh"> </i> Refresh Schema</a></li>
                            </ul>
                            <button class="btn btn-success disabled db-select-button" id="db-select-caret" data-toggle="dropdown"><span class="caret"></span></button>
                        </div>
                    </div>
                    </li>
                    <li>
                    <div class="dropdown" style='margin-left:10px' >
                        <div class="btn-group log-group">
                            <button class='btn btn-success' id='log-select-button'>Messages&amp;Logs</button>
                            <ul id='log-list' class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                <li>
                                <div id="log-container" class='container span2' style='height:400px;white-space:normal;overflow:auto;padding:5px'>
                                </div>
                                </li>
                                <li>
                                <a class="btn" id="log-close" type="button" style="margin:5px" value="Input">Close</a>
                                </li>
                            </ul>
                            <button class="btn btn-success" id="log-select-button-caret"><span class="caret"></span></button>
                        </div>
                    </div>
                    </li>
                    <li>
                    <div class="dropdown" style='margin-left:10px' >
                        <div class="btn-group clipper-group">
                            <button class='btn btn-success' id='clipper-select-button'>Clips</button>
                            <ul id='clip-list' class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon"  type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li class='clip-item'> 
                                <div class="control-group" style="margin-left:5px;margin-right:5px;margin-top:1px;margin-bottom:1px;">
                                    <div class="controls">
                                        <div class="input-append" style="margin-bottom:0px">
                                            <input class="span2" id="inputIcon" type="text">
                                            <span class="add-on" style="cursor:pointer"><i class="icon-remove-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                </li>
                                <li>
                                <a class="btn" id="clipper-close" type="button" style="margin:5px" value="Input">Close</a>
                                </li>
                            </ul>
                            <button class="btn btn-success" id="clipper-select-button-caret"><span class="caret"></span></button>
                        </div>
                    </div>
                    </li>
                    <li>
                    <img id="ajax-loader" style="margin-top:12px;margin-left:10px;display:none" src="static/misc/images/ajax-loader.gif">
                    </li>
                </ul>
                <ul class="nav pull-right" style="margin-right:20px">
                    <li><button id='credit-button' class='btn btn-danger pull-right' href="ctab-5">Credits</button></li>
                </ul>
            </div>
        </div>
        <div class="ctab" id="ctab-1">
            <div class="row">
                <h4 class="span8 offset1">Remote Database<small><p>This is the details of connection to the db you want to run your queries against</p></small></h4>
            </div>
            <div class="row">
                <div class="span4">
                    <form class="form-horizontal">
                        <div class="control-group">
                            <label class="control-label" for="host_remote">Host</label>
                            <div class="controls">
                                <input type="text" id="host_remote" name="host_remote" placeholder="Enter host address" value="localhost"/>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="port_remote">Port</label>
                            <div class="controls">
                                <input type="text" id="port_remote" name="host_remote" placeholder="Enter host address" value="5432"/>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="user_remote">User</label>
                            <div class="controls">
                                <input type="text" id="user_remote" name="user_remote" placeholder="username" value="root"/>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="password_remote">Password</label>
                            <div class="controls">
                                <input type="password" id="password_remote" name="password_remote" placeholder="" />
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div style="float:none;clear:both"></div>
            <button height:200px' class="btn btn-success span5 offset1" id="check_connection">Connect and load databases</button>
        </div>
        <div class="ctab" id="ctab-3" style="display:none">
            <div class="well">
                <table class='table table-condensed table-striped' id='history-table'>
                    <thead id='history-table-head'>
                        <tr>
                            <!--
                            <th style="width:50px">Id</th>
                            <th style="width:50px">Date</th>
                            -->
                            <th>Query History
                                <div class="btn-group pull-right">
                                    <button class='btn btn-danger' style="margin-bottom:5px" id='delete-unbookmarked'>Delete all queries that are not bookmarked!</button>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id='history-table-body'>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="ctab" id="ctab-2" style="display:none">
            <div class="row-fluid">
                <div style="height:600;" class="span12">
                    <!-- query tab -->
                    <ul class="nav nav-tabs query-tabs" style="margin-bottom:5px;">
                        <li class="active querylink" rel="query-1"><a href="#">Query 1<button class="close" style="margin-left:5px">&times;</button></a></li>
                        <li class="add-query"><a href="#">+</a></li>
                        <li>
                            <div class="dropdown" >
                                <div class="btn-group">
                                    <button class="btn btn-inverse disabled class execute-button" id="execute-button">Execute</button>
                                    <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                        <li><a href='#' id="explain-button">Explain</a></li>
                                        <li><a href='#' id="execute-selection-button">Execute Selection</a></li>
                                        <li><a href='#' id="explain-selection-button">Explain Selection</a></li>
                                        <li><a href="#" id='format-sql-button'>Format Query</a></li>
                                    </ul>
                                    <button class="btn btn-inverse disabled execute-button" data-toggle="dropdown"><span class="caret"></span></button>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="query-1-tab">
                            <div id="query-1-tab-container" style="position:relative;height:300px;width:100%;margin:0px;padding:0px;"></div>
                        </div>
                    </div>
                    <div class="container-fluid" style="padding:0px" >
                        <div class="row-fluid">
                            <div class="span-12" id="result-container" style="overflow:auto;height:200px;background-color:#ffffff">
                                <table class='table table-condensed table-striped'  style="font-size:10px" id='query-result-table'>
                                    <thead id='query-result-table-head'>
                                        <tr>
                                        </tr>
                                    </thead>
                                    <tbody id='query-result-table-body'>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- query tab end -->
                </div>
            </div>
        </div>
        <div class="ctab" id="ctab-5" style="display:none">
            <div class="row-fluid">
                <div style="height:600;margin-left:30px" class="span3 offset0">
                    <div class="well"  style="overflow-x:hidden;">
                        <button id="selected-db-name" class="btn btn-danger" >No Database Selected</button>
                        <div class="css-treeview">
                            <ul id="table-tree">
                                <li></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div style="height:600;" class="span8">
                    <div id="schema-well" class="well" style="height:400px;width:100%;overflow:auto;">
                        <h4 id="displayed-table-name"></h4>
                        <table class='table table-condensed table-striped' style="font-size:10px" id='data-table'>
                            <thead id='data-table-head'>
                                <tr>
                                </tr>
                            </thead>
                            <tbody id='data-table-body'>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <script src="static/jstorage/json2.js"></script>
        <script src="static/jquery/jquery.js"></script>
        <script src="static/jstorage/jstorage.js"></script>
        <script src="static/bootstrap/js/bootstrap.min.js"></script>
        <script src="static/jqueryui/js/jquery-ui-1.10.0.custom.min.js"></script>
        <script src="static/ace/ace.js"></script>
        <script>
        var activetab    = 1;
        var editor       = null;
        var totaltabs    = 1;
        var schemaloaded = 0;
        var selectedDb   = null;
        var results      = {};
        function getLogContainerWidth()
        {
            var bodywidth = $('body').width();
            var leftoffet = $('#log-select-button').offset().left;
            return bodywidth - leftoffet-10;
        }
        function showError(message)
        {
            var element = $('<div class="alert alert-error"> <button type="button" class="close" data-dismiss="alert">&times;</button> <span id="status-bar" >'+message+'</span></div>');
            $('#log-container').prepend(element);
            $('#log-container').width(getLogContainerWidth());
            $('#log-select-button').removeClass('btn-success').addClass('btn-danger');
        }
        function showSuccess(message)
        {
            var element = $('<div class="alert alert-success"> <button type="button" class="close" data-dismiss="alert">&times;</button> <span>'+message+'</span></div>');
            $('#log-container').prepend(element);
            $('#log-container').width(getLogContainerWidth());
            $('#log-select-button').removeClass('btn-danger').addClass('btn-success');
        }
        function getConnectionDetails()
        {
            var details = {};
            details.remotehost     = $('#host_remote').val();
            details.remoteport     = $('#port_remote').val();
            details.remoteuser     = $('#user_remote').val();
            details.remotepassword = $('#password_remote').val();
            details.localstorage  = 1;
            return details;
        }
        function isLocalStorage()
        {
            return true;
        }
        function initStore()
        {
            if(getHistory()==false) {
                setHistory({last_id:1,queries:[]});
            }
        }
        function getHistory()
        {
            return $.jStorage.get('Query History', false);
        }
        function setHistory(history)
        {
            $.jStorage.set('Query History',history);
        }
        function addToHistory(query)
        {
            var history = getHistory();
            var id = history.last_id;
            history.queries.push([id,query,'']);
            history.last_id++;
            setHistory(history);
        }
        function fillResult()
        {
            $('#query-result-table-head tr').empty();
            $('#query-result-table-body').empty();
            if(results[activetab] == undefined) return;
            var result = results[activetab];
            $('#query-result-table-head tr').empty();
            if(result.columns) {
                for(var i=0;i<result.columns.length;i++) {
                    $('#query-result-table-head tr').append($('<th></th>').text(result.columns[i]));
                }
            }
            if(result.data) {
                $('#query-result-table-body').empty();
                var dlength = result.data.length;
                for(var i=0;i<dlength;i++) {
                    var row = result.data[i];
                    var newrow = $("<tr></tr>");
                    for(c in row) {
                        newrow.append($("<td></td>").text(row[c]));
                    }
                    $('#query-result-table-body').append(newrow);
                }
                var remaining_height = parseInt($(window).height() - $('#query-'+activetab+'-tab-container').height()); 
                remaining_height-=100;
                $('#result-container').height(remaining_height);
            }
        }
        function executesql(sql,explain)
        {
            if(schemaloaded != 1) {
                alert("No connection available.");
                return false;
            }
            if(!selectedDb) {
                alert("Database not selected.");
                return false;
            }
            var parameters = getConnectionDetails();
            parameters['db'] = selectedDb;
            parameters['query'] = sql;
            parameters['op'] = 'execute';
            if(explain) parameters['op'] = 'explain';
            $.post('',parameters, function(data) {
                var obj = jQuery.parseJSON(data);
                if(obj.status == 'success') {
                    showSuccess(obj.data.message);
                    results[activetab] = obj.data;
                    fillResult();
                    addToHistory(sql);
                } else if(obj.status == 'error') {
                    showError(obj.errorMessage);
                }
            });
        }
        function executeselection()
        {
            if(!editor) return false;
            executesql(editor.session.getTextRange(editor.getSelectionRange()),false);
        }
        function execute()
        {
            if(!editor) return false;
            executesql(editor.getValue(),false);
        }
        function explain()
        {
            if(!editor) return false;
            executesql(editor.getValue(),true);
        }
        function explainselection()
        {
            if(!editor) return false;
            executesql(editor.session.getTextRange(editor.getSelectionRange()),true);
        }
        function formatsql()
        {
            if(!editor) return false;
            var sql = editor.getValue();
            var parameters = getConnectionDetails();
            parameters['op'] = 'formatSql';
            parameters['query'] = sql;
            $.post('',parameters, function(data) {
                var obj = jQuery.parseJSON(data);
                if(obj.status == 'success') {
                    editor.setValue(obj.data.formatted);
                    editor.clearSelection();
                    showSuccess(obj.data.message);
                } else if(obj.status == 'error') {
                    showError(obj.errorMessage);
                }
            });
        }
        function loadDataFromTable(tablename)
        {
            if(selectedDb) {
                var parameters = getConnectionDetails();
                parameters['db'] = selectedDb;
                parameters['table'] = tablename;
                parameters['op'] = 'loaddata';
                $.post('',parameters, function(data) {
                    var obj = jQuery.parseJSON(data);
                    if(obj.status == 'success') {
                        $('#data-table-head tr').empty();
                        if(obj.data.columns) {
                            for(var i=0;i<obj.data.columns.length;i++) {
                                $('#data-table-head tr').append($('<th></th>').text(obj.data.columns[i]));
                            }
                        }
                        if(obj.data.data) {
                            $('#data-table-body').empty();
                            var dlength = obj.data.data.length;
                            for(var i=0;i<dlength;i++) {
                                var row = obj.data.data[i];
                                var newrow = $("<tr></tr>");
                                for(var c in row) {
                                    newrow.append($("<td></td>").text(row[c]));
                                }
                                $('#data-table-body').append(newrow);
                            }
                        }
                        $("#displayed-table-name").text(tablename);
                    }
                });
            }
        }
        function fillHistory(data)
        {
            $('#history-table-body').empty();
            var dlength = data.length;
            for(var i=0;i<dlength;i++) {
                var row = data[i];
                if(i % 2) {
                    var newrow = $("<tr class='warning'></tr>");
                } else {
                    var newrow = $("<tr></tr>");
                }
                newrow.append($("<td><pre style='border:none;background-color:transparent'>"+row[1]+"</pre><form style='margin:0px'><input type='text' id='query_id_"+row[0]+"' style='margin-left:20px' placeholder='Add a bookmark.' class='bookmark-field' value='"+row[2]+"'/></form></td>"));
                $('#history-table-body').append(newrow);
            }
        }
        function loadHistory()
        {
            if(isLocalStorage()) {
                loadHistoryLocal();
            } else {
                loadHistoryRemote();
            }
        }
        function loadHistoryLocal()
        {
            fillHistory(getHistory().queries);
        }
        function loadHistoryRemote()
        {
            var parameters = getConnectionDetails();
            parameters['db'] = selectedDb;
            parameters['op'] = 'loadhistory';

            $.post('',parameters, function(data) {
                var obj = jQuery.parseJSON(data);
                if(obj.status == 'success') {
                    if(obj.data) {
                        fillHistory(obj.data);
                    }
                } else {
                    showError(obj.errorMessage);
                }
            });
        }
        function saveBookmark(id,bookmark)
        {
            if(isLocalStorage()) {
                saveBookmarkLocal(id, bookmark);
            } else {
                saveBookmarkRemote(id, bookmark);
            }
        }
        function saveBookmarkLocal(id, bookmark)
        {
            var history = getHistory();
            for(var i in history.queries) {
                var item = history.queries[i];
                if(item[0] == id) {
                    history.queries[i][2] = bookmark;
                    setHistory(history);    
                    return true;
                }
            }
        }
        function saveBookmarkRemote(id, bookmark)
        {
            var parameters = getConnectionDetails();
            parameters['db'] = selectedDb;
            parameters['op'] = 'saveBookmark';
            parameters['queryid'] = id;
            parameters['bookmarkstring'] = bookmark;
            $.post('',parameters, function(data) {});
        }
        function loadTables()
        {
            if(selectedDb) {
                var parameters = getConnectionDetails();
                parameters['db'] = selectedDb;
                parameters['op'] = 'gettables';

                $.post('',parameters, function(data) {
                    var obj = jQuery.parseJSON(data);
                    if(obj.status == 'success') {
                        $('#table-tree').empty();
                        for(var i=0;i<obj.data.length;i++) {
                            var table = obj.data[i];
                            var ul = $("<ul></ul>");
                            var fieldLength = table.fields.length;
                            for(var fo = 0;fo < fieldLength; fo++) {
                                ul.append($("<li>"+table.fields[fo].name+'<i style=\'margin-left:10px\'>('+table.fields[fo].type+')</i>'+"</li>"));
                            }
                            var li = $("<li></li>");
                            li.append("<input type='checkbox'/><label  class='clickable-table-name' rel='"+table.name+"'>"+table.name+"</label>");
                            li.append(ul);
                            $('#table-tree').append(li);
                        }
                        $('.execute-button').removeClass('disabled');
                    }
                });

            }
            return false;
        }
        function getSchema(event)
        {
            var parameters = getConnectionDetails();
            parameters['op'] = 'getschema';
            $('.dbselection','#database-list').remove();
            $.post('',parameters, function(data) {
                var obj = jQuery.parseJSON(data);
                if(obj.status == 'success') {
                    schemaloaded = 1;
                    $('.db-select-button').removeClass('disabled');
                    $('#db-select-caret').tooltip({html:false,trigger:'manual', title:'Please select a database',placement:'bottom'});
                    window.setTimeout(function() { $('#db-select-caret').tooltip('hide');}, 3000);
                    $('#db-select-caret').tooltip('show');
                    showSuccess("Connected!");
                    for(var i=0;i<obj.data.length;i++) {
                        var dbname = obj.data[i];
                        $('.divider','#database-list').before($("<li><a data-target='#' href='#' class='dbselection' rel='"+dbname+"'>"+dbname+"</a></li>"));
                    }
                } else {
                    schemaloaded = 0;
                    showError(obj.errorMessage);
                }
            });
            return false;
        }
        function deleteunbookmarked()
        {
            if(isLocalStorage()) {
                deleteUnBookmarkedLocal();
            } else {
                deleteUnBookmarkedRemote();
            }
        }
        function deleteUnBookmarkedLocal()
        {
            var history = getHistory();
            var queries = [];
            for(var i in history.queries) {
                if(history.queries[i][2].length > 0) {
                    queries.push(history.queries[i]);
                }
            }
            history.queries = queries;
            setHistory(history);
            loadHistory();
        }
        function deleteUnBookmarkedRemote()
        {
            var parameters = getConnectionDetails();
            parameters['op'] = 'deleteWithoutBookmarks';
            $.post('',parameters, function(data) {
                var obj = jQuery.parseJSON(data);
                if(obj.status == 'success') {
                    loadHistory();
                } else {
                    showError(obj.errorMessage);
                }

            });
        }
        function setLocalDetailsVis()
        {
            if(isLocalStorage()) {
                $('.js-local-details').hide();
            } else {
                $('.js-local-details').show();
            }
        }
        $(function() {
            initStore();
            setLocalDetailsVis();
            $('#localstorage').change(setLocalDetailsVis);
            $(document).ajaxSend(function() { $('#ajax-loader').show(); });
            $(document).ajaxSuccess(function() { $('#ajax-loader').hide(); });
            $('#delete-unbookmarked').click(function() {
                deleteunbookmarked();
            });
            $('#history-table').on('change','.bookmark-field', function() {
                var idparts = $(this).attr('id').split('_');
                var id = idparts[2];
                saveBookmark(id,$(this).val());
            });
            $('#clipper-select-button-caret').click(function() {
                $('#clip-list').toggle();
            });
            $('#log-select-button-caret').click(function() {
                $('#log-list').toggle();
            });
            $('#clipper-close').click(function() {
                $('#clip-list').hide();
            });
            $('#log-close').click(function() {
                $('#log-list').hide();
            });
            $('.add-on','.clip-item').click(function() {
                $('input',$(this).parent().parent()).val('');
                $('.clip-item').on('mouseup','*',function(event){event.stopPropagation();return false;});
            });
            $('#credit-button').click(function() { $('#credits-modal').modal('show') });
            $('#credits-modal').modal({backdrop:true,show:false});
            $('#explain-button').click(explain);
            $('#explain-selection-button').click(explainselection);
            $('#execute-button').click(execute);
            $('#execute-selection-button').click(executeselection);
            $('#format-sql-button').click(formatsql);
            $('#check_connection,#refresh-schema').click(getSchema);
            $('#table-tree').on('click','.clickable-table-name', function() {
                var tablename = $(this).attr('rel');
                loadDataFromTable(tablename);
            });
            $('#database-list').on('click','.dbselection',function() {
                var dbname = $(this).attr('rel');
                selectedDb = dbname;
                $('.execute-button').removeClass('disabled');
                $('#db-select-button').text(dbname);
                $('#database-list').dropdown('toggle');
                $('#selected-db-name').text("Load tables in `"+dbname+"`.");
                $('#table-tree').empty();
                return false;
            });
            $('.add-query').click(function() {
                totaltabs++;
                $('.query-tabs li').removeClass('active');
                $('.add-query').before('<li class="active querylink" rel="query-'+totaltabs+'"><a href="#">Query '+totaltabs+'<button class="close" style="margin-left:5px">&times;</button></a></li>');
                $('.tab-content').append($('<div class="tab-pane active" id="query-'+totaltabs+'-tab"><div id="query-'+totaltabs+'-tab-container" style="position:relative;height:300px;width:100%;"></div></div>'));
                $("li[rel='query-"+totaltabs+"']").click();
                return false;
            });
            $('ul.nav li a.nav-link','.sqlcraft-mainnav').click(function() {
                $('ul.nav li','.sqlcraft-mainnav').removeClass('active');
                $(this).parent().addClass('active');
                $('.ctab').hide();
                $('#'+$(this).attr('href')).show();
                if($(this).attr('href')=='ctab-2') {
                    $("li[rel='query-"+activetab+"']").click();
                }
                if($(this).attr('href')=='ctab-5')  {
                    var remaining_height = parseInt($(window).height() - 100); 
                    remaining_height-= 50;
                    $('#schema-well').height(remaining_height);
                }
                if($(this).attr('href')=='ctab-3') {
                    loadHistory();
                }
                return false;
            });
            $('.query-tabs').on('click', '.close',function(event) {     
                var li = $(this).parent().parent().attr('rel');
                li = li.split('-');
                li = li[1];
                results[li] = null;
                var tobeactivated = $(this).parent().parent().prev('li.querylink');
                if(tobeactivated.length == 0 )  tobeactivated = $(this).parent().parent().next('li.querylink');
                if(tobeactivated.length == 0 )  {
                    showError('You cannot close last tab :-)');
                    return false;
                }
                if(li == activetab) tobeactivated.click();
                var id = 'query-'+li+'-tab';
                $('#'+id).remove();
                $(this).parent().parent().remove();
                event.stopPropagation();
                return false;
            });
            $('.query-tabs').on('click', 'li.querylink',function() {
                if(activetab) {
                    if(editor) {
                        var content = editor.getValue();
                        var height = $('#query-'+activetab+'-tab-container').height();
                        var id = 'query-'+activetab+'-tab-container';
                        $('#'+id).remove();
                        $('#query-'+activetab+'-tab').append($("<div id='query-"+activetab+"-tab-container' style='position:relative;height:"+height+"px;width:100%;'></div>"));
                        $('#query-'+activetab+'-tab-container').html(content);
                    }
                    $('#query-'+activetab+'-tab').hide();
                }
                $('.query-tabs li').removeClass('active');
                var id = $(this).attr('rel');
                var parts = id.split('-');
                activetab = parts[1];
                $("li[rel='query-"+activetab+"']").addClass('active');
                $('#query-'+activetab+'-tab').show();
                editor = ace.edit(id+'-tab-container');
                editor.setTheme("ace/theme/ambiance");
                editor.getSession().setMode("ace/mode/sql");
                editor.setShowPrintMargin(false);
                $('#'+id+'-tab-container').resizable({ handles: "s",resize:function() { editor.resize();
                var remaining_height = parseInt($(window).height() - $('#'+id+'-tab-container').height()); 
                remaining_height-=100;
                $('#result-container').height(remaining_height);

                } });
                fillResult();
                return false;
            });
            $('#log-container').width(getLogContainerWidth());
            $('#selected-db-name').click(loadTables);
        });
        </script>
    </body>
</html>
