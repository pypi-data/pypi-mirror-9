{% extends "base.html" %}

{% block body %}
  
  <style>
    .highlight {
      padding: 3px;
      margin-bottom: 14px;
      background-color: #f7f7f9;
      border: 1px solid #e1e1e8;
      border-radius: 4px;
    }

    .highlight:hover {
      cursor:pointer;
    }
    #sortable { list-style-type: none; margin: 0; padding: 0; }
  </style>
  <script src="{{SQL_DASHBOARDS_PREFIX}}/static/jquery-ui.js"></script>
  <script>
  var getWidgetIds = function () {
    var dashboard_widget_ids = [];
    $("#sortable li[id^='widget']").each(function() {
      dashboard_widget_ids.push($(this).attr('id').split("_")[1]);
    });
    return dashboard_widget_ids;
  }
  $(function() {
    $( "#sortable" ).sortable({
      revert: true,
      update:function(event, ui) {
        $.ajax({
          url:"{{SQL_DASHBOARDS_PREFIX}}/dashboard/{{dashboard.id}}/change_order?order=" + getWidgetIds().join(","),
        });
      }
    });
    $( "ul, li, div" ).disableSelection();

  });
  function reloadQuery(query_id)
  {
    $("#id_query_" + query_id).hide();
    $.ajax({
      url:"{{SQL_DASHBOARDS_PREFIX}}/query/to_highcharts/" + query_id,
      statusCode:{
        200:function(data) {
          $("#id_query_" + query_id).show();
          $("#id_query_" + query_id).html(data);
        },
        202:function(data) {
          $("#id_query_" + query_id).show();
          $("#id_query_" + query_id).html("<p class=\"text-danger\"><b>Error : " + data + "</b></p>");
        }
      }
    })
  }
  </script>
 
<div class="container">
  {% if dashboard_id %}
  <h1>{{dashboard.title}}</h1>
  <ul id="sortable" class="col-lg-12">
    {% for query in dashboard.queries %}
    <li id="widget_{{query.id}}" class="ui-state-default col-lg-{{dashboard.getColumnSize}}" style="floaf:left;">
      {% include "django_sql_dashboards/query_widget.html" %}
    </li>
    {% endfor %}
    <li class="ui-state-default col-lg-{{dashboard.getColumnSize}}" style="floaf:left;">
      {% load crispy_forms_tags %}
      {% crispy form %}
    </li>
  </ul>
  {% else %}
  <div class="row">
    <div class="col-lg-4">
      {% load crispy_forms_tags %}
      {% crispy form %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
