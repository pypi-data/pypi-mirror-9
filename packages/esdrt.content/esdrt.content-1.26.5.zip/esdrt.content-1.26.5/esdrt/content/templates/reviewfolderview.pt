<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="esdrt.content">
  <tal:block metal:fill-slot="javascript_head_slot">
    <script type="text/javascript">
      $(document).ready(function(){
        $(".observationText").text(function(index, currentText){
          if (currentText.length > 500){
            $(this).text(currentText.substr(0, 500) + "...");
            $(this).attr("title", currentText);
          }
        });
        $('table.observationList tr').superLink('a:first');
        $(".chosen-select").chosen({width: "100%", allow_single_deselect: true});
        $("#btnFilter").click(function(){
          var filter = "";
            if ($('#countryFilter').val() != ""){
              if (filter == ""){
                filter += "?";
              }else{
                filter += "&";
              }
              filter += "country=" + $('#countryFilter').val();
            }
            if ($('#statusFilter').val() != ""){
              if (filter == ""){
                filter += "?";
              }else{
                filter += "&";
              }
              filter += "status=" + $('#statusFilter').val();
            }
            if ($('#reviewYearFilter').val() != ""){
              if (filter == ""){
                filter += "?";
              }else{
                filter += "&";
              }
              filter += "reviewYear=" + $('#reviewYearFilter').val();
            }
            if ($('#inventoryYearFilter').val() != ""){
              if (filter == ""){
                filter += "?";
              }else{
                filter += "&";
              }
              filter += "inventoryYear=" + $('#inventoryYearFilter').val();
            }
            if ($('#freeTextFilter').val() != ""){
              if (filter == ""){
                filter += "?";
              }else{
                filter += "&";
              }
              filter += "freeText=" + $('#freeTextFilter').val();
            }
            if ($("input:checked").length > 0){
              var len = $("input:checked").length;
              var highlights = "";
              for(i=0; i < len; i++){
                highlights += $("input:checked")[i].value + ","
              }
              highlights = highlights.substring(0, highlights.length - 1)
              if (filter == ""){
                filter += "?";
              }else{
                filter += "&";
              }
              filter += "highlights=" + highlights;
            }
            window.location.href = window.location.pathname + filter;

        })
      })
    </script>
  </tal:block>
<body>
  <metal:main fill-slot="content-core">
    <metal:content-core define-macro="content-core">

      <div class="actions" tal:condition="view/can_add_observation">
        <a href="./++add++Observation"
          tal:attributes="href string:${here/absolute_url}/++add++Observation"
          class="standardButton">
            New observation
        </a>
      </div>
      <div id="tabs">
        <div class="tabs">
          <div class="active">
            <a class="eea-icon overview" tal:attributes="href string:${here/absolute_url}/view">Overview list</a>
          </div>
          <div>
            <a class="eea-icon inbox" tal:attributes="href string:${here/absolute_url}/inboxview">My view</a>
          </div>
        </div>
      </div>
      <div id="filters">
        <div class="row" style="padding-top:25px">
          <div class="cell position-1 width-3 esdLabel">Country</div>
          <div class="cell position-4 width-3 esdLabel" title="Review year is the year in which the emissions inventory was submitted and the review was carried out.">Review year</div>
          <div class="cell position-7 width-3 esdLabel" title="Inventory year is the year or a range of years (e.g. '2012', '2009-2012') in which the emissions occured and an issue was observed in the review.">Inventory year</div>
          <div class="cell position-11 width-3 esdLabel" title="Key flags highlight important information that is closely related to the main purpose of 'initial checks' and ESD review.">Key flags</div>
        </div>
        <div class="row">
          <div class="cell position-1 width-3">
            <select id="countryFilter" class="chosen-select" data-placeholder="Select country">
              <option></option>
              <tal:block tal:repeat="item view/get_countries">
                <option
                  tal:define="country python:'';
                              country request/country | country"
                  tal:attributes="value python:item[0];
                                  selected python:item[0]==country"
                  tal:content="python:item[1]"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-4 width-3">
            <select id="reviewYearFilter" class="chosen-select" data-placeholder="Select review year">
              <option></option>
              <tal:block tal:repeat="item view/get_review_years">
                <option
                  tal:define="reviewYear python:'';
                              reviewYear request/reviewYear | reviewYear"
                  tal:attributes="value python:item;
                                  selected python:item==reviewYear"
                  tal:content="python:item"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-7 width-3">
            <select id="inventoryYearFilter" class="chosen-select" data-placeholder="Select inventory year">
              <option></option>
              <tal:block tal:repeat="item view/get_inventory_years">
                <option
                  tal:define="inventoryYear python:'';
                              inventoryYear request/inventoryYear | inventoryYear"
                  tal:attributes="value python:item;
                                  selected python:item==inventoryYear"
                  tal:content="python:item"></option>
              </tal:block>
            </select>
          </div>
          <div class="cell position-11 width-5" style="position:absolute;z-index:2">
            <tal:block tal:repeat="item view/get_highlights">
              <tal:block tal:define="highlights python:'';
                                     highlights request/highlights | highlights">
                <input type="checkbox"
                  tal:attributes="value python:item[0];
                                  checked python:highlights.find(item[0]) >= 0;
                                  id python:item[0]"/>
                <label tal:attributes="for python:item[0];"
                  tal:content="python:item[1]"></label><br/>
              </tal:block>
            </tal:block>
          </div>
        </div>
        <div class="row" style="padding-top:30px">
          <div class="cell position-1 width-3 esdLabel">Status</div>
          <div class="cell position-4 width-6 esdLabel">Free text</div>
        </div>
        <div class="row">
          <div class="cell position-1 width-3">
            <select id="statusFilter"  class="chosen-select" data-placeholder="Select status"
                tal:define="status python:'';
                            status request/status | status">
              <option></option>
             <option tal:attributes="selected python:'open'==status"
                value="open">Open</option>
              <option tal:attributes="selected python:'finished'==status"
                value="finished">Finished</option>
            </select>
          </div>
          <div class="cell position-4 width-6 esdLabel">
            <input type="text" id="freeTextFilter" style="width:100%;border-radius:5px;height:21px"
                tal:define="freeText python:'';
                            freeText request/freeText | freeText"
                tal:attributes="value python:freeText"/>
          </div>
        </div>
        <div class="row" style="padding-top:30px">
          <div class="cell position-1 width-1">
            <a class="standardButton" id="btnFilter">Search</a>
          </div>
        </div>
      </div>
      <div id="no-content" tal:condition="not: view/get_questions">

        <p>
          There are no observations to review.
        </p>

      </div>



      <div id="observations">
        <table class="observationList listing" tal:condition="view/get_questions">
          <thead>
            <tr>
              <th>
                Observation
              </th>
              <th style="width:45%">
                In short
              </th>
              <th>
                CRF code
              </th>
              <th style="width:47px">
                Review year
              </th>
              <th>
                Status
              </th>
              <th>
                Step
              </th>
              <th tal:condition="view/is_secretariat">
                Author
              </th>
            </tr>
          </thead>

          <tbody>
            <tal:block tal:repeat="item view/get_questions">

              <tal:item condition="python:item.portal_type == 'Observation'">
                <tal:item define="observation nocall:item;
                                  toLocalizedTime nocall:here/@@plone/toLocalizedTime;">
                  <tr tal:attributes="data-href observation/absolute_url;
                      class string:clickableRow ${observation/observation_css_class};">
                    <td class="observationRefCell">
                        <a tal:attributes="href observation/absolute_url;"/>
                        <span class="ref-num"
                          tal:content="observation/getId">
                          UK-WAS-13-001
                        </span>
                        /
                        <span class="obs-title"
                          tal:content="observation/Title">
                          Observation title
                        </span>
                        <br/>
                        <div class="potentialSignificantIssue"
                             tal:condition="observation/observation_is_potential_significant_issue">
                          Potential significant issue
                        </div>
                        <div class="potentialTechnicalCorrectionTag"
                             tal:condition="observation/observation_is_potential_technical_correction">
                          Potential technical correction
                        </div>
                        <div class="technicalCorrectionTag"
                          tal:condition="observation/observation_is_technical_correction">
                            Technical correction
                        </div>
                    </td>
                    <td tal:content="observation/text"
                      class="observationText">
                      Observation description
                    </td>
                    <td tal:content="observation/crf_code_value">
                      1A1 Energy industries
                    </td>
                    <td tal:content="observation/review_year" class="yearCell">
                      2014
                    </td>
                    <td>
                      <span
                        tal:replace="structure observation/overview_status">
                          Open
                      </span>
                    </td>
                    <td>
                      <div tal:attributes="class observation/observation_phase">&nbsp;</div>
                    </td>
                    <td tal:condition="view/is_secretariat">
                      <span tal:replace="python:view.get_author_name(observation.Creator())" />
                    </td>
                </tr>
                </tal:item>
              </tal:item>
            </tal:block>
          </tbody>

        </table>
      </div>
      <div class="actions" tal:condition="python:view.can_add_observation() and view.get_questions()">
        <a href="./++add++Observation"
          tal:attributes="href string:${here/absolute_url}/++add++Observation"
          class="standardButton">
            New observation
        </a>
      </div>
      <div id="workflowhelp">
        WORKFLOW
      </div>
    </metal:content-core>
  </metal:main>

</body>
</html>

