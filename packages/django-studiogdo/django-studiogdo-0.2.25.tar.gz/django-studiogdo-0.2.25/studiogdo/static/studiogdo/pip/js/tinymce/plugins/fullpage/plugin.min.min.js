tinymce.PluginManager.add("fullpage",function(x){function w(){var a=v();x.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(b){u(tinymce.extend(a,b.data))}})}function v(){function a(f,d){var g=f.attr(d);return g||""}var j,i,h=t(),e={};return e.fontface=x.getParam("fullpage_default_fontface",""),e.fontsize=x.getParam("fullpage_default_fontsize",""),j=h.firstChild,7==j.type&&(e.xml_pi=!0,i=/encoding="([^"]+)"/.exec(j.value),i&&(e.docencoding=i[1])),j=h.getAll("#doctype")[0],j&&(e.doctype="<!DOCTYPE"+j.value+">"),j=h.getAll("title")[0],j&&j.firstChild&&(e.title=j.firstChild.value),n(h.getAll("meta"),function(g){var f,l=g.attr("name"),k=g.attr("http-equiv");l?e[l.toLowerCase()]=g.attr("content"):"Content-Type"==k&&(f=/charset\s*=\s*(.*)\s*/gi.exec(g.attr("content")),f&&(e.docencoding=f[1]))}),j=h.getAll("html")[0],j&&(e.langcode=a(j,"lang")||a(j,"xml:lang")),e.stylesheets=[],tinymce.each(h.getAll("link"),function(b){"stylesheet"==b.attr("rel")&&e.stylesheets.push(b.attr("href"))}),j=h.getAll("body")[0],j&&(e.langdir=a(j,"dir"),e.style=a(j,"style"),e.visited_color=a(j,"vlink"),e.link_color=a(j,"link"),e.active_color=a(j,"alink")),e}function u(C){function B(f,d,g){f.attr(d,g?g:void 0)}function A(b){y.firstChild?y.insert(b,y.firstChild):y.append(b)}var z,y,l,k,i,e=x.dom;z=t(),y=z.getAll("head")[0],y||(k=z.getAll("html")[0],y=new m("head",1),k.firstChild?k.insert(y,k.firstChild,!0):k.append(y)),k=z.firstChild,C.xml_pi?(i='version="1.0"',C.docencoding&&(i+=' encoding="'+C.docencoding+'"'),7!=k.type&&(k=new m("xml",7),z.insert(k,z.firstChild,!0)),k.value=i):k&&7==k.type&&k.remove(),k=z.getAll("#doctype")[0],C.doctype?(k||(k=new m("#doctype",10),C.xml_pi?z.insert(k,z.firstChild):A(k)),k.value=C.doctype.substring(9,C.doctype.length-1)):k&&k.remove(),k=null,n(z.getAll("meta"),function(b){"Content-Type"==b.attr("http-equiv")&&(k=b)}),C.docencoding?(k||(k=new m("meta",1),k.attr("http-equiv","Content-Type"),k.shortEnded=!0,A(k)),k.attr("content","text/html; charset="+C.docencoding)):k&&k.remove(),k=z.getAll("title")[0],C.title?(k?k.empty():(k=new m("title",1),A(k)),k.append(new m("#text",3)).value=C.title):k&&k.remove(),n("keywords,description,author,copyright,robots".split(","),function(b){var D,j,f=z.getAll("meta"),d=C[b];for(D=0;D<f.length;D++){if(j=f[D],j.attr("name")==b){return void (d?j.attr("content",d):j.remove())}}d&&(k=new m("meta",1),k.attr("name",b),k.attr("content",d),k.shortEnded=!0,A(k))});var a={};tinymce.each(z.getAll("link"),function(b){"stylesheet"==b.attr("rel")&&(a[b.attr("href")]=b)}),tinymce.each(C.stylesheets,function(b){a[b]||(k=new m("link",1),k.attr({rel:"stylesheet",text:"text/css",href:b}),k.shortEnded=!0,A(k)),delete a[b]}),tinymce.each(a,function(b){b.remove()}),k=z.getAll("body")[0],k&&(B(k,"dir",C.langdir),B(k,"style",C.style),B(k,"vlink",C.visited_color),B(k,"link",C.link_color),B(k,"alink",C.active_color),e.setAttribs(x.getBody(),{style:C.style,dir:C.dir,vLink:C.visited_color,link:C.link_color,aLink:C.active_color})),k=z.getAll("html")[0],k&&(B(k,"lang",C.langcode),B(k,"xml:lang",C.langcode)),y.firstChild||y.remove(),l=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(z),p=l.substring(0,l.indexOf("</body>"))}function t(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(p)}function s(C){function B(b){return b.replace(/<\/?[A-Z]+/g,function(c){return c.toLowerCase()})}var A,z,y,k,j=C.content,i="",g=x.dom;if(!C.selection&&!("raw"==C.format&&p||C.source_view&&x.getParam("fullpage_hide_in_source_view"))){0!==j.length||C.source_view||(j=tinymce.trim(p)+"\n"+tinymce.trim(j)+"\n"+tinymce.trim(o)),j=j.replace(/<(\/?)BODY/gi,"<$1body"),A=j.indexOf("<body"),-1!=A?(A=j.indexOf(">",A),p=B(j.substring(0,A+1)),z=j.indexOf("</body",A),-1==z&&(z=j.length),C.content=j.substring(A+1,z),o=B(j.substring(z))):(p=r(),o="\n</body>\n</html>"),y=t(),n(y.getAll("style"),function(b){b.firstChild&&(i+=b.firstChild.value)}),k=y.getAll("body")[0],k&&g.setAttribs(x.getBody(),{style:k.attr("style")||"",dir:k.attr("dir")||"",vLink:k.attr("vlink")||"",link:k.attr("link")||"",aLink:k.attr("alink")||""}),g.remove("fullpage_styles");var e=x.getDoc().getElementsByTagName("head")[0];i&&(g.add(e,"style",{id:"fullpage_styles"},i),k=g.get("fullpage_styles"),k.styleSheet&&(k.styleSheet.cssText=i));var a={};tinymce.each(e.getElementsByTagName("link"),function(b){"stylesheet"==b.rel&&b.getAttribute("data-mce-fullpage")&&(a[b.href]=b)}),tinymce.each(y.getAll("link"),function(d){var c=d.attr("href");a[c]||"stylesheet"!=d.attr("rel")||g.add(e,"link",{rel:"stylesheet",text:"text/css",href:c,"data-mce-fullpage":"1"}),delete a[c]}),tinymce.each(a,function(b){b.parentNode.removeChild(b)})}}function r(){var a,f="",e="";return x.getParam("fullpage_default_xml_pi")&&(f+='<?xml version="1.0" encoding="'+x.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),f+=x.getParam("fullpage_default_doctype","<!DOCTYPE html>"),f+="\n<html>\n<head>\n",(a=x.getParam("fullpage_default_title"))&&(f+="<title>"+a+"</title>\n"),(a=x.getParam("fullpage_default_encoding"))&&(f+='<meta http-equiv="Content-Type" content="text/html; charset='+a+'" />\n'),(a=x.getParam("fullpage_default_font_family"))&&(e+="font-family: "+a+";"),(a=x.getParam("fullpage_default_font_size"))&&(e+="font-size: "+a+";"),(a=x.getParam("fullpage_default_text_color"))&&(e+="color: "+a+";"),f+="</head>\n<body"+(e?' style="'+e+'"':"")+">\n"}function q(a){a.selection||a.source_view&&x.getParam("fullpage_hide_in_source_view")||(a.content=tinymce.trim(p)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(o))}var p,o,n=tinymce.each,m=tinymce.html.Node;x.addCommand("mceFullPageProperties",w),x.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),x.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),x.on("BeforeSetContent",s),x.on("GetContent",q)});