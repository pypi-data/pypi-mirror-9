tinymce.PluginManager.add("media",function(z,y){function x(b){return -1!=b.indexOf(".mp3")?"audio/mpeg":-1!=b.indexOf(".wav")?"audio/wav":-1!=b.indexOf(".mp4")?"video/mp4":-1!=b.indexOf(".webm")?"video/webm":-1!=b.indexOf(".ogg")?"video/ogg":-1!=b.indexOf(".swf")?"application/x-shockwave-flash":""}function w(a){var f=z.settings.media_scripts;if(f){for(var e=0;e<f.length;e++){if(-1!==a.indexOf(f[e].filter)){return f[e]}}}}function v(){function a(e){var d,l,k,j;d=m.find("#width")[0],l=m.find("#height")[0],k=d.value(),j=l.value(),m.find("#constrain")[0].checked()&&i&&h&&k&&j&&(e.control==d?(j=Math.round(k/i*j),l.value(j)):(k=Math.round(j/h*k),d.value(k))),i=k,h=j}function B(){g=s(this.value()),this.parent().parent().fromJSON(g)}var m,i,h,g,f=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source",onchange:function(b){tinymce.each(b.meta,function(d,c){m.find("#"+c).value(d)})}}];z.settings.media_alt_source!==!1&&f.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),z.settings.media_poster!==!1&&f.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),z.settings.media_dimensions!==!1&&f.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:a},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:a},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),g=r(z.selection.getNode()),i=g.width,h=g.height;var A={id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:u(),multiline:!0,label:"Source"};A[n]=B,m=z.windowManager.open({title:"Insert/edit video",data:g,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){g=s(this.next().find("#embed").value()),this.fromJSON(g)},items:f},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(t(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},A]}],onSubmit:function(){var j,C,l,k;for(j=z.dom.select("img[data-mce-object]"),z.insertContent(t(this.toJSON())),C=z.dom.select("img[data-mce-object]"),l=0;l<j.length;l++){for(k=C.length-1;k>=0;k--){j[l]==C[k]&&C.splice(k,1)}}z.selection.select(C[0]),z.nodeChanged()}})}function u(){var a=z.selection.getNode();return a.getAttribute("data-mce-object")?z.selection.getContent():void 0}function t(c){var b="";if(!c.source1&&(tinymce.extend(c,s(c.embed)),!c.source1)){return""}if(c.source2||(c.source2=""),c.poster||(c.poster=""),c.source1=z.convertURL(c.source1,"source"),c.source2=z.convertURL(c.source2,"source"),c.source1mime=x(c.source1),c.source2mime=x(c.source2),c.poster=z.convertURL(c.poster,"poster"),c.flashPlayerUrl=z.convertURL(y+"/moxieplayer.swf","movie"),tinymce.each(o,function(f){var e,h,g;if(e=f.regex.exec(c.source1)){for(g=f.url,h=0;e[h];h++){g=g.replace("$"+h,function(){return e[h]})}c.source1=g,c.type=f.type,c.width=c.width||f.w,c.height=c.height||f.h}}),c.embed){b=p(c.embed,c,!0)}else{var a=w(c.source1);a&&(c.type="script",c.width=a.width,c.height=a.height),c.width=c.width||300,c.height=c.height||150,tinymce.each(c,function(d,e){c[e]=z.dom.encode(d)}),"iframe"==c.type?b+='<iframe src="'+c.source1+'" width="'+c.width+'" height="'+c.height+'"></iframe>':"application/x-shockwave-flash"==c.source1mime?(b+='<object data="'+c.source1+'" width="'+c.width+'" height="'+c.height+'" type="application/x-shockwave-flash">',c.poster&&(b+='<img src="'+c.poster+'" width="'+c.width+'" height="'+c.height+'" />'),b+="</object>"):-1!=c.source1mime.indexOf("audio")?z.settings.audio_template_callback?b=z.settings.audio_template_callback(c):b+='<audio controls="controls" src="'+c.source1+'">'+(c.source2?'\n<source src="'+c.source2+'"'+(c.source2mime?' type="'+c.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==c.type?b+='<script src="'+c.source1+'"><\/script>':b=z.settings.video_template_callback?z.settings.video_template_callback(c):'<video width="'+c.width+'" height="'+c.height+'"'+(c.poster?' poster="'+c.poster+'"':"")+' controls="controls">\n<source src="'+c.source1+'"'+(c.source1mime?' type="'+c.source1mime+'"':"")+" />\n"+(c.source2?'<source src="'+c.source2+'"'+(c.source2mime?' type="'+c.source2mime+'"':"")+" />\n":"")+"</video>"}return b}function s(d){var c={};return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(b,g){if(c.source1||"param"!=b||(c.source1=g.map.movie),("iframe"==b||"object"==b||"embed"==b||"video"==b||"audio"==b)&&(c.type||(c.type=b),c=tinymce.extend(g.map,c)),"script"==b){var f=w(g.map.src);if(!f){return}c={type:"script",source1:g.map.src,width:f.width,height:f.height}}"source"==b&&(c.source1?c.source2||(c.source2=g.map.src):c.source1=g.map.src),"img"!=b||c.poster||(c.poster=g.map.src)}}).parse(d),c.source1=c.source1||c.src||c.data,c.source2=c.source2||"",c.poster=c.poster||"",c}function r(a){return a.getAttribute("data-mce-object")?s(z.serializer.serialize(a,{selection:!0})):{}}function q(a){if(z.settings.media_filter_html===!1){return a}var d=new tinymce.html.Writer;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!1,special:"script,noscript",comment:function(b){d.comment(b)},cdata:function(b){d.cdata(b)},text:function(e,c){d.text(e,c)},start:function(f,c,h){if("script"!=f&&"noscript"!=f){for(var g=0;g<c.length;g++){if(0===c[g].name.indexOf("on")){return}}d.start(f,c,h)}},end:function(b){"script"!=b&&"noscript"!=b&&d.end(b)}},new tinymce.html.Schema({})).parse(a),d.getContent()}function p(i,h,A){function m(B,g){var F,E,D,C;for(F in g){if(D=""+g[F],B.map[F]){for(E=B.length;E--;){C=B[E],C.name==F&&(D?(B.map[F]=D,C.value=D):(delete B.map[F],B.splice(E,1)))}}else{D&&(B.push({name:F,value:D}),B.map[F]=D)}}}var l,k=new tinymce.html.Writer,j=0;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(b){k.comment(b)},cdata:function(b){k.cdata(b)},text:function(d,c){k.text(d,c)},start:function(b,d,c){switch(b){case"video":case"object":case"embed":case"img":case"iframe":m(d,{width:h.width,height:h.height})}if(A){switch(b){case"video":m(d,{poster:h.poster,src:""}),h.source2&&m(d,{src:""});break;case"iframe":m(d,{src:h.source1});break;case"source":if(j++,2>=j&&(m(d,{src:h["source"+j],type:h["source"+j+"mime"]}),!h["source"+j])){return}break;case"img":if(!h.poster){return}l=!0}}k.start(b,d,c)},end:function(b){if("video"==b&&A){for(var e=1;2>=e;e++){if(h["source"+e]){var d=[];d.map={},e>j&&(m(d,{src:h["source"+e],type:h["source"+e+"mime"]}),k.start("source",d,!0))}}}if(h.poster&&"object"==b&&A&&!l){var c=[];c.map={},m(c,{src:h.poster,width:h.width,height:h.height}),k.start("img",c,!0)}k.end(b)}},new tinymce.html.Schema({})).parse(i),k.getContent()}var o=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$2?title=0&amp;byline=0"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"'}],n=tinymce.Env.ie&&tinymce.Env.ie<=8?"onChange":"onInput";z.on("ResolveName",function(d){var c;1==d.target.nodeType&&(c=d.target.getAttribute("data-mce-object"))&&(d.name=c)}),z.on("preInit",function(){var a=z.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(b){a[b]=new RegExp("</"+b+"[^>]*>","gi")});var d=z.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(b){d[b]={}}),z.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(K,J){for(var I,H,G,F,E,D,C,B,A=K.length;A--;){if(H=K[A],H.parent&&("script"!=H.name||(B=w(H.attr("src"))))){for(G=new tinymce.html.Node("img",1),G.shortEnded=!0,B&&(B.width&&H.attr("width",B.width.toString()),B.height&&H.attr("height",B.height.toString())),D=H.attributes,I=D.length;I--;){F=D[I].name,E=D[I].value,"width"!==F&&"height"!==F&&"style"!==F&&(("data"==F||"src"==F)&&(E=z.convertURL(E,F)),G.attr("data-mce-p-"+F,E))}C=H.firstChild&&H.firstChild.value,C&&(G.attr("data-mce-html",escape(C)),G.firstChild=null),G.attr({width:H.attr("width")||"300",height:H.attr("height")||("audio"==J?"30":"150"),style:H.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":J,"class":"mce-object mce-object-"+J}),H.replace(G)}}}),z.serializer.addAttributeFilter("data-mce-object",function(I,H){for(var G,F,E,D,C,B,A,m=I.length;m--;){if(G=I[m],G.parent){for(A=G.attr(H),F=new tinymce.html.Node(A,1),"audio"!=A&&"script"!=A&&F.attr({width:G.attr("width"),height:G.attr("height")}),F.attr({style:G.attr("style")}),D=G.attributes,E=D.length;E--;){var j=D[E].name;0===j.indexOf("data-mce-p-")&&F.attr(j.substr(11),D[E].value)}"script"==A&&F.attr("type","text/javascript"),C=G.attr("data-mce-html"),C&&(B=new tinymce.html.Node("#text",3),B.raw=!0,B.value=q(unescape(C)),F.append(B)),G.replace(F)}}})}),z.on("ObjectSelected",function(d){var c=d.target.getAttribute("data-mce-object");("audio"==c||"script"==c)&&d.preventDefault()}),z.on("objectResized",function(e){var d,f=e.target;f.getAttribute("data-mce-object")&&(d=f.getAttribute("data-mce-html"),d&&(d=unescape(d),f.setAttribute("data-mce-html",escape(p(d,{width:e.width,height:e.height})))))}),z.addButton("media",{tooltip:"Insert/edit video",onclick:v,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]}),z.addMenuItem("media",{icon:"media",text:"Insert video",onclick:v,context:"insert",prependToContext:!0})});