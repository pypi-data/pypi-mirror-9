tinymce.PluginManager.add("layer",function(h){function g(b){do{if(b.className&&-1!=b.className.indexOf("mceItemLayer")){return b}}while(b=b.parentNode)}function l(a){var d=h.dom;tinymce.each(d.select("div,p",a),function(b){/^(absolute|relative|fixed)$/i.test(b.style.position)&&(b.hasVisual?d.addClass(b,"mceItemVisualAid"):d.removeClass(b,"mceItemVisualAid"),d.addClass(b,"mceItemLayer"))})}function k(q){var p,o,n=[],m=g(h.selection.getNode()),b=-1,a=-1;for(o=[],tinymce.walk(h.getBody(),function(c){1==c.nodeType&&/^(absolute|relative|static)$/i.test(c.style.position)&&o.push(c)},"childNodes"),p=0;p<o.length;p++){n[p]=o[p].style.zIndex?parseInt(o[p].style.zIndex,10):0,0>b&&o[p]==m&&(b=p)}if(0>q){for(p=0;p<n.length;p++){if(n[p]<n[b]){a=p;break}}a>-1?(o[b].style.zIndex=n[a],o[a].style.zIndex=n[b]):n[b]>0&&(o[b].style.zIndex=n[b]-1)}else{for(p=0;p<n.length;p++){if(n[p]>n[b]){a=p;break}}a>-1?(o[b].style.zIndex=n[a],o[a].style.zIndex=n[b]):o[b].style.zIndex=n[b]+1}h.execCommand("mceRepaint")}function j(){var a=h.dom,f=a.getPos(a.getParent(h.selection.getNode(),"*")),e=h.getBody();h.dom.add(e,"div",{style:{position:"absolute",left:f.x,top:f.y>20?f.y:20,width:100,height:100},"class":"mceItemVisualAid mceItemLayer"},h.selection.getContent()||h.getLang("layer.content")),tinymce.Env.ie&&a.setHTML(e,e.innerHTML)}function i(){var a=g(h.selection.getNode());a||(a=h.dom.getParent(h.selection.getNode(),"DIV,P,IMG")),a&&("absolute"==a.style.position.toLowerCase()?(h.dom.setStyles(a,{position:"",left:"",top:"",width:"",height:""}),h.dom.removeClass(a,"mceItemVisualAid"),h.dom.removeClass(a,"mceItemLayer")):(a.style.left||(a.style.left="20px"),a.style.top||(a.style.top="20px"),a.style.width||(a.style.width=a.width?a.width+"px":"100px"),a.style.height||(a.style.height=a.height?a.height+"px":"100px"),a.style.position="absolute",h.dom.setAttrib(a,"data-mce-style",""),h.addVisual(h.getBody())),h.execCommand("mceRepaint"),h.nodeChanged())}h.addCommand("mceInsertLayer",j),h.addCommand("mceMoveForward",function(){k(1)}),h.addCommand("mceMoveBackward",function(){k(-1)}),h.addCommand("mceMakeAbsolute",function(){i()}),h.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"}),h.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"}),h.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"}),h.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"}),h.on("init",function(){tinymce.Env.ie&&h.getDoc().execCommand("2D-Position",!1,!0)}),h.on("mouseup",function(b){var a=g(b.target);a&&h.dom.setAttrib(a,"data-mce-style","")}),h.on("mousedown",function(n){var m,b=n.target,a=h.getDoc();tinymce.Env.gecko&&(g(b)?"on"!==a.designMode&&(a.designMode="on",b=a.body,m=b.parentNode,m.removeChild(b),m.appendChild(b)):"on"==a.designMode&&(a.designMode="off"))}),h.on("NodeChange",l)});