tinymce.PluginManager.add("image",function(d){function e(g,h){function i(k,l){j.parentNode&&j.parentNode.removeChild(j),h({width:k,height:l})}var j=document.createElement("img");j.onload=function(){i(j.clientWidth,j.clientHeight)},j.onerror=function(){i()};var f=j.style;f.visibility="hidden",f.position="fixed",f.bottom=f.left=0,f.width=f.height="auto",document.body.appendChild(j),j.src=g}function a(h,i,f){function g(j,k){return k=k||[],tinymce.each(j,function(m){var l={text:m.text||m.title};m.menu?l.menu=g(m.menu):(l.value=m.value,i(l)),k.push(l)}),k}return g(h,f||[])}function b(f){return function(){var g=d.settings.image_list;"string"==typeof g?tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}}):"function"==typeof g?g(f):f(g)}}function c(H){function f(){var v,w,t,u;v=m.find("#width")[0],w=m.find("#height")[0],v&&w&&(t=v.value(),u=w.value(),m.find("#constrain")[0].checked()&&o&&p&&t&&u&&(o!=t?(u=Math.round(t/o*u),w.value(u)):(t=Math.round(u/p*t),v.value(t))),o=t,p=u)}function g(){function t(v){function u(){v.onload=v.onerror=null,d.selection&&(d.selection.select(v),d.nodeChanged())}v.onload=function(){G.width||G.height||!n||j.setAttribs(v,{width:v.clientWidth,height:v.clientHeight}),u()},v.onerror=u}k(),f(),G=tinymce.extend(G,m.toJSON()),G.alt||(G.alt=""),""===G.width&&(G.width=null),""===G.height&&(G.height=null),G.style||(G.style=null),G={src:G.src,alt:G.alt,width:G.width,height:G.height,style:G.style,"class":G["class"]},d.undoManager.transact(function(){return G.src?(l?j.setAttribs(l,G):(G.id="__mcenew",d.focus(),d.selection.setContent(j.createHTML("img",G)),l=j.get("__mcenew"),j.setAttrib(l,"id",null)),void t(l)):void (l&&(j.remove(l),d.focus(),d.nodeChanged()))})}function h(t){return t&&(t=t.replace(/px$/,"")),t}function i(w){var x=w.meta||{};if(q&&q.value(d.convertURL(this.value(),"src")),tinymce.each(x,function(y,z){m.find("#"+z).value(y)}),!x.width&&!x.height){var t=this.value(),u=new RegExp("^(?:[a-z]+:)?//","i"),v=d.settings.document_base_url;v&&!u.test(t)&&t.substring(0,v.length)!==v&&this.value(v+t),e(this.value(),function(y){y.width&&y.height&&n&&(o=y.width,p=y.height,m.find("#width").value(o),m.find("#height").value(p))})}}function k(){function v(w){return w.length>0&&/^[0-9]+$/.test(w)&&(w+="px"),w}if(d.settings.image_advtab){var t=m.toJSON(),u=j.parseStyle(t.style);delete u.margin,u["margin-top"]=u["margin-bottom"]=v(t.vspace),u["margin-left"]=u["margin-right"]=v(t.hspace),u["border-width"]=v(t.border),m.find("#style").value(j.serializeStyle(j.parseStyle(j.serializeStyle(u))))}}var m,o,p,q,r,G={},j=d.dom,l=d.selection.getNode(),n=d.settings.image_dimensions!==!1;o=j.getAttrib(l,"width"),p=j.getAttrib(l,"height"),"IMG"!=l.nodeName||l.getAttribute("data-mce-object")||l.getAttribute("data-mce-placeholder")?l=null:G={src:j.getAttrib(l,"src"),alt:j.getAttrib(l,"alt"),"class":j.getAttrib(l,"class"),width:o,height:p},H&&(q={type:"listbox",label:"Image list",values:a(H,function(t){t.value=d.convertURL(t.value||t.url,"src")},[{text:"None",value:""}]),value:G.src&&d.convertURL(G.src,"src"),onselect:function(t){var u=m.find("#alt");(!u.value()||t.lastControl&&u.value()==t.lastControl.text())&&u.value(t.control.text()),m.find("#src").value(t.control.value()).fire("change")},onPostRender:function(){q=this}}),d.settings.image_class_list&&(r={name:"class",type:"listbox",label:"Class",values:a(d.settings.image_class_list,function(t){t.value&&(t.textStyle=function(){return d.formatter.getCssText({inline:"img",classes:[t.value]})})})});var s=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:i},q];d.settings.image_description!==!1&&s.push({name:"alt",type:"textbox",label:"Image description"}),n&&s.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),s.push(r),d.settings.image_advtab?(l&&(G.hspace=h(l.style.marginLeft||l.style.marginRight),G.vspace=h(l.style.marginTop||l.style.marginBottom),G.border=h(l.style.borderWidth),G.style=d.dom.serializeStyle(d.dom.parseStyle(d.dom.getAttrib(l,"style")))),m=d.windowManager.open({title:"Insert/edit image",data:G,bodyType:"tabpanel",body:[{title:"General",type:"form",items:s},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:k},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:g})):m=d.windowManager.open({title:"Insert/edit image",data:G,body:s,onSubmit:g})}d.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:b(c),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"}),d.addMenuItem("image",{icon:"image",text:"Insert image",onclick:b(c),context:"insert",prependToContext:!0}),d.addCommand("mceImage",b(c))});